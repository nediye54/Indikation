<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagnose – MDG</title>
  <meta name="description" content="In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen." />
  <link rel="stylesheet" href="./style.css" />
  <style>
    .dx-wrap{ max-width:1120px; margin:0 auto; padding:1.25rem 1rem 3rem; }
    .dx-top{ display:grid; grid-template-columns:1.1fr .9fr; gap:1rem; align-items:start; }
    .dx-actions{ display:flex; gap:.65rem; flex-wrap:wrap; align-items:center; }
    .dx-kpi{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.8rem; }
    .dx-kpi .pill{ white-space:nowrap; }
    .dx-grid{ display:grid; grid-template-columns:1fr; gap:.75rem; margin-top:.6rem; }
    .dx-field{ display:grid; gap:.35rem; }
    .dx-label{ font-weight:800; color:var(--muted,#aab); }
    .dx-help{ font-size:.9rem; color:var(--muted,#aab); line-height:1.35; }
    .dx-help b{ color:var(--text,#fff); }
    .dx-rangeRow{ display:grid; grid-template-columns:1fr auto; gap:.7rem; align-items:center; }
    .dx-rangeVal{ font-weight:900; min-width:2.2rem; text-align:right; }
    .dx-divider{ height:1px; background:rgba(255,255,255,.08); margin:.9rem 0; }
    .dx-questions{ display:grid; gap:1rem; margin-top:1rem; }
    .dx-q{ padding-top:.9rem; border-top:1px solid rgba(255,255,255,.08); }
    .dx-q:first-child{ border-top:0; padding-top:0; }
    .dx-qtitle{ font-weight:950; margin-bottom:.35rem; }
    .dx-example{ margin-top:.25rem; display:grid; gap:.25rem; }
    .dx-example .ex{ font-size:.9rem; color:var(--muted,#aab); }
    .dx-example .ex::before{ content:"• "; opacity:.9; }
    .dx-output pre{ white-space:pre-wrap; word-break:break-word; }
    .dx-report{ margin-top:1rem; }
    .dx-reportGrid{ display:grid; grid-template-columns:1fr; gap:1rem; }
    .dx-reportBox{ padding:1rem; border:1px solid rgba(255,255,255,.10); border-radius:var(--radius2,18px); background:rgba(255,255,255,.02); }
    .dx-reportBox h3{ margin:0 0 .6rem; }
    .dx-badges{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .dx-note{ font-size:.9rem; color:var(--muted,#aab); }
    .dx-treeSvg{ width:100%; height:auto; display:block; border-radius:14px; }
    .dx-treeSvg text{ font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .dx-feedback{ display:none; margin-top:.9rem; }
    .dx-feedback .row{ display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
    .dx-stars{ display:flex; gap:.25rem; }
    .dx-star{ width:34px; height:34px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.03); display:grid; place-items:center; cursor:pointer; user-select:none; }
    .dx-star[aria-pressed="true"]{ border-color:rgba(110,231,183,.65); box-shadow:0 0 0 2px rgba(110,231,183,.15) inset; }
    .dx-ta{ width:100%; min-height:90px; resize:vertical; padding:.75rem .85rem; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.18); color:var(--text,#fff); }
    @media (max-width:980px){ .dx-top{ grid-template-columns:1fr; } }
  </style>
</head>

<body>
  <a class="skip-link" href="#main">Skip</a>

  <header class="header" id="top">
    <div class="container header__inner">
      <a class="brand" href="./index.html" aria-label="Home">
        <span class="brand__mark" aria-hidden="true">MDG</span>
      </a>

      <nav class="nav" aria-label="Main">
        <a class="nav__link" href="./how.html" data-i18n="nav.how">How it works</a>
        <a class="nav__link" href="./why.html" data-i18n="nav.why">Why MDG</a>
        <a class="nav__link" href="./faq.html" data-i18n="nav.faq">FAQ</a>
      </nav>

      <div class="header__actions">
        <div class="lang" role="group" aria-label="Language">
          <button class="chip chip--ghost" type="button" data-lang="de" aria-pressed="true">DE</button>
          <button class="chip chip--ghost" type="button" data-lang="tr" aria-pressed="false">TR</button>
          <button class="chip chip--ghost" type="button" data-lang="en" aria-pressed="false">EN</button>
        </div>
        <a class="btn btn--ghost" href="./index.html" data-i18n="cta.backHome">Home</a>
      </div>

      <button class="burger" type="button" aria-label="Menu" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
    </div>

    <div class="drawer" hidden>
      <div class="drawer__content">
        <a class="drawer__link" href="./how.html" data-i18n="nav.how">How it works</a>
        <a class="drawer__link" href="./why.html" data-i18n="nav.why">Why MDG</a>
        <a class="drawer__link" href="./faq.html" data-i18n="nav.faq">FAQ</a>
        <div class="drawer__sep"></div>
        <a class="btn btn--ghost btn--full" href="./index.html" data-i18n="cta.backHome">Home</a>
      </div>
    </div>
  </header>

  <main id="main">
    <div class="dx-wrap">
      <div class="section__head">
        <h1 class="h2" data-i18n="dx.title">Diagnosis</h1>
        <p class="sub" data-i18n="dx.sub">In a few minutes to decision-confidence: detect instability early, diagnose precisely, build architecture.</p>
      </div>

      <div class="dx-top">
        <div class="card">
          <h2 class="h3" data-i18n="dx.contextTitle">1) Context</h2>

          <div class="dx-grid">
            <div class="dx-field">
              <div class="dx-label" data-i18n="dx.mode">Mode</div>
              <div class="dx-badges">
                <span class="pill pill--muted" id="modeBadge">—</span>
                <span class="pill pill--muted" id="tokenBadge" style="display:none;">Token: ✓</span>
              </div>
              <div class="dx-help" id="modeHint"></div>
            </div>

            <div class="dx-field">
              <label class="dx-label" for="goalSelect" data-i18n="dx.goal">Goal</label>
              <select class="dx-input" id="goalSelect">
                <option value="stabilize" data-i18n="dx.goal.stabilize">Stabilize (reduce tension fast)</option>
                <option value="rebuild" data-i18n="dx.goal.rebuild">Rebuild (change architecture)</option>
              </select>
              <div class="dx-help" id="goalHelp"></div>
            </div>

            <div class="dx-field">
              <label class="dx-label" for="oneLiner" data-i18n="dx.oneliner">Describe the situation in one sentence</label>
              <input class="dx-input" id="oneLiner" type="text" maxlength="160" placeholder="…" />
              <div class="dx-help" id="oneLinerHelp"></div>
            </div>

            <div class="dx-divider"></div>

            <h2 class="h3" style="margin:0;" data-i18n="dx.scanTitle">2) Quick Scan (sliders)</h2>
            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.load.title">Load & bottlenecks</div>
              <div class="dx-help" id="exLoad"></div>
              <div class="dx-rangeRow">
                <input id="sLoad" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vLoad">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.decisions.title">Decision architecture</div>
              <div class="dx-help" id="exDecisions"></div>
              <div class="dx-rangeRow">
                <input id="sDecisions" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vDecisions">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.energy.title">Energy & error handling</div>
              <div class="dx-help" id="exEnergy"></div>
              <div class="dx-rangeRow">
                <input id="sEnergy" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vEnergy">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.growth.title">Growth pressure / complexity</div>
              <div class="dx-help" id="exGrowth"></div>
              <div class="dx-rangeRow">
                <input id="sGrowth" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vGrowth">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.power.title">Power–responsibility alignment</div>
              <div class="dx-help" id="exPower"></div>
              <div class="dx-rangeRow">
                <input id="sPower" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vPower">2</div>
              </div>
            </div>

            <div class="dx-divider"></div>

            <h2 class="h3" style="margin:0;" data-i18n="dx.moreTitle">3) Precision Questions (adaptive)</h2>
            <div class="dx-questions" id="questions"></div>

            <div class="dx-actions" style="margin-top:.9rem;">
              <button class="btn btn--primary" type="button" id="runBtn" data-i18n="dx.run">Run assessment</button>
              <button class="btn btn--ghost" type="button" id="resetBtn" data-i18n="dx.reset">Reset</button>
              <span class="micro" id="statusLine">—</span>
            </div>

            <div class="dx-kpi">
              <span class="pill pill--muted" id="kpiPrimary">—</span>
              <span class="pill pill--muted" id="kpiPath">—</span>
              <span class="pill pill--muted" id="kpiRisk">—</span>
            </div>
          </div>
        </div>

        <div class="card dx-output">
          <h2 class="h3" data-i18n="dx.outputTitle">Strategic Output</h2>
          <p class="micro" data-i18n="dx.outputHint">You will get: primary instability, why it happens, what to do now, and what to rebuild.</p>

          <div class="dx-reportGrid">
            <div class="dx-reportBox">
              <h3 class="h3" style="margin-top:0;" data-i18n="dx.assessmentTitle">Assessment</h3>
              <pre id="resultText" class="micro" style="margin:0;">—</pre>
            </div>

            <div class="dx-reportBox">
              <h3 class="h3" style="margin-top:0;" data-i18n="dx.execTitle">Executive Report</h3>
              <p class="dx-note" id="execHint"></p>

              <div class="dx-actions" style="margin-top:.6rem;">
                <button class="btn btn--primary" type="button" id="execBtn" data-i18n="dx.execBtn">Generate Executive Report</button>
                <button class="btn btn--ghost" type="button" id="copyExecBtn" disabled data-i18n="dx.copy">Copy</button>
                <button class="btn btn--ghost" type="button" id="svgBtn">SVG</button>
                <button class="btn btn--ghost" type="button" id="pdfBtn">PDF</button>
              </div>

              <div class="dx-report" id="reportContainer" style="display:none;">
                <pre id="execText" class="micro" style="margin:.8rem 0 0;">—</pre>
              </div>

              <div class="dx-report" id="treeContainer" style="display:none; margin-top:.9rem;">
                <div class="micro" style="opacity:.85; margin-bottom:.4rem;" data-i18n="dx.treeTitle">Tree</div>
                <div id="treeSvgWrap"></div>
              </div>

              <div class="dx-feedback dx-reportBox" id="feedbackBox">
                <h3 class="h3" style="margin-top:0;" data-i18n="fb.title">Feedback</h3>
                <p class="dx-note" id="fbHint"></p>

                <div class="row" style="margin-top:.6rem;">
                  <div class="dx-stars" id="fbStars" aria-label="Rating">
                    <button class="dx-star" type="button" data-v="1" aria-pressed="false">1</button>
                    <button class="dx-star" type="button" data-v="2" aria-pressed="false">2</button>
                    <button class="dx-star" type="button" data-v="3" aria-pressed="false">3</button>
                    <button class="dx-star" type="button" data-v="4" aria-pressed="false">4</button>
                    <button class="dx-star" type="button" data-v="5" aria-pressed="false">5</button>
                  </div>
                  <span class="micro" id="fbVal">—</span>
                </div>

                <div style="margin-top:.6rem;">
                  <textarea class="dx-ta" id="fbText" maxlength="800" placeholder="…"></textarea>
                </div>

                <div class="dx-actions" style="margin-top:.6rem;">
                  <button class="btn btn--primary" type="button" id="fbSendBtn" disabled data-i18n="fb.send">Send</button>
                  <span class="micro" id="fbStatus">—</span>
                </div>
              </div>

            </div>
          </div>

          <p class="micro" style="margin-top:1rem; opacity:.85;" data-i18n="dx.privacy">Privacy: inputs are processed via API only to generate the assessment/report.</p>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer__grid">
      <div>
        <div class="brand brand--footer">
          <span class="brand__mark" aria-hidden="true">MDG</span>
        </div>
        <p class="micro" data-i18n="footer.tag">Structure diagnosis for stabilization and rebuild.</p>
      </div>
      <div class="footer__legal">
        <a href="./impressum.html" rel="nofollow">Impressum</a>
        <a href="./datenschutz.html" rel="nofollow">Datenschutz</a>
        <a href="./kontakt.html" rel="nofollow">Kontakt</a>
      </div>
    </div>
  </footer>

  <script>
  (() => {
    const API_BASE = "https://api.mdg-indikation.de";
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const burger = $(".burger");
    const drawer = $(".drawer");
    if (burger && drawer) {
      burger.addEventListener("click", () => {
        const open = !drawer.hasAttribute("hidden");
        if (open) { drawer.setAttribute("hidden",""); burger.setAttribute("aria-expanded","false"); }
        else { drawer.removeAttribute("hidden"); burger.setAttribute("aria-expanded","true"); }
      });
    }

    const ss = window.sessionStorage;
    const ls = window.localStorage;

    function uuid(){
      const a = crypto.getRandomValues(new Uint8Array(16));
      a[6] = (a[6] & 0x0f) | 0x40;
      a[8] = (a[8] & 0x3f) | 0x80;
      const h = [...a].map(b => b.toString(16).padStart(2,"0")).join("");
      return `${h.slice(0,8)}-${h.slice(8,12)}-${h.slice(12,16)}-${h.slice(16,20)}-${h.slice(20)}`;
    }

    function getClientId(){
      let id = ls.getItem("mdg_client_id");
      if (!id || id.length < 16) { id = uuid(); ls.setItem("mdg_client_id", id); }
      return id;
    }

    const params = new URLSearchParams(location.search);
    const modeParam = (params.get("mode") || "").toLowerCase();
    const storedMode = ((ss.getItem("mdg_mode") || ls.getItem("mdg_mode") || "")).toLowerCase();
    const businessOk = (ss.getItem("mdg_business_ok") === "1") || (ls.getItem("mdg_business_ok") === "1");
    const tokenStored = (ss.getItem("mdg_business_token") || ls.getItem("mdg_business_token") || ls.getItem("mdg_token") || "").trim();
    const wantsBusiness = (modeParam === "business") || (storedMode === "business");
    const mode = (wantsBusiness && businessOk) ? "business" : "private";

    $("#modeBadge").textContent = (mode === "business") ? "Business" : "Private";
    if (mode === "business") $("#tokenBadge").style.display = "";

    const dict = {
      de: {
        "nav.how":"Wie es funktioniert","nav.why":"Warum MDG","nav.faq":"FAQ","cta.backHome":"Zur Homepage",
        "dx.title":"Diagnose","dx.sub":"In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen.",
        "dx.contextTitle":"1) Kontext","dx.mode":"Modus","dx.goal":"Ziel","dx.goal.stabilize":"Stabilisieren (Spannung schnell senken)","dx.goal.rebuild":"Umbauen (Architektur verändern)",
        "dx.oneliner":"Beschreibe die Situation in einem Satz","dx.scanTitle":"2) Quick Scan (Slider)","dx.moreTitle":"3) Präzisionsfragen (adaptiv)",
        "dx.run":"Diagnose starten","dx.reset":"Zurücksetzen",
        "dx.outputTitle":"Output","dx.outputHint":"Du erhältst: Primärinstabilität, warum sie entsteht, Sofortmaßnahmen und Umbaupfad.",
        "dx.assessmentTitle":"Strategisches Assessment","dx.execTitle":"Executive Report","dx.execBtn":"Executive Report erzeugen","dx.copy":"Kopieren","dx.treeTitle":"Tree",
        "dx.privacy":"Datenschutz: Inputs werden via API nur zur Generierung von Assessment/Report verarbeitet.","footer.tag":"Strukturdiagnose für Stabilisierung und Umbau.",
        "q.load.title":"Last & Engpässe","q.decisions.title":"Entscheidungsarchitektur","q.energy.title":"Energie & Fehlerkultur","q.growth.title":"Wachstumsdruck / Komplexität","q.power.title":"Macht–Verantwortung (Alignment)",
        "fb.title":"Feedback","fb.send":"Senden"
      },
      tr: {
        "nav.how":"Nasıl çalışır","nav.why":"Neden MDG","nav.faq":"SSS","cta.backHome":"Anasayfa",
        "dx.title":"Analiz","dx.sub":"Birkaç dakika içinde karar güveni: istikrarsızlığı erken gör, nedeni doğru teşhis et, mimari kur.",
        "dx.contextTitle":"1) Bağlam","dx.mode":"Mod","dx.goal":"Hedef","dx.goal.stabilize":"Stabilize et","dx.goal.rebuild":"Yeniden kur",
        "dx.oneliner":"Durumu tek cümleyle anlat","dx.scanTitle":"2) Hızlı tarama (Slider)","dx.moreTitle":"3) Kesinleştirme soruları",
        "dx.run":"Başlat","dx.reset":"Sıfırla",
        "dx.outputTitle":"Çıktı","dx.outputHint":"Alacağın: ana instabilite, nedenleri, hemen yapılacaklar ve dönüşüm yolu.",
        "dx.assessmentTitle":"Stratejik değerlendirme","dx.execTitle":"Yönetici Raporu","dx.execBtn":"Rapor üret","dx.copy":"Kopyala","dx.treeTitle":"Ağaç",
        "dx.privacy":"Gizlilik: Veriler yalnızca rapor üretimi için API üzerinden işlenir.","footer.tag":"Stabilizasyon ve yeniden kurulum için yapı teşhisi.",
        "q.load.title":"Yük & darboğazlar","q.decisions.title":"Karar mimarisi","q.energy.title":"Enerji & hata kültürü","q.growth.title":"Büyüme baskısı / karmaşıklık","q.power.title":"Güç–sorumluluk uyumu",
        "fb.title":"Geri bildirim","fb.send":"Gönder"
      },
      en: {
        "nav.how":"How it works","nav.why":"Why MDG","nav.faq":"FAQ","cta.backHome":"Home",
        "dx.title":"Diagnosis","dx.sub":"In a few minutes to decision-confidence: detect instability early, diagnose precisely, build architecture.",
        "dx.contextTitle":"1) Context","dx.mode":"Mode","dx.goal":"Goal","dx.goal.stabilize":"Stabilize","dx.goal.rebuild":"Rebuild",
        "dx.oneliner":"Describe the situation in one sentence","dx.scanTitle":"2) Quick Scan (sliders)","dx.moreTitle":"3) Precision Questions (adaptive)",
        "dx.run":"Run assessment","dx.reset":"Reset",
        "dx.outputTitle":"Output","dx.outputHint":"You will get: primary instability, why it happens, what to do now, and what to rebuild.",
        "dx.assessmentTitle":"Strategic Assessment","dx.execTitle":"Executive Report","dx.execBtn":"Generate Executive Report","dx.copy":"Copy","dx.treeTitle":"Tree",
        "dx.privacy":"Privacy: inputs are processed via API only to generate the assessment/report.","footer.tag":"Structure diagnosis for stabilization and rebuild.",
        "q.load.title":"Load & bottlenecks","q.decisions.title":"Decision architecture","q.energy.title":"Energy & error handling","q.growth.title":"Growth pressure / complexity","q.power.title":"Power–responsibility alignment",
        "fb.title":"Feedback","fb.send":"Send"
      }
    };

    function getLang(){
      const pressed = $$("[data-lang]").find(b => b.getAttribute("aria-pressed") === "true");
      return pressed?.dataset.lang || "de";
    }

    function applyLang(lang){
      if(!dict[lang]) lang = "en";
      document.documentElement.lang = lang;
      $$("[data-lang]").forEach(b => b.setAttribute("aria-pressed", String(b.dataset.lang === lang)));
      $$("[data-i18n]").forEach(el => {
        const k = el.dataset.i18n;
        const v = dict[lang][k];
        if (v) el.textContent = v;
      });
      renderExamples(lang);
      renderAdaptiveQuestions(lang);
      renderHints(lang);
      renderFeedbackCopy(lang);
    }

    $$("[data-lang]").forEach(btn => btn.addEventListener("click", () => applyLang(btn.dataset.lang)));

    function t(lang, de, tr, en){ return (lang==="de"?de:(lang==="tr"?tr:en)); }

    function renderExamples(lang){
      const business = (mode === "business");

      if (wantsBusiness && !businessOk) {
        $("#modeHint").innerHTML = t(lang,
          "Business-Zugang nicht aktiv. Bitte Token über die Landingpage bestätigen.",
          "Business erişimi aktif değil. Lütfen token’ı ana sayfada doğrula.",
          "Business access not active. Please verify token on the landing page."
        );
      } else {
        $("#modeHint").innerHTML = business
          ? t(lang,
              "Business-Modus: Fokus auf Unternehmen, Führung, Teams und Verantwortung.",
              "Business modu: şirket, liderlik, ekip ve sorumluluk odağı.",
              "Business mode: focus on companies, leadership, teams, accountability."
            )
          : t(lang,
              "Privat-Modus: Fokus auf persönliche Systeme, Beziehungen, Alltag, Rollen & Belastung.",
              "Özel mod: kişisel sistemler, ilişkiler, günlük hayat, roller ve yük odağı.",
              "Private mode: focus on personal systems, relationships, daily life, roles and load."
            );
      }

      $("#goalHelp").innerHTML = t(lang,
        "<b>Stabilisieren</b> = Spannung senken. <b>Umbauen</b> = Architektur ändern.",
        "<b>Stabilize</b> = gerilimi düşür. <b>Yeniden kur</b> = mimariyi değiştir.",
        "<b>Stabilize</b> = reduce tension. <b>Rebuild</b> = change architecture."
      );

      $("#oneLinerHelp").innerHTML = business
        ? t(lang,
            "Beispiel: <b>„Entscheidungen dauern zu lange und hängen an 1 Person.“</b>",
            "Örnek: <b>“Kararlar çok uzun sürüyor ve 1 kişiye bağlı.”</b>",
            "Example: <b>“Decisions take too long and depend on one person.”</b>"
          )
        : t(lang,
            "Beispiel: <b>„Ich prokrastiniere und verliere Kontrolle über meinen Alltag.“</b>",
            "Örnek: <b>“Erteleme yapıyorum ve günlük hayat kontrolüm kayıyor.”</b>",
            "Example: <b>“I procrastinate and lose control over my daily life.”</b>"
          );

      $("#exLoad").innerHTML = business
        ? t(lang,
          "0 = verteilt. 6 = 1–2 Rollen sind Dauer-Engpass.<div class='dx-example'><div class='ex'>„Ops ist 120% ausgelastet.“</div></div>",
          "0 = dağıtılmış. 6 = 1–2 rol sürekli darboğaz.<div class='dx-example'><div class='ex'>“Operasyon %120 dolu.”</div></div>",
          "0 = distributed. 6 = 1–2 roles are permanent bottlenecks.<div class='dx-example'><div class='ex'>“Ops at 120%.”</div></div>"
        )
        : t(lang,
          "0 = tragbar. 6 = alles hängt an dir.<div class='dx-example'><div class='ex'>„Ohne mich bricht alles.“</div></div>",
          "0 = dengeli. 6 = her şey sana bağlı.<div class='dx-example'><div class='ex'>“Ben yokken her şey çöker.”</div></div>",
          "0 = manageable. 6 = everything depends on you.<div class='dx-example'><div class='ex'>“Without me it breaks.”</div></div>"
        );

      $("#exDecisions").innerHTML = business
        ? t(lang,
          "0 = klar & schnell. 6 = unklar, langsam, politisch.<div class='dx-example'><div class='ex'>„Keiner weiß wer entscheidet.“</div></div>",
          "0 = net & hızlı. 6 = belirsiz, yavaş, politik.<div class='dx-example'><div class='ex'>“Kim karar verir belli değil.”</div></div>",
          "0 = clear & fast. 6 = unclear, slow, political.<div class='dx-example'><div class='ex'>“No one knows who decides.”</div></div>"
        )
        : t(lang,
          "0 = klar umsetzen. 6 = Chaos/Endlosschleife.<div class='dx-example'><div class='ex'>„Wir drehen uns im Kreis.“</div></div>",
          "0 = net uygulama. 6 = kaos/kısır döngü.<div class='dx-example'><div class='ex'>“Kısır döngü.”</div></div>",
          "0 = execute clearly. 6 = chaos/loop.<div class='dx-example'><div class='ex'>“We go in circles.”</div></div>"
        );

      $("#exEnergy").innerHTML = business
        ? t(lang,
          "0 = Rhythmus ok. 6 = Überlastung, Fehler eskalieren.<div class='dx-example'><div class='ex'>„Keine Regeneration.“</div></div>",
          "0 = ritim iyi. 6 = aşırı yük, hatalar büyür.<div class='dx-example'><div class='ex'>“Toparlanma yok.”</div></div>",
          "0 = rhythm ok. 6 = overload, errors escalate.<div class='dx-example'><div class='ex'>“No recovery.”</div></div>"
        )
        : t(lang,
          "0 = Energie ok. 6 = Limit, Fehler häufen sich.<div class='dx-example'><div class='ex'>„Ich wiederhole Fehler.“</div></div>",
          "0 = enerji var. 6 = limit, hata artıyor.<div class='dx-example'><div class='ex'>“Aynı hata.”</div></div>",
          "0 = energy ok. 6 = at the limit, errors pile up.<div class='dx-example'><div class='ex'>“Repeating mistakes.”</div></div>"
        );

      $("#exGrowth").innerHTML = business
        ? t(lang,
          "0 = kontrolliert. 6 = Komplexität > Struktur.<div class='dx-example'><div class='ex'>„Koordination frisst Output.“</div></div>",
          "0 = kontrollü. 6 = karmaşıklık > yapı.<div class='dx-example'><div class='ex'>“Koordinasyon çıktıyı yiyor.”</div></div>",
          "0 = controlled. 6 = complexity > structure.<div class='dx-example'><div class='ex'>“Coordination eats output.”</div></div>"
        )
        : t(lang,
          "0 = übersichtlich. 6 = zu viele Themen.<div class='dx-example'><div class='ex'>„Alles ist gleichzeitig wichtig.“</div></div>",
          "0 = net. 6 = çok konu.<div class='dx-example'><div class='ex'>“Her şey acil.”</div></div>",
          "0 = clear. 6 = too many topics.<div class='dx-example'><div class='ex'>“Everything is urgent.”</div></div>"
        );

      $("#exPower").innerHTML = business
        ? t(lang,
          "0 = aligned. 6 = Misalignment.<div class='dx-example'><div class='ex'>„KPI ohne Entscheidung.“</div></div>",
          "0 = uyumlu. 6 = kopuk.<div class='dx-example'><div class='ex'>“KPI var, yetki yok.”</div></div>",
          "0 = aligned. 6 = misalignment.<div class='dx-example'><div class='ex'>“KPI without authority.”</div></div>"
        )
        : t(lang,
          "0 = Einfluss = Konsequenz. 6 = du trägst ohne Einfluss.<div class='dx-example'><div class='ex'>„Ich muss liefern, andere blockieren.“</div></div>",
          "0 = etki = sonuç. 6 = etki yokken sonuç.<div class='dx-example'><div class='ex'>“Teslim bende, engel başkası.”</div></div>",
          "0 = influence = consequence. 6 = you bear without influence.<div class='dx-example'><div class='ex'>“I must deliver, others block.”</div></div>"
        );

      $("#execHint").textContent = business
        ? t(lang,
          "Business: Diagnose + Operating Model + Rollen + Rhythmus + KPIs + 30-60-90.",
          "Business: teşhis + işletim modeli + roller + ritim + KPI + 30-60-90.",
          "Business: diagnosis + operating model + roles + cadence + KPIs + 30-60-90."
        )
        : t(lang,
          "Privat: Ursachenlogik, klare Prioritäten, konkrete Moves.",
          "Özel: neden mantığı, net öncelikler, somut adımlar.",
          "Private: causal logic, clear priorities, concrete moves."
        );
    }

    function escapeHtml(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    
    const API_BASE = "https://api.mdg-indikation.de";
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    const ls = window.localStorage;
    const ss = window.sessionStorage;

    /* ===========================
       MODE & TOKEN STATE
    ============================ */

    const params = new URLSearchParams(location.search);
    const modeParam = (params.get("mode") || "").toLowerCase();
    const storedMode = ((ss.getItem("mdg_mode") || ls.getItem("mdg_mode") || "")).toLowerCase();
    const businessOk = (ss.getItem("mdg_business_ok") === "1") || (ls.getItem("mdg_business_ok") === "1");
    const tokenStored = (ss.getItem("mdg_business_token") || ls.getItem("mdg_business_token") || "").trim();

    const wantsBusiness = (modeParam === "business") || (storedMode === "business");
    const mode = (wantsBusiness && businessOk) ? "business" : "private";

    $("#modeBadge").textContent = (mode === "business") ? "Business" : "Private";
    if (mode === "business") $("#tokenBadge").style.display = "";

    /* ===========================
       SLIDER LIVE VALUES
    ============================ */

    const sliders = ["Load","Decisions","Energy","Growth","Power"];
    sliders.forEach(key => {
      const s = $("#s" + key);
      const v = $("#v" + key);
      if (!s || !v) return;
      v.textContent = s.value;
      s.addEventListener("input", () => v.textContent = s.value);
    });

    /* ===========================
       RUN ASSESSMENT
    ============================ */

    $("#runBtn").addEventListener("click", async () => {
      $("#statusLine").textContent = "…";
      $("#resultText").textContent = "…";
      $("#kpiPrimary").textContent = "—";
      $("#kpiPath").textContent = "—";
      $("#kpiRisk").textContent = "—";
      $("#treeContainer").style.display = "none";
      $("#reportContainer").style.display = "none";
      $("#feedbackBox").style.display = "none";

      const payload = {
        mode,
        token: tokenStored || undefined,
        problem: $("#oneLiner").value.trim(),
        intent: $("#goalSelect").value,
        lang: document.documentElement.lang || "de",
        quick_scan: {
          load: Number($("#sLoad").value),
          decisions: Number($("#sDecisions").value),
          energy: Number($("#sEnergy").value),
          growth: Number($("#sGrowth").value),
          power: Number($("#sPower").value)
        }
      };

      try {
        const res = await fetch(API_BASE + "/api/assess", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("Assessment failed");

        const data = await res.json();

        $("#resultText").textContent = data.assessment_text || "—";
        $("#kpiPrimary").textContent = data.primary || "—";
        $("#kpiPath").textContent = data.path || "—";
        $("#kpiRisk").textContent = data.risk || "—";

        window.__lastAssessment = data;
        $("#statusLine").textContent = "✓";

      } catch (err) {
        $("#statusLine").textContent = "Error";
        $("#resultText").textContent = "Server error.";
      }
    });

    /* ===========================
       EXECUTIVE REPORT
    ============================ */

    $("#execBtn").addEventListener("click", async () => {
      if (!window.__lastAssessment) return;

      $("#execText").textContent = "…";
      $("#reportContainer").style.display = "block";
      $("#treeContainer").style.display = "none";
      $("#feedbackBox").style.display = "none";

      try {
        const res = await fetch(API_BASE + "/api/report", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            mode,
            token: tokenStored || undefined,
            lang: document.documentElement.lang || "de",
            problem: $("#oneLiner").value.trim(),
            intent: $("#goalSelect").value,
            answers: window.__lastAssessment
          })
        });

        if (!res.ok) throw new Error("Report failed");

        const data = await res.json();
        $("#execText").textContent = data.report_markdown || "";
        $("#copyExecBtn").disabled = false;

        window.__lastReport = data.report_markdown || "";

        $("#feedbackBox").style.display = "block";

      } catch (err) {
        $("#execText").textContent = "Server error.";
      }
    });

    /* ===========================
       COPY
    ============================ */

    $("#copyExecBtn").addEventListener("click", async () => {
      if (!window.__lastReport) return;
      await navigator.clipboard.writeText(window.__lastReport);
    });

    /* ===========================
       SVG TREE
    ============================ */

    $("#svgBtn").addEventListener("click", async () => {
      if (!window.__lastAssessment) return;

      const res = await fetch(API_BASE + "/api/tree", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          mode,
          token: tokenStored || undefined,
          lang: document.documentElement.lang || "de",
          assessment: window.__lastAssessment
        })
      });

      if (!res.ok) return;

      const data = await res.json();
      $("#treeSvgWrap").innerHTML = data.tree_svg || "";
      $("#treeContainer").style.display = "block";
    });

    /* ===========================
       PDF
    ============================ */

    $("#pdfBtn").addEventListener("click", async () => {
      if (!window.__lastReport) return;

      const res = await fetch(API_BASE + "/api/pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          mode,
          token: tokenStored || undefined,
          report_markdown: window.__lastReport
        })
      });

      if (!res.ok) return;

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "mdg-report.pdf";
      a.click();
      URL.revokeObjectURL(url);
    });

    /* ===========================
       FEEDBACK
    ============================ */

    let rating = 0;

    $$("#fbStars .dx-star").forEach(btn => {
      btn.addEventListener("click", () => {
        rating = Number(btn.dataset.v);
        $$("#fbStars .dx-star").forEach(b =>
          b.setAttribute("aria-pressed", b.dataset.v == rating ? "true" : "false")
        );
        $("#fbVal").textContent = rating + "/5";
        $("#fbSendBtn").disabled = false;
      });
    });

    $("#fbSendBtn").addEventListener("click", async () => {
      const text = $("#fbText").value.trim();

      const res = await fetch(API_BASE + "/api/feedback", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          rating,
          text,
          page: "diagnose",
          mode,
          lang: document.documentElement.lang || "de"
        })
      });

      if (res.ok) {
        $("#fbStatus").textContent = "✓";
        $("#fbSendBtn").disabled = true;
      } else {
        $("#fbStatus").textContent = "Error";
      }
    });

  })();
  </script>
</body>
</html>
