<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagnose – MDG</title>
  <meta name="description" content="In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen." />
  <link rel="stylesheet" href="./style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,400;0,500;1,400&family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <style>

    /* ─── Font override ─── */
    :root {
      --font-body: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'DM Mono', 'Fira Code', ui-monospace, monospace;
      --glow-green: rgba(110,231,183,.15);
      --glow-blue:  rgba(96,165,250,.12);
      --r: 18px;
    }
    body { font-family: var(--font-body); }

    /* ─── Page shell ─── */
    .dx-page {
      max-width: 1160px;
      margin: 0 auto;
      padding: 1.75rem 1.25rem 4rem;
    }

    /* ─── Hero bar ─── */
    .dx-hero {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      padding-bottom: 1.25rem;
      border-bottom: 1px solid var(--stroke);
      margin-bottom: 1.5rem;
    }
    .dx-hero h1 { margin: 0 0 .3rem; }
    .dx-hero .sub { margin: 0; max-width: 580px; }
    .dx-kpi {
      display: flex;
      gap: .4rem;
      flex-wrap: wrap;
      align-self: flex-end;
    }
    .dx-kpi .pill {
      font-family: var(--font-mono);
      font-size: .75rem;
      white-space: nowrap;
      transition: border-color .2s, color .2s;
    }
    .dx-kpi .pill.active {
      border-color: rgba(110,231,183,.45);
      color: #a7f3d0;
    }

    /* ─── Two-column layout ─── */
    .dx-grid {
      display: grid;
      grid-template-columns: minmax(0,1.15fr) minmax(360px,.85fr);
      gap: 1.25rem;
      align-items: start;
    }
    @media (max-width: 980px) { .dx-grid { grid-template-columns: 1fr; } }

    /* ─── Section headers inside card ─── */
    .dx-shead {
      display: flex;
      align-items: center;
      gap: .55rem;
      margin: 0 0 .85rem;
    }
    .dx-snum {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.65rem;
      height: 1.65rem;
      border-radius: 999px;
      border: 1px solid rgba(110,231,183,.25);
      background: rgba(110,231,183,.08);
      font-weight: 900;
      font-size: .72rem;
      color: var(--primary);
      flex-shrink: 0;
    }
    .dx-snum.blue {
      border-color: rgba(96,165,250,.22);
      background: rgba(96,165,250,.08);
      color: #93c5fd;
    }
    .dx-stitle { font-weight: 800; font-size: .95rem; margin: 0; }

    /* ─── Field helpers ─── */
    .dx-fields { display: grid; gap: .85rem; }
    .dx-field  { display: grid; gap: .3rem; }
    .dx-flabel {
      font-size: .76rem;
      font-weight: 900;
      letter-spacing: .07em;
      text-transform: uppercase;
      color: var(--muted-2);
    }
    .dx-fhelp   { font-size: .86rem; color: var(--muted); line-height: 1.4; }
    .dx-fhelp b { color: var(--text); }
    .dx-divider { height: 1px; background: var(--stroke); margin: .2rem 0; }

    /* ─── Mode tag ─── */
    .dx-modeline { display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; }
    .dx-modetag {
      font-weight: 900;
      font-size: .82rem;
      padding: .2rem .65rem;
      border-radius: 999px;
      border: 1px solid rgba(110,231,183,.28);
      background: rgba(110,231,183,.07);
      color: #a7f3d0;
    }

    /* ─── Range sliders ─── */
    .dx-range-row { display: grid; grid-template-columns: 1fr auto; gap: .65rem; align-items: center; }
    .dx-range-val {
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: .95rem;
      min-width: 1.4rem;
      text-align: right;
      color: var(--primary);
    }
    input[type="range"].dx-range {
      -webkit-appearance: none;
      width: 100%;
      height: 4px;
      border-radius: 999px;
      background: var(--bg-2);
      outline: none;
      cursor: pointer;
    }
    input[type="range"].dx-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px; height: 18px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      box-shadow: 0 0 0 4px var(--glow-green);
      transition: box-shadow .15s;
    }
    input[type="range"].dx-range::-webkit-slider-thumb:hover {
      box-shadow: 0 0 0 7px var(--glow-green);
    }
    input[type="range"].dx-range::-moz-range-thumb {
      width: 18px; height: 18px;
      border-radius: 50%;
      background: var(--primary);
      border: none;
      cursor: pointer;
    }

    /* ─── Adaptive questions ─── */
    .dx-qs    { display: grid; gap: .85rem; }
    .dx-q     { padding-top: .85rem; border-top: 1px solid rgba(255,255,255,.06); }
    .dx-q:first-child { border-top: 0; padding-top: 0; }
    .dx-qtitle { font-weight: 800; font-size: .88rem; line-height: 1.35; margin-bottom: .4rem; }
    .dx-opts   { display: flex; gap: .4rem; flex-wrap: wrap; }
    .dx-opt {
      display: flex;
      align-items: center;
      gap: .35rem;
      padding: .3rem .7rem;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.025);
      font-size: .79rem;
      font-weight: 600;
      cursor: pointer;
      transition: border-color .15s, background .15s;
    }
    .dx-opt:hover {
      border-color: rgba(110,231,183,.38);
      background: rgba(110,231,183,.06);
    }
    .dx-opt input[type="radio"] {
      accent-color: var(--primary);
      width: 12px; height: 12px;
    }

    /* ─── Action row ─── */
    .dx-actions { display: flex; gap: .55rem; flex-wrap: wrap; align-items: center; }

    /* ─── Status ─── */
    #statusLine {
      font-family: var(--font-mono);
      font-size: .78rem;
      color: var(--muted-2);
      transition: color .2s;
    }
    #statusLine.running { color: var(--warning); }
    #statusLine.done    { color: var(--primary); }
    #statusLine.err     { color: var(--danger); }

    /* ─── Output column ─── */
    .dx-out { min-width: 0; }

    .dx-rbox {
      padding: 1.15rem;
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      background: rgba(255,255,255,.025);
      transition: border-color .2s;
    }
    .dx-rbox + .dx-rbox { margin-top: 1rem; }
    .dx-rbox:focus-within { border-color: rgba(110,231,183,.22); }
    .dx-rbox h3 { margin: 0 0 .55rem; font-size: .95rem; }
    .dx-rbox pre {
      font-family: var(--font-mono);
      font-size: .78rem;
      white-space: pre-wrap;
      word-break: break-word;
      overflow: auto;
      max-height: 42vh;
      color: var(--muted);
      margin: 0;
      line-height: 1.65;
    }
    .dx-rnote { font-size: .86rem; color: var(--muted); margin: 0 0 .65rem; line-height: 1.4; }

    /* slide-in for report area */
    #reportContainer { animation: dxSlide .22s ease; }
    @keyframes dxSlide {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ─── Feedback box ─── */
    #feedbackBox {
      margin-top: 1rem;
      padding: 1rem 1.1rem 1.1rem;
      border-radius: var(--r);
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      animation: dxSlide .2s ease;
    }
    .dx-fb-head {
      font-size: .72rem;
      font-weight: 900;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--muted-2);
      margin-bottom: .75rem;
    }
    .dx-fb-rows   { display: grid; gap: .6rem; }
    .dx-fb-row    { display: grid; gap: .25rem; }
    .dx-fb-label  { font-weight: 700; font-size: .8rem; color: var(--muted); }
    .dx-fb-hint   { font-size: .73rem; color: var(--muted-2); }
    .dx-fb-inline { display: flex; gap: .55rem; flex-wrap: wrap; align-items: center; }
    .dx-fb-foot   { display: flex; align-items: center; gap: .7rem; margin-top: .4rem; }
    .dx-fb-status { font-family: var(--font-mono); font-size: .78rem; color: var(--muted-2); }

    /* shared textarea / number input inside feedback */
    .dx-fb-rows textarea,
    .dx-fb-rows input[type="number"] {
      width: 100%;
      padding: .58rem .72rem;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: var(--bg-2);
      color: var(--text);
      font-family: var(--font-body);
      font-size: .84rem;
      resize: vertical;
      box-sizing: border-box;
      outline: none;
      transition: border-color .15s, box-shadow .15s;
    }
    .dx-fb-rows textarea:focus,
    .dx-fb-rows input[type="number"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--glow-green);
    }
    .dx-fb-rows input[type="number"] { max-width: 100px; resize: none; }

    /* ─── Privacy note ─── */
    .dx-privacy {
      font-size: .76rem;
      color: var(--muted-2);
      margin-top: 1rem;
      line-height: 1.45;
    }

    /* ─── Copy button: success state ─── */
    .btn--ok {
      background: rgba(110,231,183,.12) !important;
      border-color: rgba(110,231,183,.4) !important;
      color: #a7f3d0 !important;
    }

    /* ─── Header cleanup (inherited from style.css; keep nav__link active) ─── */
    .brand__text   { display: none !important; }
    .drawer[hidden]{ display: none !important; }

    /* ─── select + input consistent focus ring ─── */
    .dx-input:focus, select.dx-input:focus {
      border-color: var(--primary) !important;
      box-shadow: 0 0 0 3px var(--glow-green) !important;
    }

  </style>
</head>
<body>

<!-- ══════════════════════════════════════════
     HEADER
══════════════════════════════════════════ -->
<header class="header" id="top">
  <div class="container header__inner">
    <a class="brand" href="./index.html" aria-label="Home">
      <span class="brand__mark" aria-hidden="true">MDG</span>
      <span class="brand__text">v4</span>
    </a>

    <nav class="nav" aria-label="Main">
      <a class="nav__link" href="./how.html" data-i18n="nav.how">Wie es funktioniert</a>
      <a class="nav__link" href="./why.html" data-i18n="nav.why">Warum MDG</a>
      <a class="nav__link" href="./faq.html" data-i18n="nav.faq">FAQ</a>
    </nav>

    <div class="header__actions">
      <div class="lang" role="group" aria-label="Language">
        <button class="chip chip--ghost" type="button" data-lang="de" aria-pressed="true">DE</button>
        <button class="chip chip--ghost" type="button" data-lang="tr" aria-pressed="false">TR</button>
        <button class="chip chip--ghost" type="button" data-lang="en" aria-pressed="false">EN</button>
      </div>
      <a class="btn btn--ghost" href="./index.html" data-i18n="cta.backHome">Zur Homepage</a>
    </div>

    <button class="burger" type="button" aria-label="Menu" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
  </div>

  <div class="drawer" hidden>
    <div class="drawer__content">
      <a class="drawer__link" href="./how.html"  data-i18n="nav.how">Wie es funktioniert</a>
      <a class="drawer__link" href="./why.html"  data-i18n="nav.why">Warum MDG</a>
      <a class="drawer__link" href="./faq.html"  data-i18n="nav.faq">FAQ</a>
      <div class="drawer__sep"></div>
      <a class="btn btn--ghost btn--full" href="./index.html" data-i18n="cta.backHome">Zur Homepage</a>
    </div>
  </div>
</header>

<!-- ══════════════════════════════════════════
     MAIN
══════════════════════════════════════════ -->
<main id="main">
<div class="dx-page">

  <!-- Hero -->
  <div class="dx-hero">
    <div>
      <h1 class="h2" data-i18n="dx.title">Diagnose</h1>
      <p class="sub" data-i18n="dx.sub">
        In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen.
      </p>
    </div>
    <div class="dx-kpi">
      <span class="pill pill--muted" id="kpiPrimary">Primär: —</span>
      <span class="pill pill--muted" id="kpiPath">Pfad: —</span>
      <span class="pill pill--muted" id="kpiRisk">Risiko: —</span>
    </div>
  </div>

  <!-- Two-column -->
  <div class="dx-grid">

    <!-- ══ LEFT: INPUT ══ -->
    <div class="card">

      <!-- 1) Kontext -->
      <div class="dx-shead">
        <span class="dx-snum">1</span>
        <h2 class="dx-stitle" data-i18n="dx.s1">Kontext</h2>
      </div>

      <div class="dx-fields">

        <!-- Mode -->
        <div class="dx-field">
          <div class="dx-flabel" data-i18n="dx.mode">Modus</div>
          <div class="dx-modeline">
            <span class="dx-modetag" id="modeText">—</span>
            <span class="pill pill--muted" id="tokenBadge" style="display:none; font-size:.72rem;">Token ✓</span>
          </div>
          <div class="dx-fhelp" id="modeHint"></div>
        </div>

        <!-- Goal -->
        <div class="dx-field">
          <label class="dx-flabel" for="goalSelect" data-i18n="dx.goal">Ziel</label>
          <select class="dx-input" id="goalSelect">
            <option value="stabilize" data-i18n="dx.goal.stabilize">Stabilisieren</option>
            <option value="rebuild"   data-i18n="dx.goal.rebuild">Umbauen</option>
          </select>
          <div class="dx-fhelp" id="goalHelp"></div>
        </div>

        <!-- One-liner -->
        <div class="dx-field">
          <label class="dx-flabel" for="oneLiner" data-i18n="dx.oneliner">Situation in einem Satz</label>
          <input class="dx-input" id="oneLiner" type="text" maxlength="160" placeholder="…" autocomplete="off" />
          <div class="dx-fhelp" id="oneLinerHelp"></div>
        </div>

        <div class="dx-divider"></div>

        <!-- 2) Quick Scan -->
        <div class="dx-shead" style="margin-bottom:.6rem;">
          <span class="dx-snum">2</span>
          <h2 class="dx-stitle" data-i18n="dx.s2">Quick Scan</h2>
        </div>

        <!-- Slider: Load -->
        <div class="dx-field">
          <div class="dx-flabel" data-i18n="q.load.title">Last &amp; Engpässe</div>
          <div class="dx-fhelp" id="exLoad"></div>
          <div class="dx-range-row">
            <input id="sLoad" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
            <div class="dx-range-val" id="vLoad">2</div>
          </div>
        </div>

        <!-- Slider: Decisions -->
        <div class="dx-field">
          <div class="dx-flabel" data-i18n="q.decisions.title">Entscheidungsarchitektur</div>
          <div class="dx-fhelp" id="exDecisions"></div>
          <div class="dx-range-row">
            <input id="sDecisions" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
            <div class="dx-range-val" id="vDecisions">2</div>
          </div>
        </div>

        <!-- Slider: Energy -->
        <div class="dx-field">
          <div class="dx-flabel" data-i18n="q.energy.title">Energie &amp; Fehlerkultur</div>
          <div class="dx-fhelp" id="exEnergy"></div>
          <div class="dx-range-row">
            <input id="sEnergy" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
            <div class="dx-range-val" id="vEnergy">2</div>
          </div>
        </div>

        <!-- Slider: Growth -->
        <div class="dx-field">
          <div class="dx-flabel" data-i18n="q.growth.title">Wachstumsdruck / Komplexität</div>
          <div class="dx-fhelp" id="exGrowth"></div>
          <div class="dx-range-row">
            <input id="sGrowth" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
            <div class="dx-range-val" id="vGrowth">2</div>
          </div>
        </div>

        <!-- Slider: Power -->
        <div class="dx-field">
          <div class="dx-flabel" data-i18n="q.power.title">Macht–Verantwortung</div>
          <div class="dx-fhelp" id="exPower"></div>
          <div class="dx-range-row">
            <input id="sPower" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
            <div class="dx-range-val" id="vPower">2</div>
          </div>
        </div>

        <div class="dx-divider"></div>

        <!-- 3) Precision questions -->
        <div class="dx-shead" style="margin-bottom:.5rem;">
          <span class="dx-snum">3</span>
          <h2 class="dx-stitle" data-i18n="dx.s3">Präzisionsfragen</h2>
        </div>
        <div class="dx-qs" id="questions"></div>

        <!-- CTA row -->
        <div class="dx-actions" style="margin-top: .8rem;">
          <button class="btn btn--primary" type="button" id="runBtn"   data-i18n="dx.run">Diagnose starten</button>
          <button class="btn btn--ghost"   type="button" id="resetBtn" data-i18n="dx.reset">Zurücksetzen</button>
          <span id="statusLine" class="micro">—</span>
        </div>

      </div>
    </div><!-- /card left -->

    <!-- ══ RIGHT: OUTPUT ══ -->
    <div class="card dx-out">

      <div class="dx-shead" style="margin-bottom:.9rem;">
        <span class="dx-snum blue">↗</span>
        <h2 class="dx-stitle" data-i18n="dx.outTitle">Output</h2>
      </div>

      <!-- Strategic Assessment -->
      <div class="dx-rbox">
        <h3 data-i18n="dx.assessTitle">Strategisches Assessment</h3>
        <pre id="resultText">—</pre>
      </div>

      <!-- Executive Report -->
      <div class="dx-rbox">
        <h3 data-i18n="dx.execTitle">Executive Report</h3>
        <p class="dx-rnote" id="execHint"></p>

        <div class="dx-actions">
          <button class="btn btn--primary" type="button" id="execBtn"     data-i18n="dx.execBtn">Report erzeugen</button>
          <button class="btn btn--ghost"   type="button" id="copyExecBtn" disabled data-i18n="dx.copy">Kopieren</button>
          <button class="btn btn--ghost"   type="button" id="pdfBtn"      data-i18n="dx.pdf">PDF</button>
        </div>

        <!-- Report text + feedback — shown after generation -->
        <div id="reportContainer" style="display:none;">
          <div class="dx-divider" style="margin:.9rem 0 .75rem;"></div>
          <pre id="execText">—</pre>

          <!-- ═══ UNIFIED FEEDBACK — single static instance, IDs: fbQ1/fbQ2/fbNps ═══ -->
          <div id="feedbackBox" style="display:none;">
            <div class="dx-fb-head" data-i18n="fb.head">Feedback</div>
            <div class="dx-fb-rows">

              <div class="dx-fb-row">
                <div class="dx-fb-label" data-i18n="fb.q1">1) Was war am hilfreichsten?</div>
                <textarea id="fbQ1" rows="2" maxlength="220" placeholder="…"></textarea>
              </div>

              <div class="dx-fb-row">
                <div class="dx-fb-label" data-i18n="fb.q2">2) Was fehlt / ist unklar?</div>
                <textarea id="fbQ2" rows="2" maxlength="220" placeholder="…"></textarea>
              </div>

              <div class="dx-fb-row">
                <div class="dx-fb-label" data-i18n="fb.q3">3) Bewertung (0–10)</div>
                <div class="dx-fb-inline">
                  <input id="fbNps" type="number" min="0" max="10" step="1" placeholder="8" />
                  <span class="dx-fb-hint" id="fbHint" data-i18n="fb.hint">0 = nicht hilfreich · 10 = extrem hilfreich</span>
                </div>
              </div>

              <div class="dx-fb-foot">
                <button class="btn btn--primary" type="button" id="fbSendBtn" disabled data-i18n="fb.send">Senden</button>
                <span class="dx-fb-status" id="fbStatus">—</span>
              </div>

            </div>
          </div><!-- /feedbackBox -->

        </div><!-- /reportContainer -->
      </div><!-- /dx-rbox exec -->

      <p class="dx-privacy" data-i18n="dx.privacy">
        Inputs werden via API ausschließlich zur Generierung von Assessment und Report verarbeitet.
      </p>

    </div><!-- /card right -->

  </div><!-- /dx-grid -->
</div><!-- /dx-page -->
</main>

<!-- ══════════════════════════════════════════
     FOOTER
══════════════════════════════════════════ -->
<footer class="footer">
  <div class="container footer__grid">
    <div>
      <div class="brand brand--footer">
        <span class="brand__mark" aria-hidden="true">MDG</span>
        <span class="brand__text">v4</span>
      </div>
      <p class="micro" data-i18n="footer.tag">Strukturdiagnose für Stabilisierung und Umbau.</p>
    </div>
    <div class="footer__legal">
      <a href="./impressum.html"   rel="nofollow">Impressum</a>
      <a href="./datenschutz.html" rel="nofollow">Datenschutz</a>
      <a href="./kontakt.html"     rel="nofollow">Kontakt</a>
    </div>
  </div>
</footer>

<!-- ══════════════════════════════════════════
     SCRIPT  — clean, single IIFE, no duplication
══════════════════════════════════════════ -->
<script>
(() => {
  "use strict";

  /* ── helpers ─────────────────────────────── */
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => [...r.querySelectorAll(s)];
  const API = "https://api.mdg-indikation.de";

  /* ── mobile drawer ───────────────────────── */
  const burger = $(".burger"), drawer = $(".drawer");
  if (burger && drawer) {
    const open  = () => { drawer.hidden = false; burger.setAttribute("aria-expanded","true");  document.body.classList.add("no-scroll"); };
    const close = () => { drawer.hidden = true;  burger.setAttribute("aria-expanded","false"); document.body.classList.remove("no-scroll"); };
    burger.addEventListener("click", () => drawer.hidden ? open() : close());
    drawer.addEventListener("click", e => { if (!$(".drawer__content",drawer).contains(e.target)) close(); });
    window.addEventListener("keydown", e => { if (e.key==="Escape") close(); });
  }

  /* ── mode detection ──────────────────────── */
  const params = new URLSearchParams(location.search);
  const ss = sessionStorage, ls = localStorage;

  const modeParam   = (params.get("mode") || "").toLowerCase();
  const storedMode  = (ss.getItem("mdg_mode") || ls.getItem("mdg_mode") || "").toLowerCase();
  const businessOk  = ss.getItem("mdg_business_ok")==="1" || ls.getItem("mdg_business_ok")==="1";
  const tokenStored = (ss.getItem("mdg_business_token") || ls.getItem("mdg_business_token") || ls.getItem("mdg_token") || "").trim();

  const wantBiz = modeParam==="business" || storedMode==="business";
  const mode    = wantBiz && businessOk ? "business" : "private";

  $("#modeText").textContent = mode==="business" ? "Business" : "Privat";
  if (mode==="business") $("#tokenBadge").style.display = "";

  /* ── i18n dictionary ─────────────────────── */
  const dict = {
    de: {
      "nav.how":"Wie es funktioniert","nav.why":"Warum MDG","nav.faq":"FAQ","cta.backHome":"Zur Homepage",
      "dx.title":"Diagnose",
      "dx.sub":"In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen.",
      "dx.s1":"Kontext","dx.s2":"Quick Scan","dx.s3":"Präzisionsfragen",
      "dx.mode":"Modus","dx.goal":"Ziel","dx.goal.stabilize":"Stabilisieren","dx.goal.rebuild":"Umbauen",
      "dx.oneliner":"Situation in einem Satz",
      "q.load.title":"Last & Engpässe","q.decisions.title":"Entscheidungsarchitektur",
      "q.energy.title":"Energie & Fehlerkultur","q.growth.title":"Wachstumsdruck / Komplexität",
      "q.power.title":"Macht–Verantwortung",
      "dx.run":"Diagnose starten","dx.reset":"Zurücksetzen",
      "dx.outTitle":"Output","dx.assessTitle":"Strategisches Assessment",
      "dx.execTitle":"Executive Report","dx.execBtn":"Report erzeugen","dx.copy":"Kopieren","dx.pdf":"PDF",
      "dx.privacy":"Inputs werden via API ausschließlich zur Generierung von Assessment und Report verarbeitet.",
      "footer.tag":"Strukturdiagnose für Stabilisierung und Umbau.",
      "kpi.primary":"Primär","kpi.path":"Pfad","kpi.risk":"Risiko",
      "fb.head":"Feedback","fb.q1":"1) Was war am hilfreichsten?","fb.q2":"2) Was fehlt / ist unklar?",
      "fb.q3":"3) Bewertung (0–10)","fb.hint":"0 = nicht hilfreich · 10 = extrem hilfreich","fb.send":"Senden"
    },
    tr: {
      "nav.how":"Nasıl çalışır","nav.why":"Neden MDG","nav.faq":"SSS","cta.backHome":"Anasayfa",
      "dx.title":"Analiz",
      "dx.sub":"Birkaç dakika içinde karar güveni: istikrarsızlığı erken gör, nedeni doğru teşhis et, mimari kur.",
      "dx.s1":"Bağlam","dx.s2":"Hızlı tarama","dx.s3":"Kesinleştirme soruları",
      "dx.mode":"Mod","dx.goal":"Hedef","dx.goal.stabilize":"Stabilize et","dx.goal.rebuild":"Yeniden kur",
      "dx.oneliner":"Durumu tek cümleyle anlat",
      "q.load.title":"Yük & darboğazlar","q.decisions.title":"Karar mimarisi",
      "q.energy.title":"Enerji & hata kültürü","q.growth.title":"Büyüme baskısı / karmaşıklık",
      "q.power.title":"Güç–sorumluluk uyumu",
      "dx.run":"Başlat","dx.reset":"Sıfırla",
      "dx.outTitle":"Çıktı","dx.assessTitle":"Stratejik değerlendirme",
      "dx.execTitle":"Yönetici raporu","dx.execBtn":"Rapor üret","dx.copy":"Kopyala","dx.pdf":"PDF",
      "dx.privacy":"Veriler yalnızca rapor üretimi için API üzerinden işlenir.",
      "footer.tag":"Stabilizasyon ve yeniden kurulum için yapı teşhisi.",
      "kpi.primary":"Ana","kpi.path":"Yol","kpi.risk":"Risk",
      "fb.head":"Geri bildirim","fb.q1":"1) En faydalı kısım neydi?","fb.q2":"2) Ne eksik / belirsiz?",
      "fb.q3":"3) Puan (0–10)","fb.hint":"0 = faydasız · 10 = çok faydalı","fb.send":"Gönder"
    },
    en: {
      "nav.how":"How it works","nav.why":"Why MDG","nav.faq":"FAQ","cta.backHome":"Home",
      "dx.title":"Diagnosis",
      "dx.sub":"In a few minutes to decision-confidence: detect instability early, diagnose precisely, build architecture.",
      "dx.s1":"Context","dx.s2":"Quick Scan","dx.s3":"Precision Questions",
      "dx.mode":"Mode","dx.goal":"Goal","dx.goal.stabilize":"Stabilize","dx.goal.rebuild":"Rebuild",
      "dx.oneliner":"Describe the situation in one sentence",
      "q.load.title":"Load & bottlenecks","q.decisions.title":"Decision architecture",
      "q.energy.title":"Energy & error handling","q.growth.title":"Growth pressure / complexity",
      "q.power.title":"Power–responsibility alignment",
      "dx.run":"Run assessment","dx.reset":"Reset",
      "dx.outTitle":"Output","dx.assessTitle":"Strategic Assessment",
      "dx.execTitle":"Executive Report","dx.execBtn":"Generate Report","dx.copy":"Copy","dx.pdf":"PDF",
      "dx.privacy":"Inputs are processed via API only to generate the assessment and report.",
      "footer.tag":"Structure diagnosis for stabilization and rebuild.",
      "kpi.primary":"Primary","kpi.path":"Path","kpi.risk":"Risk",
      "fb.head":"Feedback","fb.q1":"1) What helped most?","fb.q2":"2) What's missing / unclear?",
      "fb.q3":"3) Score (0–10)","fb.hint":"0 = not helpful · 10 = extremely helpful","fb.send":"Send"
    }
  };

  /* ── i18n helpers ────────────────────────── */
  const getLang = () => {
    const pressed = $$("[data-lang]").find(b => b.getAttribute("aria-pressed")==="true");
    return pressed?.dataset.lang || ls.getItem("mdg_lang") || "de";
  };
  const T = (lang, de, tr, en) => lang==="tr" ? tr : lang==="en" ? en : de;
  const esc = s => String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

  /* ── apply language ──────────────────────── */
  function applyLang(lang) {
    if (!dict[lang]) lang = "de";
    ls.setItem("mdg_lang", lang);
    document.documentElement.lang = lang;
    $$("[data-lang]").forEach(b => b.setAttribute("aria-pressed", String(b.dataset.lang===lang)));
    $$("[data-i18n]").forEach(el => {
      const v = dict[lang][el.dataset.i18n];
      if (v !== undefined) el.textContent = v;
    });
    renderHelp(lang);
    renderQuestions(lang);
    if (!STATE.assessment) resetKpis(lang);
  }
  $$("[data-lang]").forEach(b => b.addEventListener("click", () => applyLang(b.dataset.lang)));

  /* ── help texts (mode-aware) ─────────────── */
  function renderHelp(lang) {
    const biz = mode==="business";

    // Mode hint
    $("#modeHint").textContent = (wantBiz && !businessOk)
      ? T(lang,
          "Business-Zugang nicht aktiv – bitte Token über die Landingpage bestätigen.",
          "Business erişimi aktif değil – lütfen token'ı ana sayfada doğrula.",
          "Business access inactive – please verify token on the landing page.")
      : biz
        ? T(lang,
            "Business: Fokus auf Unternehmen, Führung, Teams und Verantwortung.",
            "Business: şirket, liderlik, ekip ve sorumluluk odağı.",
            "Business: focus on companies, leadership, teams & accountability.")
        : T(lang,
            "Privat: Fokus auf persönliche Systeme, Beziehungen, Alltag und Belastung.",
            "Özel: kişisel sistemler, ilişkiler, günlük hayat ve yük odağı.",
            "Private: focus on personal systems, relationships, daily life & load.");

    // Goal help
    $("#goalHelp").innerHTML = T(lang,
      "<b>Stabilisieren</b> = Spannung senken. <b>Umbauen</b> = Architektur ändern.",
      "<b>Stabilize</b> = gerilimi düşür. <b>Yeniden kur</b> = mimariyi değiştir.",
      "<b>Stabilize</b> = reduce tension. <b>Rebuild</b> = change architecture.");

    // One-liner examples (mode-specific)
    $("#oneLinerHelp").innerHTML = biz
      ? T(lang,
          "Bsp 1: <b>&#8222;Entscheidungen dauern zu lange und hängen an einer Person.&quot;</b><br>Bsp 2: <b>&#8222;Team A und B blockieren sich, Qualität fällt.&quot;</b>",
          "Örn 1: <b>&quot;Kararlar çok uzun sürüyor ve bir kişiye bağlı.&quot;</b><br>Örn 2: <b>&quot;A ve B ekibi birbirini kilitliyor, kalite düşüyor.&quot;</b>",
          "Ex 1: <b>&quot;Decisions take too long and depend on one person.&quot;</b><br>Ex 2: <b>&quot;Team A and B block each other, quality drops.&quot;</b>")
      : T(lang,
          "Bsp 1: <b>&#8222;Ich prokrastiniere und verliere Kontrolle über meinen Alltag.&quot;</b><br>Bsp 2: <b>&#8222;Wir haben wiederkehrende Konflikte und nichts ändert sich.&quot;</b>",
          "Örn 1: <b>&quot;Erteleme yapıyorum ve günlük hayat kontrolüm kayıyor.&quot;</b><br>Örn 2: <b>&quot;Tekrarlayan çatışmalar var ve hiçbir şey değişmiyor.&quot;</b>",
          "Ex 1: <b>&quot;I procrastinate and lose control over my daily life.&quot;</b><br>Ex 2: <b>&quot;We have recurring conflicts and nothing changes.&quot;</b>");

    // Slider help — dynamic, updates live on slider move
    updateSliderHelp(lang);
    ["sLoad","sDecisions","sEnergy","sGrowth","sPower"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", () => updateSliderHelp(getLang()));
    });

    // Exec hint
    $("#execHint").textContent = biz
      ? T(lang,
          "Business: Diagnose + Operating Model + Rollen + Rhythmus + KPIs + 30-60-90.",
          "Business: teşhis + işletim modeli + roller + ritim + KPI + 30-60-90.",
          "Business: diagnosis + operating model + roles + cadence + KPIs + 30-60-90.")
      : T(lang,
          "Privat: Ursachenlogik, Spannungsdynamik, klare Prioritäten, konkrete Moves.",
          "Özel: neden mantığı, gerilim dinamiği, net öncelikler, somut adımlar.",
          "Private: causal logic, tension dynamics, clear priorities, concrete moves.");
  }

  /* ── slider help texts (dynamic, value-aware) ────────────── */
  function updateSliderHelp(lang) {
    const biz = mode === "business";

    // Each slider: array of 7 entries (values 0–6), each: { label, hint }
    // Label = scale anchor shown at all times
    // Hint  = contextual explanation shown below, specific to current value

    const sliders = {
      sLoad: {
        exId: "exLoad",
        label: T(lang,
          "0 = Last gleichmäßig verteilt · 6 = dauerhafter Engpass",
          "0 = yük dengeli dağılmış · 6 = kalıcı darboğaz",
          "0 = load distributed evenly · 6 = permanent bottleneck"),
        hints: biz ? [
          T(lang,"Alle Rollen tragen angemessen – kein Einzelner ist überlastet.","Tüm roller dengeli taşıyor – kimse aşırı yüklü değil.","All roles carry proportional load – no one is overloaded."),
          T(lang,"Leichte Ungleichgewichte spürbar, aber noch selbstregulierend.","Hafif dengesizlikler var ama sistem kendini düzeltiyor.","Minor imbalances, but the system self-corrects."),
          T(lang,"Einzelne Personen oder Teams übernehmen regelmäßig mehr als vorgesehen.","Bazı kişiler veya ekipler düzenli olarak fazla yük taşıyor.","Certain people or teams regularly carry more than they should."),
          T(lang,"Klare Überlastung einzelner Knoten – andere warten oder sind unterausgelastet.","Bazı düğümler açıkça aşırı yüklü – diğerleri bekliyor.","Clear overload at specific nodes – others waiting or underused."),
          T(lang,"Wichtige Personen arbeiten regelmäßig am Limit – Krankheit oder Kündigung wäre ein Systemausfall.","Kilit kişiler düzenli olarak sınırda çalışıyor – ayrılmaları krize yol açar.","Key people regularly at the limit – their departure would be a system failure."),
          T(lang,"Das System hängt an 1–2 Personen. Deren Ausfall würde Prozesse zum Stillstand bringen.","Sistem 1–2 kişiye bağlı. Ayrılmaları süreçleri durdurur.","The system depends on 1–2 people. Their departure would halt operations."),
          T(lang,"Totaler Stau: Engpässe blockieren alles andere. Sofortmaßnahme erforderlich.","Tam tıkanıklık: darboğazlar her şeyi engelliyor. Acil müdahale gerekli.","Total blockage: bottlenecks are stopping everything. Immediate action needed.")
        ] : [
          T(lang,"Du hast genug Energie und Kapazität für das, was auf dich wartet.","Seni bekleyenler için yeterli enerjin ve kapasitenin var.","You have enough energy and capacity for what's ahead."),
          T(lang,"Meistens gut – ab und zu wird es eng, aber du erholt dich schnell.","Çoğunlukla iyi – ara sıra zorlanıyorsun ama çabuk toparlanıyorsun.","Usually fine – occasionally tight, but you recover quickly."),
          T(lang,"Du merkst, dass einzelne Bereiche mehr Energie kosten als sie zurückgeben.","Bazı alanların verdiğinden fazla enerji aldığını fark ediyorsun.","You notice certain areas cost more energy than they return."),
          T(lang,"Mehrere Dinge laufen gleichzeitig – du schaffst alles, aber kaum noch mit Puffer.","Birçok şey aynı anda yürüyor – her şeyi yapıyorsun ama tampon kalmadı.","Multiple things running at once – you manage, but with almost no buffer."),
          T(lang,"Du funktionierst, aber du spürst: wenn noch etwas dazukommt, kippt es.","Çalışıyorsun ama bir şey daha eklense her şeyin dağılacağını hissediyorsun.","You're functioning, but one more thing and it tips over."),
          T(lang,"Du bist regelmäßig erschöpft – Erholung bringt kaum mehr echte Erholung.","Düzenli olarak tükeniyorsun – dinlenme artık gerçek bir toparlanma sağlamıyor.","You're regularly exhausted – rest barely brings real recovery anymore."),
          T(lang,"Kompletter Kapazitätsengpass: du kannst nicht mehr priorisieren, nur noch reagieren.","Tam kapasite tükenmesi: öncelik belirleyemiyorsun, sadece tepki veriyorsun.","Complete capacity collapse: you can't prioritize anymore, only react.")
        ]
      },
      sDecisions: {
        exId: "exDecisions",
        label: T(lang,
          "0 = Entscheidungen klar & schnell · 6 = unklar & blockiert",
          "0 = kararlar net & hızlı · 6 = belirsiz & bloke",
          "0 = decisions clear & fast · 6 = unclear & blocked"),
        hints: biz ? [
          T(lang,"Jeder weiß, wer was entscheidet – Entscheidungen kommen schnell und werden umgesetzt.","Herkes kimin ne kararı verdiğini biliyor – kararlar hızlı alınıp uygulanıyor.","Everyone knows who decides what – decisions come fast and get executed."),
          T(lang,"Meist klar, gelegentlich kurze Rückfragen – kein strukturelles Problem.","Çoğunlukla net, bazen kısa onay soruları – yapısal sorun yok.","Mostly clear, occasional quick check-ins – no structural problem."),
          T(lang,"Manche Entscheidungen brauchen unnötig viele Abstimmungsrunden.","Bazı kararlar gereksiz yere çok tur onay gerektiriyor.","Some decisions require unnecessarily many alignment rounds."),
          T(lang,"Entscheidungen werden oft nach oben eskaliert, obwohl es nicht nötig wäre.","Kararlar genellikle gereksiz yere yukarı taşınıyor.","Decisions are often escalated upward even when not necessary."),
          T(lang,"Entscheidungsverantwortung ist unklar – Aufgaben bleiben liegen oder werden mehrfach besprochen.","Karar sorumluluğu belirsiz – işler askıda kalıyor ya da defalarca tartışılıyor.","Decision ownership is unclear – tasks stall or get discussed repeatedly."),
          T(lang,"Entscheidungen passieren entweder gar nicht oder an einer einzigen Person.","Kararlar ya hiç alınmıyor ya da tek bir kişide birikmiş.","Decisions either don't happen or pile up at one single person."),
          T(lang,"Das System ist entscheidungsgelähmt – Unsicherheit, wer was darf, blockiert alles.","Sistem karar felci içinde – kimin ne yapabileceği belirsizliği her şeyi engelliyor.","The system is decision-paralyzed – uncertainty over who can do what blocks everything.")
        ] : [
          T(lang,"Du weißt klar, was du willst und wie du entscheidest – kein innerer Stillstand.","Ne istediğini ve nasıl karar vereceğini net biliyorsun – içsel bir duraksama yok.","You know clearly what you want and how you decide – no inner standstill."),
          T(lang,"Meistens entscheidungsfreudig – ab und zu zögerst du, aber nicht lange.","Çoğunlukla kararlısın – bazen tereddüt ediyorsun ama uzun sürmüyor.","Usually decisive – occasionally hesitant, but not for long."),
          T(lang,"Bei manchen Themen merkst du, dass du immer wieder abwägst, statt zu entscheiden.","Bazı konularda karar vermek yerine sürekli tartıyorsun.","On some topics you notice you keep weighing instead of deciding."),
          T(lang,"Entscheidungen kosten dich überproportional viel Energie – du zweifelst oft nach.","Kararlar sana orantısız enerji maliyeti çıkarıyor – sonradan çok sorguluyorsun.","Decisions cost you disproportionate energy – you often doubt them afterward."),
          T(lang,"Du verschiebst wichtige Entscheidungen regelmäßig – weil alle Optionen mit Verlust verbunden wirken.","Önemli kararları düzenli erteliyorsun – tüm seçenekler kayıpla bağlantılı görünüyor.","You regularly postpone important decisions – all options seem to involve loss."),
          T(lang,"Du steckst fest: du weißt nicht, was du wirklich willst oder wohin du gehst.","Sıkışmış hissediyorsun: ne istediğini ya da nereye gittiğini gerçekten bilmiyorsun.","You're stuck: you don't know what you really want or where you're going."),
          T(lang,"Komplette Entscheidungslähmung: Bewegung fühlt sich in jede Richtung falsch an.","Tam karar felci: her yönde hareket yanlış hissettiriyor.","Complete decision paralysis: movement feels wrong in every direction.")
        ]
      },
      sEnergy: {
        exId: "exEnergy",
        label: T(lang,
          "0 = Energie stabil, Fehler werden gelernt · 6 = Erschöpfung, Fehler werden versteckt",
          "0 = enerji dengeli, hatalardan ders alınıyor · 6 = tükenme, hatalar gizleniyor",
          "0 = energy stable, errors are learned from · 6 = exhaustion, errors are hidden"),
        hints: biz ? [
          T(lang,"Team hat Energie – Fehler werden offen besprochen und als Lernquelle genutzt.","Ekipte enerji var – hatalar açıkça konuşuluyor ve öğrenme kaynağı olarak kullanılıyor.","Team has energy – errors are openly discussed and used as learning."),
          T(lang,"Überwiegend gesunde Energie – Fehlerkultur vorhanden, wenn auch nicht explizit gelebt.","Ağırlıklı sağlıklı enerji – hata kültürü var, her ne kadar açıkça yaşatılmasa da.","Mostly healthy energy – error culture present, though not explicitly lived."),
          T(lang,"Erste Anzeichen von Erschöpfung bei Einzelnen – Fehler werden manchmal unter den Tisch gekehrt.","Bazı kişilerde ilk tükenmişlik belirtileri – hatalar zaman zaman örtbas ediliyor.","First signs of exhaustion in individuals – errors sometimes swept under the rug."),
          T(lang,"Deutliche Erschöpfungszeichen im Team – Fehler werden eher vermieden als analysiert.","Ekipte belirgin tükenmişlik belirtileri – hatalar analiz edilmek yerine önleniyor.","Clear exhaustion signs in the team – errors avoided rather than analyzed."),
          T(lang,"Hohe Erschöpfung, sinkende Initiative – Fehler werden systematisch versteckt aus Angst.","Yüksek tükenmişlik, azalan inisiyatif – hatalar korku nedeniyle sistematik gizleniyor.","High exhaustion, falling initiative – errors systematically hidden out of fear."),
          T(lang,"Burnout bei Schlüsselpersonen – Fehlerkultur nicht vorhanden, Schuldige werden gesucht.","Kilit kişilerde tükenmişlik – hata kültürü yok, suçlu aranıyor.","Burnout in key people – no error culture, blame-seeking instead."),
          T(lang,"Systemweite Erschöpfung – niemand zeigt Probleme, alle reagieren nur noch defensiv.","Sistem genelinde tükenmişlik – kimse sorunları göstermiyor, herkes savunmacı tepki veriyor.","System-wide exhaustion – nobody surfaces problems, everyone reacts defensively.")
        ] : [
          T(lang,"Du hast echte Energie für das, was dir wichtig ist – Rückschläge bringen dich nicht aus der Bahn.","Önemsediklerin için gerçek enerjin var – aksilikler seni raydan çıkarmıyor.","You have real energy for what matters to you – setbacks don't derail you."),
          T(lang,"Meistens stabil – gelegentliche Tiefs, aber du weißt, wie du dich erholst.","Çoğunlukla dengeli – ara sıra inişler var ama nasıl toparlanacağını biliyorsun.","Mostly stable – occasional lows, but you know how to recover."),
          T(lang,"Du merkst, dass Fehler oder Misserfolge länger nachwirken als früher.","Hataların veya başarısızlıkların eskisinden daha uzun süre etkisinde kaldığını fark ediyorsun.","You notice that errors or failures linger longer than they used to."),
          T(lang,"Fehler treffen dich hart – du analysierst sie kaum noch, du vermeidest sie lieber.","Hatalar seni derinden etkiliyor – artık analiz etmek yerine kaçınmayı tercih ediyorsun.","Errors hit you hard – you barely analyze them anymore, you'd rather avoid them."),
          T(lang,"Du hast kaum noch Energie für Neues – das Bestehende halten kostet alles.","Yeni şeyler için neredeyse enerjin kalmadı – olanı ayakta tutmak her şeyi tüketiyor.","You have barely any energy for new things – maintaining the existing takes everything."),
          T(lang,"Du funktionierst nach außen, aber innen bist du leer – Erschöpfung ist dein Normalzustand.","Dışarıdan işler görünüyorsun ama içten boşsun – tükenmişlik senin normal halin oldu.","You function outwardly, but inside you're empty – exhaustion has become your baseline."),
          T(lang,"Komplette innere Erschöpfung – Fehler oder Rückschläge können dich kaum noch bewegen.","Tam içsel tükenmişlik – hatalar veya geri adımlar artık seni neredeyse etkilemiyor.","Complete inner exhaustion – errors or setbacks can barely move you anymore.")
        ]
      },
      sGrowth: {
        exId: "exGrowth",
        label: T(lang,
          "0 = Wachstum kontrolliert · 6 = Komplexität übersteigt Struktur",
          "0 = büyüme kontrollü · 6 = karmaşıklık yapıyı aşıyor",
          "0 = growth controlled · 6 = complexity exceeds structure"),
        hints: biz ? [
          T(lang,"Wachstum und Strukturkomplexität sind synchron – das System skaliert gesund.","Büyüme ve yapısal karmaşıklık senkron – sistem sağlıklı ölçekleniyor.","Growth and structural complexity are in sync – the system scales healthily."),
          T(lang,"Leichte Spannung zwischen Wachstum und Prozessen – aber noch kontrollierbar.","Büyüme ve süreçler arasında hafif gerilim – ama hâlâ kontrol altında.","Slight tension between growth and processes – still manageable."),
          T(lang,"Bestehende Prozesse werden durch Wachstum regelmäßig überdehnt.","Mevcut süreçler büyüme tarafından düzenli olarak aşılıyor.","Existing processes are regularly overstretched by growth."),
          T(lang,"Das System wächst schneller als die Strukturen – Improvisation ersetzt Architektur.","Sistem yapılardan daha hızlı büyüyor – doğaçlama mimariyi ikame ediyor.","The system grows faster than structures – improvisation replaces architecture."),
          T(lang,"Komplexität ist unübersichtlich – niemand hat noch einen vollständigen Überblick.","Karmaşıklık artık anlaşılmaz – kimsenin tam bir genel görünümü kalmadı.","Complexity is opaque – nobody has a complete overview anymore."),
          T(lang,"Struktur ist de facto zusammengebrochen – nur noch informelle Netzwerke halten das System am Laufen.","Yapı fiilen çökmüş – sistemi sadece gayri resmi ağlar ayakta tutuyor.","Structure has de facto collapsed – only informal networks keep the system running."),
          T(lang,"Totales Kontrollverlust: Wachstum und Komplexität sind nicht mehr steuerbar.","Tam kontrol kaybı: büyüme ve karmaşıklık artık yönetilemez.","Total loss of control: growth and complexity are no longer manageable.")
        ] : [
          T(lang,"Dein Leben ist strukturiert und die Komplexität fühlt sich handhabbar an.","Hayatın yapılandırılmış ve karmaşıklık yönetilebilir hissettiriyor.","Your life is structured and the complexity feels manageable."),
          T(lang,"Gelegentlich wird es unübersichtlich, aber du findest deinen Weg wieder.","Ara sıra bulanıklaşıyor ama yolunu tekrar buluyorsun.","Occasionally things get unclear, but you find your way again."),
          T(lang,"Du merkst, dass immer mehr Rollen oder Erwartungen auf dich einwirken.","Üzerine giderek daha fazla rol ve beklenti yığıldığını fark ediyorsun.","You notice more and more roles or expectations landing on you."),
          T(lang,"Das Leben fühlt sich zu komplex an – du verlierst den Überblick über Prioritäten.","Hayat çok karmaşık hissettiriyor – önceliklerin üzerindeki kontrolü kaybediyorsun.","Life feels too complex – you're losing sight of priorities."),
          T(lang,"Du lebst in ständiger Reaktion – es gibt keinen ruhigen Moment mehr für echte Orientierung.","Sürekli tepkisel yaşıyorsun – gerçek bir yön bulmak için artık sakin bir an yok.","You're living in constant reaction – no quiet moment left for real orientation."),
          T(lang,"Die Komplexität hat dich überwältigt – du weißt nicht mehr, womit du anfangen sollst.","Karmaşıklık seni ezdi – artık nereden başlayacağını bilmiyorsun.","Complexity has overwhelmed you – you don't know where to start anymore."),
          T(lang,"Vollständiger Überblicksverlust – alles fühlt sich gleich dringend und gleich unlösbar an.","Tam genel görünüm kaybı – her şey eşit derecede acil ve çözümsüz hissettiriyor.","Complete loss of overview – everything feels equally urgent and equally unsolvable.")
        ]
      },
      sPower: {
        exId: "exPower",
        label: T(lang,
          "0 = Macht & Verantwortung gekoppelt · 6 = entkoppelt / konzentriert",
          "0 = güç & sorumluluk eşleşmiş · 6 = ayrışmış / yoğunlaşmış",
          "0 = power & responsibility coupled · 6 = decoupled / concentrated"),
        hints: biz ? [
          T(lang,"Wer Verantwortung trägt, hat auch die Entscheidungsmacht – klares, konsistentes System.","Sorumluluk taşıyan karar yetkisine de sahip – net ve tutarlı bir sistem.","Those with responsibility also have decision power – clear, consistent system."),
          T(lang,"Überwiegend gut gekoppelt – kleine Reibungen, aber keine strukturellen Brüche.","Büyük ölçüde iyi eşleşmiş – küçük sürtüşmeler var ama yapısal kırıklar yok.","Largely well coupled – minor friction, but no structural breaks."),
          T(lang,"Einzelne Rollen tragen Verantwortung ohne echte Entscheidungsmacht.","Bazı roller gerçek karar gücü olmadan sorumluluk taşıyor.","Certain roles carry responsibility without real decision authority."),
          T(lang,"Macht und Verantwortung klaffen spürbar auseinander – das erzeugt stille Frustration.","Güç ve sorumluluk belirgin biçimde ayrışmış – bu sessiz hayal kırıklığı yaratıyor.","Power and responsibility are noticeably misaligned – creating silent frustration."),
          T(lang,"Entscheidungen werden von Personen getroffen, die nicht die Konsequenzen tragen.","Kararlar sonuçları taşımayan kişiler tarafından alınıyor.","Decisions are made by people who don't bear the consequences."),
          T(lang,"Macht ist bei 1–2 Personen konzentriert, während andere Verantwortung tragen, aber nichts entscheiden dürfen.","Güç 1–2 kişide yoğunlaşmış, diğerleri sorumluluk taşıyor ama karar veremiyorlar.","Power concentrated in 1–2 people while others carry responsibility but cannot decide."),
          T(lang,"Völlige Entkopplung: Macht, Verantwortung und Konsequenz haben keine strukturelle Verbindung mehr.","Tam ayrışma: güç, sorumluluk ve sonuç arasında artık yapısal bağlantı yok.","Complete decoupling: power, responsibility and consequence have no structural link.")
        ] : [
          T(lang,"Du hast das Gefühl, dein Leben aktiv zu gestalten – Entscheidungen liegen bei dir.","Hayatını aktif olarak şekillendirdiğini hissediyorsun – kararlar sende.","You feel like you're actively shaping your life – decisions rest with you."),
          T(lang,"Überwiegend selbstbestimmt – gelegentlich beeinflusst dich das Umfeld stärker als du willst.","Ağırlıklı olarak öz-belirleyici – çevre zaman zaman istediğinden daha fazla etkiliyor.","Mostly self-determined – occasionally the environment influences you more than you'd like."),
          T(lang,"Du merkst, dass du in manchen Bereichen Verantwortung trägst, aber nicht wirklich entscheiden kannst.","Bazı alanlarda sorumluluk taşıdığını ama gerçekten karar veremediğini fark ediyorsun.","You notice you carry responsibility in some areas but can't really decide."),
          T(lang,"Du trägst viel Verantwortung für Dinge, die andere eigentlich steuern – das zehrt.","Başkalarının kontrol ettiği şeyler için çok sorumluluk taşıyorsun – bu yıpratıyor.","You carry a lot of responsibility for things others actually control – that drains you."),
          T(lang,"Du hast das Gefühl, an Dinge gebunden zu sein, über die du keine echte Kontrolle hast.","Gerçek kontrolün olmadığı şeylere bağlı hissediyorsun kendini.","You feel tied to things you have no real control over."),
          T(lang,"Du funktionierst, aber kaum nach eigenen Regeln – die Situation bestimmt mehr als du.","İşler yürüyor ama neredeyse kendi kurallarına göre değil – durumu sen değil o belirliyor.","You're functioning, but barely on your own terms – the situation dictates more than you."),
          T(lang,"Du hast das Steuer aus der Hand verloren – externe Kräfte oder Personen bestimmen dein Leben.","Direksiyonu elinden bıraktın – dış güçler ya da kişiler hayatını belirliyor.","You've lost the wheel – external forces or people are determining your life.")
        ]
      }
    };

    Object.entries(sliders).forEach(([sliderId, cfg]) => {
      const slider = document.getElementById(sliderId);
      const exEl = document.getElementById(cfg.exId);
      if (!slider || !exEl) return;
      const val = parseInt(slider.value, 10) || 0;
      const hint = cfg.hints[val] || cfg.hints[0];
      exEl.innerHTML = `<span style="opacity:.55;font-size:.78rem;">${cfg.label}</span><br><span style="font-size:.82rem;color:var(--text);">${hint}</span>`;
    });
  }

  /* ── adaptive questions ──────────────────── */
  function renderQuestions(lang) {
    const biz = mode==="business";
    const qs = biz ? [
      { id:"b_q1",
        title: T(lang,"Wo entsteht aktuell die größte Verzögerung?","En büyük gecikme nerede?","Where is the biggest delay?"),
        opts: [
          {v:"decisions", l:T(lang,"Entscheidungen","Kararlar","Decisions")},
          {v:"handoff",   l:T(lang,"Übergaben","Devir","Handoffs")},
          {v:"quality",   l:T(lang,"Qualität / Rework","Kalite / rework","Quality / rework")},
          {v:"capacity",  l:T(lang,"Kapazität / Skills","Kapasite / skill","Capacity / skills")}
        ]},
      { id:"b_q2",
        title: T(lang,"Was passiert, wenn die Schlüsselrolle zwei Wochen ausfällt?","Kritik rol iki hafta yoksa ne olur?","If the key role is out for two weeks?"),
        opts: [
          {v:"fine",  l:T(lang,"Läuft weiter","Devam eder","Continues")},
          {v:"slow",  l:T(lang,"Wird langsamer","Yavaşlar","Slower")},
          {v:"break", l:T(lang,"Bricht zusammen","Kırılır","Breaks")}
        ]},
      { id:"b_q3",
        title: T(lang,"Wie klar sind Rollen & Zuständigkeiten?","Roller/sorumluluklar ne kadar net?","How clear are roles & ownership?"),
        opts: [
          {v:"clear",   l:T(lang,"Sehr klar","Çok net","Very clear")},
          {v:"mixed",   l:T(lang,"Teilweise","Kısmen","Partial")},
          {v:"unclear", l:T(lang,"Unklar","Belirsiz","Unclear")}
        ]}
    ] : [
      { id:"p_q1",
        title: T(lang,"Was ist der Haupt-Auslöser der Spannung?","Gerilimin ana tetikleyicisi nedir?","Main trigger of the tension?"),
        opts: [
          {v:"time",        l:T(lang,"Zeitdruck","Zaman baskısı","Time pressure")},
          {v:"conflict",    l:T(lang,"Konflikt","Çatışma","Conflict")},
          {v:"uncertainty", l:T(lang,"Unklarheit","Belirsizlik","Uncertainty")},
          {v:"energy",      l:T(lang,"Erschöpfung","Yorgunluk","Exhaustion")}
        ]},
      { id:"p_q2",
        title: T(lang,"Wie stark hängt das System an einer Person?","Sistem bir kişiye ne kadar bağlı?","How much does the system depend on one person?"),
        opts: [
          {v:"low",    l:T(lang,"Gering","Az","Low")},
          {v:"medium", l:T(lang,"Mittel","Orta","Medium")},
          {v:"high",   l:T(lang,"Hoch","Yüksek","High")}
        ]},
      { id:"p_q3",
        title: T(lang,"Wie gut werden Fehler genutzt statt versteckt?","Hatalar öğrenmeye dönüyor mu?","How well are errors used instead of hidden?"),
        opts: [
          {v:"good",  l:T(lang,"Gut","İyi","Good")},
          {v:"mixed", l:T(lang,"Gemischt","Karışık","Mixed")},
          {v:"bad",   l:T(lang,"Schlecht","Kötü","Bad")}
        ]}
    ];

    const root = $("#questions");
    root.innerHTML = "";
    qs.forEach(q => {
      const d = document.createElement("div");
      d.className = "dx-q";
      d.innerHTML = `
        <div class="dx-qtitle">${esc(q.title)}</div>
        <div class="dx-opts">
          ${q.opts.map(o => `
            <label class="dx-opt">
              <input type="radio" name="${q.id}" value="${o.v}" />
              ${esc(o.l)}
            </label>`).join("")}
        </div>`;
      root.appendChild(d);
    });
  }

  /* ── sliders ─────────────────────────────── */
  function syncSliders() {
    [["sLoad","vLoad"],["sDecisions","vDecisions"],["sEnergy","vEnergy"],
     ["sGrowth","vGrowth"],["sPower","vPower"]].forEach(([sid,vid]) => {
      const s = document.getElementById(sid), v = document.getElementById(vid);
      if (s && v) v.textContent = s.value;
    });
  }
  $$('input[type="range"]').forEach(r => r.addEventListener("input", syncSliders));

  /* ── KPI pills ───────────────────────────── */
  function resetKpis(lang) {
    const k = dict[lang] || dict.de;
    $("#kpiPrimary").textContent = k["kpi.primary"] + ": —";
    $("#kpiPath").textContent    = k["kpi.path"]    + ": —";
    $("#kpiRisk").textContent    = k["kpi.risk"]    + ": —";
    [$('#kpiPrimary'),$('#kpiPath'),$('#kpiRisk')].forEach(el => el?.classList.remove("active"));
  }
  function setKpis(lang, data) {
    const k = dict[lang] || dict.de;
    const set = (id, key, val) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = k[key] + ": " + (val || "—");
      if (val) el.classList.add("active"); else el.classList.remove("active");
    };
    set("kpiPrimary","kpi.primary", data?.primary);
    set("kpiPath",   "kpi.path",    data?.path);
    set("kpiRisk",   "kpi.risk",    data?.risk);
  }

  /* ── status line ─────────────────────────── */
  function setStatus(msg, cls="") {
    const el = $("#statusLine");
    el.textContent = msg;
    el.className = "micro" + (cls ? " "+cls : "");
  }

  /* ── API ─────────────────────────────────── */
  async function postJSON(path, body) {
    const res  = await fetch(`${API}${path}`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body) });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data?.error || `Error ${res.status}`);
    return data;
  }
  function downloadBlob(blob, name) {
    const a = document.createElement("a"), url = URL.createObjectURL(blob);
    a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 800);
  }

  /* ── payload builder ─────────────────────── */
  function buildPayload() {
    const radios = {};
    $$('input[type="radio"]:checked').forEach(r => { radios[r.name] = r.value; });
    return {
      version: "v4",
      mode,
      token:   mode==="business" ? tokenStored : undefined,
      lang:    getLang(),
      problem: ($("#oneLiner").value || "").trim(),
      intent:  $("#goalSelect").value,
      answers: {
        quick_scan: {
          load:      +$("#sLoad").value,
          decisions: +$("#sDecisions").value,
          energy:    +$("#sEnergy").value,
          growth:    +$("#sGrowth").value,
          power:     +$("#sPower").value,
        },
        radios
      },
      meta: { ts: new Date().toISOString(), ua: navigator.userAgent }
    };
  }

  /* ── state ───────────────────────────────── */
  const STATE = { assessment: null, report: "" };

  /* ── run assessment ──────────────────────── */
  async function runAssessment() {
    const lang = getLang();
    const payload = buildPayload();

    if (!payload.problem) {
      alert(T(lang,"Bitte beschreibe die Situation in einem Satz.","Lütfen durumu tek cümleyle yaz.","Please describe the situation in one sentence."));
      return;
    }
    if (mode==="business" && !payload.token) {
      alert(T(lang,"Business-Token fehlt – bitte über die Landingpage einsteigen.","Business token eksik.","Business token missing."));
      return;
    }

    setStatus(T(lang,"läuft …","çalışıyor …","running …"), "running");
    $("#resultText").textContent = "—";
    $("#execText").textContent   = "—";
    $("#copyExecBtn").disabled   = true;
    $("#reportContainer").style.display = "none";
    $("#feedbackBox").style.display     = "none";
    STATE.assessment = null; STATE.report = "";
    resetKpis(lang);

    try {
      const data = await postJSON("/api/assess", payload);
      STATE.assessment = data;
      $("#resultText").textContent = data.assessment_text || JSON.stringify(data, null, 2);
      setKpis(lang, data);
      setStatus(T(lang,"fertig ✓","bitti ✓","done ✓"), "done");
    } catch(e) {
      setStatus(T(lang,"Fehler: ","Hata: ","Error: ") + (e?.message||String(e)), "err");
    }
  }

  /* ── run executive report ────────────────── */
  async function runReport() {
    const lang = getLang();

    if (!STATE.assessment) {
      alert(T(lang,"Bitte zuerst die Diagnose starten.","Önce değerlendirmeyi çalıştır.","Run the assessment first."));
      return;
    }

    setStatus(T(lang,"Report wird erstellt …","Rapor oluşturuluyor …","Generating report …"), "running");
    $("#execText").textContent   = "—";
    $("#copyExecBtn").disabled   = true;
    $("#reportContainer").style.display = "none";
    $("#feedbackBox").style.display     = "none";
    STATE.report = "";

    try {
      const payload = { ...buildPayload(), assessment: STATE.assessment };
      const data    = await postJSON("/api/report", payload);
      STATE.report  = data.report_markdown || JSON.stringify(data, null, 2);
      $("#execText").textContent  = STATE.report;
      $("#reportContainer").style.display = "block";
      $("#copyExecBtn").disabled  = false;
      clearFeedback();
      $("#feedbackBox").style.display = "block";
      setStatus(T(lang,"Report fertig ✓","Rapor hazır ✓","Report ready ✓"), "done");
    } catch(e) {
      setStatus(T(lang,"Fehler: ","Hata: ","Error: ") + (e?.message||String(e)), "err");
    }
  }

  /* ── PDF ─────────────────────────────────── */
  async function runPdf() {
    const lang = getLang();
    if (!STATE.assessment) {
      alert(T(lang,"Bitte zuerst die Diagnose starten.","Önce değerlendirmeyi çalıştır.","Run the assessment first."));
      return;
    }
    setStatus(T(lang,"PDF wird erstellt …","PDF oluşturuluyor …","Generating PDF …"), "running");
    try {
      const payload = { ...buildPayload(), assessment: STATE.assessment };
      if (STATE.report) payload.report_markdown = STATE.report;
      const res = await fetch(`${API}/api/pdf`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload) });
      if (!res.ok) throw new Error((await res.text().catch(()=>"")).slice(0,140) || `PDF ${res.status}`);
      const ct = (res.headers.get("content-type")||"").toLowerCase();
      if (ct.includes("application/json")) {
        const d   = await res.json().catch(()=>({}));
        const b64 = d?.pdf_base64 || d?.base64 || "";
        if (!b64) throw new Error("No pdf_base64 in response");
        downloadBlob(new Blob([Uint8Array.from(atob(b64), c=>c.charCodeAt(0))], {type:"application/pdf"}), "mdg-executive-report.pdf");
      } else {
        downloadBlob(new Blob([await res.arrayBuffer()], {type:"application/pdf"}), "mdg-executive-report.pdf");
      }
      setStatus(T(lang,"PDF fertig ✓","PDF hazır ✓","PDF ready ✓"), "done");
    } catch(e) {
      setStatus(T(lang,"Fehler: ","Hata: ","Error: ") + (e?.message||String(e)), "err");
    }
  }

  /* ── feedback ────────────────────────────── */
  /*
   * UNIFIED SYSTEM — single set of static IDs:
   *   fbQ1 (textarea)  fbQ2 (textarea)  fbNps (number)
   *   fbSendBtn        fbStatus
   * Elements exist in the DOM from page load.
   * hookFeedback() attaches input-listeners ONCE at init.
   * clearFeedback() resets values when a new report is generated.
   */
  function clearFeedback() {
    ["fbQ1","fbQ2","fbNps"].forEach(id => { const el = document.getElementById(id); if (el) el.value=""; });
    $("#fbSendBtn").disabled    = true;
    $("#fbStatus").textContent  = "—";
  }

  function feedbackOk() {
    const q1  = ($("#fbQ1").value||"").trim();
    const q2  = ($("#fbQ2").value||"").trim();
    const nps = ($("#fbNps").value||"").trim();
    const n   = Number(nps);
    return q1.length>=2 && q2.length>=2 && /^\d{1,2}$/.test(nps) && n>=0 && n<=10;
  }

  function hookFeedback() {
    ["fbQ1","fbQ2","fbNps"].forEach(id => {
      document.getElementById(id)?.addEventListener("input", () => {
        document.getElementById("fbSendBtn").disabled = !feedbackOk();
      });
    });
  }

  async function sendFeedback() {
    const lang = getLang();
    if (!feedbackOk()) return;
    const payload = {
      page:"diagnose", mode, lang,
      problem: ($("#oneLiner").value||"").trim(),
      q1:  ($("#fbQ1").value||"").trim(),
      q2:  ($("#fbQ2").value||"").trim(),
      nps: Number(($("#fbNps").value||"").trim()),
      meta: { ts: new Date().toISOString(), ua: navigator.userAgent }
    };
    $("#fbStatus").textContent  = "…";
    $("#fbSendBtn").disabled    = true;
    try {
      await postJSON("/api/feedback", payload);
      $("#fbStatus").textContent = "✓";
    } catch {
      $("#fbStatus").textContent = T(lang,"Fehler","Hata","Error");
      document.getElementById("fbSendBtn").disabled = false;
    }
  }

  /* ── copy exec ───────────────────────────── */
  $("#copyExecBtn").addEventListener("click", async () => {
    const txt = $("#execText").textContent || "";
    if (!txt || txt==="—") return;
    try {
      await navigator.clipboard.writeText(txt);
      const btn = $("#copyExecBtn"), lang = getLang(), prev = btn.textContent;
      btn.classList.add("btn--ok");
      btn.textContent = T(lang,"Kopiert ✓","Kopyalandı ✓","Copied ✓");
      setTimeout(() => { btn.classList.remove("btn--ok"); btn.textContent=prev; }, 1800);
    } catch {}
  });

  /* ── reset all ───────────────────────────── */
  function resetAll() {
    ($("#oneLiner").value = ""), ($("#goalSelect").value = "stabilize");
    ["sLoad","sDecisions","sEnergy","sGrowth","sPower"].forEach(id => { const el=document.getElementById(id); if(el) el.value="2"; });
    $$('input[type="radio"]').forEach(r => r.checked=false);
    STATE.assessment=null; STATE.report="";
    $("#resultText").textContent = "—";
    $("#execText").textContent   = "—";
    $("#reportContainer").style.display = "none";
    $("#copyExecBtn").disabled   = true;
    $("#feedbackBox").style.display = "none";
    const lang = getLang();
    resetKpis(lang);
    setStatus(T(lang,"bereit","hazır","ready"), "");
    syncSliders();
    renderQuestions(lang);
  }

  /* ── event wiring ────────────────────────── */
  $("#runBtn")   .addEventListener("click", runAssessment);
  $("#execBtn")  .addEventListener("click", runReport);
  $("#pdfBtn")   .addEventListener("click", runPdf);
  $("#fbSendBtn").addEventListener("click", sendFeedback);
  $("#resetBtn") .addEventListener("click", () => {
    const lang = getLang();
    if (confirm(T(lang,"Wirklich zurücksetzen?","Sıfırlansın mı?","Reset everything?"))) resetAll();
  });

  /* ── boot ────────────────────────────────── */
  // Read lang: URL param → localStorage → "de"
  const initLang = (params.get("lang") || ls.getItem("mdg_lang") || "de").toLowerCase();
  syncSliders();
  hookFeedback();                              // wire feedback inputs ONCE, elements exist
  applyLang(dict[initLang] ? initLang : "de");
  setStatus(T(initLang,"bereit","hazır","ready"), "");

})();
</script>
</body>
</html>
