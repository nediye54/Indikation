<!-- diagnose.html — MDG V4 (Drop: Diagnose) -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagnose – MDG v4</title>
  <meta name="description" content="MDG Diagnose: Instabilität früh erkennen, Ursachen präzise diagnostizieren, IDG/ADG-Pfad und Executive Report." />
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <a class="skip-link" href="#main">Zum Inhalt springen</a>

  <header class="header" id="top">
    <div class="container header__inner">
      <a class="brand" href="./index.html" aria-label="Zur Startseite">
        <span class="brand__mark" aria-hidden="true">MDG</span>
        <span class="brand__text">v4</span>
      </a>

      <nav class="nav" aria-label="Hauptnavigation">
        <a class="nav__link" href="./index.html#how" data-i18n="nav.how">Wie es funktioniert</a>
        <a class="nav__link" href="#main" data-i18n="nav.dx">Diagnose</a>
        <a class="nav__link" href="./verlauf.html" data-i18n="nav.history">Verlauf</a>
      </nav>

      <div class="header__actions">
        <div class="lang" role="group" aria-label="Sprache">
          <button class="chip chip--ghost" type="button" data-lang="de" aria-pressed="true">DE</button>
          <button class="chip chip--ghost" type="button" data-lang="tr" aria-pressed="false">TR</button>
          <button class="chip chip--ghost" type="button" data-lang="en" aria-pressed="false">EN</button>
        </div>
        <a class="btn btn--ghost" href="./index.html" data-i18n="cta.backHome">Zur Homepage</a>
      </div>

      <button class="burger" type="button" aria-label="Menü öffnen" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
    </div>

    <div class="drawer" hidden>
      <div class="drawer__content">
        <a class="drawer__link" href="./index.html#how" data-i18n="nav.how">Wie es funktioniert</a>
        <a class="drawer__link" href="#main" data-i18n="nav.dx">Diagnose</a>
        <a class="drawer__link" href="./verlauf.html" data-i18n="nav.history">Verlauf</a>
        <div class="drawer__sep"></div>
        <a class="btn btn--ghost btn--full" href="./index.html" data-i18n="cta.backHome">Zur Homepage</a>
      </div>
    </div>
  </header>

  <main id="main">
    <section class="section wizard">
      <div class="container">
        <div class="wizard__shell">

          <div class="wizard__head">
            <div>
              <div class="pill pill--muted" id="dx_mode_badge">—</div>
              <h1 class="h2" data-i18n="dx.h1" style="margin:.65rem 0 0;">Diagnose</h1>
              <p class="sub" data-i18n="dx.sub" style="margin:.6rem auto 0; max-width:820px;">
                In wenigen Minuten zur Entscheidungssicherheit: Quick Scan → Ergebnis → Executive Report.
              </p>
            </div>

            <div class="progress">
              <div class="progress__bar"><i id="dx_prog_i" style="width:0%"></i></div>
              <div class="progress__pct" id="dx_prog_t">0%</div>
            </div>
          </div>

          <!-- STEP NAV -->
          <div class="dx-nav">
            <button class="chip" type="button" data-stepgo="1">1 · Kontext</button>
            <button class="chip" type="button" data-stepgo="2">2 · Ziel</button>
            <button class="chip" type="button" data-stepgo="3">3 · Quick Scan</button>
            <button class="chip chip--ghost" type="button" data-stepgo="4">→ Ergebnis</button>
          </div>

          <!-- STEP 1 -->
          <section class="dx-step" id="step1" data-step="1">
            <div class="card">
              <h2 class="h3" data-i18n="s1.h">1) Beschreibe dein Thema in einem Satz</h2>
              <p class="p" data-i18n="s1.p">
                Kein Roman. Wir brauchen den Kern, damit die Struktur sichtbar wird.
              </p>

              <label class="dx-label" for="dx_context" data-i18n="s1.label">Kontext (1 Satz)</label>
              <textarea id="dx_context" rows="3" placeholder="z.B. Wir streiten ständig über Prioritäten und alles hängt an einer Person."></textarea>

              <div class="ex2">
                <div class="ex2__t" data-i18n="ex.title">Beispiele</div>
                <div class="ex2__grid">
                  <div class="ex2__item" data-i18n="s1.ex1">„Ich streite häufig mit meinem Partner über Kleinigkeiten.“</div>
                  <div class="ex2__item" data-i18n="s1.ex2">„Im Team entscheidet alles der Chef, Lieferungen sind unzuverlässig.“</div>
                </div>
              </div>

              <div class="dx-actions">
                <button class="btn btn--primary" type="button" id="go2" data-i18n="cta.next">Weiter</button>
              </div>
            </div>
          </section>

          <!-- STEP 2 -->
          <section class="dx-step" id="step2" data-step="2" hidden>
            <div class="card">
              <h2 class="h3" data-i18n="s2.h">2) Was willst du jetzt?</h2>
              <p class="p" data-i18n="s2.p">
                Stabilisieren = Spannung runter, Kontrolle zurück. Umbauen = Architektur neu designen.
              </p>

              <div class="choice2">
                <button class="choice2__btn" type="button" data-intent="stabilize">
                  <div class="choice2__k" data-i18n="s2.a">Stabilisieren</div>
                  <div class="choice2__t" data-i18n="s2.a2">Schnell Ruhe reinbringen, Fehler stoppen, Last senken.</div>
                </button>

                <button class="choice2__btn" type="button" data-intent="redesign">
                  <div class="choice2__k" data-i18n="s2.b">Umbauen</div>
                  <div class="choice2__t" data-i18n="s2.b2">Struktur neu: Entscheidungen, Rollen, Schnittstellen, Rhythmus.</div>
                </button>
              </div>

              <div class="ex2">
                <div class="ex2__t" data-i18n="ex.title">Beispiele</div>
                <div class="ex2__grid">
                  <div class="ex2__item" data-i18n="s2.ex1">Stabilisieren: „Wir haben Chaos – erstmal stoppen, sortieren, priorisieren.“</div>
                  <div class="ex2__item" data-i18n="s2.ex2">Umbauen: „So geht es nicht weiter – Verantwortungen & Entscheidungswege müssen neu.“</div>
                </div>
              </div>

              <div class="dx-actions">
                <button class="btn btn--ghost" type="button" id="back1" data-i18n="cta.back">Zurück</button>
                <button class="btn btn--primary" type="button" id="go3" data-i18n="cta.next">Weiter</button>
              </div>
            </div>
          </section>

          <!-- STEP 3 -->
          <section class="dx-step" id="step3" data-step="3" hidden>
            <div class="card">
              <h2 class="h3" data-i18n="s3.h">3) Quick Scan (streng, klar, präzise)</h2>
              <p class="p" data-i18n="s3.p">
                Schiebe den Regler so, wie es heute wirklich ist. 0 = unkritisch · 10 = kritisch.
              </p>

              <div class="scan">
                <!-- Q1 -->
                <div class="scan__q">
                  <div class="scan__head">
                    <div>
                      <div class="scan__k" data-i18n="q1.t">Entscheidungen sind an eine Person gebunden</div>
                      <div class="scan__d" data-i18n="q1.d">Wie sehr hängt „Weiterkommen“ an einer Person?</div>
                    </div>
                    <div class="scan__v"><span id="v1">0</span>/10</div>
                  </div>
                  <input class="scan__r" id="q1" type="range" min="0" max="10" step="1" value="0" />
                  <div class="exline">
                    <div class="exline__a" data-i18n="q1.ex1">Beispiel A: „Ohne ihn passiert nichts.“</div>
                    <div class="exline__b" data-i18n="q1.ex2">Beispiel B: „Auch ohne ihn läuft es stabil weiter.“</div>
                  </div>
                </div>

                <!-- Q2 -->
                <div class="scan__q">
                  <div class="scan__head">
                    <div>
                      <div class="scan__k" data-i18n="q2.t">Last ist unfair / konzentriert</div>
                      <div class="scan__d" data-i18n="q2.d">Tragen wenige Rollen zu viel (Zeit, Verantwortung, Stress)?</div>
                    </div>
                    <div class="scan__v"><span id="v2">0</span>/10</div>
                  </div>
                  <input class="scan__r" id="q2" type="range" min="0" max="10" step="1" value="0" />
                  <div class="exline">
                    <div class="exline__a" data-i18n="q2.ex1">Beispiel A: „1–2 Leute brennen aus, alle fragen sie.“</div>
                    <div class="exline__b" data-i18n="q2.ex2">Beispiel B: „Arbeit ist gut verteilt, Vertretung klappt.“</div>
                  </div>
                </div>

                <!-- Q3 -->
                <div class="scan__q">
                  <div class="scan__head">
                    <div>
                      <div class="scan__k" data-i18n="q3.t">Wachstum / Komplexität überfordert Struktur</div>
                      <div class="scan__d" data-i18n="q3.d">Wird es bei mehr Last sofort chaotisch?</div>
                    </div>
                    <div class="scan__v"><span id="v3">0</span>/10</div>
                  </div>
                  <input class="scan__r" id="q3" type="range" min="0" max="10" step="1" value="0" />
                  <div class="exline">
                    <div class="exline__a" data-i18n="q3.ex1">Beispiel A: „+20% reicht und Qualität kippt.“</div>
                    <div class="exline__b" data-i18n="q3.ex2">Beispiel B: „Mehr Last bleibt kontrollierbar.“</div>
                  </div>
                </div>

                <!-- Q4 -->
                <div class="scan__q">
                  <div class="scan__head">
                    <div>
                      <div class="scan__k" data-i18n="q4.t">Macht & Verantwortung sind entkoppelt</div>
                      <div class="scan__d" data-i18n="q4.d">Entscheidet jemand, der die Konsequenzen nicht trägt?</div>
                    </div>
                    <div class="scan__v"><span id="v4">0</span>/10</div>
                  </div>
                  <input class="scan__r" id="q4" type="range" min="0" max="10" step="1" value="0" />
                  <div class="exline">
                    <div class="exline__a" data-i18n="q4.ex1">Beispiel A: „Andere entscheiden, ich muss es ausbaden.“</div>
                    <div class="exline__b" data-i18n="q4.ex2">Beispiel B: „Wer entscheidet, trägt auch die Folgen.“</div>
                  </div>
                </div>

                <!-- Q5 -->
                <div class="scan__q">
                  <div class="scan__head">
                    <div>
                      <div class="scan__k" data-i18n="q5.t">Energie / Fehler werden nicht integriert</div>
                      <div class="scan__d" data-i18n="q5.d">Wird Stress höher und Fehler wiederholen sich?</div>
                    </div>
                    <div class="scan__v"><span id="v5">0</span>/10</div>
                  </div>
                  <input class="scan__r" id="q5" type="range" min="0" max="10" step="1" value="0" />
                  <div class="exline">
                    <div class="exline__a" data-i18n="q5.ex1">Beispiel A: „Man ist müde, Fehler passieren wieder.“</div>
                    <div class="exline__b" data-i18n="q5.ex2">Beispiel B: „Erholung & Lernen sind fest eingebaut.“</div>
                  </div>
                </div>
              </div>

              <div class="dx-actions">
                <button class="btn btn--ghost" type="button" id="back2" data-i18n="cta.back">Zurück</button>
                <button class="btn btn--primary" type="button" id="calc" data-i18n="cta.calc">Ergebnis berechnen</button>
              </div>
            </div>
          </section>

          <!-- STEP 4 RESULT -->
          <section class="dx-step" id="step4" data-step="4" hidden>
            <div class="card">
              <div class="res-head">
                <div>
                  <h2 class="h3" data-i18n="r.h">Ergebnis</h2>
                  <p class="micro" id="r_sub">—</p>
                </div>
                <div class="res-actions">
                  <button class="btn btn--ghost" type="button" id="recalc" data-i18n="cta.recalc">Neu berechnen</button>
                  <button class="btn btn--primary" type="button" id="exec" data-i18n="cta.exec">Executive Report</button>
                </div>
              </div>

              <div class="res-grid">
                <div class="res-card">
                  <div class="pill pill--muted" data-i18n="r.primary">Primärinstabilität</div>
                  <div class="res-title" id="r_primary">—</div>
                  <p class="p" id="r_primary_why">—</p>
                </div>

                <div class="res-card">
                  <div class="pill pill--muted" data-i18n="r.path">Pfad</div>
                  <div class="res-title" id="r_path">—</div>
                  <p class="p" id="r_path_why">—</p>
                </div>
              </div>

              <div class="viz-grid">
                <div class="viz-card">
                  <div class="viz-head">
                    <div class="h3" data-i18n="viz.radar">Radar</div>
                    <div class="micro" data-i18n="viz.radar2">Strukturspannung je Dimension</div>
                  </div>
                  <div id="radar_mount"></div>
                </div>

                <div class="viz-card">
                  <div class="viz-head">
                    <div class="h3" data-i18n="viz.tensions">Spannungen</div>
                    <div class="micro" data-i18n="viz.tensions2">Wo bricht es zuerst?</div>
                  </div>
                  <div id="bars_mount"></div>
                </div>
              </div>

              <div class="moves">
                <div class="moves__col">
                  <div class="pill pill--muted" data-i18n="moves.now">3 Moves jetzt</div>
                  <ol class="ol" id="moves_now"></ol>
                </div>
                <div class="moves__col">
                  <div class="pill pill--muted" data-i18n="moves.week">3 Moves diese Woche</div>
                  <ol class="ol" id="moves_week"></ol>
                </div>
              </div>

              <!-- Adaptive precision question -->
              <div class="card" id="prec_block" style="margin-top:18px; display:none;">
                <div class="pill pill--muted" data-i18n="prec.pill">Präzisionsfrage</div>
                <h3 class="h3" id="prec_q" style="margin:.6rem 0 0;">—</h3>
                <p class="micro" id="prec_hint" style="margin:.5rem 0 0;">—</p>

                <label class="dx-label" for="prec_a" style="margin-top:14px;" data-i18n="prec.answer">Deine Antwort</label>
                <textarea id="prec_a" rows="3" placeholder=""></textarea>

                <div class="dx-actions" style="margin-top:12px;">
                  <button class="btn btn--ghost" type="button" id="prec_skip" data-i18n="prec.skip">Überspringen</button>
                  <button class="btn btn--primary" type="button" id="prec_apply" data-i18n="prec.apply">Antwort anwenden</button>
                </div>
              </div>

              <!-- Executive report output -->
              <div class="card" id="report_block" style="margin-top:18px; display:none;">
                <div class="pill pill--muted" data-i18n="rep.pill">Executive Report</div>
                <p class="micro" id="rep_status" style="margin:.65rem 0 0;">—</p>
                <div class="report" id="rep_html"></div>
              </div>

            </div>
          </section>

        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container footer__grid">
      <div>
        <div class="brand brand--footer">
          <span class="brand__mark" aria-hidden="true">MDG</span>
          <span class="brand__text">v4</span>
        </div>
        <p class="micro" data-i18n="footer.tag">Strukturdiagnose für Stabilisierung und Umbau.</p>
      </div>
      <div class="footer__links">
        <a href="./index.html#how" data-i18n="nav.how">Wie es funktioniert</a>
        <a href="./verlauf.html" data-i18n="nav.history">Verlauf</a>
        <a href="#top" data-i18n="footer.top">Nach oben</a>
      </div>
      <div class="footer__legal">
        <a href="./impressum.html" rel="nofollow">Impressum</a>
        <a href="./datenschutz.html" rel="nofollow">Datenschutz</a>
        <a href="./kontakt.html" rel="nofollow">Kontakt</a>
      </div>
    </div>
  </footer>

  <script src="./script.js" defer></script>

  <!-- Diagnose logic + SVG viz -->
  <script defer>
    (() => {
      "use strict";
      const $ = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

      const API_BASE = (window.MDG && window.MDG.API_BASE) ? window.MDG.API_BASE : "https://api.mdg-indikation.de";
      const K = (window.MDG && window.MDG.storage) ? window.MDG.storage : { K_LANG:"mdg_lang", K_MODE:"mdg_mode", K_TOKEN:"mdg_token" };

      const clamp01 = (x)=> Math.max(0, Math.min(1, x));
      const esc = (s)=> String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

      // ======= Premium minimal CSS add-ons for this page (keeps your main style.css intact) =======
      const style = document.createElement("style");
      style.textContent = `
        .dx-nav{ display:flex; gap:.5rem; flex-wrap:wrap; margin: 0 0 18px; }
        .dx-step{ scroll-margin-top: 90px; }
        .dx-actions{ display:flex; gap:.7rem; flex-wrap:wrap; margin-top:18px; }
        .choice2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px; }
        .choice2__btn{ text-align:left; padding:16px; border-radius: 18px; border:1px solid var(--stroke); background: rgba(255,255,255,.05); color: var(--text); }
        .choice2__btn:hover{ border-color: rgba(110,231,183,.55); transform: translateY(-1px); }
        .choice2__k{ font-weight:900; font-size:1.05rem; }
        .choice2__t{ color: var(--muted); margin-top:6px; line-height:1.5; }
        .scan{ display:grid; gap:12px; margin-top:16px; }
        .scan__q{ border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); border-radius: 18px; padding:14px; }
        .scan__head{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
        .scan__k{ font-weight:900; }
        .scan__d{ color: var(--muted); font-size:.92rem; margin-top:4px; }
        .scan__v{ font-weight:900; color: var(--text); opacity:.9; }
        .scan__r{ width:100%; margin-top:12px; }
        .ex2{ margin-top:14px; border:1px dashed rgba(255,255,255,.14); background: rgba(0,0,0,.10); border-radius: 16px; padding:12px; }
        .ex2__t{ font-weight:900; color: var(--muted); font-size:.85rem; }
        .ex2__grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
        .ex2__item{ color: var(--muted); background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius: 14px; padding:10px; line-height:1.45; }
        .exline{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
        .exline__a,.exline__b{ font-size:.86rem; color: var(--muted); background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius: 14px; padding:10px; }
        .res-head{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; }
        .res-actions{ display:flex; gap:.6rem; flex-wrap:wrap; }
        .res-grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px; }
        .res-card{ border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); border-radius: 18px; padding:14px; }
        .res-title{ font-weight:950; font-size:1.25rem; margin:.6rem 0 .2rem; }
        .viz-grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px; }
        .viz-card{ border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); border-radius: 18px; padding:14px; overflow:hidden; }
        .viz-head{ display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-bottom:10px; }
        .moves{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px; }
        .moves__col{ border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); border-radius: 18px; padding:14px; }
        .report{ margin-top:14px; color: var(--text); }
        .report h1,.report h2,.report h3{ margin: 14px 0 8px; }
        .report p{ color: var(--muted); line-height:1.65; margin: 8px 0; }
        .report ul{ margin: 8px 0 8px 18px; color: var(--muted); }
        .report code{ background: rgba(255,255,255,.06); padding: 2px 6px; border-radius: 8px; border: 1px solid rgba(255,255,255,.10); }
        @media (max-width: 980px){
          .choice2{ grid-template-columns:1fr; }
          .ex2__grid{ grid-template-columns:1fr; }
          .exline{ grid-template-columns:1fr; }
          .res-grid{ grid-template-columns:1fr; }
          .viz-grid{ grid-template-columns:1fr; }
          .moves{ grid-template-columns:1fr; }
        }
      `;
      document.head.appendChild(style);

      // ======= i18n (this page only) =======
      const dict = {
        de: {
          "nav.how":"Wie es funktioniert",
          "nav.dx":"Diagnose",
          "nav.history":"Verlauf",
          "cta.backHome":"Zur Homepage",
          "dx.h1":"Diagnose",
          "dx.sub":"In wenigen Minuten zur Entscheidungssicherheit: Quick Scan → Ergebnis → Executive Report.",
          "ex.title":"Beispiele",
          "cta.next":"Weiter",
          "cta.back":"Zurück",
          "cta.calc":"Ergebnis berechnen",
          "cta.recalc":"Neu berechnen",
          "cta.exec":"Executive Report",
          "s1.h":"1) Beschreibe dein Thema in einem Satz",
          "s1.p":"Kein Roman. Wir brauchen den Kern, damit die Struktur sichtbar wird.",
          "s1.label":"Kontext (1 Satz)",
          "s1.ex1":"„Ich streite häufig mit meinem Partner über Kleinigkeiten.“",
          "s1.ex2":"„Im Team entscheidet alles der Chef, Lieferungen sind unzuverlässig.“",
          "s2.h":"2) Was willst du jetzt?",
          "s2.p":"Stabilisieren = Spannung runter, Kontrolle zurück. Umbauen = Architektur neu designen.",
          "s2.a":"Stabilisieren",
          "s2.a2":"Schnell Ruhe reinbringen, Fehler stoppen, Last senken.",
          "s2.b":"Umbauen",
          "s2.b2":"Struktur neu: Entscheidungen, Rollen, Schnittstellen, Rhythmus.",
          "s2.ex1":"Stabilisieren: „Wir haben Chaos – erstmal stoppen, sortieren, priorisieren.“",
          "s2.ex2":"Umbauen: „So geht es nicht weiter – Verantwortungen & Entscheidungswege müssen neu.“",
          "s3.h":"3) Quick Scan (streng, klar, präzise)",
          "s3.p":"Schiebe den Regler so, wie es heute wirklich ist. 0 = unkritisch · 10 = kritisch.",
          "q1.t":"Entscheidungen sind an eine Person gebunden",
          "q1.d":"Wie sehr hängt „Weiterkommen“ an einer Person?",
          "q1.ex1":"Beispiel A: „Ohne ihn passiert nichts.“",
          "q1.ex2":"Beispiel B: „Auch ohne ihn läuft es stabil weiter.“",
          "q2.t":"Last ist unfair / konzentriert",
          "q2.d":"Tragen wenige Rollen zu viel (Zeit, Verantwortung, Stress)?",
          "q2.ex1":"Beispiel A: „1–2 Leute brennen aus, alle fragen sie.“",
          "q2.ex2":"Beispiel B: „Arbeit ist gut verteilt, Vertretung klappt.“",
          "q3.t":"Wachstum / Komplexität überfordert Struktur",
          "q3.d":"Wird es bei mehr Last sofort chaotisch?",
          "q3.ex1":"Beispiel A: „+20% reicht und Qualität kippt.“",
          "q3.ex2":"Beispiel B: „Mehr Last bleibt kontrollierbar.“",
          "q4.t":"Macht & Verantwortung sind entkoppelt",
          "q4.d":"Entscheidet jemand, der die Konsequenzen nicht trägt?",
          "q4.ex1":"Beispiel A: „Andere entscheiden, ich muss es ausbaden.“",
          "q4.ex2":"Beispiel B: „Wer entscheidet, trägt auch die Folgen.“",
          "q5.t":"Energie / Fehler werden nicht integriert",
          "q5.d":"Wird Stress höher und Fehler wiederholen sich?",
          "q5.ex1":"Beispiel A: „Man ist müde, Fehler passieren wieder.“",
          "q5.ex2":"Beispiel B: „Erholung & Lernen sind fest eingebaut.“",
          "r.h":"Ergebnis",
          "r.primary":"Primärinstabilität",
          "r.path":"Pfad",
          "viz.radar":"Radar",
          "viz.radar2":"Strukturspannung je Dimension",
          "viz.tensions":"Spannungen",
          "viz.tensions2":"Wo bricht es zuerst?",
          "moves.now":"3 Moves jetzt",
          "moves.week":"3 Moves diese Woche",
          "prec.pill":"Präzisionsfrage",
          "prec.answer":"Deine Antwort",
          "prec.skip":"Überspringen",
          "prec.apply":"Antwort anwenden",
          "rep.pill":"Executive Report",
          "footer.tag":"Strukturdiagnose für Stabilisierung und Umbau.",
          "footer.top":"Nach oben"
        },
        tr: {
          "nav.how":"Nasıl çalışır",
          "nav.dx":"Analiz",
          "nav.history":"Geçmiş",
          "cta.backHome":"Anasayfa",
          "dx.h1":"Analiz",
          "dx.sub":"Dakikalar içinde karar netliği: Hızlı tarama → Sonuç → Executive Report.",
          "ex.title":"Örnekler",
          "cta.next":"Devam",
          "cta.back":"Geri",
          "cta.calc":"Sonucu hesapla",
          "cta.recalc":"Yeniden hesapla",
          "cta.exec":"Executive Report",
          "s1.h":"1) Konuyu tek cümleyle yaz",
          "s1.p":"Hikâye değil. Yapıyı görmek için çekirdek gerekir.",
          "s1.label":"Bağlam (1 cümle)",
          "s1.ex1":"“Partnerimle sık sık küçük şeyler yüzünden tartışıyorum.”",
          "s1.ex2":"“Ekipte her şeye patron karar veriyor, teslimatlar düzensiz.”",
          "s2.h":"2) Şu an ne istiyorsun?",
          "s2.p":"Stabilize = gerilimi düşür, kontrolü geri al. Yeniden kur = mimariyi yeniden tasarla.",
          "s2.a":"Stabilize",
          "s2.a2":"Hızlı sakinleşme, hataları durdur, yükü azalt.",
          "s2.b":"Yeniden kur",
          "s2.b2":"Karar, rol, arayüz, ritim yeniden tasarım.",
          "s2.ex1":"Stabilize: “Kaos var — önce durdur, sırala, önceliklendir.”",
          "s2.ex2":"Yeniden kur: “Böyle gitmez — sorumluluklar & karar yolları değişmeli.”",
          "s3.h":"3) Hızlı Tarama (sıkı, net, kesin)",
          "s3.p":"Bugünü dürüstçe işaretle. 0 = sorun yok · 10 = kritik.",
          "q1.t":"Kararlar tek kişiye bağlı",
          "q1.d":"İlerleme ne kadar tek kişiye bağlı?",
          "q1.ex1":"Örnek A: “O olmadan hiçbir şey olmaz.”",
          "q1.ex2":"Örnek B: “O olmasa da sistem işler.”",
          "q2.t":"Yük adaletsiz / yoğunlaşmış",
          "q2.d":"Az kişi fazla yük mü taşıyor (zaman, stres, sorumluluk)?",
          "q2.ex1":"Örnek A: “1–2 kişi tükeniyor, herkes onlara soruyor.”",
          "q2.ex2":"Örnek B: “Yük dağıtılmış, yedekleme var.”",
          "q3.t":"Büyüme / karmaşıklık yapıyı aşıyor",
          "q3.d":"Daha fazla yükte hemen kaos mu oluyor?",
          "q3.ex1":"Örnek A: “%20 artış bile kaliteyi düşürür.”",
          "q3.ex2":"Örnek B: “Artış kontrol edilebilir.”",
          "q4.t":"Güç ve sorumluluk kopuk",
          "q4.d":"Sonucu taşımayan biri mi karar veriyor?",
          "q4.ex1":"Örnek A: “Başka biri karar veriyor, ben bedelini ödüyorum.”",
          "q4.ex2":"Örnek B: “Karar veren sonucu da taşır.”",
          "q5.t":"Enerji / hatalar entegre edilmiyor",
          "q5.d":"Stres artıyor ve hatalar tekrar mı ediyor?",
          "q5.ex1":"Örnek A: “Yorgunluk var, aynı hatalar geri geliyor.”",
          "q5.ex2":"Örnek B: “Dinlenme & öğrenme ritmi var.”",
          "r.h":"Sonuç",
          "r.primary":"Birincil instabilite",
          "r.path":"Yol",
          "viz.radar":"Radar",
          "viz.radar2":"Boyutlara göre gerilim",
          "viz.tensions":"Gerilimler",
          "viz.tensions2":"İlk neresi kırılır?",
          "moves.now":"Şimdi 3 hamle",
          "moves.week":"Bu hafta 3 hamle",
          "prec.pill":"Kesinleştirme sorusu",
          "prec.answer":"Cevabın",
          "prec.skip":"Atla",
          "prec.apply":"Uygula",
          "rep.pill":"Executive Report",
          "footer.tag":"Stabilizasyon ve yeniden kurulum için yapı teşhisi.",
          "footer.top":"Yukarı"
        },
        en: {
          "nav.how":"How it works",
          "nav.dx":"Diagnosis",
          "nav.history":"History",
          "cta.backHome":"Home",
          "dx.h1":"Diagnosis",
          "dx.sub":"Decision confidence in minutes: Quick scan → Result → Executive Report.",
          "ex.title":"Examples",
          "cta.next":"Next",
          "cta.back":"Back",
          "cta.calc":"Calculate result",
          "cta.recalc":"Recalculate",
          "cta.exec":"Executive Report",
          "s1.h":"1) Describe your case in one sentence",
          "s1.p":"No story. We need the core to reveal structure.",
          "s1.label":"Context (1 sentence)",
          "s1.ex1":"“I often argue with my partner about small things.”",
          "s1.ex2":"“In the team, the boss decides everything; deliveries are unreliable.”",
          "s2.h":"2) What do you want now?",
          "s2.p":"Stabilize = reduce tension and regain control. Redesign = rebuild architecture.",
          "s2.a":"Stabilize",
          "s2.a2":"Bring calm fast, stop errors, reduce load.",
          "s2.b":"Redesign",
          "s2.b2":"Rebuild decisions, roles, interfaces, rhythm.",
          "s2.ex1":"Stabilize: “We’re in chaos — stop, sort, prioritize first.”",
          "s2.ex2":"Redesign: “This cannot continue — responsibilities & decision paths must change.”",
          "s3.h":"3) Quick Scan (strict, clear, precise)",
          "s3.p":"Move the slider to match reality today. 0 = safe · 10 = critical.",
          "q1.t":"Decisions are bound to one person",
          "q1.d":"How much does progress depend on one person?",
          "q1.ex1":"Example A: “Without them, nothing moves.”",
          "q1.ex2":"Example B: “It runs even without them.”",
          "q2.t":"Load is unfair / concentrated",
          "q2.d":"Do a few roles carry too much load (time, stress, responsibility)?",
          "q2.ex1":"Example A: “1–2 people burn out, everyone asks them.”",
          "q2.ex2":"Example B: “Work is distributed; backup works.”",
          "q3.t":"Growth / complexity overwhelms structure",
          "q3.d":"Does +load immediately create chaos?",
          "q3.ex1":"Example A: “+20% flips quality.”",
          "q3.ex2":"Example B: “More load stays controlled.”",
          "q4.t":"Power and responsibility are decoupled",
          "q4.d":"Does someone decide who doesn’t carry consequences?",
          "q4.ex1":"Example A: “Others decide; I pay the price.”",
          "q4.ex2":"Example B: “Decision-makers carry consequences.”",
          "q5.t":"Energy / errors are not integrated",
          "q5.d":"Does stress rise and do errors repeat?",
          "q5.ex1":"Example A: “Tiredness; the same errors repeat.”",
          "q5.ex2":"Example B: “Recovery & learning are built-in.”",
          "r.h":"Result",
          "r.primary":"Primary instability",
          "r.path":"Path",
          "viz.radar":"Radar",
          "viz.radar2":"Structural tension per dimension",
          "viz.tensions":"Tensions",
          "viz.tensions2":"Where it breaks first",
          "moves.now":"3 moves now",
          "moves.week":"3 moves this week",
          "prec.pill":"Precision question",
          "prec.answer":"Your answer",
          "prec.skip":"Skip",
          "prec.apply":"Apply answer",
          "rep.pill":"Executive Report",
          "footer.tag":"Structural diagnosis for stabilization and redesign.",
          "footer.top":"Top"
        }
      };

      function lang(){
        return localStorage.getItem(K.K_LANG) || "de";
      }

      function t(key){
        const l = lang();
        return dict[l]?.[key] || dict.de[key] || key;
      }

      function applyLang(){
        const l = lang();
        document.documentElement.lang = l;
        $$("[data-lang]").forEach(b => b.setAttribute("aria-pressed", String(b.dataset.lang === l)));
        $$("[data-i18n]").forEach(el => {
          const key = el.dataset.i18n;
          const val = dict[l]?.[key];
          if (!val) return;
          if (el.children && el.children.length) return;
          el.textContent = val;
        });
      }

      $$("[data-lang]").forEach(btn => btn.addEventListener("click", () => {
        localStorage.setItem(K.K_LANG, btn.dataset.lang);
        applyLang();
        // rerender viz labels if needed
        if (window.__MDG_VIZ__) window.__MDG_VIZ__.rerender();
      }));

      // ======= Mode bootstrap =======
      function getMode(){
        const qs = new URLSearchParams(location.search);
        const qmode = qs.get("mode");
        const stored = localStorage.getItem(K.K_MODE);
        const mode = qmode || stored || "private";
        localStorage.setItem(K.K_MODE, mode);
        return mode;
      }

      const mode = getMode();
      $("#dx_mode_badge").textContent = mode === "business" ? "Business" : "Private";

      // If business: token required
      function requireTokenIfBusiness(){
        if (mode !== "business") return true;
        const tok = localStorage.getItem(K.K_TOKEN) || "";
        if (!tok) {
          alert("Business requires token. Please enter token on landing page.");
          location.href = "./index.html";
          return false;
        }
        return true;
      }
      requireTokenIfBusiness();

      // ======= Steps =======
      let intent = "stabilize"; // stabilize|redesign
      let lastScores = null;
      let lastResult = null;
      let precision = { q:null, hint:null };

      function showStep(n){
        $$(".dx-step").forEach(s => s.hidden = true);
        const sec = $(`#step${n}`);
        if (sec) sec.hidden = false;
        updateProgress(n);
        sec?.scrollIntoView({behavior:"smooth", block:"start"});
      }

      function updateProgress(step){
        const pct = Math.round(((step-1)/3)*100);
        $("#dx_prog_i").style.width = pct + "%";
        $("#dx_prog_t").textContent = pct + "%";
      }

      $$("[data-stepgo]").forEach(b => b.addEventListener("click", () => showStep(Number(b.dataset.stepgo))));

      $("#go2").addEventListener("click", () => {
        const s = ($("#dx_context").value || "").trim();
        if (s.length < 8) { alert("Please enter a short context sentence."); return; }
        showStep(2);
      });
      $("#back1").addEventListener("click", () => showStep(1));
      $("#back2").addEventListener("click", () => showStep(2));
      $("#go3").addEventListener("click", () => showStep(3));

      $$(".choice2__btn").forEach(btn => btn.addEventListener("click", () => {
        $$(".choice2__btn").forEach(x => x.style.borderColor = "rgba(255,255,255,.12)");
        btn.style.borderColor = "rgba(110,231,183,.55)";
        intent = btn.dataset.intent || "stabilize";
      }));

      // ======= Slider sync =======
      const pairs = [["q1","v1"],["q2","v2"],["q3","v3"],["q4","v4"],["q5","v5"]];
      pairs.forEach(([qid, vid]) => {
        const q = document.getElementById(qid);
        const v = document.getElementById(vid);
        if (q && v) {
          v.textContent = q.value;
          q.addEventListener("input", () => v.textContent = q.value);
        }
      });

      // ======= Scoring (local quick result) =======
      function quickScore(){
        const a = Number($("#q1").value); // decision monop
        const b = Number($("#q2").value); // load
        const c = Number($("#q3").value); // growth
        const d = Number($("#q4").value); // power mismatch
        const e = Number($("#q5").value); // energy/errors

        const scores = { D:a, L:b, G:c, M:d, EF:e };
        return scores;
      }

      function classify(scores){
        const entries = Object.entries(scores).map(([k,v]) => ({k, v:Number(v)}));
        entries.sort((x,y)=> y.v - x.v);
        const primary = entries[0];
        const secondary = entries[1];

        const growth = scores.G;
        const ADG_trigger = (scores.G >= 6) || (scores.D >= 7) || (scores.L >= 7) || (scores.M >= 7);
        const EF_red = scores.EF >= 7;

        let path = "IDG";
        let pathWhy = "";
        if (ADG_trigger && EF_red) { path = "IDG → ADG"; pathWhy = "Stabilisieren (Energie/Fehler), danach Architektur-Umbau."; }
        else if (ADG_trigger) { path = "ADG"; pathWhy = "Umbau erforderlich: Struktur muss Last/Wachstum/Mismatch tragen."; }
        else if (EF_red) { path = "IDG"; pathWhy = "Stabilisierung zuerst (Energie/Fehler), dann neu bewerten."; }
        else { path = "IDG"; pathWhy = "Stabilisierung reicht vermutlich; Umbau optional je nach Ziel."; }

        return { primary, secondary, path, pathWhy, growth };
      }

      function labelType(k){
        const L = lang();
        const map = {
          D:{ de:["Entscheidungsmonopol","Zu viel hängt an einer Person, ohne klare Delegation/Vertretung."],
              tr:["Karar tekeli","Fazla şey tek kişiye bağlı, devir/vekâlet net değil."],
              en:["Decision monopoly","Too much depends on one person; delegation/backup is unclear."]},
          L:{ de:["Lastasymmetrie","Zu viel Last auf wenigen Rollen → Engpass & Ausfallrisiko."],
              tr:["Yük asimetrisi","Yük birkaç rolde yoğun → darboğaz ve kopma riski."],
              en:["Load asymmetry","Load concentrates on few roles → bottleneck & failure risk."]},
          G:{ de:["Wachstum ohne Struktur","Mehr Last/Komplexität kippt sofort Qualität oder Tempo."],
              tr:["Yapısız büyüme","Daha fazla yük/karmaşıklık kaliteyi veya hızı hemen düşürür."],
              en:["Growth without structure","More load/complexity quickly flips quality or speed."]},
          M:{ de:["Macht–Verantwortungs-Mismatch","Wer entscheidet, trägt nicht sauber Risiko/Konsequenz."],
              tr:["Güç–sorumluluk uyumsuzluğu","Karar veren risk/sonucu net taşımıyor."],
              en:["Power–responsibility mismatch","Decision power is not coupled to risk/consequences."]},
          EF:{ de:["Energie/Fehlerintegration","Stress steigt, Fehler wiederholen sich, Lernen fehlt."],
               tr:["Enerji/hata entegrasyonu","Stres artıyor, hatalar tekrarlanıyor, öğrenme yok."],
               en:["Energy/error integration","Stress rises, errors repeat, learning is missing."]},
        };
        const it = map[k] || null;
        if (!it) return { title:"—", why:"—" };
        const [title, why] = it[L] || it.de;
        return { title, why };
      }

      function buildMoves(scores, classif){
        const now = [];
        const week = [];

        // EF first
        if (scores.EF >= 7){
          now.push(t("moves.now") === "3 Moves jetzt" ? "48h: keine irreversiblen Entscheidungen (Fehler-Puffer)." : "48h: irreversible karar yok (hata tamponu).");
          now.push("Top-3 Prioritäten, Rest pausieren (Last senken).");
          now.push("Täglicher 10-Min Review: Frühindikatoren + Stop-Liste.");
          week.push("Fixer Rhythmus: Schlaf/Erholung + Messpunkt (0–10 täglich).");
          week.push("Fehlerlog: 1 Root Cause / Woche, ohne Schuldzuweisung.");
          week.push("Entscheidungsregeln für Low-Energy-Zeiten definieren.");
        }

        const pk = classif.primary.k;

        if (pk === "D"){
          now.push("Decision Triage: nur 3 Entscheidungen/Woche zentral – Rest delegieren.");
          now.push("A/B/C-Klassen: kritisch/strategisch/operativ definieren.");
          week.push("Delegationsmatrix + Stellvertretung für kritische Entscheidungen.");
          week.push("Entscheidungslog (Owner, Grund, Review-Datum).");
          week.push("Eskalationspfad in 3 Stufen (klar, kurz).");
        }
        if (pk === "L"){
          now.push("Engpass benennen + 2 Aufgaben sofort abgeben.");
          now.push("Backup für Kernaufgaben festlegen (SPOF-Schutz).");
          week.push("3 Kernprozesse als Checklisten dokumentieren.");
          week.push("20% Last umschichten (konkret: wer übernimmt was).");
          week.push("Kapazitätsgrenze: was ab heute nicht mehr angenommen wird.");
        }
        if (pk === "G"){
          now.push("Wachstum drosseln: keine neue Komplexität bis Struktur nachzieht.");
          now.push("Schnittstellen reduzieren: 1–2 Übergabepunkte definieren.");
          week.push("Koordinationsrhythmus (Weekly) + klarer Output pro Meeting.");
          week.push("Komplexitätsbudget (Tabu-Liste) definieren.");
          week.push("Skalierungsregel: Wachstum nur bei erfüllten Strukturkriterien.");
        }
        if (pk === "M"){
          now.push("Mismatch sichtbar: Entscheidung vs Risiko vs Info vs Konsequenz auflisten.");
          now.push("Owner + Konsequenz koppeln (eine Person, ein Ergebnis).");
          week.push("Rollenrechte dokumentieren (entscheidet/führt aus/prüft).");
          week.push("Accountability-Kennzahl je Rolle definieren.");
          week.push("Delegation + Eskalation (kurz) festlegen.");
        }
        if (pk === "EF"){
          now.push("Belastung/Regeneration messen: 0–10 täglich + Trend.");
          now.push("Fehler ohne Sanktion: 1 Kanal/Format definieren.");
          week.push("Weekly Review + Root Cause fix einführen.");
          week.push("Lessons Learned: 3 Bullet Points/Woche.");
          week.push("Schutzregel: keine Entscheidungen im Energieminimum.");
        }

        const dedupe = (arr)=> Array.from(new Set(arr)).filter(Boolean);
        const take3 = (arr)=> dedupe(arr).slice(0,3);
        return { now: take3(now), week: take3(week) };
      }

      // ======= SVG VIZ =======
      function renderRadarSVG(scores){
        // scores 0..10
        const dims = [
          {k:"D", label: (lang()==="tr"?"Karar":"Decision"), v:scores.D},
          {k:"L", label: (lang()==="tr"?"Yük":"Load"), v:scores.L},
          {k:"G", label: (lang()==="tr"?"Büyüme":"Growth"), v:scores.G},
          {k:"M", label: (lang()==="tr"?"Güç":"Power"), v:scores.M},
          {k:"EF",label: (lang()==="tr"?"Enerji":"Energy"), v:scores.EF},
        ];

        const W = 360, H = 300;
        const cx = 180, cy = 150;
        const r = 110;

        const rings = [0.25,0.5,0.75,1.0];

        const pts = dims.map((d, i) => {
          const ang = (-Math.PI/2) + (i * (2*Math.PI/dims.length));
          const rr = (d.v/10) * r;
          return { x: cx + Math.cos(ang)*rr, y: cy + Math.sin(ang)*rr };
        });

        const poly = pts.map(p => `${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(" ");

        const axes = dims.map((d,i)=>{
          const ang = (-Math.PI/2) + (i * (2*Math.PI/dims.length));
          const x = cx + Math.cos(ang)*r;
          const y = cy + Math.sin(ang)*r;
          const lx = cx + Math.cos(ang)*(r+22);
          const ly = cy + Math.sin(ang)*(r+22);
          return { x, y, lx, ly, label:d.label };
        });

        const svg =
`<svg viewBox="0 0 ${W} ${H}" width="100%" height="300" role="img" aria-label="Radar">
  <defs>
    <linearGradient id="g1" x1="0" x2="1">
      <stop offset="0" stop-color="rgba(110,231,183,.85)"/>
      <stop offset="1" stop-color="rgba(96,165,250,.85)"/>
    </linearGradient>
  </defs>

  <rect x="0" y="0" width="${W}" height="${H}" rx="18" fill="rgba(255,255,255,.02)" stroke="rgba(255,255,255,.08)"/>

  ${rings.map(fr=>{
      const rr = r*fr;
      // regular polygon ring
      const ringPts = dims.map((d,i)=>{
        const ang = (-Math.PI/2) + (i * (2*Math.PI/dims.length));
        const x = cx + Math.cos(ang)*rr;
        const y = cy + Math.sin(ang)*rr;
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(" ");
      return `<polygon points="${ringPts}" fill="none" stroke="rgba(255,255,255,.08)" stroke-dasharray="${fr<1? "3 5":"0"}"/>`;
    }).join("\n")}

  ${axes.map(a=> `<line x1="${cx}" y1="${cy}" x2="${a.x.toFixed(1)}" y2="${a.y.toFixed(1)}" stroke="rgba(255,255,255,.10)"/>`).join("\n")}

  <polygon points="${poly}" fill="url(#g1)" opacity="0.26" stroke="rgba(110,231,183,.75)" stroke-width="2"/>
  ${pts.map(p=> `<circle cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="3.8" fill="rgba(234,240,255,.95)" opacity=".9"/>`).join("\n")}

  ${axes.map(a => `
    <text x="${a.lx.toFixed(1)}" y="${a.ly.toFixed(1)}" fill="rgba(234,240,255,.75)"
          font-size="12" font-weight="700" text-anchor="middle" dominant-baseline="middle">${esc(a.label)}</text>
  `).join("\n")}
</svg>`;
        $("#radar_mount").innerHTML = svg;
      }

      function renderBarsSVG(scores){
        const items = [
          {k:"D", t: labelType("D").title, v:scores.D},
          {k:"L", t: labelType("L").title, v:scores.L},
          {k:"G", t: labelType("G").title, v:scores.G},
          {k:"M", t: labelType("M").title, v:scores.M},
          {k:"EF",t: labelType("EF").title, v:scores.EF},
        ].sort((a,b)=> b.v - a.v);

        const W=520, rowH=42, H= items.length*rowH + 30;
        const x0=170, barW=300;

        const svgRows = items.map((it, idx)=>{
          const y = 20 + idx*rowH;
          const w = Math.round((it.v/10)*barW);
          const danger = it.v >= 8;
          const stroke = danger ? "rgba(248,113,113,.55)" : "rgba(110,231,183,.35)";
          const fill = danger ? "rgba(248,113,113,.18)" : "rgba(110,231,183,.16)";
          return `
            <text x="20" y="${y+14}" fill="rgba(234,240,255,.80)" font-size="12" font-weight="800">${esc(it.t)}</text>
            <rect x="${x0}" y="${y}" width="${barW}" height="18" rx="9" fill="rgba(255,255,255,.04)" stroke="rgba(255,255,255,.08)"></rect>
            <rect x="${x0}" y="${y}" width="${w}" height="18" rx="9" fill="${fill}" stroke="${stroke}"></rect>
            <text x="${x0+barW+12}" y="${y+14}" fill="rgba(234,240,255,.72)" font-size="12" font-weight="900">${it.v}/10</text>
          `;
        }).join("\n");

        const svg =
`<svg viewBox="0 0 ${W} ${H}" width="100%" height="${H}" role="img" aria-label="Tensions">
  <rect x="0" y="0" width="${W}" height="${H}" rx="18" fill="rgba(255,255,255,.02)" stroke="rgba(255,255,255,.08)"/>
  ${svgRows}
</svg>`;
        $("#bars_mount").innerHTML = svg;
      }

      window.__MDG_VIZ__ = {
        rerender(){
          if (lastScores) {
            renderRadarSVG(lastScores);
            renderBarsSVG(lastScores);
          }
        }
      };

      // ======= Render result =======
      function renderResult(scores){
        lastScores = scores;
        const c = classify(scores);
        lastResult = c;

        const p = labelType(c.primary.k);
        $("#r_primary").textContent = p.title;
        $("#r_primary_why").textContent = p.why;

        $("#r_path").textContent = c.path;
        $("#r_path_why").textContent = c.pathWhy;

        $("#r_sub").textContent = `Mode: ${mode} · Intent: ${intent}`;

        // moves
        const mv = buildMoves(scores, c);
        $("#moves_now").innerHTML = mv.now.map(x => `<li>${esc(x)}</li>`).join("");
        $("#moves_week").innerHTML = mv.week.map(x => `<li>${esc(x)}</li>`).join("");

        // viz
        renderRadarSVG(scores);
        renderBarsSVG(scores);
      }

      // ======= Calculate =======
      $("#calc").addEventListener("click", () => {
        const s = quickScore();
        renderResult(s);
        showStep(4);

        // After quick result: ask worker for 1 precision question (optional)
        requestPrecisionQuestion().catch(()=>{});
      });

      $("#recalc").addEventListener("click", () => showStep(3));

      // ======= Precision question (worker) =======
      async function requestPrecisionQuestion(){
        $("#prec_block").style.display = "none";
        precision = { q:null, hint:null };

        const token = localStorage.getItem(K.K_TOKEN) || null;
        const payload = {
          mode,
          lang: lang(),
          intent,
          context_sentence: ($("#dx_context").value || "").trim(),
          quick_scores: lastScores,
          token
        };

        const res = await fetch(`${API_BASE}/api/gpt/precision`, {
          method:"POST",
          headers: {
            "Content-Type":"application/json",
            ...(token ? {"Authorization": `Bearer ${token}`} : {})
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(()=> ({}));
        if (!res.ok) return;

        if (data && data.question) {
          precision.q = data.question;
          precision.hint = data.hint || "";
          $("#prec_q").textContent = data.question;
          $("#prec_hint").textContent = data.hint || "";
          $("#prec_a").value = "";
          $("#prec_block").style.display = "block";
        }
      }

      $("#prec_skip").addEventListener("click", () => {
        $("#prec_block").style.display = "none";
      });

      $("#prec_apply").addEventListener("click", async () => {
        const ans = ($("#prec_a").value || "").trim();
        $("#prec_block").style.display = "none";
        if (!ans) return;
        // Store it in memory for report call
        precision.answer = ans;
      });

      // ======= Executive report (worker gpt-4o) =======
      $("#exec").addEventListener("click", async () => {
        $("#report_block").style.display = "block";
        $("#rep_status").textContent = "…";
        $("#rep_html").innerHTML = "";

        const token = localStorage.getItem(K.K_TOKEN) || null;

        const payload = {
          mode,
          lang: lang(),
          intent,
          context_sentence: ($("#dx_context").value || "").trim(),
          quick_scores: lastScores,
          classification: lastResult,
          precision_question: precision.q,
          precision_answer: precision.answer || null,
          // You can later add more structured answers here.
        };

        try {
          const res = await fetch(`${API_BASE}/api/gpt/diagnose`, {
            method:"POST",
            headers: {
              "Content-Type":"application/json",
              ...(token ? {"Authorization": `Bearer ${token}`} : {})
            },
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(()=> ({}));
          if (!res.ok) throw new Error(data?.error || "report_failed");

          // Render markdown-ish to HTML (safe-ish minimal)
          const html = mdLiteToHtml(String(data.report_markdown || ""));
          $("#rep_status").textContent = data.status || "OK";
          $("#rep_html").innerHTML = html;

          // if worker returns refined scores, rerender
          if (data.refined_scores) {
            renderResult(data.refined_scores);
          }
        } catch (e) {
          $("#rep_status").textContent = "Fehler: " + (e?.message || String(e));
        }
      });

      function mdLiteToHtml(md){
        // Minimal markdown renderer: headings, bullets, paragraphs.
        const lines = md.split(/\r?\n/);
        const out = [];
        let inUl = false;

        const closeUl = () => { if (inUl) { out.push("</ul>"); inUl=false; } };

        for (const raw of lines){
          const line = raw.trim();
          if (!line){
            closeUl();
            continue;
          }
          if (line.startsWith("### ")){
            closeUl();
            out.push(`<h3>${esc(line.slice(4))}</h3>`);
            continue;
          }
          if (line.startsWith("## ")){
            closeUl();
            out.push(`<h2>${esc(line.slice(3))}</h2>`);
            continue;
          }
          if (line.startsWith("# ")){
            closeUl();
            out.push(`<h1>${esc(line.slice(2))}</h1>`);
            continue;
          }
          if (line.startsWith("- ")){
            if (!inUl){ out.push("<ul>"); inUl=true; }
            out.push(`<li>${esc(line.slice(2))}</li>`);
            continue;
          }
          closeUl();
          out.push(`<p>${esc(line)}</p>`);
        }
        closeUl();
        return out.join("\n");
      }

      // init
      applyLang();
      showStep(1);
    })();
  </script>
</body>
</html>
