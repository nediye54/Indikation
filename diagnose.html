<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagnose – MDG v4</title>
  <meta name="description" content="In wenigen Minuten zur Entscheidungssicherheit." />
  <link rel="stylesheet" href="./style.css" />

  <style>
    .dx-wrap{ max-width:1100px; margin:0 auto; padding:40px 20px 80px; }
    .dx-grid{ display:grid; gap:18px; }
    .dx-field{ display:grid; gap:6px; }
    .dx-label{ font-weight:700; }
    .dx-help{ font-size:13px; opacity:.7; line-height:1.4; }
    .dx-rangeRow{ display:flex; gap:14px; align-items:center; }
    .dx-rangeVal{ width:28px; text-align:right; font-weight:800; }
    .dx-divider{ height:1px; background:rgba(255,255,255,.08); margin:16px 0; }
    .dx-output pre{ white-space:pre-wrap; }
    .dx-report{ margin-top:20px; display:none; }
    .dx-actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .pill{ padding:6px 10px; border-radius:20px; font-size:12px; background:rgba(255,255,255,.08); }
  </style>
</head>

<body>

<header class="header">
  <div class="container header__inner">
    <a href="./index.html" class="brand">
      <span class="brand__mark">MDG</span>
      <span>v4</span>
    </a>
  </div>
</header>

<main>
  <div class="dx-wrap">

    <h1>Diagnose</h1>
    <p>In wenigen Minuten zur Entscheidungssicherheit.</p>

    <div class="card dx-grid">

      <div class="dx-field">
        <div class="dx-label">Modus</div>
        <div style="display:flex; gap:10px;">
          <span id="modeBadge" class="pill">–</span>
          <span id="tokenBadge" class="pill" style="display:none;">Token ✓</span>
        </div>
      </div>

      <div class="dx-field">
        <label class="dx-label">Ziel</label>
        <select id="goalSelect" class="dx-input">
          <option value="stabilize">Stabilisieren</option>
          <option value="rebuild">Umbauen</option>
        </select>
      </div>

      <div class="dx-field">
        <label class="dx-label">Situation in einem Satz</label>
        <input id="oneLiner" class="dx-input" maxlength="160" placeholder="…" />
      </div>

      <div class="dx-divider"></div>

      <h3>Quick Scan</h3>

      <div class="dx-field">
        <div>Last / Engpässe</div>
        <div class="dx-rangeRow">
          <input id="sLoad" type="range" min="0" max="6" step="1" value="2" />
          <div id="vLoad" class="dx-rangeVal">2</div>
        </div>
      </div>

      <div class="dx-field">
        <div>Entscheidungsarchitektur</div>
        <div class="dx-rangeRow">
          <input id="sDecisions" type="range" min="0" max="6" step="1" value="2" />
          <div id="vDecisions" class="dx-rangeVal">2</div>
        </div>
      </div>

      <div class="dx-field">
        <div>Energie / Fehlerkultur</div>
        <div class="dx-rangeRow">
          <input id="sEnergy" type="range" min="0" max="6" step="1" value="2" />
          <div id="vEnergy" class="dx-rangeVal">2</div>
        </div>
      </div>

      <div class="dx-field">
        <div>Wachstumsdruck</div>
        <div class="dx-rangeRow">
          <input id="sGrowth" type="range" min="0" max="6" step="1" value="2" />
          <div id="vGrowth" class="dx-rangeVal">2</div>
        </div>
      </div>

      <div class="dx-field">
        <div>Macht–Verantwortung</div>
        <div class="dx-rangeRow">
          <input id="sPower" type="range" min="0" max="6" step="1" value="2" />
          <div id="vPower" class="dx-rangeVal">2</div>
        </div>
      </div>

      <div class="dx-divider"></div>

      <div class="dx-actions">
        <button id="runBtn" class="btn btn--primary">Diagnose starten</button>
        <button id="resetBtn" class="btn btn--ghost">Zurücksetzen</button>
        <span id="statusLine">Status: bereit</span>
      </div>

      <div style="display:flex; gap:10px; margin-top:10px;">
        <span id="kpiPrimary" class="pill">Primary: –</span>
        <span id="kpiPath" class="pill">Path: –</span>
        <span id="kpiRisk" class="pill">Risk: –</span>
      </div>

    </div>

    <div class="card dx-output" style="margin-top:30px;">
      <h3>Assessment</h3>
      <pre id="resultText">–</pre>
    </div>

    <div class="card dx-report">
      <h3>Executive Report</h3>

      <div class="dx-actions">
        <button id="execBtn" class="btn btn--primary">
          Executive Report erzeugen
        </button>

        <button id="copyExecBtn" class="btn btn--ghost" disabled>
          Kopieren
        </button>

        <button id="pdfBtn" class="btn btn--ghost">
          Premium PDF
        </button>
      </div>

      <pre id="execText" style="margin-top:15px;">–</pre>
    </div>

  </div>
</main>

<script>
(() => {

  const API_BASE = "https://api.mdg-indikation.de";

  const $ = (id) => document.getElementById(id);

  // -----------------------------
  // MODE + TOKEN LOGIC (STABIL)
  // -----------------------------

  const params = new URLSearchParams(window.location.search);
  const modeParam = (params.get("mode") || "").toLowerCase();

  const storedMode =
    sessionStorage.getItem("mdg_mode") ||
    localStorage.getItem("mdg_mode") ||
    "private";

  const businessOk =
    sessionStorage.getItem("mdg_business_ok") === "1" ||
    localStorage.getItem("mdg_business_ok") === "1";

  const storedToken =
    sessionStorage.getItem("mdg_business_token") ||
    localStorage.getItem("mdg_business_token") ||
    localStorage.getItem("mdg_token") ||
    "";

  const wantsBusiness =
    modeParam === "business" || storedMode === "business";

  const mode =
    wantsBusiness && businessOk ? "business" : "private";

  $("modeBadge").textContent =
    mode === "business" ? "Business" : "Private";

  if (mode === "business" && storedToken) {
    $("tokenBadge").style.display = "";
  }

  // -----------------------------
  // SLIDER SYNC
  // -----------------------------

  function syncSliders() {
    $("vLoad").textContent = $("sLoad").value;
    $("vDecisions").textContent = $("sDecisions").value;
    $("vEnergy").textContent = $("sEnergy").value;
    $("vGrowth").textContent = $("sGrowth").value;
    $("vPower").textContent = $("sPower").value;
  }

  document.querySelectorAll('input[type="range"]')
    .forEach(r => r.addEventListener("input", syncSliders));

  syncSliders();

  // -----------------------------
  // BUILD PAYLOAD
  // -----------------------------

  function buildPayload() {
    return {
      version: "v4",
      mode,
      token: mode === "business" ? storedToken : undefined,
      problem: $("oneLiner").value.trim(),
      intent: $("goalSelect").value,
      answers: {
        quick_scan: {
          load: Number($("sLoad").value),
          decisions: Number($("sDecisions").value),
          energy: Number($("sEnergy").value),
          growth: Number($("sGrowth").value),
          power: Number($("sPower").value)
        }
      }
    };
  }

  async function postJson(path, body) {
    const res = await fetch(API_BASE + path, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      throw new Error(data.error || "Server error");
    }

    return data;
  }

  let LAST_ASSESSMENT = null;

  // -----------------------------
  // RUN ASSESSMENT
  // -----------------------------

  async function runAssessment() {

    const payload = buildPayload();

    if (!payload.problem) {
      alert("Bitte Situation in einem Satz beschreiben.");
      return;
    }

    if (mode === "business" && !payload.token) {
      alert("Business Token fehlt.");
      return;
    }

    $("statusLine").textContent = "Status: läuft …";
    $("resultText").textContent = "–";
    $("execText").textContent = "–";
    $("copyExecBtn").disabled = true;
    document.querySelector(".dx-report").style.display = "none";

    try {
      const data = await postJson("/api/assess", payload);

      LAST_ASSESSMENT = data;

      $("resultText").textContent =
        data.assessment_text || JSON.stringify(data, null, 2);

      $("kpiPrimary").textContent = "Primary: " + (data.primary || "–");
      $("kpiPath").textContent = "Path: " + (data.path || "–");
      $("kpiRisk").textContent = "Risk: " + (data.risk || "–");

      $("statusLine").textContent = "Status: fertig";

    } catch (e) {
      $("statusLine").textContent =
        "Status: Fehler – " + e.message;
    }
  }

  // -----------------------------
  // EXECUTIVE REPORT
  // -----------------------------

  async function runExecutiveReport() {

    if (!LAST_ASSESSMENT) {
      alert("Bitte zuerst Diagnose starten.");
      return;
    }

    $("statusLine").textContent = "Status: Report wird erstellt …";
    $("execText").textContent = "–";

    try {

      const payload = buildPayload();
      payload.assessment = LAST_ASSESSMENT;

      const data = await postJson("/api/report", payload);

      $("execText").textContent =
        data.report_markdown || JSON.stringify(data, null, 2);

      $("copyExecBtn").disabled = false;
      document.querySelector(".dx-report").style.display = "block";

      $("statusLine").textContent = "Status: Report fertig";

    } catch (e) {
      $("statusLine").textContent =
        "Status: Fehler – " + e.message;
    }
  }

  // -----------------------------
  // COPY
  // -----------------------------

  async function copyExec() {
    const txt = $("execText").textContent;
    if (!txt || txt === "–") return;

    try {
      await navigator.clipboard.writeText(txt);
      $("statusLine").textContent = "Status: kopiert";
    } catch {}
  }

  // -----------------------------
  // RESET
  // -----------------------------

  function resetAll() {
    $("oneLiner").value = "";
    $("goalSelect").value = "stabilize";

    ["sLoad","sDecisions","sEnergy","sGrowth","sPower"]
      .forEach(id => $(id).value = 2);

    syncSliders();

    LAST_ASSESSMENT = null;

    $("resultText").textContent = "–";
    $("execText").textContent = "–";
    $("copyExecBtn").disabled = true;

    document.querySelector(".dx-report").style.display = "none";

    $("kpiPrimary").textContent = "Primary: –";
    $("kpiPath").textContent = "Path: –";
    $("kpiRisk").textContent = "Risk: –";

    $("statusLine").textContent = "Status: bereit";
  }

  // -----------------------------
  // PDF (STABIL FALLBACK)
  // -----------------------------

  function exportPDF() {
    window.print();
  }

  // -----------------------------
  // EVENT LISTENERS (SAFE)
  // -----------------------------

  $("runBtn").addEventListener("click", runAssessment);
  $("execBtn").addEventListener("click", runExecutiveReport);
  $("copyExecBtn").addEventListener("click", copyExec);
  $("resetBtn").addEventListener("click", resetAll);
  $("pdfBtn").addEventListener("click", exportPDF);

})();
</script>

</body>
</html>
