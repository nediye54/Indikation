<!-- diagnose.html (V4) — COMPLETE FILE (private/business separated + token only for business) -->
<!doctype html>
<html lang="en" data-mode="private">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MDG – Diagnosis</title>
  <meta name="description" content="MDG Diagnosis: detect instability early, diagnose causes precisely, decide Stabilize vs Rebuild." />
  <link rel="stylesheet" href="./style.css" />
  <style>
    /* Minimal page-only styling (keeps your style.css as primary) */
    .dx-wrap{ max-width:1100px; margin:0 auto; padding:24px; }
    .dx-topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
    .dx-brand{ display:flex; align-items:center; gap:10px; }
    .dx-chip{ border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); color:inherit; border-radius:999px; padding:8px 12px; cursor:pointer; }
    .dx-chip[aria-pressed="true"]{ border-color:rgba(110,231,183,.35); box-shadow:0 0 0 3px rgba(110,231,183,.10); }
    .dx-card{ border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18); border-radius:18px; padding:18px; }
    .dx-grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width: 980px){ .dx-grid{ grid-template-columns:1fr; } }
    .dx-h1{ font-size:34px; line-height:1.1; margin:0 0 10px; }
    .dx-sub{ opacity:.82; margin:0 0 14px; }
    .dx-row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .dx-row{ grid-template-columns:1fr; } }

    .dx-label{ display:block; font-weight:800; margin:0 0 6px; opacity:.9; }
    .dx-help{ font-size:12px; opacity:.75; margin-top:8px; }
    .dx-help b{ opacity:.95; }
    .dx-text{ width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.03); color:inherit; padding:12px 12px; outline:none; }
    .dx-text:focus{ border-color:rgba(110,231,183,.35); box-shadow:0 0 0 3px rgba(110,231,183,.10); }

    .dx-cta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:14px; }
    .dx-btn{ border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); color:inherit; padding:10px 14px; cursor:pointer; }
    .dx-btn.primary{ border-color:rgba(110,231,183,.40); background:rgba(110,231,183,.15); }
    .dx-btn.danger{ border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.12); }
    .dx-btn:disabled{ opacity:.45; cursor:not-allowed; }

    .dx-sectionTitle{ font-weight:950; margin:0 0 10px; letter-spacing:.2px; }
    .dx-hr{ border:0; border-top:1px solid rgba(255,255,255,.10); margin:14px 0; }

    .q{ padding-top:12px; margin-top:12px; border-top:1px solid rgba(255,255,255,.08); }
    .q:first-child{ border-top:0; padding-top:0; margin-top:0; }
    .q-title{ font-weight:900; margin:0 0 8px; }
    .q-ex{ font-size:12px; opacity:.78; margin:0 0 10px; }
    .q-ex .exline{ display:block; margin-top:3px; }
    .q-sliderRow{ display:flex; align-items:center; gap:10px; }
    .q-slider{ width:100%; }
    .q-val{ min-width:54px; text-align:right; font-variant-numeric: tabular-nums; opacity:.9; font-weight:900; }
    .pill{ display:inline-flex; align-items:center; gap:8px; border:1px solid rgba(255,255,255,.12); border-radius:999px; padding:8px 10px; background:rgba(255,255,255,.04); opacity:.92; }
    .pill small{ opacity:.7; font-weight:800; }
    .dx-kpis{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }

    .dx-result{ display:none; margin-top:14px; }
    .dx-pre{ white-space:pre-wrap; word-break:break-word; border-radius:16px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.25); padding:14px; }

    /* Modal */
    .modalBackdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:18px; z-index:9999; }
    .modal{ max-width:520px; width:100%; border-radius:18px; border:1px solid rgba(255,255,255,.12); background:rgba(10,12,18,.92); backdrop-filter: blur(10px); padding:16px; }
    .modalHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .modalTitle{ font-weight:950; margin:0; }
    .modalClose{ border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); color:inherit; border-radius:12px; padding:6px 10px; cursor:pointer; }
  </style>
</head>

<body>
  <div class="dx-wrap">
    <div class="dx-topbar">
      <div class="dx-brand">
        <div class="pill"><b>MDG</b> <small id="modeBadge">private</small></div>
        <div class="pill"><small id="langBadge">EN</small></div>
      </div>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <button class="dx-chip" type="button" data-lang="de" aria-pressed="false">DE</button>
        <button class="dx-chip" type="button" data-lang="tr" aria-pressed="false">TR</button>
        <button class="dx-chip" type="button" data-lang="en" aria-pressed="true">EN</button>
        <a class="dx-btn" href="./index.html" id="backHome">Home</a>
      </div>
    </div>

    <div class="dx-card">
      <h1 class="dx-h1" data-i18n="h1">In a few minutes to decision certainty.</h1>
      <p class="dx-sub" data-i18n="sub">
        You describe your situation in one sentence, choose “Stabilize” or “Rebuild”, answer a focused scan, and get a premium executive diagnosis.
      </p>

      <div class="dx-row">
        <div>
          <label class="dx-label" for="oneLiner" data-i18n="oneLinerLabel">Describe the situation in one sentence</label>
          <textarea class="dx-text" id="oneLiner" rows="3" placeholder="e.g., ‘Our project is late and everyone is overloaded.’"></textarea>
          <div class="dx-help">
            <b data-i18n="twoExamples">Two examples:</b>
            <span class="exline" data-i18n="oneLinerEx1">• “We keep arguing at home about the same topic every week.”</span>
            <span class="exline" data-i18n="oneLinerEx2">• “Decisions are stuck with me and my team can’t move without approval.”</span>
          </div>
        </div>

        <div>
          <label class="dx-label" data-i18n="goalLabel">What do you want?</label>
          <div class="dx-cta">
            <button class="dx-btn primary" type="button" id="goalStabilize" data-goal="stabilize" aria-pressed="true" data-i18n="stabilize">Stabilize (IDG)</button>
            <button class="dx-btn" type="button" id="goalRebuild" data-goal="rebuild" aria-pressed="false" data-i18n="rebuild">Rebuild (ADG)</button>
          </div>
          <div class="dx-help">
            <b data-i18n="goalExamples">Two examples:</b>
            <span class="exline" data-i18n="goalEx1">• Stabilize: “Stop the bleeding, reduce overload, regain control.”</span>
            <span class="exline" data-i18n="goalEx2">• Rebuild: “Change the structure so the same problems can’t return.”</span>
          </div>

          <hr class="dx-hr" />

          <div class="dx-kpis">
            <div class="pill"><small data-i18n="progress">Progress</small> <b id="progressPct">0%</b></div>
            <div class="pill"><small data-i18n="saved">Autosave</small> <b id="autosaveState">ON</b></div>
          </div>

          <div class="dx-cta" style="margin-top:10px;">
            <button class="dx-btn primary" type="button" id="run" data-i18n="run">Run diagnosis</button>
            <button class="dx-btn" type="button" id="reset" data-i18n="reset">Reset</button>
          </div>
          <div class="dx-help" id="businessHint" style="display:none;">
            <b data-i18n="businessNote">Business mode:</b>
            <span data-i18n="businessNote2">questions and output are optimized for managers, owners, leaders.</span>
          </div>
        </div>
      </div>
    </div>

    <div class="dx-grid" style="margin-top:14px;">
      <div class="dx-card">
        <div class="dx-sectionTitle" data-i18n="scanTitle">Quick scan (sliders)</div>
        <div class="dx-help" style="margin-top:-6px; margin-bottom:10px;" data-i18n="scanSub">
          Move each slider to what feels most true today. 0 = no issue, 10 = critical.
        </div>

        <div id="questions"></div>
      </div>

      <div class="dx-card">
        <div class="dx-sectionTitle" data-i18n="followupTitle">Clarification question (adaptive)</div>
        <div class="dx-help" data-i18n="followupSub">
          After the scan, the engine asks 1 question to increase precision, then finalizes.
        </div>

        <div class="q" id="followupBox" style="display:none;">
          <p class="q-title" id="followupQ">—</p>
          <div id="followupChoices" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
        </div>

        <hr class="dx-hr" />

        <div class="dx-sectionTitle" data-i18n="resultTitle">Strategic assessment</div>
        <div class="dx-help" data-i18n="resultSub">
          Your output appears here after “Run diagnosis”. (Private and Business differ.)
        </div>

        <div class="dx-result" id="resultBox">
          <div class="dx-pre" id="resultText"></div>
          <div class="dx-cta">
            <button class="dx-btn primary" id="execReport" type="button" data-i18n="execReport">Generate Executive Report</button>
            <button class="dx-btn" id="copyReport" type="button" data-i18n="copy">Copy</button>
          </div>
          <div class="dx-help" id="statusLine">Status: —</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Business token modal (only shown in business mode, closable) -->
  <div class="modalBackdrop" id="tokenBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="tokenTitle">
      <div class="modalHead">
        <h3 class="modalTitle" id="tokenTitle" data-i18n="tokenTitle">Business access</h3>
        <button class="modalClose" type="button" id="tokenClose" data-i18n="close">Close</button>
      </div>
      <p class="dx-help" style="margin-top:10px;" data-i18n="tokenInfo">
        Business requires a token. Private mode is free and does not require a token.
      </p>
      <label class="dx-label" for="tokenInput" style="margin-top:12px;" data-i18n="tokenLabel">Token</label>
      <input class="dx-text" id="tokenInput" placeholder="MDG-XXXX-XXXX" />
      <div class="dx-cta">
        <button class="dx-btn primary" type="button" id="tokenSave" data-i18n="continue">Continue</button>
        <button class="dx-btn" type="button" id="tokenToPrivate" data-i18n="switchPrivate">Switch to Private</button>
      </div>
      <div class="dx-help" id="tokenStatus">—</div>
    </div>
  </div>

  <script>
    // =========================================================
    // PATCHES INCLUDED: mode separation + token only for business
    // =========================================================

    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    // ---- API base (your CF custom domain) ----
    const API_BASE = "https://api.mdg-indikation.de"; // keep

    // ===== MODE DETECTION (PRIVATE / BUSINESS) =====
    const mode =
      new URLSearchParams(location.search).get("mode") ||
      localStorage.getItem("mdg_mode") ||
      "private";

    localStorage.setItem("mdg_mode", mode);
    document.documentElement.dataset.mode = mode;
    $("#modeBadge").textContent = mode;
    $("#businessHint").style.display = (mode === "business") ? "block" : "none";

    // ===== Language =====
    const dict = {
      en: {
        h1:"In a few minutes to decision certainty.",
        sub:"You describe your situation in one sentence, choose “Stabilize” or “Rebuild”, answer a focused scan, and get a premium executive diagnosis.",
        oneLinerLabel:"Describe the situation in one sentence",
        twoExamples:"Two examples:",
        oneLinerEx1:"• “We keep arguing at home about the same topic every week.”",
        oneLinerEx2:"• “Decisions are stuck with me and my team can’t move without approval.”",
        goalLabel:"What do you want?",
        stabilize:"Stabilize (IDG)",
        rebuild:"Rebuild (ADG)",
        goalExamples:"Two examples:",
        goalEx1:"• Stabilize: “Stop the bleeding, reduce overload, regain control.”",
        goalEx2:"• Rebuild: “Change the structure so the same problems can’t return.”",
        progress:"Progress",
        saved:"Autosave",
        run:"Run diagnosis",
        reset:"Reset",
        businessNote:"Business mode:",
        businessNote2:"questions and output are optimized for managers, owners, leaders.",
        scanTitle:"Quick scan (sliders)",
        scanSub:"Move each slider to what feels most true today. 0 = no issue, 10 = critical.",
        followupTitle:"Clarification question (adaptive)",
        followupSub:"After the scan, the engine asks 1 question to increase precision, then finalizes.",
        resultTitle:"Strategic assessment",
        resultSub:"Your output appears here after “Run diagnosis”. (Private and Business differ.)",
        execReport:"Generate Executive Report",
        copy:"Copy",
        tokenTitle:"Business access",
        close:"Close",
        tokenInfo:"Business requires a token. Private mode is free and does not require a token.",
        tokenLabel:"Token",
        continue:"Continue",
        switchPrivate:"Switch to Private",
      },
      de: {
        h1:"In wenigen Minuten zur Entscheidungssicherheit.",
        sub:"Du beschreibst dein Thema in einem Satz, wählst „Stabilisieren“ oder „Umbauen“, beantwortest einen fokussierten Scan – und erhältst eine Premium-Diagnose.",
        oneLinerLabel:"Beschreibe die Situation in einem Satz",
        twoExamples:"Zwei Beispiele:",
        oneLinerEx1:"• „Wir streiten zuhause jede Woche über das gleiche Thema.“",
        oneLinerEx2:"• „Entscheidungen hängen bei mir fest und das Team kommt ohne Freigabe nicht weiter.“",
        goalLabel:"Was willst du?",
        stabilize:"Stabilisieren (IDG)",
        rebuild:"Umbauen (ADG)",
        goalExamples:"Zwei Beispiele:",
        goalEx1:"• Stabilisieren: „Überlast stoppen, Druck rausnehmen, Kontrolle zurückholen.“",
        goalEx2:"• Umbauen: „Struktur ändern, damit die gleichen Probleme nicht zurückkommen.“",
        progress:"Fortschritt",
        saved:"Auto-Save",
        run:"Diagnose starten",
        reset:"Zurücksetzen",
        businessNote:"Business-Modus:",
        businessNote2:"Fragen & Output sind auf Manager, Unternehmer, Verantwortliche optimiert.",
        scanTitle:"Quick Scan (Slider)",
        scanSub:"Jeden Slider auf „heute trifft zu“ setzen. 0 = kein Problem, 10 = kritisch.",
        followupTitle:"Klärungsfrage (adaptiv)",
        followupSub:"Nach dem Scan stellt die Engine 1 Frage für mehr Präzision, dann finalisiert sie.",
        resultTitle:"Strategische Einschätzung",
        resultSub:"Output erscheint nach „Diagnose starten“. (Privat/Business unterschiedlich.)",
        execReport:"Executive Report erzeugen",
        copy:"Kopieren",
        tokenTitle:"Business-Zugang",
        close:"Schließen",
        tokenInfo:"Business benötigt Token. Privat ist frei und benötigt keinen Token.",
        tokenLabel:"Token",
        continue:"Weiter",
        switchPrivate:"Zu Privat wechseln",
      },
      tr: {
        h1:"Birkaç dakikada karar netliği.",
        sub:"Konuyu tek cümlede yaz, “Stabilize” veya “Rebuild” seç, kısa taramayı yap ve premium yönetici çıktısını al.",
        oneLinerLabel:"Durumu tek cümlede anlat",
        twoExamples:"İki örnek:",
        oneLinerEx1:"• “Evde her hafta aynı konuda tartışıyoruz.”",
        oneLinerEx2:"• “Kararlar bende kilitleniyor, ekip onaysız ilerleyemiyor.”",
        goalLabel:"Ne istiyorsun?",
        stabilize:"Stabilize (IDG)",
        rebuild:"Rebuild (ADG)",
        goalExamples:"İki örnek:",
        goalEx1:"• Stabilize: “Aşırı yükü azalt, kontrolü geri kazan.”",
        goalEx2:"• Rebuild: “Sorunların geri gelmemesi için yapıyı değiştir.”",
        progress:"İlerleme",
        saved:"Oto-kayıt",
        run:"Analizi başlat",
        reset:"Sıfırla",
        businessNote:"Business modu:",
        businessNote2:"Sorular ve çıktı; yönetici, işletme sahibi ve sorumlular için optimize edilir.",
        scanTitle:"Hızlı tarama (slider)",
        scanSub:"Sliderları bugüne göre ayarla. 0 = sorun yok, 10 = kritik.",
        followupTitle:"Netleştirme sorusu (adaptif)",
        followupSub:"Taramadan sonra 1 soru sorar, sonra sonucu kesinleştirir.",
        resultTitle:"Stratejik değerlendirme",
        resultSub:"“Analizi başlat” sonrası burada görünür. (Private/Business farklı.)",
        execReport:"Executive Report üret",
        copy:"Kopyala",
        tokenTitle:"Business erişimi",
        close:"Kapat",
        tokenInfo:"Business için token gerekir. Private ücretsizdir ve token istemez.",
        tokenLabel:"Token",
        continue:"Devam",
        switchPrivate:"Private’a geç",
      }
    };

    let lang = localStorage.getItem("mdg_lang") || "en";
    function applyLang(next){
      if (!dict[next]) next = "en";
      lang = next;
      localStorage.setItem("mdg_lang", lang);
      $("#langBadge").textContent = lang.toUpperCase();
      $$("[data-lang]").forEach(b => b.setAttribute("aria-pressed", String(b.dataset.lang === lang)));
      $$("[data-i18n]").forEach(el => {
        const key = el.dataset.i18n;
        const val = dict[lang][key];
        if (val) el.textContent = val;
      });
      document.documentElement.lang = lang;
    }
    $$("[data-lang]").forEach(btn => btn.addEventListener("click", () => applyLang(btn.dataset.lang)));
    applyLang(lang);

    // ===== Token gating (ONLY for business) =====
    function showTokenModal(){
      $("#tokenBackdrop").style.display = "flex";
      $("#tokenBackdrop").setAttribute("aria-hidden", "false");
      $("#tokenStatus").textContent = "—";
      $("#tokenInput").value = localStorage.getItem("mdg_token") || "";
      setTimeout(() => $("#tokenInput").focus(), 10);
    }
    function hideTokenModal(){
      $("#tokenBackdrop").style.display = "none";
      $("#tokenBackdrop").setAttribute("aria-hidden", "true");
    }
    $("#tokenClose").addEventListener("click", hideTokenModal);
    $("#tokenToPrivate").addEventListener("click", () => {
      localStorage.setItem("mdg_mode", "private");
      // reload to re-render private set
      location.href = "diagnose.html?mode=private";
    });
    $("#tokenSave").addEventListener("click", () => {
      const t = ($("#tokenInput").value || "").trim();
      if (t.length < 6) { $("#tokenStatus").textContent = "Invalid token."; return; }
      localStorage.setItem("mdg_token", t);
      $("#tokenStatus").textContent = "Saved.";
      hideTokenModal();
    });

    if (mode === "business") {
      const token = localStorage.getItem("mdg_token");
      if (!token) showTokenModal();
    }

    // ===== Goal toggle =====
    let goal = localStorage.getItem("mdg_goal") || "stabilize";
    function setGoal(g){
      goal = g;
      localStorage.setItem("mdg_goal", goal);
      $("#goalStabilize").classList.toggle("primary", goal === "stabilize");
      $("#goalRebuild").classList.toggle("primary", goal === "rebuild");
      $("#goalStabilize").setAttribute("aria-pressed", String(goal === "stabilize"));
      $("#goalRebuild").setAttribute("aria-pressed", String(goal === "rebuild"));
    }
    $("#goalStabilize").addEventListener("click", () => setGoal("stabilize"));
    $("#goalRebuild").addEventListener("click", () => setGoal("rebuild"));
    setGoal(goal);

    // ===== Questions (Private vs Business) =====
    // Slider scale: 0..10 where 10 = critical
    const PRIVATE_QUESTIONS = [
      {
        id:"q_load",
        title: {en:"Overload & pressure", de:"Überlast & Druck", tr:"Aşırı yük & baskı"},
        text: {
          en:"How overloaded are you (or the system) right now?",
          de:"Wie überlastet bist du (oder das System) gerade?",
          tr:"Şu anda ne kadar aşırı yüklüsün (veya sistem)?"
        },
        ex: {
          en:["0: “I feel fine, enough time and energy.”","10: “I’m constantly at the limit, things drop.”"],
          de:["0: „Alles im Rahmen, genug Zeit/Energie.“","10: „Dauerhaft am Limit, Dinge fallen runter.“"],
          tr:["0: “İyi hissediyorum, yeterli zaman/enerji var.”","10: “Sürekli sınırdayım, işler düşüyor.”"]
        }
      },
      {
        id:"q_conflict",
        title:{en:"Conflict & tension", de:"Konflikt & Spannung", tr:"Çatışma & gerilim"},
        text:{
          en:"How much tension/conflict is present?",
          de:"Wie viel Spannung/Konflikt ist vorhanden?",
          tr:"Ne kadar gerilim/çatışma var?"
        },
        ex:{
          en:["0: “Disagreements are rare and resolved quickly.”","10: “Constant fights / cold war / escalation.”"],
          de:["0: „Selten, schnell lösbar.“","10: „Dauerstreit / kalter Krieg / Eskalation.“"],
          tr:["0: “Nadiren, hızlı çözülüyor.”","10: “Sürekli kavga / soğuk savaş / tırmanma.”"]
        }
      },
      {
        id:"q_decisions",
        title:{en:"Decision clarity", de:"Entscheidungsklarheit", tr:"Karar netliği"},
        text:{
          en:"How clear are decisions and next steps?",
          de:"Wie klar sind Entscheidungen und nächste Schritte?",
          tr:"Kararlar ve sonraki adımlar ne kadar net?"
        },
        ex:{
          en:["0: “Clear decisions, action happens.”","10: “Stuck, unclear, looping discussions.”"],
          de:["0: „Klar entschieden, umgesetzt.“","10: „Blockiert, unklar, Endlosschleife.“"],
          tr:["0: “Net karar, aksiyon var.”","10: “Kilitli, belirsiz, döngü.”"]
        }
      },
      {
        id:"q_trust",
        title:{en:"Trust & safety", de:"Vertrauen & Sicherheit", tr:"Güven & güvenlik"},
        text:{
          en:"How safe is it to speak openly (without punishment)?",
          de:"Wie sicher ist Offenheit (ohne Bestrafung)?",
          tr:"Açık konuşmak ne kadar güvenli (ceza yok)?"
        },
        ex:{
          en:["0: “We can speak openly; mistakes are handled calmly.”","10: “People hide, fear, blame dominates.”"],
          de:["0: „Offenheit möglich, Fehler ruhig bearbeitet.“","10: „Verstecken, Angst, Schuld dominiert.“"],
          tr:["0: “Açık konuşulur, hata sakin ele alınır.”","10: “Gizleme, korku, suçlama.”"]
        }
      },
      {
        id:"q_energy",
        title:{en:"Energy & recovery", de:"Energie & Regeneration", tr:"Enerji & toparlanma"},
        text:{
          en:"Are you recovering enough to stay stable?",
          de:"Regenerierst du genug, um stabil zu bleiben?",
          tr:"Stabil kalmak için yeterince toparlanıyor musun?"
        },
        ex:{
          en:["0: “Sleep/rest is good; I recharge.”","10: “No recovery; fatigue accumulates.”"],
          de:["0: „Schlaf/Erholung gut, ich lade auf.“","10: „Keine Regeneration, Müdigkeit wächst.“"],
          tr:["0: “Uyku/dinlenme iyi; şarj oluyorum.”","10: “Toparlanma yok; yorgunluk birikiyor.”"]
        }
      }
    ];

    const BUSINESS_QUESTIONS = [
      {
        id:"b_bottleneck",
        title:{en:"Bottleneck risk (SPOF)", de:"Engpassrisiko (SPOF)", tr:"Darboğaz riski (SPOF)"},
        text:{
          en:"How dependent is execution on one person/role?",
          de:"Wie stark hängt Umsetzung an einer Person/Rolle?",
          tr:"Uygulama tek kişi/role ne kadar bağlı?"
        },
        ex:{
          en:["0: “Work continues even if one key person is absent.”","10: “If X is out, everything stops.”"],
          de:["0: „Auch ohne Schlüsselperson läuft es weiter.“","10: „Wenn X ausfällt, steht alles.“"],
          tr:["0: “Kilit kişi yokken de işler yürür.”","10: “X yoksa her şey durur.”"]
        }
      },
      {
        id:"b_decision_latency",
        title:{en:"Decision latency", de:"Entscheidungsverzug", tr:"Karar gecikmesi"},
        text:{
          en:"How slow are decisions relative to operational tempo?",
          de:"Wie langsam sind Entscheidungen im Verhältnis zum Tempo?",
          tr:"Kararlar iş temposuna göre ne kadar yavaş?"
        },
        ex:{
          en:["0: “Decisions match the speed of the business.”","10: “Waiting kills momentum; approvals block.”"],
          de:["0: „Entscheidungen passen zum Business-Tempo.“","10: „Warten killt Momentum; Freigaben blocken.“"],
          tr:["0: “Kararlar iş hızına uygundur.”","10: “Bekleme ivmeyi öldürür; onay bloklar.”"]
        }
      },
      {
        id:"b_process",
        title:{en:"Process clarity", de:"Prozessklarheit", tr:"Süreç netliği"},
        text:{
          en:"How documented and repeatable are key processes?",
          de:"Wie dokumentiert & wiederholbar sind Kernprozesse?",
          tr:"Kritik süreçler ne kadar dokümante ve tekrarlanabilir?"
        },
        ex:{
          en:["0: “Clear playbooks/checklists exist.”","10: “Mostly tribal knowledge; handoffs fail.”"],
          de:["0: „Playbooks/Checklisten vorhanden.“","10: „Wissen im Kopf; Übergaben scheitern.“"],
          tr:["0: “Playbook/checklist var.”","10: “Bilgi kafada; devirler bozulur.”"]
        }
      },
      {
        id:"b_growth",
        title:{en:"Growth sensitivity", de:"Wachstumssensitivität", tr:"Büyüme hassasiyeti"},
        text:{
          en:"If workload +20%: how close are you to a break?",
          de:"Bei +20% Last: wie nah am Bruch?",
          tr:"İş yükü +%20 olursa: kırılmaya ne kadar yakınsın?"
        },
        ex:{
          en:["0: “We absorb it with small friction.”","10: “Quality collapses / deadlines break.”"],
          de:["0: „Mit wenig Reibung absorbierbar.“","10: „Qualität kollabiert / Deadlines reißen.“"],
          tr:["0: “Az sürtünmeyle absorbe ederiz.”","10: “Kalite çöker / teslimatlar kırılır.”"]
        }
      },
      {
        id:"b_accountability",
        title:{en:"Accountability & ownership", de:"Accountability & Ownership", tr:"Sorumluluk & sahiplik"},
        text:{
          en:"How clear is ‘who owns what’ and consequences?",
          de:"Wie klar ist „wer besitzt was“ inkl. Konsequenzen?",
          tr:"‘Kim neye sahip’ ve sonuçlar ne kadar net?"
        },
        ex:{
          en:["0: “Each area has an owner; outcomes are measured.”","10: “No owner; blame games; unclear metrics.”"],
          de:["0: „Owner je Bereich; Outcome messbar.“","10: „Kein Owner; Schuldspiele; unklare Metriken.“"],
          tr:["0: “Her alanın sahibi var; sonuç ölçülür.”","10: “Sahip yok; suçlama; metrik belirsiz.”"]
        }
      }
    ];

    const QUESTIONS = (mode === "business") ? BUSINESS_QUESTIONS : PRIVATE_QUESTIONS;

    // ===== Storage =====
    const STORAGE_KEY = "mdg_dx_v4";
    function loadState(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); } catch { return {}; }
    }
    function saveState(partial){
      const prev = loadState();
      const next = { ...prev, ...partial, ts: Date.now(), mode, goal, lang };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
      updateProgress();
    }

    // ===== Render questions =====
    function renderQuestions(){
      const state = loadState();
      const wrap = $("#questions");
      wrap.innerHTML = "";

      QUESTIONS.forEach(q => {
        const v = typeof state[q.id] === "number" ? state[q.id] : 0;

        const div = document.createElement("div");
        div.className = "q";
        div.innerHTML = `
          <div class="q-title">${escapeHtml(q.title[lang] || q.title.en)}</div>
          <div style="opacity:.9; margin-bottom:8px;">${escapeHtml(q.text[lang] || q.text.en)}</div>
          <div class="q-ex">
            <span class="exline">${escapeHtml((q.ex[lang] || q.ex.en)[0])}</span>
            <span class="exline">${escapeHtml((q.ex[lang] || q.ex.en)[1])}</span>
          </div>
          <div class="q-sliderRow">
            <input class="q-slider" type="range" min="0" max="10" step="1" value="${v}" data-q="${q.id}">
            <div class="q-val" id="val_${q.id}">${v}/10</div>
          </div>
        `;
        wrap.appendChild(div);
      });

      $$('input[type="range"][data-q]').forEach(r => {
        r.addEventListener("input", () => {
          const id = r.dataset.q;
          const val = Number(r.value);
          $("#val_" + id).textContent = `${val}/10`;
          saveState({ [id]: val });
        });
      });

      updateProgress();
    }

    function updateProgress(){
      const state = loadState();
      const answered = QUESTIONS.filter(q => typeof state[q.id] === "number" && state[q.id] !== 0).length;
      const total = QUESTIONS.length;
      const pct = total ? Math.round((answered / total) * 100) : 0;
      $("#progressPct").textContent = pct + "%";
    }

    // ===== Reset =====
    $("#reset").addEventListener("click", () => {
      if (!confirm("Reset this diagnosis?")) return;
      localStorage.removeItem(STORAGE_KEY);
      $("#oneLiner").value = "";
      setGoal("stabilize");
      $("#followupBox").style.display = "none";
      $("#resultBox").style.display = "none";
      $("#resultText").textContent = "";
      $("#statusLine").textContent = "Status: —";
      renderQuestions();
    });

    // ===== Follow-up (adaptive 1 question) =====
    function buildFollowupQuestion(state){
      // Simple heuristic: pick the highest slider dimension and ask a clarifier
      let top = { id:null, v:-1 };
      QUESTIONS.forEach(q => {
        const v = Number(state[q.id] ?? 0);
        if (v > top.v) top = { id:q.id, v };
      });

      if (!top.id || top.v < 6) {
        // ask about time horizon if no strong signal
        return {
          q: {
            en:"What is your time horizon for change?",
            de:"Wie ist dein Zeithorizont für Veränderung?",
            tr:"Değişim için zaman ufkun nedir?"
          },
          choices: [
            { key:"h1", en:"24–72 hours", de:"24–72 Stunden", tr:"24–72 saat" },
            { key:"h2", en:"2–4 weeks", de:"2–4 Wochen", tr:"2–4 hafta" },
            { key:"h3", en:"2–3 months", de:"2–3 Monate", tr:"2–3 ay" },
          ]
        };
      }

      // mapping from top driver to a clarifying question
      const map = {
        q_load: {
          q:{ en:"Where does overload mainly come from?", de:"Woher kommt die Überlast hauptsächlich?", tr:"Aşırı yükün ana kaynağı nedir?" },
          choices:[
            {key:"o1", en:"Too many tasks", de:"Zu viele Aufgaben", tr:"Çok fazla iş"},
            {key:"o2", en:"Too many decisions", de:"Zu viele Entscheidungen", tr:"Çok fazla karar"},
            {key:"o3", en:"Unclear priorities", de:"Unklare Prioritäten", tr:"Belirsiz öncelikler"},
          ]
        },
        q_decisions: {
          q:{ en:"What blocks decisions most?", de:"Was blockiert Entscheidungen am stärksten?", tr:"Kararları en çok ne bloke ediyor?" },
          choices:[
            {key:"d1", en:"Fear of mistakes", de:"Fehlerangst", tr:"Hata korkusu"},
            {key:"d2", en:"One person must approve", de:"Eine Person muss freigeben", tr:"Tek kişi onaylıyor"},
            {key:"d3", en:"No clear owner", de:"Kein Owner", tr:"Sahip yok"},
          ]
        },
        q_trust: {
          q:{ en:"What happens after a mistake?", de:"Was passiert nach einem Fehler?", tr:"Hata sonrası ne oluyor?" },
          choices:[
            {key:"t1", en:"We learn and improve", de:"Wir lernen & verbessern", tr:"Öğrenir ve iyileştiririz"},
            {key:"t2", en:"We hide or excuse", de:"Wir verstecken/reden raus", tr:"Gizler/mazeret üretiriz"},
            {key:"t3", en:"Blame and punishment", de:"Schuld & Bestrafung", tr:"Suçlama ve ceza"},
          ]
        },
        q_conflict: {
          q:{ en:"What is the conflict mostly about?", de:"Worum geht der Konflikt meist?", tr:"Çatışma çoğunlukla ne hakkında?" },
          choices:[
            {key:"c1", en:"Values / respect", de:"Werte/Respekt", tr:"Değerler/saygı"},
            {key:"c2", en:"Responsibilities", de:"Verantwortung", tr:"Sorumluluk"},
            {key:"c3", en:"Resources / time", de:"Ressourcen/Zeit", tr:"Kaynak/zaman"},
          ]
        },
        q_energy: {
          q:{ en:"What is your strongest recovery lever?", de:"Was ist dein stärkster Regenerationshebel?", tr:"En güçlü toparlanma kaldıraçın nedir?" },
          choices:[
            {key:"e1", en:"Sleep schedule", de:"Schlafrhythmus", tr:"Uyku düzeni"},
            {key:"e2", en:"Load reduction", de:"Last reduzieren", tr:"Yük azaltma"},
            {key:"e3", en:"Boundaries", de:"Grenzen", tr:"Sınırlar"},
          ]
        },
        b_bottleneck: {
          q:{ en:"Which area is the strongest bottleneck?", de:"Wo ist der stärkste Engpass?", tr:"En güçlü darboğaz nerede?" },
          choices:[
            {key:"b1", en:"Approvals", de:"Freigaben", tr:"Onaylar"},
            {key:"b2", en:"Operations execution", de:"Operative Umsetzung", tr:"Operasyon yürütme"},
            {key:"b3", en:"Client delivery", de:"Kundenauslieferung", tr:"Müşteri teslimatı"},
          ]
        },
        b_decision_latency: {
          q:{ en:"What is the main decision choke point?", de:"Wo ist der Haupt-Entscheidungsengpass?", tr:"Ana karar boğazı nerede?" },
          choices:[
            {key:"x1", en:"Founder/CEO", de:"Founder/CEO", tr:"Kurucu/CEO"},
            {key:"x2", en:"Leadership team", de:"Führungsteam", tr:"Yönetim ekibi"},
            {key:"x3", en:"Cross-team coordination", de:"Team-übergreifend", tr:"Ekipler arası"},
          ]
        },
        b_process: {
          q:{ en:"Where do handoffs fail most?", de:"Wo scheitern Übergaben am meisten?", tr:"Devirler en çok nerede bozuluyor?" },
          choices:[
            {key:"p1", en:"Sales → Delivery", de:"Sales → Delivery", tr:"Satış → Teslimat"},
            {key:"p2", en:"Product → Engineering", de:"Produkt → Engineering", tr:"Ürün → Mühendislik"},
            {key:"p3", en:"Ops → Support", de:"Ops → Support", tr:"Operasyon → Destek"},
          ]
        },
        b_growth: {
          q:{ en:"What breaks first under +20% load?", de:"Was bricht zuerst bei +20% Last?", tr:"+%20 yükte ilk ne kırılır?" },
          choices:[
            {key:"g1", en:"Quality", de:"Qualität", tr:"Kalite"},
            {key:"g2", en:"Speed", de:"Geschwindigkeit", tr:"Hız"},
            {key:"g3", en:"Team morale", de:"Moral", tr:"Moral"},
          ]
        },
        b_accountability: {
          q:{ en:"Where is ownership least clear?", de:"Wo ist Ownership am unklarsten?", tr:"Sahiplik en belirsiz nerede?" },
          choices:[
            {key:"a1", en:"Priorities", de:"Prioritäten", tr:"Öncelikler"},
            {key:"a2", en:"KPIs/metrics", de:"KPIs/Metriken", tr:"KPI/metrikler"},
            {key:"a3", en:"Decision rights", de:"Entscheidungsrechte", tr:"Karar yetkileri"},
          ]
        }
      };

      return map[top.id] || map.q_decisions;
    }

    function renderFollowup(fu){
      $("#followupQ").textContent = fu.q[lang] || fu.q.en;
      const choices = $("#followupChoices");
      choices.innerHTML = "";
      fu.choices.forEach(c => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "dx-btn";
        b.textContent = c[lang] || c.en;
        b.addEventListener("click", () => {
          saveState({ followup: c.key });
          // mark selection UI
          $$("#followupChoices .dx-btn").forEach(x => x.classList.remove("primary"));
          b.classList.add("primary");
        });
        choices.appendChild(b);
      });
      $("#followupBox").style.display = "block";
    }

    // ===== Run diagnosis =====
    async function run(){
      // Token check only for business
      if (mode === "business" && !localStorage.getItem("mdg_token")) {
        showTokenModal();
        return;
      }

      const state = loadState();
      const oneLiner = ($("#oneLiner").value || "").trim();
      if (oneLiner.length < 6) {
        alert(lang === "de" ? "Bitte 1 Satz eingeben." : (lang === "tr" ? "Lütfen 1 cümle yaz." : "Please write one sentence."));
        return;
      }

      // Build followup if not present
      if (!state.followup) {
        const fu = buildFollowupQuestion(state);
        renderFollowup(fu);
        $("#statusLine").textContent = "Status: " + (lang==="de" ? "Bitte Klärungsfrage auswählen." : (lang==="tr" ? "Lütfen netleştirme seç." : "Please choose the clarification."));
        $("#resultBox").style.display = "none";
        return;
      }

      // Prepare payload for worker
      const answers = QUESTIONS.map(q => ({
        id: q.id,
        value: Number(state[q.id] ?? 0),
        title: q.title.en,
        prompt: q.text.en
      }));

      const payload = {
        mode,
        lang,
        goal,
        one_liner: oneLiner,
        followup: state.followup,
        answers,
        // include token only for business requests
        token: mode === "business" ? localStorage.getItem("mdg_token") : null,
        meta: {
          ts: new Date().toISOString(),
          userAgent: navigator.userAgent
        }
      };

      $("#statusLine").textContent = "Status: " + (lang==="de" ? "Analysiere …" : (lang==="tr" ? "Analiz …" : "Analyzing …"));
      $("#resultBox").style.display = "block";
      $("#resultText").textContent = "";

      try{
        // You will implement this endpoint in your worker:
        // POST /api/ai/diagnose  -> returns { followup_question?, assessment_text, executive_report_prompt? ... }
        const res = await fetch(`${API_BASE}/api/ai/diagnose`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(data?.error || "Request failed");

        // Show result
        $("#resultText").textContent = data.assessment_text || JSON.stringify(data, null, 2);
        $("#statusLine").textContent = "Status: " + (lang==="de" ? "Fertig." : (lang==="tr" ? "Bitti." : "Done."));

        // store last AI output for report generation
        window.__MDG_LAST_AI__ = data;

      }catch(e){
        $("#statusLine").textContent = "Status: " + (lang==="de" ? "Fehler: " : "Error: ") + (e?.message || String(e));
      }
    }

    $("#run").addEventListener("click", run);

    // ===== Executive report =====
    $("#execReport").addEventListener("click", async () => {
      if (mode === "business" && !localStorage.getItem("mdg_token")) { showTokenModal(); return; }

      const state = loadState();
      const oneLiner = ($("#oneLiner").value || "").trim();
      if (!oneLiner) return;

      $("#statusLine").textContent = "Status: " + (lang==="de" ? "Report wird erstellt …" : (lang==="tr" ? "Rapor hazırlanıyor …" : "Creating report …"));

      try{
        const payload = {
          mode, lang, goal,
          one_liner: oneLiner,
          followup: state.followup || null,
          answers: QUESTIONS.map(q => ({ id:q.id, value:Number(state[q.id] ?? 0) })),
          token: mode === "business" ? localStorage.getItem("mdg_token") : null,
          last_ai: window.__MDG_LAST_AI__ || null
        };

        // You will implement this endpoint in your worker:
        // POST /api/ai/executive-report -> returns { report_markdown }
        const res = await fetch(`${API_BASE}/api/ai/executive-report`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(data?.error || "Report failed");

        $("#resultText").textContent = data.report_markdown || data.report || JSON.stringify(data, null, 2);
        $("#statusLine").textContent = "Status: " + (lang==="de" ? "Report fertig." : (lang==="tr" ? "Rapor hazır." : "Report ready."));

      }catch(e){
        $("#statusLine").textContent = "Status: " + (lang==="de" ? "Fehler: " : "Error: ") + (e?.message || String(e));
      }
    });

    $("#copyReport").addEventListener("click", async () => {
      const txt = $("#resultText").textContent || "";
      if (!txt) return;
      try { await navigator.clipboard.writeText(txt); $("#statusLine").textContent = "Status: copied."; }
      catch { $("#statusLine").textContent = "Status: copy failed."; }
    });

    // ===== Autosave one-liner =====
    $("#oneLiner").addEventListener("input", () => saveState({ oneLiner: $("#oneLiner").value }));

    // Restore one-liner
    const st = loadState();
    if (st.oneLiner) $("#oneLiner").value = st.oneLiner;

    renderQuestions();

    // Utility
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
  </script>
</body>
</html>
