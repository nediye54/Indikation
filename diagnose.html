<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagnose – MDG</title>
  <meta name="description" content="In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen." />
  <link rel="stylesheet" href="./style.css" />
  <style>
    /* Drop 4 UI polish (page-only) */
    .dx-wrap{ max-width: 1120px; margin: 0 auto; padding: 1.25rem 1rem 3rem; }

    /* keep 2-column layout stable (output must NOT shrink) */
    .dx-top{
      display:grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(380px, .9fr);
      gap:1rem;
      align-items:start;
    }
    @media (max-width: 980px){
      .dx-top{ grid-template-columns: 1fr; }
    }

    .dx-actions{ display:flex; gap:.65rem; flex-wrap:wrap; align-items:center; }
    .dx-kpi{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.8rem; }
    .dx-kpi .pill{ white-space:nowrap; }
    .dx-grid{ display:grid; grid-template-columns: 1fr; gap:.75rem; margin-top:.6rem; }
    .dx-field{ display:grid; gap:.35rem; }
    .dx-label{ font-weight: 800; color: var(--muted, #aab); }
    .dx-help{ font-size:.9rem; color: var(--muted, #aab); line-height:1.35; }
    .dx-help b{ color: var(--text, #fff); }
    .dx-rangeRow{ display:grid; grid-template-columns: 1fr auto; gap:.7rem; align-items:center; }
    .dx-rangeVal{ font-weight: 900; min-width: 2.2rem; text-align:right; }
    .dx-divider{ height:1px; background: rgba(255,255,255,.08); margin: .9rem 0; }
    .dx-questions{ display:grid; gap: 1rem; margin-top: 1rem; }
    .dx-q{ padding-top:.9rem; border-top: 1px solid rgba(255,255,255,.08); }
    .dx-q:first-child{ border-top: 0; padding-top: 0; }
    .dx-qtitle{ font-weight: 950; margin-bottom:.35rem; }
    .dx-example{ margin-top:.25rem; display:grid; gap:.25rem; }
    .dx-example .ex{ font-size:.9rem; color: var(--muted, #aab); }
    .dx-example .ex::before{ content:"• "; opacity:.9; }

    /* output: readable, stable width */
    .dx-output{ min-width: 0; }
    .dx-output pre{
      white-space: pre-wrap;
      word-break: break-word;
      overflow: auto;
      max-height: 46vh;
    }

    .dx-report{ margin-top: 1rem; }
    .dx-reportGrid{ display:grid; grid-template-columns: 1fr; gap:1rem; }
    .dx-reportBox{
      padding: 1rem;
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2, 18px);
      background: rgba(255,255,255,.02);
    }
    .dx-reportBox h3{ margin:0 0 .6rem; }
    .dx-note{ font-size:.9rem; color: var(--muted, #aab); }

    /* Drop 2b: SVG tree */
    .dx-treeSvg { width:100%; height:auto; display:block; border-radius: 14px; }
    .dx-treeSvg text { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }

    /* Header cleanup: remove visual clutter + stop duplicate drawer showing */
    .brand__text{ display:none !important; } /* removes "v4" next to MDG */
    .drawer[hidden]{ display:none !important; }

    /* small UI cleanup */
    .dx-modeLine{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .dx-modeTag{ font-weight:900; }
  </style>
</head>

<body>
  <a class="skip-link" href="#main">Skip</a>

  <header class="header" id="top">
    <div class="container header__inner">
      <a class="brand" href="./index.html" aria-label="Home">
        <span class="brand__mark" aria-hidden="true">MDG</span>
        <span class="brand__text">v4</span>
      </a>

      <nav class="nav" aria-label="Main">
        <a class="nav__link" href="./how.html" data-i18n="nav.how">How it works</a>
        <a class="nav__link" href="./why.html" data-i18n="nav.why">Why MDG</a>
        <a class="nav__link" href="./faq.html" data-i18n="nav.faq">FAQ</a>
      </nav>

      <div class="header__actions">
        <div class="lang" role="group" aria-label="Language">
          <button class="chip chip--ghost" type="button" data-lang="de" aria-pressed="true">DE</button>
          <button class="chip chip--ghost" type="button" data-lang="tr" aria-pressed="false">TR</button>
          <button class="chip chip--ghost" type="button" data-lang="en" aria-pressed="false">EN</button>
        </div>
        <a class="btn btn--ghost" href="./index.html" data-i18n="cta.backHome">Zur Homepage</a>
      </div>

      <button class="burger" type="button" aria-label="Menu" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
    </div>

    <div class="drawer" hidden>
      <div class="drawer__content">
        <a class="drawer__link" href="./how.html" data-i18n="nav.how">How it works</a>
        <a class="drawer__link" href="./why.html" data-i18n="nav.why">Why MDG</a>
        <a class="drawer__link" href="./faq.html" data-i18n="nav.faq">FAQ</a>
        <div class="drawer__sep"></div>
        <a class="btn btn--ghost btn--full" href="./index.html" data-i18n="cta.backHome">Zur Homepage</a>
      </div>
    </div>
  </header>

  <main id="main">
    <div class="dx-wrap">
      <div class="section__head">
        <h1 class="h2" data-i18n="dx.title">Diagnose</h1>
        <p class="sub" data-i18n="dx.sub">
          In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen.
        </p>
      </div>

      <div class="dx-top">
        <!-- LEFT: input -->
        <div class="card">
          <h2 class="h3" data-i18n="dx.contextTitle">1) Kontext</h2>

          <div class="dx-grid">
            <div class="dx-field">
              <div class="dx-label" data-i18n="dx.mode">Modus</div>

              <!-- Drop 4: remove redundant pill; show clean line -->
              <div class="dx-modeLine">
                <span class="dx-modeTag" id="modeText">—</span>
                <span class="pill pill--muted" id="tokenBadge" style="display:none;">Token: ✓</span>
              </div>

              <div class="dx-help" id="modeHint"></div>
            </div>

            <div class="dx-field">
              <label class="dx-label" for="goalSelect" data-i18n="dx.goal">Ziel</label>
              <select class="dx-input" id="goalSelect">
                <option value="stabilize" data-i18n="dx.goal.stabilize">Stabilisieren (Spannung schnell senken)</option>
                <option value="rebuild" data-i18n="dx.goal.rebuild">Umbauen (Architektur verändern)</option>
              </select>
              <div class="dx-help" id="goalHelp"></div>
            </div>

            <div class="dx-field">
              <label class="dx-label" for="oneLiner" data-i18n="dx.oneliner">Beschreibe die Situation in einem Satz</label>
              <input class="dx-input" id="oneLiner" type="text" maxlength="160" placeholder="…" />
              <div class="dx-help" id="oneLinerHelp"></div>
            </div>

            <div class="dx-divider"></div>

            <h2 class="h3" style="margin:0;" data-i18n="dx.scanTitle">2) Quick Scan (Slider)</h2>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.load.title">Last & Engpässe</div>
              <div class="dx-help" id="exLoad"></div>
              <div class="dx-rangeRow">
                <input id="sLoad" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vLoad">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.decisions.title">Entscheidungsarchitektur</div>
              <div class="dx-help" id="exDecisions"></div>
              <div class="dx-rangeRow">
                <input id="sDecisions" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vDecisions">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.energy.title">Energie & Fehlerkultur</div>
              <div class="dx-help" id="exEnergy"></div>
              <div class="dx-rangeRow">
                <input id="sEnergy" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vEnergy">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.growth.title">Wachstumsdruck / Komplexität</div>
              <div class="dx-help" id="exGrowth"></div>
              <div class="dx-rangeRow">
                <input id="sGrowth" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vGrowth">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.power.title">Macht–Verantwortung (Alignment)</div>
              <div class="dx-help" id="exPower"></div>
              <div class="dx-rangeRow">
                <input id="sPower" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vPower">2</div>
              </div>
            </div>

            <div class="dx-divider"></div>

            <h2 class="h3" style="margin:0;" data-i18n="dx.moreTitle">3) Präzisionsfragen (adaptiv)</h2>
            <!-- Drop 4: remove redundant line ("jede Frage hat 2 Beispiele") -->
            <div class="dx-questions" id="questions"></div>

            <div class="dx-actions" style="margin-top: .9rem;">
              <button class="btn btn--primary" type="button" id="runBtn" data-i18n="dx.run">Diagnose starten</button>
              <button class="btn btn--ghost" type="button" id="resetBtn" data-i18n="dx.reset">Zurücksetzen</button>
              <span class="micro" id="statusLine">—</span>
            </div>

            <div class="dx-kpi">
              <span class="pill pill--muted" id="kpiPrimary">Primär: —</span>
              <span class="pill pill--muted" id="kpiPath">Pfad: —</span>
              <span class="pill pill--muted" id="kpiRisk">Risiko: —</span>
            </div>
          </div>
        </div>

        <!-- RIGHT: output -->
        <div class="card dx-output">
          <h2 class="h3" data-i18n="dx.outputTitle">Output</h2>
          <p class="micro" data-i18n="dx.outputHint">
            Du erhältst: Primärinstabilität, warum sie entsteht, Sofortmaßnahmen und Umbaupfad.
          </p>

          <div class="dx-reportGrid">
            <div class="dx-reportBox">
              <h3 class="h3" style="margin-top:0;" data-i18n="dx.assessmentTitle">Strategisches Assessment</h3>
              <pre id="resultText" class="micro" style="margin:0;">—</pre>
            </div>

            <div class="dx-reportBox">
              <h3 class="h3" style="margin-top:0;" data-i18n="dx.execTitle">Executive Report</h3>
              <p class="dx-note" id="execHint"></p>

              <div class="dx-actions" style="margin-top:.6rem;">
                <button class="btn btn--primary" type="button" id="execBtn" data-i18n="dx.execBtn">Executive Report erzeugen</button>
                <button class="btn btn--ghost" type="button" id="copyExecBtn" disabled data-i18n="dx.copy">Kopieren</button>
                <!-- Drop 4: remove "Premium" from buttons -->
                <button class="btn btn--ghost" type="button" id="svgBtn" data-i18n="dx.svgBtn">SVG</button>
                <button class="btn btn--ghost" type="button" id="pdfBtn" data-i18n="dx.pdfBtn">PDF</button>
              </div>

              <div class="dx-report" id="reportContainer" style="display:none;">
                <pre id="execText" class="micro" style="margin: .8rem 0 0;">—</pre>
              </div>

              <div class="dx-report" id="treeContainer" style="display:none; margin-top:.9rem;">
                <div class="micro" style="opacity:.85; margin-bottom:.4rem;" data-i18n="dx.treeTitle">Tree (SVG)</div>
                <div id="treeSvgWrap"></div>
              </div>
            </div>
          </div>

          <p class="micro" style="margin-top:1rem; opacity:.85;" data-i18n="dx.privacy">
            Datenschutz: Inputs werden via API nur zur Generierung von Assessment/Report verarbeitet.
          </p>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer__grid">
      <div>
        <div class="brand brand--footer">
          <span class="brand__mark" aria-hidden="true">MDG</span>
          <span class="brand__text">v4</span>
        </div>
        <p class="micro" data-i18n="footer.tag">Strukturdiagnose für Stabilisierung und Umbau.</p>
      </div>
      <div class="footer__legal">
        <a href="./impressum.html" rel="nofollow">Impressum</a>
        <a href="./datenschutz.html" rel="nofollow">Datenschutz</a>
        <a href="./kontakt.html" rel="nofollow">Kontakt</a>
      </div>
    </div>
  </footer>

  <script>
  (() => {
    const API_BASE = "https://api.mdg-indikation.de";

    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    const burger = $(".burger");
    const drawer = $(".drawer");
    if (burger && drawer) {
      burger.addEventListener("click", () => {
        const open = drawer.hasAttribute("hidden") ? false : true;
        if (open) {
          drawer.setAttribute("hidden", "");
          burger.setAttribute("aria-expanded", "false");
        } else {
          drawer.removeAttribute("hidden");
          burger.setAttribute("aria-expanded", "true");
        }
      });
    }

    const params = new URLSearchParams(location.search);
    const modeParam = (params.get("mode") || "").toLowerCase();

    const ss = window.sessionStorage;
    const ls = window.localStorage;

    const storedMode = ((ss.getItem("mdg_mode") || ls.getItem("mdg_mode") || "")).toLowerCase();
    const businessOk = (ss.getItem("mdg_business_ok") === "1") || (ls.getItem("mdg_business_ok") === "1");
    const tokenStored =
      (ss.getItem("mdg_business_token") || ls.getItem("mdg_business_token") || ls.getItem("mdg_token") || "").trim();

    const wantsBusiness = (modeParam === "business") || (storedMode === "business");
    const mode = (wantsBusiness && businessOk) ? "business" : "private";

    $("#modeText").textContent = (mode === "business") ? "Business" : "Privat";
    if (mode === "business") $("#tokenBadge").style.display = "";

    const dict = {
      de: {
        "nav.how":"Wie es funktioniert",
        "nav.why":"Warum MDG",
        "nav.faq":"FAQ",
        "cta.backHome":"Zur Homepage",

        "dx.title":"Diagnose",
        "dx.sub":"In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen.",
        "dx.contextTitle":"1) Kontext",
        "dx.mode":"Modus",
        "dx.goal":"Ziel",
        "dx.goal.stabilize":"Stabilisieren (Spannung schnell senken)",
        "dx.goal.rebuild":"Umbauen (Architektur verändern)",
        "dx.oneliner":"Beschreibe die Situation in einem Satz",
        "dx.scanTitle":"2) Quick Scan (Slider)",
        "dx.moreTitle":"3) Präzisionsfragen (adaptiv)",
        "dx.run":"Diagnose starten",
        "dx.reset":"Zurücksetzen",

        "dx.outputTitle":"Output",
        "dx.outputHint":"Du erhältst: Primärinstabilität, warum sie entsteht, Sofortmaßnahmen und Umbaupfad.",
        "dx.assessmentTitle":"Strategisches Assessment",
        "dx.execTitle":"Executive Report",
        "dx.execBtn":"Executive Report erzeugen",
        "dx.copy":"Kopieren",
        "dx.svgBtn":"SVG",
        "dx.pdfBtn":"PDF",
        "dx.treeTitle":"Tree (SVG)",
        "dx.privacy":"Datenschutz: Inputs werden via API nur zur Generierung von Assessment/Report verarbeitet.",
        "footer.tag":"Strukturdiagnose für Stabilisierung und Umbau.",

        "q.load.title":"Last & Engpässe",
        "q.decisions.title":"Entscheidungsarchitektur",
        "q.energy.title":"Energie & Fehlerkultur",
        "q.growth.title":"Wachstumsdruck / Komplexität",
        "q.power.title":"Macht–Verantwortung (Alignment)",

        "kpi.primary":"Primär",
        "kpi.path":"Pfad",
        "kpi.risk":"Risiko"
      },
      tr: {
        "nav.how":"Nasıl çalışır",
        "nav.why":"Neden MDG",
        "nav.faq":"SSS",
        "cta.backHome":"Anasayfa",

        "dx.title":"Analiz",
        "dx.sub":"Birkaç dakika içinde karar güveni: istikrarsızlığı erken gör, nedeni doğru teşhis et, mimari kur.",
        "dx.contextTitle":"1) Bağlam",
        "dx.mode":"Mod",
        "dx.goal":"Hedef",
        "dx.goal.stabilize":"Stabilize et (gerilimi hızlı düşür)",
        "dx.goal.rebuild":"Yeniden kur (mimariyi değiştir)",
        "dx.oneliner":"Durumu tek cümleyle anlat",
        "dx.scanTitle":"2) Hızlı tarama (Slider)",
        "dx.moreTitle":"3) Kesinleştirme soruları",
        "dx.run":"Başlat",
        "dx.reset":"Sıfırla",

        "dx.outputTitle":"Çıktı",
        "dx.outputHint":"Alacağın: ana instabilite, nedenleri, hemen yapılacaklar ve dönüşüm yolu.",
        "dx.assessmentTitle":"Stratejik değerlendirme",
        "dx.execTitle":"Yönetici raporu",
        "dx.execBtn":"Rapor üret",
        "dx.copy":"Kopyala",
        "dx.svgBtn":"SVG",
        "dx.pdfBtn":"PDF",
        "dx.treeTitle":"Ağaç (SVG)",
        "dx.privacy":"Gizlilik: Veriler yalnızca rapor üretimi için API üzerinden işlenir.",
        "footer.tag":"Stabilizasyon ve yeniden kurulum için yapı teşhisi.",

        "q.load.title":"Yük & darboğazlar",
        "q.decisions.title":"Karar mimarisi",
        "q.energy.title":"Enerji & hata kültürü",
        "q.growth.title":"Büyüme baskısı / karmaşıklık",
        "q.power.title":"Güç–sorumluluk uyumu",

        "kpi.primary":"Ana",
        "kpi.path":"Yol",
        "kpi.risk":"Risk"
      },
      en: {
        "nav.how":"How it works",
        "nav.why":"Why MDG",
        "nav.faq":"FAQ",
        "cta.backHome":"Home",

        "dx.title":"Diagnosis",
        "dx.sub":"In a few minutes to decision-confidence: detect instability early, diagnose precisely, build architecture.",
        "dx.contextTitle":"1) Context",
        "dx.mode":"Mode",
        "dx.goal":"Goal",
        "dx.goal.stabilize":"Stabilize (reduce tension fast)",
        "dx.goal.rebuild":"Rebuild (change architecture)",
        "dx.oneliner":"Describe the situation in one sentence",
        "dx.scanTitle":"2) Quick Scan (sliders)",
        "dx.moreTitle":"3) Precision Questions (adaptive)",
        "dx.run":"Run assessment",
        "dx.reset":"Reset",

        "dx.outputTitle":"Output",
        "dx.outputHint":"You will get: primary instability, why it happens, what to do now, and what to rebuild.",
        "dx.assessmentTitle":"Strategic Assessment",
        "dx.execTitle":"Executive Report",
        "dx.execBtn":"Generate Executive Report",
        "dx.copy":"Copy",
        "dx.svgBtn":"SVG",
        "dx.pdfBtn":"PDF",
        "dx.treeTitle":"Tree (SVG)",
        "dx.privacy":"Privacy: inputs are processed via API only to generate the assessment/report.",
        "footer.tag":"Structure diagnosis for stabilization and rebuild.",

        "q.load.title":"Load & bottlenecks",
        "q.decisions.title":"Decision architecture",
        "q.energy.title":"Energy & error handling",
        "q.growth.title":"Growth pressure / complexity",
        "q.power.title":"Power–responsibility alignment",

        "kpi.primary":"Primary",
        "kpi.path":"Path",
        "kpi.risk":"Risk"
      }
    };

    function getLang(){
      const pressed = $$("[data-lang]").find(b => b.getAttribute("aria-pressed") === "true");
      return pressed?.dataset.lang || "de";
    }

    function applyLang(lang){
      if(!dict[lang]) lang = "en";
      document.documentElement.lang = lang;
      $$("[data-lang]").forEach(b => b.setAttribute("aria-pressed", String(b.dataset.lang === lang)));
      $$("[data-i18n]").forEach(el => {
        const k = el.dataset.i18n;
        const v = dict[lang][k];
        if (v) el.textContent = v;
      });
      renderExamples(lang);
      renderAdaptiveQuestions(lang);
      renderHints(lang);

      // Drop 4: KPI labels language-safe (avoid English in DE)
      const k = dict[lang];
      $("#kpiPrimary").textContent = (k["kpi.primary"] || "Primary") + ": —";
      $("#kpiPath").textContent    = (k["kpi.path"] || "Path") + ": —";
      $("#kpiRisk").textContent    = (k["kpi.risk"] || "Risk") + ": —";
    }

    $$("[data-lang]").forEach(btn => btn.addEventListener("click", () => applyLang(btn.dataset.lang)));

    function renderExamples(lang){
      const business = (mode === "business");
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));

      if (wantsBusiness && !businessOk) {
        $("#modeHint").innerHTML = t(
          "Business-Zugang nicht aktiv. Bitte Token über die Landingpage bestätigen.",
          "Business erişimi aktif değil. Lütfen token’ı ana sayfada doğrula.",
          "Business access not active. Please verify token on the landing page."
        );
      } else {
        $("#modeHint").innerHTML = business
          ? t(
              "Business-Modus: Fragen sind auf Unternehmen, Führung, Teams und Verantwortung zugeschnitten.",
              "Business modu: Sorular şirket, liderlik, ekip ve sorumluluk için özelleştirildi.",
              "Business mode: questions are tailored to companies, leadership, teams, and accountability."
            )
          : t(
              "Privat-Modus: Fokus auf persönliche Systeme, Beziehungen, Alltag, Rollen & Belastung.",
              "Özel mod: kişisel sistemler, ilişkiler, günlük hayat, roller ve yük odağı.",
              "Private mode: focus on personal systems, relationships, daily life, roles and load."
            );
      }

      $("#goalHelp").innerHTML = t(
        "<b>Stabilisieren</b> = Spannung senken. <b>Umbauen</b> = Architektur ändern.",
        "<b>Stabilize</b> = gerilimi düşür. <b>Yeniden kur</b> = mimariyi değiştir.",
        "<b>Stabilize</b> = reduce tension. <b>Rebuild</b> = change architecture."
      );

      $("#oneLinerHelp").innerHTML = business
        ? t(
            "Beispiel 1: <b>„Unsere Entscheidungen dauern zu lange und hängen an 1 Person.“</b><br>Beispiel 2: <b>„Team A und B blockieren sich, Qualität fällt.“</b>",
            "Örnek 1: <b>“Kararlar çok uzun sürüyor ve 1 kişiye bağlı.”</b><br>Örnek 2: <b>“Takım A ve B birbirini kilitliyor, kalite düşüyor.”</b>",
            "Example 1: <b>“Decisions take too long and depend on one person.”</b><br>Example 2: <b>“Team A and B block each other, quality drops.”</b>"
          )
        : t(
            "Beispiel 1: <b>„Ich prokrastiniere und verliere Kontrolle über meinen Alltag.“</b><br>Beispiel 2: <b>„Wir haben wiederkehrende Konflikte und nichts ändert sich.“</b>",
            "Örnek 1: <b>“Erteleme yapıyorum ve günlük hayat kontrolüm kayıyor.”</b><br>Örnek 2: <b>“Tekrarlayan çatışmalar var ve hiçbir şey değişmiyor.”</b>",
            "Example 1: <b>“I procrastinate and lose control over my daily life.”</b><br>Example 2: <b>“We have recurring conflicts and nothing changes.”</b>"
          );

      $("#exLoad").innerHTML = business
        ? t(
          "0 = verteilt, kein Engpass. 6 = 1–2 Rollen sind Dauer-Engpass.<div class='dx-example'><div class='ex'>„Sales hängt an mir, ohne mich kein Abschluss.“</div><div class='ex'>„Ops ist 120% ausgelastet, alle warten.“</div></div>",
          "0 = darboğaz yok. 6 = 1–2 rol sürekli darboğaz.<div class='dx-example'><div class='ex'>“Satış bende; ben olmadan kapanış yok.”</div><div class='ex'>“Operasyon %120 dolu; herkes bekliyor.”</div></div>",
          "0 = no bottleneck. 6 = 1–2 roles are permanent bottlenecks.<div class='dx-example'><div class='ex'>“Sales depends on me; without me no close.”</div><div class='ex'>“Ops at 120%; everyone is waiting.”</div></div>"
        )
        : t(
          "0 = gleichmäßig tragbar. 6 = alles hängt an dir/1 Person.<div class='dx-example'><div class='ex'>„Wenn ich 2 Tage ausfalle, bricht alles.“</div><div class='ex'>„Ich mache 90% allein, niemand übernimmt.“</div></div>",
          "0 = dengeli. 6 = her şey sana/1 kişiye bağlı.<div class='dx-example'><div class='ex'>“2 gün yok olsam her şey çöker.”</div><div class='ex'>“%90’ını ben yapıyorum, kimse devralmıyor.”</div></div>",
          "0 = evenly manageable. 6 = everything depends on you/one person.<div class='dx-example'><div class='ex'>“If I’m out for 2 days, everything breaks.”</div><div class='ex'>“I do 90% alone; nobody takes over.”</div></div>"
        );

      $("#exDecisions").innerHTML = business
        ? t(
          "0 = klar & schnell. 6 = unklar, langsam, politisch.<div class='dx-example'><div class='ex'>„Keiner weiß wer entscheiden darf.“</div><div class='ex'>„3 Wochen diskutieren, dann passiert nichts.“</div></div>",
          "0 = net & hızlı. 6 = belirsiz, yavaş, politik.<div class='dx-example'><div class='ex'>“Kim karar verir belli değil.”</div><div class='ex'>“3 hafta tartışıp sonra hiçbir şey yapmıyoruz.”</div></div>",
          "0 = clear & fast. 6 = unclear, slow, political.<div class='dx-example'><div class='ex'>“No one knows who can decide.”</div><div class='ex'>“We debate for 3 weeks, then nothing happens.”</div></div>"
        )
        : t(
          "0 = klar entscheiden & umsetzen. 6 = Chaos/Endlosschleife.<div class='dx-example'><div class='ex'>„Ich ändere ständig die Richtung.“</div><div class='ex'>„Wir drehen uns im Kreis und eskalieren.“</div></div>",
          "0 = net karar + uygulama. 6 = kaos / kısır döngü.<div class='dx-example'><div class='ex'>“Sürekli yön değiştiriyorum.”</div><div class='ex'>“Kısır döngüdeyiz ve büyüyor.”</div></div>",
          "0 = clear decisions + execution. 6 = chaos / infinite loop.<div class='dx-example'><div class='ex'>“I constantly change direction.”</div><div class='ex'>“We go in circles and escalate.”</div></div>"
        );

      $("#exEnergy").innerHTML = business
        ? t(
          "0 = stabiler Rhythmus. 6 = Überlastung, Fehler eskalieren.<div class='dx-example'><div class='ex'>„Fehler werden versteckt, niemand lernt.“</div><div class='ex'>„Dauerfeuer, keine Regeneration.“</div></div>",
          "0 = ritim iyi. 6 = aşırı yük, hatalar büyür.<div class='dx-example'><div class='ex'>“Hatalar saklanıyor, kimse öğrenmiyor.”</div><div class='dx-example'><div class='ex'>“Sürekli yoğun; toparlanma yok.”</div></div>",
          "0 = stable rhythm. 6 = overload, errors escalate.<div class='dx-example'><div class='ex'>“Errors are hidden; nobody learns.”</div><div class='ex'>“Constant fire; no recovery.”</div></div>"
        )
        : t(
          "0 = Energie & Feedback. 6 = Limit, Fehler häufen sich.<div class='dx-example'><div class='ex'>„Ich schlafe schlecht und bin gereizt.“</div><div class='ex'>„Ich wiederhole dieselben Fehler.“</div></div>",
          "0 = enerji var. 6 = limit, hata artıyor.<div class='dx-example'><div class='ex'>“Kötü uyuyorum, çabuk sinirleniyorum.”</div><div class='ex'>“Aynı hataları tekrar ediyorum.”</div></div>",
          "0 = energy + feedback. 6 = at the limit, errors pile up.<div class='dx-example'><div class='ex'>“I sleep badly and get irritated.”</div><div class='ex'>“I keep repeating the same mistakes.”</div></div>"
        );

      $("#exGrowth").innerHTML = business
        ? t(
          "0 = Wachstum kontrolliert. 6 = Komplexität > Struktur.<div class='dx-example'><div class='ex'>„Neue Projekte rein, aber Prozesse fehlen.“</div><div class='ex'>„Koordination frisst Output.“</div></div>",
          "0 = kontrollü büyüme. 6 = karmaşıklık > yapı.<div class='dx-example'><div class='ex'>“Yeni projeler var ama süreç yok.”</div><div class='ex'>“Koordinasyon çıktıyı yiyor.”</div></div>",
          "0 = controlled growth. 6 = complexity > structure.<div class='dx-example'><div class='ex'>“New projects, but no processes.”</div><div class='ex'>“Coordination eats output.”</div></div>"
        )
        : t(
          "0 = wenig Komplexität. 6 = zu viele Themen, Überblick weg.<div class='dx-example'><div class='ex'>„Ich fange 10 Dinge an, nichts wird fertig.“</div><div class='ex'>„Alles wird gleichzeitig wichtiger.“</div></div>",
          "0 = düşük karmaşıklık. 6 = çok konu, kontrol kayıyor.<div class='dx-example'><div class='ex'>“10 şeye başlıyorum, bitmiyor.”</div><div class='ex'>“Her şey aynı anda acil.”</div></div>",
          "0 = low complexity. 6 = too many topics, you lose overview.<div class='dx-example'><div class='ex'>“I start 10 things, finish none.”</div><div class='ex'>“Everything becomes urgent at once.”</div></div>"
        );

      $("#exPower").innerHTML = business
        ? t(
          "0 = Verantwortung + Befugnis passen. 6 = Misalignment.<div class='dx-example'><div class='ex'>„Owner trägt KPI, darf nicht entscheiden.“</div><div class='ex'>„Entscheider trägt keine Konsequenz.“</div></div>",
          "0 = uyumlu. 6 = kopuk.<div class='dx-example'><div class='ex'>“KPI bende ama karar yetkisi yok.”</div><div class='ex'>“Karar veren sonucu taşımıyor.”</div></div>",
          "0 = aligned. 6 = misalignment.<div class='dx-example'><div class='ex'>“Owner has KPI but can’t decide.”</div><div class='ex'>“Decider bears no consequence.”</div></div>"
        )
        : t(
          "0 = Einfluss = Konsequenz. 6 = du trägst ohne Einfluss (oder umgekehrt).<div class='dx-example'><div class='ex'>„Ich muss liefern, aber andere blockieren.“</div><div class='dx-example'><div class='ex'>„Ich entscheide, spüre aber keine Folgen.“</div></div>",
          "0 = etki = sonuç. 6 = etki yokken sonuç taşıma.<div class='dx-example'><div class='ex'>“Teslim bende ama başkası engelliyor.”</div><div class='ex'>“Karar veriyorum ama sonuç yaşamıyorum.”</div></div>",
          "0 = influence = consequence. 6 = you bear without influence (or vice versa).<div class='dx-example'><div class='ex'>“I must deliver but others block.”</div><div class='ex'>“I decide but feel no consequences.”</div></div>"
        );

      $("#execHint").textContent = business
        ? t(
          "Business: Diagnose + Operating Model + Rollen + Rhythmus + KPIs + 30-60-90.",
          "Business: teşhis + işletim modeli + roller + ritim + KPI + 30-60-90.",
          "Business: diagnosis + operating model + roles + cadence + KPIs + 30-60-90."
        )
        : t(
          "Privat: Ursachenlogik, Spannungsdynamik, klare Prioritäten, konkrete Moves.",
          "Özel: neden mantığı, gerilim dinamiği, net öncelikler, somut adımlar.",
          "Private: causal logic, tension dynamics, clear priorities, concrete moves."
        );
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderAdaptiveQuestions(lang){
      const business = (mode === "business");
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));

      const qs = business ? [
        {
          id:"b_q1",
          title: t("Wo entsteht aktuell die größte Verzögerung?","En büyük gecikme nerede?","Where is the biggest delay?"),
          help: "", /* Drop 4: remove redundant helper line */
          options: [
            {v:"decisions", label:t("Entscheidungen (Freigaben/Eskalation)","Kararlar (onay/eskalasyon)","Decisions (approvals/escalation)")},
            {v:"handoff", label:t("Übergaben (Team→Team)","Devir (takım→takım)","Handoffs (team→team)")},
            {v:"quality", label:t("Qualität (Rework/Bugs)","Kalite (rework/bug)","Quality (rework/bugs)")},
            {v:"capacity", label:t("Kapazität (Leute/Skills)","Kapasite (kişi/skill)","Capacity (people/skills)")},
          ],
          ex: [
            t("„Freigaben brauchen immer den CEO.“","“Onaylar hep CEO’da.”","“Approvals always need the CEO.”"),
            t("„Team A wartet ständig auf Team B.“","“Takım A hep Takım B’yi bekliyor.”","“Team A constantly waits for Team B.”")
          ]
        },
        {
          id:"b_q2",
          title: t("Was passiert, wenn die Schlüsselrolle 2 Wochen ausfällt?","Kritik rol 2 hafta yoksa?","If the key role is out for 2 weeks?"),
          help: "",
          options: [
            {v:"fine", label:t("Läuft weiter (kleine Reibung)","Devam eder (küçük sürtünme)","Continues (minor friction)")},
            {v:"slow", label:t("Wird deutlich langsamer","Belirgin yavaşlar","Gets clearly slower")},
            {v:"break", label:t("Bricht (Stop in Lieferung/Entscheid)","Kırılır (teslim/karar durur)","Breaks (delivery/decisions stop)")},
          ],
          ex: [
            t("„Pipeline steht, nur 1 Person kann schließen.“","“Pipeline durur; 1 kişi kapatır.”","“Pipeline stops; only one person can close.”"),
            t("„Wissen ist nur im Chat.“","“Bilgi sadece chat’te.”","“Knowledge only lives in chat.”")
          ]
        },
        {
          id:"b_q3",
          title: t("Wie klar sind Rollen & Zuständigkeiten?","Roller/sorumluluk ne kadar net?","How clear are roles & ownership?"),
          help: "",
          options: [
            {v:"clear", label:t("Sehr klar (Owner, KPI, Entscheidung)","Çok net (owner, KPI, karar)","Very clear (owner, KPI, decision)")},
            {v:"mixed", label:t("Teilweise klar (Grauzonen)","Kısmen net (gri alan)","Partially clear (grey zones)")},
            {v:"unclear", label:t("Unklar (Konflikte/Eskalation)","Belirsiz (çatışma/eskalasyon)","Unclear (conflict/escalation)")},
          ],
          ex: [
            t("„Owner trägt KPI, Entscheidung liegt woanders.“","“KPI bende, karar başka yerde.”","“Owner has KPI, decision is elsewhere.”"),
            t("„Zwei Teams denken beide, sie sind verantwortlich.“","“İki takım da ‘bizde’ diyor.”","“Two teams both think they own it.”")
          ]
        }
      ] : [
        {
          id:"p_q1",
          title: t("Was ist der Haupt-Auslöser der Spannung?","Gerilimin ana tetikleyicisi?","Main trigger of the tension?"),
          help: "",
          options: [
            {v:"time", label:t("Zeitdruck / zu viele Dinge","Zaman baskısı / çok şey","Time pressure / too many things")},
            {v:"conflict", label:t("Konflikte / wiederkehrender Streit","Çatışma / tekrar eden konu","Conflict / recurring issue")},
            {v:"uncertainty", label:t("Unklarheit / Entscheidungen schieben","Belirsizlik / erteleme","Uncertainty / delayed decisions")},
            {v:"energy", label:t("Erschöpfung / wenig Regeneration","Yorgunluk / az toparlanma","Exhaustion / low recovery")},
          ],
          ex: [
            t("„Ich schiebe Entscheidungen, dann staut sich alles.“","“Kararı erteliyorum, her şey birikiyor.”","“I delay decisions, then everything piles up.”"),
            t("„Kleine Themen kippen sofort in Streit.“","“Küçük şeyler hemen kavgaya döner.”","“Small topics escalate into conflict.”")
          ]
        },
        {
          id:"p_q2",
          title: t("Wie stark hängt das System an 1 Person?","Sistem 1 kişiye ne kadar bağlı?","How much does the system depend on one person?"),
          help: "",
          options: [
            {v:"low", label:t("Kaum (ersetzbar)","Az (değiştirilebilir)","Low (replaceable)")},
            {v:"medium", label:t("Teilweise (mit Aufwand)","Orta (eforla)","Medium (with effort)")},
            {v:"high", label:t("Sehr stark (fällt aus = bricht)","Çok (yoksa kırılır)","High (out = break)")},
          ],
          ex: [
            t("„Wenn ich weg bin, bleibt alles liegen.“","“Ben yokken her şey durur.”","“When I’m away, everything stalls.”"),
            t("„Andere können übernehmen, wenn es dokumentiert ist.“","“Dokümanteyse başkası devralır.”","“Others can take over if documented.”")
          ]
        },
        {
          id:"p_q3",
          title: t("Wie gut werden Fehler genutzt (statt versteckt)?","Hatalar öğrenmeye dönüyor mu?","How well are errors used (instead of hidden)?"),
          help: "",
          options: [
            {v:"good", label:t("Gut (lernen, anpassen)","İyi (öğrenme, uyum)","Good (learn, adapt)")},
            {v:"mixed", label:t("Gemischt","Karışık","Mixed")},
            {v:"bad", label:t("Schlecht (Schuld, Wiederholung)","Kötü (suçlama, tekrar)","Bad (blame, repeats)")},
          ],
          ex: [
            t("„Wir sprechen offen und ändern die Ursache.“","“Açık konuşup kökü değiştiriyoruz.”","“We talk openly and change the root cause.”"),
            t("„Fehler werden vertuscht, dann passiert es wieder.“","“Hata saklanır, tekrar eder.”","“Errors get hidden, then repeat.”")
          ]
        }
      ];

      const root = $("#questions");
      root.innerHTML = "";
      qs.forEach(q => {
        const wrap = document.createElement("div");
        wrap.className = "dx-q";
        wrap.innerHTML = `
          <div class="dx-qtitle">${escapeHtml(q.title)}</div>
          ${q.help ? `<div class="dx-help">${escapeHtml(q.help)}</div>` : ``}
          <div class="dx-actions" style="margin-top:.55rem;">
            ${q.options.map(o => `
              <label class="pill pill--muted" style="cursor:pointer;">
                <input type="radio" name="${q.id}" value="${o.v}" style="margin-right:.4rem; accent-color: rgba(110,231,183,.9);" />
                ${escapeHtml(o.label)}
              </label>
            `).join("")}
          </div>
          <div class="dx-example">
            <div class="ex">Beispiel: ${q.ex[0]}</div>
            <div class="ex">Beispiel: ${q.ex[1]}</div>
          </div>
        `;
        root.appendChild(wrap);
      });
    }

    function renderHints(lang){
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));
      const k = dict[lang] || dict.en;

      $("#statusLine").textContent = t("Status: bereit", "Durum: hazır", "Status: ready");
      $("#execText").textContent = "—";
      $("#resultText").textContent = "—";
      $("#copyExecBtn").disabled = true;
      $("#reportContainer").style.display = "none";
      $("#treeContainer").style.display = "none";
      $("#treeSvgWrap").innerHTML = "";

      $("#kpiPrimary").textContent = (k["kpi.primary"] || "Primary") + ": —";
      $("#kpiPath").textContent    = (k["kpi.path"] || "Path") + ": —";
      $("#kpiRisk").textContent    = (k["kpi.risk"] || "Risk") + ": —";
    }

    function syncSliders(){
      const pairs = [["sLoad","vLoad"],["sDecisions","vDecisions"],["sEnergy","vEnergy"],["sGrowth","vGrowth"],["sPower","vPower"]];
      pairs.forEach(([sid, vid]) => {
        const s = document.getElementById(sid);
        const v = document.getElementById(vid);
        if (s && v) v.textContent = s.value;
      });
    }
    $$('input[type="range"]').forEach(r => r.addEventListener("input", syncSliders));

    function readRadios(){
      const out = {};
      $$('input[type="radio"]:checked').forEach(r => { out[r.name] = r.value; });
      return out;
    }

    function buildPayload(){
      const oneLiner = ($("#oneLiner").value || "").trim();
      const intent = $("#goalSelect").value;

      const quick_scan = {
        load: Number($("#sLoad").value),
        decisions: Number($("#sDecisions").value),
        energy: Number($("#sEnergy").value),
        growth: Number($("#sGrowth").value),
        power: Number($("#sPower").value),
      };

      return {
        version: "v4",
        mode,
        token: (mode === "business") ? tokenStored : undefined,
        lang: getLang(),
        problem: oneLiner,
        intent,
        answers: { quick_scan, radios: readRadios() },
        meta: { ts: new Date().toISOString(), ua: navigator.userAgent }
      };
    }

    async function postJson(path, body){
      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || `Request failed (${res.status})`);
      return data;
    }

    let LAST_ASSESSMENT = null;
    let LAST_TREE_SVG = "";

    async function runAssessment(){
      const lang = getLang();
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));
      const k = dict[lang] || dict.en;

      const payload = buildPayload();

      if (!payload.problem) {
        alert(t("Bitte beschreibe die Situation in einem Satz.", "Lütfen durumu tek cümleyle yaz.", "Please describe the situation in one sentence."));
        return;
      }
      if (mode === "business" && !payload.token) {
        alert(t("Business-Token fehlt. Bitte über die Landingpage erneut einsteigen.", "Business token eksik. Lütfen ana sayfadan tekrar gir.", "Business token missing. Please re-enter via landing page."));
        return;
      }

      $("#statusLine").textContent = t("Status: läuft …", "Durum: çalışıyor …", "Status: running …");
      $("#resultText").textContent = "—";
      $("#execText").textContent = "—";
      $("#copyExecBtn").disabled = true;
      $("#reportContainer").style.display = "none";
      $("#treeContainer").style.display = "none";
      $("#treeSvgWrap").innerHTML = "";
      LAST_TREE_SVG = "";

      try{
        const data = await postJson("/api/assess", payload);
        LAST_ASSESSMENT = data;

        const text = data.assessment_text || JSON.stringify(data, null, 2);
        $("#resultText").textContent = text;

        $("#kpiPrimary").textContent = (k["kpi.primary"] || "Primary") + ": " + (data.primary || "—");
        $("#kpiPath").textContent    = (k["kpi.path"] || "Path") + ": " + (data.path || "—");
        $("#kpiRisk").textContent    = (k["kpi.risk"] || "Risk") + ": " + (data.risk || "—");

        $("#statusLine").textContent = t("Status: fertig", "Durum: bitti", "Status: done");
      } catch(e){
        $("#statusLine").textContent = t("Status: Fehler – ", "Durum: Hata – ", "Status: Error – ") + (e?.message || String(e));
      }
    }

    async function runExecutiveReport(){
      const lang = getLang();
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));

      if (!LAST_ASSESSMENT) {
        alert(t("Bitte zuerst die Diagnose starten.", "Önce değerlendirmeyi çalıştır.", "Run the assessment first."));
        return;
      }

      $("#statusLine").textContent = t("Status: Report wird erstellt …", "Durum: Rapor oluşturuluyor …", "Status: generating report …");
      $("#execText").textContent = "—";
      $("#copyExecBtn").disabled = true;
      $("#reportContainer").style.display = "none";

      try{
        const payload = buildPayload();
        payload.assessment = LAST_ASSESSMENT;

        const data = await postJson("/api/report", payload);

        const text = data.report_markdown || JSON.stringify(data, null, 2);
        $("#execText").textContent = text;

        $("#reportContainer").style.display = "";
        $("#copyExecBtn").disabled = false;

        $("#statusLine").textContent = t("Status: Report fertig", "Durum: Rapor hazır", "Status: report ready");
      } catch(e){
        $("#statusLine").textContent = t("Status: Fehler – ", "Durum: Hata – ", "Status: Error – ") + (e?.message || String(e));
      }
    }

    function safeText(s){
      return String(s ?? "").replace(/[<>&]/g, (m) => ({ "<":"&lt;", ">":"&gt;", "&":"&amp;" }[m]));
    }

    function extractTreeSvg(data){
      const raw =
        (data && (data.tree_svg || data.svg || data.tree?.svg || data.tree?.tree_svg)) || "";
      if (typeof raw === "string" && raw.trim().startsWith("<svg")) return raw.trim();
      return "";
    }

    function synthTreeSvgFromReport(markdownText){
      const title = "MDG — Executive Tree";
      const lines = String(markdownText || "")
        .split("\n")
        .map(s => s.trim())
        .filter(Boolean)
        .slice(0, 18);

      const W = 980, H = 520;
      const pad = 28;
      const lineH = 22;

      const items = lines.length ? lines : ["No tree payload returned by API.", "Update worker to return tree_svg."];
      const textBlock = items.map((l,i) =>
        `<text x="${pad}" y="${pad + 44 + i*lineH}" font-size="16" fill="rgba(255,255,255,.92)">${safeText(l)}</text>`
      ).join("");

      return `
<svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
  <defs>
    <linearGradient id="bg" x1="0" x2="1" y1="0" y2="1">
      <stop offset="0" stop-color="rgba(255,255,255,.06)"/>
      <stop offset="1" stop-color="rgba(255,255,255,.02)"/>
    </linearGradient>
  </defs>
  <rect x="0" y="0" width="${W}" height="${H}" rx="18" fill="url(#bg)" stroke="rgba(255,255,255,.10)"/>
  <text x="${pad}" y="${pad+18}" font-size="18" font-weight="800" fill="rgba(255,255,255,.95)">${safeText(title)}</text>
  <text x="${pad}" y="${pad+40}" font-size="13" fill="rgba(255,255,255,.70)">Fallback render (API did not return tree_svg)</text>
  ${textBlock}
</svg>`.trim();
    }

    function renderTreeSvg(svg){
      if (!svg) return;
      LAST_TREE_SVG = svg;
      $("#treeSvgWrap").innerHTML = svg;
      const el = $("#treeSvgWrap").querySelector("svg");
      if (el) el.classList.add("dx-treeSvg");
      $("#treeContainer").style.display = "";
    }

    function downloadBlob(blob, filename){
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 800);
    }

    function downloadText(text, filename, mime="text/plain;charset=utf-8"){
      const blob = new Blob([text], { type: mime });
      downloadBlob(blob, filename);
    }

    async function runPremiumSvg(){
      const lang = getLang();
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));

      if (!LAST_ASSESSMENT) {
        alert(t("Bitte zuerst die Diagnose starten.", "Önce değerlendirmeyi çalıştır.", "Run the assessment first."));
        return;
      }

      $("#statusLine").textContent = t("Status: Tree wird erstellt …", "Durum: Tree hazırlanıyor …", "Status: generating tree …");

      try{
        const payload = buildPayload();
        payload.assessment = LAST_ASSESSMENT;

        let data = null;
        try {
          data = await postJson("/api/tree", payload);
        } catch {
          data = await postJson("/api/report", payload);
        }

        let svg = extractTreeSvg(data);
        if (!svg) {
          const reportText = data?.report_markdown || $("#execText").textContent || "";
          svg = synthTreeSvgFromReport(reportText);
        }

        renderTreeSvg(svg);
        downloadText(svg, "mdg-tree.svg", "image/svg+xml;charset=utf-8");

        $("#statusLine").textContent = t("Status: SVG fertig", "Durum: SVG hazır", "Status: SVG ready");
      } catch(e){
        $("#statusLine").textContent = t("Status: Fehler – ", "Durum: Hata – ", "Status: Error – ") + (e?.message || String(e));
      }
    }

    async function runPremiumPdf(){
      const lang = getLang();
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));

      if (!LAST_ASSESSMENT) {
        alert(t("Bitte zuerst die Diagnose starten.", "Önce değerlendirmeyi çalıştır.", "Run the assessment first."));
        return;
      }
      if (mode === "business" && !tokenStored) {
        alert(t("Business-Token fehlt.", "Business token eksik.", "Business token missing."));
        return;
      }

      $("#statusLine").textContent = t("Status: PDF wird erstellt …", "Durum: PDF oluşturuluyor …", "Status: generating PDF …");

      try{
        const payload = buildPayload();
        payload.assessment = LAST_ASSESSMENT;

        const res = await fetch(`${API_BASE}/api/pdf`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error((txt && txt.slice(0,140)) || `PDF endpoint failed (${res.status})`);
        }

        const ct = (res.headers.get("content-type") || "").toLowerCase();

        if (ct.includes("application/json")) {
          const data = await res.json().catch(() => ({}));
          const b64 = data?.pdf_base64 || data?.base64 || "";
          if (!b64) throw new Error("PDF JSON received but no pdf_base64.");
          const bin = atob(b64);
          const bytes = new Uint8Array(bin.length);
          for (let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
          const blob = new Blob([bytes], { type: "application/pdf" });
          downloadBlob(blob, "mdg-report.pdf");
        } else {
          const buf = await res.arrayBuffer();
          const blob = new Blob([buf], { type: "application/pdf" });
          downloadBlob(blob, "mdg-report.pdf");
        }

        $("#statusLine").textContent = t("Status: PDF fertig", "Durum: PDF hazır", "Status: PDF ready");
      } catch(e){
        $("#statusLine").textContent = t("Status: Fehler – ", "Durum: Hata – ", "Status: Error – ") + (e?.message || String(e));
      }
    }

    function resetAll(){
      $("#oneLiner").value = "";
      $("#goalSelect").value = "stabilize";
      ["sLoad","sDecisions","sEnergy","sGrowth","sPower"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "2";
      });
      $$('input[type="radio"]').forEach(r => r.checked = false);

      LAST_ASSESSMENT = null;
      LAST_TREE_SVG = "";

      $("#resultText").textContent = "—";
      $("#execText").textContent = "—";
      $("#reportContainer").style.display = "none";
      $("#treeContainer").style.display = "none";
      $("#treeSvgWrap").innerHTML = "";
      $("#copyExecBtn").disabled = true;

      renderHints(getLang());
      syncSliders();
    }

    $("#copyExecBtn").addEventListener("click", async () => {
      const txt = $("#execText").textContent || "";
      if (!txt || txt === "—") return;
      try { await navigator.clipboard.writeText(txt); } catch {}
    });

    $("#runBtn").addEventListener("click", runAssessment);
    $("#execBtn").addEventListener("click", runExecutiveReport);
    $("#svgBtn").addEventListener("click", runPremiumSvg);
    $("#pdfBtn").addEventListener("click", runPremiumPdf);

    $("#resetBtn").addEventListener("click", () => {
      const lang = getLang();
      const ok = confirm(lang==="de" ? "Wirklich zurücksetzen?" : (lang==="tr" ? "Sıfırlansın mı?" : "Reset?"));
      if (ok) resetAll();
    });

    syncSliders();
    applyLang("de");
  })();
  </script>
</body>
</html>
