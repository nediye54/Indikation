<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagnose – MDG</title>
  <meta name="description" content="In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen." />
  <link rel="stylesheet" href="./style.css" />
  <style>
    .dx-wrap{ max-width: 1120px; margin: 0 auto; padding: 1.25rem 1rem 3rem; }
    .dx-top{
      display:grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, .9fr);
      gap:1rem;
      align-items:start;
    }
    .dx-actions{ display:flex; gap:.65rem; flex-wrap:wrap; align-items:center; }
    .dx-kpi{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.8rem; }
    .dx-kpi .pill{ white-space:nowrap; }
    .dx-grid{ display:grid; grid-template-columns: 1fr; gap:.75rem; margin-top:.6rem; }
    .dx-field{ display:grid; gap:.35rem; }
    .dx-label{ font-weight: 800; color: var(--muted, #aab); }
    .dx-help{ font-size:.9rem; color: var(--muted, #aab); line-height:1.35; }
    .dx-help b{ color: var(--text, #fff); }
    .dx-rangeRow{ display:grid; grid-template-columns: 1fr auto; gap:.7rem; align-items:center; }
    .dx-rangeVal{ font-weight: 900; min-width: 2.2rem; text-align:right; }
    .dx-divider{ height:1px; background: rgba(255,255,255,.08); margin: .9rem 0; }
    .dx-questions{ display:grid; gap: 1rem; margin-top: 1rem; }
    .dx-q{ padding-top:.9rem; border-top: 1px solid rgba(255,255,255,.08); }
    .dx-q:first-child{ border-top: 0; padding-top: 0; }
    .dx-qtitle{ font-weight: 950; margin-bottom:.35rem; }
    .dx-example{ margin-top:.25rem; display:grid; gap:.25rem; }
    .dx-example .ex{ font-size:.9rem; color: var(--muted, #aab); }
    .dx-example .ex::before{ content:"• "; opacity:.9; }

    .dx-output{ min-width:0; }
    .dx-output pre{
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .dx-report{ margin-top: 1rem; }
    .dx-reportGrid{ display:grid; grid-template-columns: 1fr; gap:1rem; }
    .dx-reportBox{ padding: 1rem; border:1px solid rgba(255,255,255,.10); border-radius: var(--radius2, 18px); background: rgba(255,255,255,.02); }
    .dx-reportBox h3{ margin:0 0 .6rem; }
    .dx-badges{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .dx-note{ font-size:.9rem; color: var(--muted, #aab); }

    .dx-treeSvg { width:100%; height:auto; display:block; border-radius: 14px; }
    .dx-treeSvg text { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }

    /* Header cleanup overrides (safe on top of style.css) */
    .header__inner{ align-items:center; gap: 1rem; }
    .nav{ white-space:nowrap; }
    .header__actions{ display:flex; align-items:center; gap:.6rem; }
    .lang{ display:flex; gap:.35rem; align-items:center; }
    .burger{ margin-left: .25rem; }
    .drawer[hidden]{ display:none !important; }

    @media (max-width: 980px){
      .dx-top{ grid-template-columns: 1fr; }
      .nav{ display:none; }
    }
  </style>
</head>

<body>
  <a class="skip-link" href="#main">Skip</a>

  <header class="header" id="top">
    <div class="container header__inner">
      <a class="brand" href="./index.html" aria-label="Home">
        <span class="brand__mark" aria-hidden="true">MDG</span>
      </a>

      <nav class="nav" aria-label="Main">
        <a class="nav__link" href="./how.html" data-i18n="nav.how">How it works</a>
        <a class="nav__link" href="./why.html" data-i18n="nav.why">Why MDG</a>
        <a class="nav__link" href="./faq.html" data-i18n="nav.faq">FAQ</a>
      </nav>

      <div class="header__actions">
        <div class="lang" role="group" aria-label="Language">
          <button class="chip chip--ghost" type="button" data-lang="de" aria-pressed="true">DE</button>
          <button class="chip chip--ghost" type="button" data-lang="tr" aria-pressed="false">TR</button>
          <button class="chip chip--ghost" type="button" data-lang="en" aria-pressed="false">EN</button>
        </div>
        <a class="btn btn--ghost" href="./index.html" data-i18n="cta.backHome">Zur Homepage</a>
      </div>

      <button class="burger" type="button" aria-label="Menu" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
    </div>

    <div class="drawer" hidden>
      <div class="drawer__content">
        <a class="drawer__link" href="./how.html" data-i18n="nav.how">How it works</a>
        <a class="drawer__link" href="./why.html" data-i18n="nav.why">Why MDG</a>
        <a class="drawer__link" href="./faq.html" data-i18n="nav.faq">FAQ</a>
        <div class="drawer__sep"></div>
        <a class="btn btn--ghost btn--full" href="./index.html" data-i18n="cta.backHome">Zur Homepage</a>
      </div>
    </div>
  </header>

  <main id="main">
    <div class="dx-wrap">
      <div class="section__head">
        <h1 class="h2" data-i18n="dx.title">Diagnose</h1>
        <p class="sub" data-i18n="dx.sub">
          In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen.
        </p>
      </div>

      <div class="dx-top">
        <div class="card">
          <h2 class="h3" data-i18n="dx.contextTitle">1) Kontext</h2>

          <div class="dx-grid">
            <div class="dx-field">
              <div class="dx-label" data-i18n="dx.mode">Modus</div>
              <div class="dx-badges">
                <span class="micro" id="modeText">—</span>
                <span class="pill pill--muted" id="tokenBadge" style="display:none;">Token: ✓</span>
              </div>
              <div class="dx-help" id="modeHint"></div>
            </div>

            <div class="dx-field">
              <label class="dx-label" for="goalSelect" data-i18n="dx.goal">Ziel</label>
              <select class="dx-input" id="goalSelect">
                <option value="stabilize" data-i18n="dx.goal.stabilize">Stabilisieren (Spannung schnell senken)</option>
                <option value="rebuild" data-i18n="dx.goal.rebuild">Umbauen (Architektur verändern)</option>
              </select>
              <div class="dx-help" id="goalHelp"></div>
            </div>

            <div class="dx-field">
              <label class="dx-label" for="oneLiner" data-i18n="dx.oneliner">Beschreibe die Situation in einem Satz</label>
              <input class="dx-input" id="oneLiner" type="text" maxlength="160" placeholder="…" />
              <div class="dx-help" id="oneLinerHelp"></div>
            </div>

            <div class="dx-divider"></div>

            <h2 class="h3" style="margin:0;" data-i18n="dx.scanTitle">2) Quick Scan (Slider)</h2>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.load.title">Last & Engpässe</div>
              <div class="dx-help" id="exLoad"></div>
              <div class="dx-rangeRow">
                <input id="sLoad" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vLoad">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.decisions.title">Entscheidungsarchitektur</div>
              <div class="dx-help" id="exDecisions"></div>
              <div class="dx-rangeRow">
                <input id="sDecisions" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vDecisions">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.energy.title">Energie & Fehlerkultur</div>
              <div class="dx-help" id="exEnergy"></div>
              <div class="dx-rangeRow">
                <input id="sEnergy" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vEnergy">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.growth.title">Wachstumsdruck / Komplexität</div>
              <div class="dx-help" id="exGrowth"></div>
              <div class="dx-rangeRow">
                <input id="sGrowth" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vGrowth">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.power.title">Macht–Verantwortung (Alignment)</div>
              <div class="dx-help" id="exPower"></div>
              <div class="dx-rangeRow">
                <input id="sPower" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vPower">2</div>
              </div>
            </div>

            <div class="dx-divider"></div>

            <h2 class="h3" style="margin:0;" data-i18n="dx.moreTitle">3) Präzisionsfragen (adaptiv)</h2>
            <div class="dx-help" data-i18n="dx.moreHint">
              Beantworte die Folgefragen. Sie erhöhen die Präzision. Jede Frage hat 2 Beispiele.
            </div>

            <div class="dx-questions" id="questions"></div>

            <div class="dx-actions" style="margin-top: .9rem;">
              <button class="btn btn--primary" type="button" id="runBtn" data-i18n="dx.run">Diagnose starten</button>
              <button class="btn btn--ghost" type="button" id="resetBtn" data-i18n="dx.reset">Zurücksetzen</button>
              <span class="micro" id="statusLine">—</span>
            </div>

            <div class="dx-kpi" id="kpiRow">
              <span class="pill pill--muted" id="kpiPrimary">—</span>
              <span class="pill pill--muted" id="kpiPath">—</span>
              <span class="pill pill--muted" id="kpiRisk">—</span>
            </div>
          </div>
        </div>

        <div class="card dx-output">
          <h2 class="h3" data-i18n="dx.outputTitle">Output</h2>
          <p class="micro" data-i18n="dx.outputHint">
            Du erhältst: Primärinstabilität, warum sie entsteht, Sofortmaßnahmen und Umbaupfad.
          </p>

          <div class="dx-reportGrid">
            <div class="dx-reportBox">
              <h3 class="h3" style="margin-top:0;" data-i18n="dx.assessmentTitle">Strategisches Assessment</h3>
              <pre id="resultText" class="micro" style="margin:0;">—</pre>
            </div>

            <div class="dx-reportBox">
              <h3 class="h3" style="margin-top:0;" data-i18n="dx.execTitle">Executive Report</h3>
              <p class="dx-note" id="execHint"></p>

              <div class="dx-actions" style="margin-top:.6rem;">
                <button class="btn btn--primary" type="button" id="execBtn" data-i18n="dx.execBtn">Executive Report erzeugen</button>
                <button class="btn btn--ghost" type="button" id="copyExecBtn" disabled data-i18n="dx.copy">Kopieren</button>
                <button class="btn btn--ghost" type="button" id="svgBtn" data-i18n="dx.svgBtn">SVG</button>
                <button class="btn btn--ghost" type="button" id="pdfBtn" data-i18n="dx.pdfBtn">PDF</button>
              </div>

              <div class="dx-report" id="reportContainer" style="display:none;">
                <pre id="execText" class="micro" style="margin: .8rem 0 0;">—</pre>
              </div>

              <div class="dx-report" id="treeContainer" style="display:none; margin-top:.9rem;">
                <div class="micro" style="opacity:.85; margin-bottom:.4rem;" data-i18n="dx.treeTitle">Tree (SVG)</div>
                <div id="treeSvgWrap"></div>
              </div>
            </div>
          </div>

          <p class="micro" style="margin-top:1rem; opacity:.85;" data-i18n="dx.privacy">
            Datenschutz: Inputs werden via API nur zur Generierung von Assessment/Report verarbeitet.
          </p>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer__grid">
      <div>
        <div class="brand brand--footer">
          <span class="brand__mark" aria-hidden="true">MDG</span>
        </div>
        <p class="micro" data-i18n="footer.tag">Strukturdiagnose für Stabilisierung und Umbau.</p>
      </div>
      <div class="footer__legal">
        <a href="./impressum.html" rel="nofollow">Impressum</a>
        <a href="./datenschutz.html" rel="nofollow">Datenschutz</a>
        <a href="./kontakt.html" rel="nofollow">Kontakt</a>
      </div>
    </div>
  </footer>

  <script>
  (() => {
    const API_BASE = "https://api.mdg-indikation.de";
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    const burger = $(".burger");
    const drawer = $(".drawer");
    if (burger && drawer) {
      burger.addEventListener("click", () => {
        const isHidden = drawer.hasAttribute("hidden");
        if (isHidden) {
          drawer.removeAttribute("hidden");
          burger.setAttribute("aria-expanded", "true");
        } else {
          drawer.setAttribute("hidden", "");
          burger.setAttribute("aria-expanded", "false");
        }
      });
    }

    const params = new URLSearchParams(location.search);
    const modeParam = (params.get("mode") || "").toLowerCase();

    const ss = window.sessionStorage;
    const ls = window.localStorage;

    const storedMode = ((ss.getItem("mdg_mode") || ls.getItem("mdg_mode") || "")).toLowerCase();
    const businessOk = (ss.getItem("mdg_business_ok") === "1") || (ls.getItem("mdg_business_ok") === "1");
    const tokenStored =
      (ss.getItem("mdg_business_token") || ls.getItem("mdg_business_token") || ls.getItem("mdg_token") || "").trim();

    const wantsBusiness = (modeParam === "business") || (storedMode === "business");
    const mode = (wantsBusiness && businessOk) ? "business" : "private";

    $("#modeText").textContent = (mode === "business") ? "Business" : "Private";
    if (mode === "business") $("#tokenBadge").style.display = "";

    const dict = {
      de: {
        "nav.how":"Wie es funktioniert",
        "nav.why":"Warum MDG",
        "nav.faq":"FAQ",
        "cta.backHome":"Zur Homepage",

        "dx.title":"Diagnose",
        "dx.sub":"In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen.",
        "dx.contextTitle":"1) Kontext",
        "dx.mode":"Modus",
        "dx.goal":"Ziel",
        "dx.goal.stabilize":"Stabilisieren (Spannung schnell senken)",
        "dx.goal.rebuild":"Umbauen (Architektur verändern)",
        "dx.oneliner":"Beschreibe die Situation in einem Satz",
        "dx.scanTitle":"2) Quick Scan (Slider)",
        "dx.moreTitle":"3) Präzisionsfragen (adaptiv)",
        "dx.moreHint":"Beantworte die Folgefragen. Sie erhöhen die Präzision. Jede Frage hat 2 Beispiele.",
        "dx.run":"Diagnose starten",
        "dx.reset":"Zurücksetzen",

        "dx.outputTitle":"Output",
        "dx.outputHint":"Du erhältst: Primärinstabilität, warum sie entsteht, Sofortmaßnahmen und Umbaupfad.",
        "dx.assessmentTitle":"Strategisches Assessment",
        "dx.execTitle":"Executive Report",
        "dx.execBtn":"Executive Report erzeugen",
        "dx.copy":"Kopieren",
        "dx.svgBtn":"SVG",
        "dx.pdfBtn":"PDF",
        "dx.treeTitle":"Tree (SVG)",
        "dx.privacy":"Datenschutz: Inputs werden via API nur zur Generierung von Assessment/Report verarbeitet.",
        "footer.tag":"Strukturdiagnose für Stabilisierung und Umbau.",

        "q.load.title":"Last & Engpässe",
        "q.decisions.title":"Entscheidungsarchitektur",
        "q.energy.title":"Energie & Fehlerkultur",
        "q.growth.title":"Wachstumsdruck / Komplexität",
        "q.power.title":"Macht–Verantwortung (Alignment)",

        "kpi.primary":"Primär",
        "kpi.path":"Pfad",
        "kpi.risk":"Risiko",
      },
      tr: {
        "nav.how":"Nasıl çalışır",
        "nav.why":"Neden MDG",
        "nav.faq":"SSS",
        "cta.backHome":"Anasayfa",

        "dx.title":"Analiz",
        "dx.sub":"Birkaç dakika içinde karar güveni: istikrarsızlığı erken gör, nedeni doğru teşhis et, mimari kur.",
        "dx.contextTitle":"1) Bağlam",
        "dx.mode":"Mod",
        "dx.goal":"Hedef",
        "dx.goal.stabilize":"Stabilize et (gerilimi hızlı düşür)",
        "dx.goal.rebuild":"Yeniden kur (mimariyi değiştir)",
        "dx.oneliner":"Durumu tek cümleyle anlat",
        "dx.scanTitle":"2) Hızlı tarama (Slider)",
        "dx.moreTitle":"3) Kesinleştirme soruları",
        "dx.moreHint":"Takip sorularını yanıtla. Kesinliği artırır. Her soruda 2 örnek var.",
        "dx.run":"Başlat",
        "dx.reset":"Sıfırla",

        "dx.outputTitle":"Çıktı",
        "dx.outputHint":"Alacağın: ana instabilite, nedenleri, hemen yapılacaklar ve dönüşüm yolu.",
        "dx.assessmentTitle":"Stratejik değerlendirme",
        "dx.execTitle":"Executive Rapor",
        "dx.execBtn":"Executive raporu üret",
        "dx.copy":"Kopyala",
        "dx.svgBtn":"SVG",
        "dx.pdfBtn":"PDF",
        "dx.treeTitle":"Tree (SVG)",
        "dx.privacy":"Gizlilik: Veriler yalnızca rapor üretimi için API üzerinden işlenir.",
        "footer.tag":"Stabilizasyon ve yeniden kurulum için yapı teşhisi.",

        "q.load.title":"Yük & darboğazlar",
        "q.decisions.title":"Karar mimarisi",
        "q.energy.title":"Enerji & hata kültürü",
        "q.growth.title":"Büyüme baskısı / karmaşıklık",
        "q.power.title":"Güç–sorumluluk uyumu",

        "kpi.primary":"Ana",
        "kpi.path":"Yol",
        "kpi.risk":"Risk",
      },
      en: {
        "nav.how":"How it works",
        "nav.why":"Why MDG",
        "nav.faq":"FAQ",
        "cta.backHome":"Home",

        "dx.title":"Diagnosis",
        "dx.sub":"In a few minutes to decision-confidence: detect instability early, diagnose precisely, build architecture.",
        "dx.contextTitle":"1) Context",
        "dx.mode":"Mode",
        "dx.goal":"Goal",
        "dx.goal.stabilize":"Stabilize (reduce tension fast)",
        "dx.goal.rebuild":"Rebuild (change architecture)",
        "dx.oneliner":"Describe the situation in one sentence",
        "dx.scanTitle":"2) Quick Scan (sliders)",
        "dx.moreTitle":"3) Precision Questions (adaptive)",
        "dx.moreHint":"Answer the follow-up questions. They increase precision. Each question includes 2 examples.",
        "dx.run":"Run assessment",
        "dx.reset":"Reset",

        "dx.outputTitle":"Output",
        "dx.outputHint":"You will get: primary instability, why it happens, what to do now, and what to rebuild.",
        "dx.assessmentTitle":"Strategic Assessment",
        "dx.execTitle":"Executive Report",
        "dx.execBtn":"Generate Executive Report",
        "dx.copy":"Copy",
        "dx.svgBtn":"SVG",
        "dx.pdfBtn":"PDF",
        "dx.treeTitle":"Tree (SVG)",
        "dx.privacy":"Privacy: inputs are processed via API only to generate the assessment/report.",
        "footer.tag":"Structure diagnosis for stabilization and rebuild.",

        "q.load.title":"Load & bottlenecks",
        "q.decisions.title":"Decision architecture",
        "q.energy.title":"Energy & error handling",
        "q.growth.title":"Growth pressure / complexity",
        "q.power.title":"Power–responsibility alignment",

        "kpi.primary":"Primary",
        "kpi.path":"Path",
        "kpi.risk":"Risk",
      }
    };

    function getLang(){
      const pressed = $$("[data-lang]").find(b => b.getAttribute("aria-pressed") === "true");
      return pressed?.dataset.lang || "de";
    }

    function applyLang(lang){
      if(!dict[lang]) lang = "en";
      document.documentElement.lang = lang;

      $$("[data-lang]").forEach(b => b.setAttribute("aria-pressed", String(b.dataset.lang === lang)));
      $$("[data-i18n]").forEach(el => {
        const k = el.dataset.i18n;
        const v = dict[lang][k];
        if (v) el.textContent = v;
      });

      renderExamples(lang);
      renderAdaptiveQuestions(lang);
      renderHints(lang);
      syncKpis(lang, null);
    }

    $$("[data-lang]").forEach(btn => btn.addEventListener("click", () => applyLang(btn.dataset.lang)));

    function renderExamples(lang){
      const business = (mode === "business");
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));

      // Keine Wiederholungspille + kein “Premium”-Gerede – nur 1 klare Zeile
      if (wantsBusiness && !businessOk) {
        $("#modeHint").innerHTML = t(
          "Business-Zugang nicht aktiv. Bitte Token über die Homepage bestätigen.",
          "Business erişimi aktif değil. Lütfen token’ı ana sayfada doğrula.",
          "Business access not active. Please verify token on the homepage."
        );
      } else {
        $("#modeHint").innerHTML = business
          ? t(
              "Business-Modus: Fragen sind auf Unternehmen, Führung, Teams und Verantwortung zugeschnitten.",
              "Business modu: Sorular şirket, liderlik, ekip ve sorumluluk için özelleştirildi.",
              "Business mode: questions are tailored to companies, leadership, teams, and accountability."
            )
          : t(
              "Privat-Modus: Fokus auf persönliche Systeme, Beziehungen, Alltag, Rollen & Belastung.",
              "Özel mod: kişisel sistemler, ilişkiler, günlük hayat, roller ve yük odağı.",
              "Private mode: focus on personal systems, relationships, daily life, roles and load."
            );
      }

      // Ziel-Text: kurz (keine doppelte Erklärung)
      $("#goalHelp").innerHTML = t(
        "<b>Stabilisieren</b> = Spannung senken. <b>Umbauen</b> = Architektur ändern.",
        "<b>Stabilize</b> = gerilimi düşür. <b>Yeniden kur</b> = mimariyi değiştir.",
        "<b>Stabilize</b> = reduce tension. <b>Rebuild</b> = change architecture."
      );

      $("#oneLinerHelp").innerHTML = business
        ? t(
            "Beispiel 1: <b>„Unsere Entscheidungen dauern zu lange und hängen an 1 Person.“</b><br>Beispiel 2: <b>„Team A und B blockieren sich, Qualität fällt.“</b>",
            "Örnek 1: <b>“Kararlar çok uzun sürüyor ve 1 kişiye bağlı.”</b><br>Örnek 2: <b>“Takım A ve B birbirini kilitliyor, kalite düşüyor.”</b>",
            "Example 1: <b>“Decisions take too long and depend on one person.”</b><br>Example 2: <b>“Team A and B block each other, quality drops.”</b>"
          )
        : t(
            "Beispiel 1: <b>„Ich prokrastiniere und verliere Kontrolle über meinen Alltag.“</b><br>Beispiel 2: <b>„Wir haben wiederkehrende Konflikte und nichts ändert sich.“</b>",
            "Örnek 1: <b>“Erteleme yapıyorum ve günlük hayat kontrolüm kayıyor.”</b><br>Örnek 2: <b>“Tekrarlayan çatışmalar var ve hiçbir şey değişmiyor.”</b>",
            "Example 1: <b>“I procrastinate and lose control over my daily life.”</b><br>Example 2: <b>“We have recurring conflicts and nothing changes.”</b>"
          );

      $("#exLoad").innerHTML = business
        ? t(
          "0 = verteilt, kein Engpass. 6 = 1–2 Rollen sind Dauer-Engpass.<div class='dx-example'><div class='ex'>„Sales hängt an mir, ohne mich kein Abschluss.“</div><div class='ex'>„Ops ist 120% ausgelastet, alle warten.“</div></div>",
          "0 = darboğaz yok. 6 = 1–2 rol sürekli darboğaz.<div class='dx-example'><div class='ex'>“Satış bende; ben olmadan kapanış yok.”</div><div class='ex'>“Operasyon %120 dolu; herkes bekliyor.”</div></div>",
          "0 = no bottleneck. 6 = 1–2 roles are permanent bottlenecks.<div class='dx-example'><div class='ex'>“Sales depends on me; without me no close.”</div><div class='ex'>“Ops at 120%; everyone is waiting.”</div></div>"
        )
        : t(
          "0 = gleichmäßig tragbar. 6 = alles hängt an dir/1 Person.<div class='dx-example'><div class='ex'>„Wenn ich 2 Tage ausfalle, bricht alles.“</div><div class='ex'>„Ich mache 90% allein, niemand übernimmt.“</div></div>",
          "0 = dengeli. 6 = her şey sana/1 kişiye bağlı.<div class='dx-example'><div class='ex'>“2 gün yok olsam her şey çöker.”</div><div class='ex'>“%90’ını ben yapıyorum, kimse devralmıyor.”</div></div>",
          "0 = evenly manageable. 6 = everything depends on you/one person.<div class='dx-example'><div class='ex'>“If I’m out for 2 days, everything breaks.”</div><div class='ex'>“I do 90% alone; nobody takes over.”</div></div>"
        );

      $("#exDecisions").innerHTML = business
        ? t(
          "0 = klar & schnell. 6 = unklar, langsam, politisch.<div class='dx-example'><div class='ex'>„Keiner weiß wer entscheiden darf.“</div><div class='ex'>„3 Wochen diskutieren, dann passiert nichts.“</div></div>",
          "0 = net & hızlı. 6 = belirsiz, yavaş, politik.<div class='dx-example'><div class='ex'>“Kim karar verir belli değil.”</div><div class='ex'>“3 hafta tartışıp sonra hiçbir şey yapmıyoruz.”</div></div>",
          "0 = clear & fast. 6 = unclear, slow, political.<div class='dx-example'><div class='ex'>“No one knows who can decide.”</div><div class='ex'>“We debate for 3 weeks, then nothing happens.”</div></div>"
        )
        : t(
          "0 = klar entscheiden & umsetzen. 6 = Chaos/Endlosschleife.<div class='dx-example'><div class='ex'>„Ich ändere ständig die Richtung.“</div><div class='ex'>„Wir drehen uns im Kreis und eskalieren.“</div></div>",
          "0 = net karar + uygulama. 6 = kaos / kısır döngü.<div class='dx-example'><div class='ex'>“Sürekli yön değiştiriyorum.”</div><div class='ex'>“Kısır döngüdeyiz ve büyüyor.”</div></div>",
          "0 = clear decisions + execution. 6 = chaos / infinite loop.<div class='dx-example'><div class='ex'>“I constantly change direction.”</div><div class='ex'>“We go in circles and escalate.”</div></div>"
        );

      $("#exEnergy").innerHTML = business
        ? t(
          "0 = stabiler Rhythmus, Fehler werden genutzt. 6 = Überlastung, Fehler eskalieren.<div class='dx-example'><div class='ex'>„Fehler werden versteckt, niemand lernt.“</div><div class='ex'>„Dauerfeuer, keine Regeneration.“</div></div>",
          "0 = ritim iyi. 6 = aşırı yük, hatalar büyür.<div class='dx-example'><div class='ex'>“Hatalar saklanıyor, kimse öğrenmiyor.”</div><div class='ex'>“Sürekli yoğun; toparlanma yok.”</div></div>",
          "0 = stable rhythm. 6 = overload, errors escalate.<div class='dx-example'><div class='ex'>“Errors are hidden; nobody learns.”</div><div class='ex'>“Constant fire; no recovery.”</div></div>"
        )
        : t(
          "0 = Energie & Feedback. 6 = Limit, Fehler häufen sich.<div class='dx-example'><div class='ex'>„Ich schlafe schlecht und bin gereizt.“</div><div class='ex'>„Ich wiederhole dieselben Fehler.“</div></div>",
          "0 = enerji var. 6 = limit, hata artıyor.<div class='dx-example'><div class='ex'>“Kötü uyuyorum, çabuk sinirleniyorum.”</div><div class='ex'>“Aynı hataları tekrar ediyorum.”</div></div>",
          "0 = energy + feedback. 6 = at the limit, errors pile up.<div class='dx-example'><div class='ex'>“I sleep badly and get irritated.”</div><div class='ex'>“I keep repeating the same mistakes.”</div></div>"
        );

      $("#exGrowth").innerHTML = business
        ? t(
          "0 = Wachstum kontrolliert. 6 = Komplexität > Struktur.<div class='dx-example'><div class='ex'>„Neue Projekte rein, aber Prozesse fehlen.“</div><div class='ex'>„Koordination frisst Output.“</div></div>",
          "0 = kontrollü büyüme. 6 = karmaşıklık > yapı.<div class='dx-example'><div class='ex'>“Yeni projeler var ama süreç yok.”</div><div class='ex'>“Koordinasyon çıktıyı yiyor.”</div></div>",
          "0 = controlled growth. 6 = complexity > structure.<div class='dx-example'><div class='ex'>“New projects, but no processes.”</div><div class='ex'>“Coordination eats output.”</div></div>"
        )
        : t(
          "0 = wenig Komplexität. 6 = zu viele Themen, Überblick weg.<div class='dx-example'><div class='ex'>„Ich fange 10 Dinge an, nichts wird fertig.“</div><div class='ex'>„Alles wird gleichzeitig wichtiger.“</div></div>",
          "0 = düşük karmaşıklık. 6 = çok konu, kontrol kayıyor.<div class='dx-example'><div class='ex'>“10 şeye başlıyorum, bitmiyor.”</div><div class='ex'>“Her şey aynı anda acil.”</div></div>",
          "0 = low complexity. 6 = too many topics, you lose overview.<div class='dx-example'><div class='ex'>“I start 10 things, finish none.”</div><div class='ex'>“Everything becomes urgent at once.”</div></div>"
        );

      $("#exPower").innerHTML = business
        ? t(
          "0 = Verantwortung + Befugnis passen. 6 = Misalignment.<div class='dx-example'><div class='ex'>„Owner trägt KPI, darf nicht entscheiden.“</div><div class='ex'>„Entscheider trägt keine Konsequenz.“</div></div>",
          "0 = uyumlu. 6 = kopuk.<div class='dx-example'><div class='ex'>“KPI bende ama karar yetkisi yok.”</div><div class='ex'>“Karar veren sonucu taşımıyor.”</div></div>",
          "0 = aligned. 6 = misalignment.<div class='dx-example'><div class='ex'>“Owner has KPI but can’t decide.”</div><div class='ex'>“Decider bears no consequence.”</div></div>"
        )
        : t(
          "0 = Einfluss = Konsequenz. 6 = du trägst ohne Einfluss (oder umgekehrt).<div class='dx-example'><div class='ex'>„Ich muss liefern, aber andere blockieren.“</div><div class='ex'>„Ich entscheide, spüre aber keine Folgen.“</div></div>",
          "0 = etki = sonuç. 6 = etki yokken sonuç taşıma.<div class='dx-example'><div class='ex'>“Teslim bende ama başkası engelliyor.”</div><div class='ex'>“Karar veriyorum ama sonuç yaşamıyorum.”</div></div>",
          "0 = influence = consequence. 6 = you bear without influence (or vice versa).<div class='dx-example'><div class='ex'>“I must deliver but others block.”</div><div class='ex'>“I decide but feel no consequences.”</div></div>"
        );

      // Hint oben im Executive-Block (kurz)
      $("#execHint").textContent = business
        ? t(
          "Business: Diagnose + Operating Model + Rollen + Rhythmus + KPIs + 30-60-90.",
          "Business: teşhis + operating model + roller + ritim + KPI + 30-60-90.",
          "Business: diagnosis + operating model + roles + cadence + KPIs + 30-60-90."
        )
        : t(
          "Privat: Ursachenlogik, Spannungsdynamik, klare Prioritäten, konkrete Moves.",
          "Özel: neden mantığı, gerilim dinamiği, net öncelikler, somut adımlar.",
          "Private: causal logic, tension dynamics, clear priorities, concrete moves."
        );
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderAdaptiveQuestions(lang){
      const business = (mode === "business");
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));

      const qs = business ? [
        {
          id:"b_q1",
          title: t("Wo entsteht aktuell die größte Verzögerung?","En büyük gecikme nerede?","Where is the biggest delay?"),
          help: t("Wähle die passendste Option.","En uygunu seç.","Pick the best match."),
          options: [
            {v:"decisions", label:t("Entscheidungen (Freigaben/Eskalation)","Kararlar (onay/eskalasyon)","Decisions (approvals/escalation)")},
            {v:"handoff", label:t("Übergaben (Team→Team)","Devir (takım→takım)","Handoffs (team→team)")},
            {v:"quality", label:t("Qualität (Rework/Bugs)","Kalite (rework/bug)","Quality (rework/bugs)")},
            {v:"capacity", label:t("Kapazität (Leute/Skills)","Kapasite (kişi/skill)","Capacity (people/skills)")},
          ],
          ex: [
            t("Beispiel: „Freigaben brauchen immer den CEO.“","Örnek: “Onaylar hep CEO’da.”","Example: “Approvals always need the CEO.”"),
            t("Beispiel: „Team A wartet ständig auf Team B.“","Örnek: “Takım A hep Takım B’yi bekliyor.”","Example: “Team A constantly waits for Team B.”")
          ]
        },
        {
          id:"b_q2",
          title: t("Was passiert, wenn die Schlüsselrolle 2 Wochen ausfällt?","Kritik rol 2 hafta yoksa?","If the key role is out for 2 weeks?"),
          help: t("Wähle realistisch.","Gerçekçi seç.","Choose realistically."),
          options: [
            {v:"fine", label:t("Läuft weiter (kleine Reibung)","Devam eder (küçük sürtünme)","Continues (minor friction)")},
            {v:"slow", label:t("Wird deutlich langsamer","Belirgin yavaşlar","Gets clearly slower")},
            {v:"break", label:t("Bricht (Stop in Lieferung/Entscheid)","Kırılır (teslim/karar durur)","Breaks (delivery/decisions stop)")},
          ],
          ex: [
            t("Beispiel: „Pipeline steht, nur 1 Person kann schließen.“","Örnek: “Pipeline durur; 1 kişi kapatır.”","Example: “Pipeline stops; only one person can close.”"),
            t("Beispiel: „Wissen ist nur im Chat.“","Örnek: “Bilgi sadece chat’te.”","Example: “Knowledge only lives in chat.”")
          ]
        },
        {
          id:"b_q3",
          title: t("Wie klar sind Rollen & Zuständigkeiten?","Roller/sorumluluk ne kadar net?","How clear are roles & ownership?"),
          help: t("Wähle die passendste Option.","En uygunu seç.","Pick what’s most true."),
          options: [
            {v:"clear", label:t("Sehr klar (Owner, KPI, Entscheidung)","Çok net (owner, KPI, karar)","Very clear (owner, KPI, decision)")},
            {v:"mixed", label:t("Teilweise klar (Grauzonen)","Kısmen net (gri alan)","Partially clear (grey zones)")},
            {v:"unclear", label:t("Unklar (Konflikte/Eskalation)","Belirsiz (çatışma/eskalasyon)","Unclear (conflict/escalation)")},
          ],
          ex: [
            t("Beispiel: „Owner trägt KPI, Entscheidung liegt woanders.“","Örnek: “KPI bende, karar başka yerde.”","Example: “Owner has KPI, decision is elsewhere.”"),
            t("Beispiel: „Zwei Teams denken beide, sie sind verantwortlich.“","Örnek: “İki takım da ‘bizde’ diyor.”","Example: “Two teams both think they own it.”")
          ]
        }
      ] : [
        {
          id:"p_q1",
          title: t("Was ist der Haupt-Auslöser der Spannung?","Gerilimin ana tetikleyicisi?","Main trigger of the tension?"),
          help: t("Wähle die beste Option.","En iyisini seç.","Pick the best option."),
          options: [
            {v:"time", label:t("Zeitdruck / zu viele Dinge","Zaman baskısı / çok şey","Time pressure / too many things")},
            {v:"conflict", label:t("Konflikte / wiederkehrender Streit","Çatışma / tekrar eden konu","Conflict / recurring issue")},
            {v:"uncertainty", label:t("Unklarheit / Entscheidungen schieben","Belirsizlik / erteleme","Uncertainty / delayed decisions")},
            {v:"energy", label:t("Erschöpfung / wenig Regeneration","Yorgunluk / az toparlanma","Exhaustion / low recovery")},
          ],
          ex: [
            t("Beispiel: „Ich schiebe Entscheidungen, dann staut sich alles.“","Örnek: “Kararı erteliyorum, her şey birikiyor.”","Example: “I delay decisions, then everything piles up.”"),
            t("Beispiel: „Kleine Themen kippen sofort in Streit.“","Örnek: “Küçük şeyler hemen kavgaya döner.”","Example: “Small topics escalate into conflict.”")
          ]
        },
        {
          id:"p_q2",
          title: t("Wie stark hängt das System an 1 Person?","Sistem 1 kişiye ne kadar bağlı?","How much does the system depend on one person?"),
          help: t("Wähle realistisch.","Gerçekçi seç.","Choose realistically."),
          options: [
            {v:"low", label:t("Kaum (ersetzbar)","Az (değiştirilebilir)","Low (replaceable)")},
            {v:"medium", label:t("Teilweise (mit Aufwand)","Orta (eforla)","Medium (with effort)")},
            {v:"high", label:t("Sehr stark (fällt aus = bricht)","Çok (yoksa kırılır)","High (out = break)")},
          ],
          ex: [
            t("Beispiel: „Wenn ich weg bin, bleibt alles liegen.“","Örnek: “Ben yokken her şey durur.”","Example: “When I’m away, everything stalls.”"),
            t("Beispiel: „Andere können übernehmen, wenn es dokumentiert ist.“","Örnek: “Dokümanteyse başkası devralır.”","Example: “Others can take over if documented.”")
          ]
        },
        {
          id:"p_q3",
          title: t("Wie gut werden Fehler genutzt (statt versteckt)?","Hatalar öğrenmeye dönüyor mu?","How well are errors used (instead of hidden)?"),
          help: t("Wähle die beste Option.","En uygunu seç.","Pick the best option."),
          options: [
            {v:"good", label:t("Gut (lernen, anpassen)","İyi (öğrenme, uyum)","Good (learn, adapt)")},
            {v:"mixed", label:t("Gemischt","Karışık","Mixed")},
            {v:"bad", label:t("Schlecht (Schuld, Wiederholung)","Kötü (suçlama, tekrar)","Bad (blame, repeats)")},
          ],
          ex: [
            t("Beispiel: „Wir sprechen offen und ändern die Ursache.“","Örnek: “Açık konuşup kökü değiştiriyoruz.”","Example: “We talk openly and change the root cause.”"),
            t("Beispiel: „Fehler werden vertuscht, dann passiert es wieder.“","Örnek: “Hata saklanır, tekrar eder.”","Example: “Errors get hidden, then repeat.”")
          ]
        }
      ];

      const root = $("#questions");
      root.innerHTML = "";
      qs.forEach(q => {
        const wrap = document.createElement("div");
        wrap.className = "dx-q";
        wrap.innerHTML = `
          <div class="dx-qtitle">${escapeHtml(q.title)}</div>
          <div class="dx-help">${q.help ? escapeHtml(q.help) : ""}</div>
          <div class="dx-actions" style="margin-top:.55rem;">
            ${q.options.map(o => `
              <label class="pill pill--muted" style="cursor:pointer;">
                <input type="radio" name="${q.id}" value="${o.v}" style="margin-right:.4rem; accent-color: rgba(110,231,183,.9);" />
                ${escapeHtml(o.label)}
              </label>
            `).join("")}
          </div>
          <div class="dx-example">
            <div class="ex">${q.ex[0]}</div>
            <div class="ex">${q.ex[1]}</div>
          </div>
        `;
        root.appendChild(wrap);
      });
    }

    function renderHints(lang){
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));
      $("#statusLine").textContent = t("Status: bereit", "Durum: hazır", "Status: ready");
      $("#execText").textContent = "—";
      $("#resultText").textContent = "—";
      $("#copyExecBtn").disabled = true;
      $("#reportContainer").style.display = "none";
      $("#treeContainer").style.display = "none";
      $("#treeSvgWrap").innerHTML = "";
    }

    function syncSliders(){
      const pairs = [["sLoad","vLoad"],["sDecisions","vDecisions"],["sEnergy","vEnergy"],["sGrowth","vGrowth"],["sPower","vPower"]];
      pairs.forEach(([sid, vid]) => {
        const s = document.getElementById(sid);
        const v = document.getElementById(vid);
        if (s && v) v.textContent = s.value;
      });
    }
    $$('input[type="range"]').forEach(r => r.addEventListener("input", syncSliders));

    function readRadios(){
      const out = {};
      $$('input[type="radio"]:checked').forEach(r => { out[r.name] = r.value; });
      return out;
    }

    function buildPayload(){
      const oneLiner = ($("#oneLiner").value || "").trim();
      const intent = $("#goalSelect").value;

      const quick_scan = {
        load: Number($("#sLoad").value),
        decisions: Number($("#sDecisions").value),
        energy: Number($("#sEnergy").value),
        growth: Number($("#sGrowth").value),
        power: Number($("#sPower").value),
      };

      return {
        version: "v4",
        mode,
        token: (mode === "business") ? tokenStored : undefined,
        lang: getLang(),
        problem: oneLiner,
        intent,
        answers: { quick_scan, radios: readRadios() },
        meta: { ts: new Date().toISOString(), ua: navigator.userAgent }
      };
    }

    async function postJson(path, body){
      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || `Request failed (${res.status})`);
      return data;
    }

    function syncKpis(lang, data){
      const L = dict[lang] || dict.en;
      const p = data?.primary || "—";
      const path = data?.path || "—";
      const risk = data?.risk || "—";
      $("#kpiPrimary").textContent = `${L["kpi.primary"]}: ${p}`;
      $("#kpiPath").textContent = `${L["kpi.path"]}: ${path}`;
      $("#kpiRisk").textContent = `${L["kpi.risk"]}: ${risk}`;
    }

    let LAST_ASSESSMENT = null;
    let LAST_TREE_SVG = "";

    async function runAssessment(){
      const lang = getLang();
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));
      const payload = buildPayload();

      if (!payload.problem) {
        alert(t("Bitte beschreibe die Situation in einem Satz.", "Lütfen durumu tek cümleyle yaz.", "Please describe the situation in one sentence."));
        return;
      }
      if (mode === "business" && !payload.token) {
        alert(t("Business-Token fehlt. Bitte über die Homepage erneut einsteigen.", "Business token eksik. Lütfen ana sayfadan tekrar gir.", "Business token missing. Please re-enter via the homepage."));
        return;
      }

      $("#statusLine").textContent = t("Status: läuft …", "Durum: çalışıyor …", "Status: running …");
      $("#resultText").textContent = "—";
      $("#execText").textContent = "—";
      $("#copyExecBtn").disabled = true;
      $("#reportContainer").style.display = "none";
      $("#treeContainer").style.display = "none";
      $("#treeSvgWrap").innerHTML = "";
      LAST_TREE_SVG = "";

      try{
        const data = await postJson("/api/assess", payload);
        LAST_ASSESSMENT = data;

        $("#resultText").textContent = data.assessment_text || JSON.stringify(data, null, 2);
        syncKpis(lang, data);

        $("#statusLine").textContent = t("Status: fertig", "Durum: bitti", "Status: done");
      } catch(e){
        $("#statusLine").textContent = t("Status: Fehler – ", "Durum: Hata – ", "Status: Error – ") + (e?.message || String(e));
      }
    }
