<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagnose – MDG</title>
  <meta name="description" content="In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen." />
  <link rel="stylesheet" href="./style.css" />
  <style>
    /* minimal page-only tweaks (keeps v2 look via style.css) */
    .dx-wrap{ max-width: 1120px; margin: 0 auto; padding: 1.25rem 1rem 3rem; }
    .dx-top{ display:grid; grid-template-columns: 1.1fr .9fr; gap:1rem; align-items:start; }
    .dx-actions{ display:flex; gap:.65rem; flex-wrap:wrap; align-items:center; }
    .dx-kpi{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.8rem; }
    .dx-kpi .pill{ white-space:nowrap; }
    .dx-grid{ display:grid; grid-template-columns: 1fr; gap:.75rem; margin-top:.6rem; }
    .dx-field{ display:grid; gap:.35rem; }
    .dx-label{ font-weight: 800; color: var(--muted, #aab); }
    .dx-help{ font-size:.9rem; color: var(--muted, #aab); line-height:1.35; }
    .dx-help b{ color: var(--text, #fff); }
    .dx-rangeRow{ display:grid; grid-template-columns: 1fr auto; gap:.7rem; align-items:center; }
    .dx-rangeVal{ font-weight: 900; min-width: 2.2rem; text-align:right; }
    .dx-divider{ height:1px; background: rgba(255,255,255,.08); margin: .9rem 0; }
    .dx-questions{ display:grid; gap: 1rem; margin-top: 1rem; }
    .dx-q{ padding-top:.9rem; border-top: 1px solid rgba(255,255,255,.08); }
    .dx-q:first-child{ border-top: 0; padding-top: 0; }
    .dx-qtitle{ font-weight: 950; margin-bottom:.35rem; }
    .dx-example{ margin-top:.25rem; display:grid; gap:.25rem; }
    .dx-example .ex{ font-size:.9rem; color: var(--muted, #aab); }
    .dx-example .ex::before{ content:"• "; opacity:.9; }
    .dx-output pre{ white-space: pre-wrap; word-break: break-word; }
    .dx-report{ margin-top: 1rem; }
    .dx-reportGrid{ display:grid; grid-template-columns: 1fr; gap:1rem; }
    .dx-reportBox{ padding: 1rem; border:1px solid rgba(255,255,255,.10); border-radius: var(--radius2, 18px); background: rgba(255,255,255,.02); }
    .dx-reportBox h3{ margin:0 0 .6rem; }
    .dx-badges{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .dx-note{ font-size:.9rem; color: var(--muted, #aab); }
    @media (max-width: 980px){
      .dx-top{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <a class="skip-link" href="#main">Skip</a>

  <header class="header" id="top">
    <div class="container header__inner">
      <a class="brand" href="./index.html" aria-label="Home">
        <span class="brand__mark" aria-hidden="true">MDG</span>
        <span class="brand__text">v4</span>
      </a>

      <nav class="nav" aria-label="Main">
        <a class="nav__link" href="./index.html#how" data-i18n="nav.how">How it works</a>
        <a class="nav__link" href="./index.html#why" data-i18n="nav.why">Why MDG</a>
        <a class="nav__link" href="./index.html#faq" data-i18n="nav.faq">FAQ</a>
      </nav>

      <div class="header__actions">
        <div class="lang" role="group" aria-label="Language">
          <button class="chip chip--ghost" type="button" data-lang="de" aria-pressed="true">DE</button>
          <button class="chip chip--ghost" type="button" data-lang="tr" aria-pressed="false">TR</button>
          <button class="chip chip--ghost" type="button" data-lang="en" aria-pressed="false">EN</button>
        </div>
        <a class="btn btn--ghost" href="./index.html" data-i18n="cta.backHome">Home</a>
      </div>

      <button class="burger" type="button" aria-label="Menu" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
    </div>

    <div class="drawer" hidden>
      <div class="drawer__content">
        <a class="drawer__link" href="./index.html#how" data-i18n="nav.how">How it works</a>
        <a class="drawer__link" href="./index.html#why" data-i18n="nav.why">Why MDG</a>
        <a class="drawer__link" href="./index.html#faq" data-i18n="nav.faq">FAQ</a>
        <div class="drawer__sep"></div>
        <a class="btn btn--ghost btn--full" href="./index.html" data-i18n="cta.backHome">Home</a>
      </div>
    </div>
  </header>

  <main id="main">
    <div class="dx-wrap">
      <div class="section__head">
        <h1 class="h2" data-i18n="dx.title">Diagnosis</h1>
        <p class="sub" data-i18n="dx.sub">
          In a few minutes to decision-confidence: detect instability early, diagnose precisely, build architecture.
        </p>
      </div>

      <div class="dx-top">
        <!-- LEFT: input -->
        <div class="card">
          <h2 class="h3" data-i18n="dx.contextTitle">1) Context</h2>

          <div class="dx-grid">
            <div class="dx-field">
              <div class="dx-label" data-i18n="dx.mode">Mode</div>
              <div class="dx-badges">
                <span class="pill pill--muted" id="modeBadge">—</span>
                <span class="pill pill--muted" id="tokenBadge" style="display:none;">Token: ✓</span>
              </div>
              <div class="dx-help" id="modeHint"></div>
            </div>

            <div class="dx-field">
              <label class="dx-label" for="goalSelect" data-i18n="dx.goal">Goal</label>
              <select class="dx-input" id="goalSelect">
                <option value="stabilize" data-i18n="dx.goal.stabilize">Stabilize (reduce tension fast)</option>
                <option value="rebuild" data-i18n="dx.goal.rebuild">Rebuild (change architecture)</option>
              </select>
              <div class="dx-help" id="goalHelp"></div>
            </div>

            <div class="dx-field">
              <label class="dx-label" for="oneLiner" data-i18n="dx.oneliner">Describe the situation in one sentence</label>
              <input class="dx-input" id="oneLiner" type="text" maxlength="160" placeholder="…" />
              <div class="dx-help" id="oneLinerHelp"></div>
            </div>

            <div class="dx-divider"></div>

            <h2 class="h3" style="margin:0;" data-i18n="dx.scanTitle">2) Quick Scan (sliders)</h2>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.load.title">Load & bottlenecks</div>
              <div class="dx-help" id="exLoad"></div>
              <div class="dx-rangeRow">
                <input id="sLoad" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vLoad">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.decisions.title">Decision architecture</div>
              <div class="dx-help" id="exDecisions"></div>
              <div class="dx-rangeRow">
                <input id="sDecisions" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vDecisions">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.energy.title">Energy & error handling</div>
              <div class="dx-help" id="exEnergy"></div>
              <div class="dx-rangeRow">
                <input id="sEnergy" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vEnergy">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.growth.title">Growth pressure / complexity</div>
              <div class="dx-help" id="exGrowth"></div>
              <div class="dx-rangeRow">
                <input id="sGrowth" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vGrowth">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.power.title">Power–responsibility alignment</div>
              <div class="dx-help" id="exPower"></div>
              <div class="dx-rangeRow">
                <input id="sPower" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vPower">2</div>
              </div>
            </div>

            <div class="dx-divider"></div>

            <h2 class="h3" style="margin:0;" data-i18n="dx.moreTitle">3) Precision Questions (adaptive)</h2>
            <div class="dx-help" data-i18n="dx.moreHint">
              Answer the follow-up questions. They increase precision. Each question includes 2 simple examples.
            </div>

            <div class="dx-questions" id="questions"></div>

            <div class="dx-actions" style="margin-top: .9rem;">
              <button class="btn btn--primary" type="button" id="runBtn" data-i18n="dx.run">Run assessment</button>
              <button class="btn btn--ghost" type="button" id="resetBtn" data-i18n="dx.reset">Reset</button>
              <span class="micro" id="statusLine">—</span>
            </div>

            <div class="dx-kpi">
              <span class="pill pill--muted" id="kpiPrimary">Primary: —</span>
              <span class="pill pill--muted" id="kpiPath">Path: —</span>
              <span class="pill pill--muted" id="kpiRisk">Risk: —</span>
            </div>
          </div>
        </div>

        <!-- RIGHT: output -->
        <div class="card dx-output">
          <h2 class="h3" data-i18n="dx.outputTitle">Strategic Output</h2>
          <p class="micro" data-i18n="dx.outputHint">
            You will get: primary instability, why it happens, what to do now, and what to rebuild.
          </p>

          <div class="dx-reportGrid">
            <div class="dx-reportBox">
              <h3 class="h3" style="margin-top:0;" data-i18n="dx.assessmentTitle">Assessment</h3>
              <pre id="resultText" class="micro" style="margin:0;">—</pre>
            </div>

            <div class="dx-reportBox">
              <h3 class="h3" style="margin-top:0;" data-i18n="dx.execTitle">Executive Report (Premium)</h3>
              <p class="dx-note" id="execHint"></p>
              <div class="dx-actions" style="margin-top:.6rem;">
                <button class="btn btn--primary" type="button" id="execBtn" data-i18n="dx.execBtn">Generate Executive Report</button>
                <button class="btn btn--ghost" type="button" id="copyExecBtn" disabled data-i18n="dx.copy">Copy</button>
              </div>
              <div class="dx-report" id="reportContainer" style="display:none;">
                <pre id="execText" class="micro" style="margin: .8rem 0 0;">—</pre>
              </div>
            </div>
          </div>

          <p class="micro" style="margin-top:1rem; opacity:.85;" data-i18n="dx.privacy">
            Privacy: inputs are processed via API only to generate the assessment/report.
          </p>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer__grid">
      <div>
        <div class="brand brand--footer">
          <span class="brand__mark" aria-hidden="true">MDG</span>
          <span class="brand__text">v4</span>
        </div>
        <p class="micro" data-i18n="footer.tag">Structure diagnosis for stabilization and rebuild.</p>
      </div>
      <div class="footer__legal">
        <a href="./impressum.html" rel="nofollow">Impressum</a>
        <a href="./datenschutz.html" rel="nofollow">Datenschutz</a>
        <a href="./kontakt.html" rel="nofollow">Kontakt</a>
      </div>
    </div>
  </footer>

  <script src="./script.js" defer></script>

  <script>
  (() => {
    const API_BASE = "https://api.mdg-indikation.de";

    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    // ---- Mode detection (private vs business) ----
    // Business entry should set:
    // sessionStorage.setItem("mdg_business_ok","1")
    // sessionStorage.setItem("mdg_mode","business")
    // sessionStorage.setItem("mdg_business_token","MDG-0001-0001")
    // and navigate to: diagnose.html?mode=business
    const params = new URLSearchParams(location.search);
    const modeParam = (params.get("mode") || "").toLowerCase();
    const storedMode = (sessionStorage.getItem("mdg_mode") || "").toLowerCase();
    const businessOk = sessionStorage.getItem("mdg_business_ok") === "1";
    const businessToken = sessionStorage.getItem("mdg_business_token");

    const wantsBusiness = (modeParam === "business") || (storedMode === "business");
    const mode = (wantsBusiness && businessOk) ? "business" : "private";

    $("#modeBadge").textContent = mode === "business" ? "Business" : "Private";
    if (mode === "business") $("#tokenBadge").style.display = "";

    // ---- i18n ----
    const dict = {
      de: {
        "nav.how":"Wie es funktioniert",
        "nav.why":"Warum MDG",
        "nav.faq":"FAQ",
        "cta.backHome":"Zur Homepage",

        "dx.title":"Diagnose",
        "dx.sub":"In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen.",
        "dx.contextTitle":"1) Kontext",
        "dx.mode":"Modus",
        "dx.goal":"Ziel",
        "dx.goal.stabilize":"Stabilisieren (Spannung schnell senken)",
        "dx.goal.rebuild":"Umbauen (Architektur verändern)",
        "dx.oneliner":"Beschreibe die Situation in einem Satz",
        "dx.scanTitle":"2) Quick Scan (Slider)",
        "dx.moreTitle":"3) Präzisionsfragen (adaptiv)",
        "dx.moreHint":"Beantworte die Folgefragen. Sie erhöhen die Präzision. Jede Frage hat 2 simple Beispiele.",
        "dx.run":"Diagnose starten",
        "dx.reset":"Zurücksetzen",

        "dx.outputTitle":"Output",
        "dx.outputHint":"Du erhältst: Primärinstabilität, warum sie entsteht, Sofortmaßnahmen und Umbaupfad.",
        "dx.assessmentTitle":"Strategisches Assessment",
        "dx.execTitle":"Executive Report (Premium)",
        "dx.execBtn":"Executive Report erzeugen",
        "dx.copy":"Kopieren",
        "dx.privacy":"Datenschutz: Inputs werden via API nur zur Generierung von Assessment/Report verarbeitet.",
        "footer.tag":"Strukturdiagnose für Stabilisierung und Umbau.",

        "q.load.title":"Last & Engpässe",
        "q.decisions.title":"Entscheidungsarchitektur",
        "q.energy.title":"Energie & Fehlerkultur",
        "q.growth.title":"Wachstumsdruck / Komplexität",
        "q.power.title":"Macht–Verantwortung (Alignment)",
      },
      tr: {
        "nav.how":"Nasıl çalışır",
        "nav.why":"Neden MDG",
        "nav.faq":"SSS",
        "cta.backHome":"Anasayfa",

        "dx.title":"Analiz",
        "dx.sub":"Birkaç dakika içinde karar güveni: istikrarsızlığı erken gör, nedeni doğru teşhis et, mimari kur.",
        "dx.contextTitle":"1) Bağlam",
        "dx.mode":"Mod",
        "dx.goal":"Hedef",
        "dx.goal.stabilize":"Stabilize et (gerilimi hızlı düşür)",
        "dx.goal.rebuild":"Yeniden kur (mimariyi değiştir)",
        "dx.oneliner":"Durumu tek cümleyle anlat",
        "dx.scanTitle":"2) Hızlı tarama (Slider)",
        "dx.moreTitle":"3) Kesinleştirme soruları (adaptif)",
        "dx.moreHint":"Takip sorularını yanıtla. Kesinliği artırır. Her soruda 2 basit örnek var.",
        "dx.run":"Başlat",
        "dx.reset":"Sıfırla",

        "dx.outputTitle":"Çıktı",
        "dx.outputHint":"Alacağın: ana instabilite, nedenleri, hemen yapılacaklar ve dönüşüm yolu.",
        "dx.assessmentTitle":"Stratejik değerlendirme",
        "dx.execTitle":"Yönetici Raporu (Premium)",
        "dx.execBtn":"Yönetici raporu üret",
        "dx.copy":"Kopyala",
        "dx.privacy":"Gizlilik: Veriler yalnızca değerlendirme/rapor üretimi için API üzerinden işlenir.",
        "footer.tag":"Stabilizasyon ve yeniden kurulum için yapı teşhisi.",

        "q.load.title":"Yük & darboğazlar",
        "q.decisions.title":"Karar mimarisi",
        "q.energy.title":"Enerji & hata kültürü",
        "q.growth.title":"Büyüme baskısı / karmaşıklık",
        "q.power.title":"Güç–sorumluluk uyumu",
      },
      en: {
        "nav.how":"How it works",
        "nav.why":"Why MDG",
        "nav.faq":"FAQ",
        "cta.backHome":"Home",

        "dx.title":"Diagnosis",
        "dx.sub":"In a few minutes to decision-confidence: detect instability early, diagnose precisely, build architecture.",
        "dx.contextTitle":"1) Context",
        "dx.mode":"Mode",
        "dx.goal":"Goal",
        "dx.goal.stabilize":"Stabilize (reduce tension fast)",
        "dx.goal.rebuild":"Rebuild (change architecture)",
        "dx.oneliner":"Describe the situation in one sentence",
        "dx.scanTitle":"2) Quick Scan (sliders)",
        "dx.moreTitle":"3) Precision Questions (adaptive)",
        "dx.moreHint":"Answer the follow-up questions. They increase precision. Each question includes 2 simple examples.",
        "dx.run":"Run assessment",
        "dx.reset":"Reset",

        "dx.outputTitle":"Output",
        "dx.outputHint":"You will get: primary instability, why it happens, what to do now, and what to rebuild.",
        "dx.assessmentTitle":"Strategic Assessment",
        "dx.execTitle":"Executive Report (Premium)",
        "dx.execBtn":"Generate Executive Report",
        "dx.copy":"Copy",
        "dx.privacy":"Privacy: inputs are processed via API only to generate the assessment/report.",
        "footer.tag":"Structure diagnosis for stabilization and rebuild.",

        "q.load.title":"Load & bottlenecks",
        "q.decisions.title":"Decision architecture",
        "q.energy.title":"Energy & error handling",
        "q.growth.title":"Growth pressure / complexity",
        "q.power.title":"Power–responsibility alignment",
      }
    };

    function applyLang(lang){
      if(!dict[lang]) lang = "en";
      document.documentElement.lang = lang;
      $$("[data-lang]").forEach(b => b.setAttribute("aria-pressed", String(b.dataset.lang === lang)));
      $$("[data-i18n]").forEach(el => {
        const k = el.dataset.i18n;
        const v = dict[lang][k];
        if (v) el.textContent = v;
      });
      renderExamples(lang);
      renderAdaptiveQuestions(lang);
      renderHints(lang);
    }

    $$("[data-lang]").forEach(btn => btn.addEventListener("click", () => applyLang(btn.dataset.lang)));

    // ---- Examples (Business vs Private) ----
    function renderExamples(lang){
      const L = lang;
      const business = (mode === "business");
      const t = (kDe, kTr, kEn) => (L==="de"?kDe : (L==="tr"?kTr : kEn));

      // If user tries business without ok flag, warn (but still keep page functional in private)
      if (wantsBusiness && !businessOk) {
        $("#modeHint").innerHTML = t(
          "Business-Zugang nicht aktiv. Bitte Token über die Landingpage bestätigen.",
          "Business erişimi aktif değil. Lütfen token’ı ana sayfada doğrula.",
          "Business access not active. Please verify token on the landing page."
        );
      } else {
        $("#modeHint").innerHTML = business
          ? t(
              "Business-Modus: Fragen & Beispiele sind auf Unternehmen, Führung, Teams und Verantwortung zugeschnitten.",
              "Business modu: Sorular ve örnekler şirket, liderlik, ekip ve sorumluluk için özelleştirildi.",
              "Business mode: questions and examples are tailored to companies, leadership, teams, and accountability."
            )
          : t(
              "Privat-Modus: Fokus auf persönliche Systeme, Beziehungen, Alltag, Rollen & Belastung.",
              "Özel mod: kişisel sistemler, ilişkiler, günlük hayat, roller ve yük odağı.",
              "Private mode: focus on personal systems, relationships, daily life, roles and load."
            );
      }

      $("#goalHelp").innerHTML = t(
        "<b>Stabilisieren</b> = Sofortmaßnahmen gegen Spannung. <b>Umbauen</b> = strukturelle Änderungen, die zukünftige Brüche verhindern.",
        "<b>Stabilize</b> = gerilimi hızlı düşür. <b>Yeniden kur</b> = gelecekteki kırılmaları önleyecek yapısal değişim.",
        "<b>Stabilize</b> = immediate moves to reduce tension. <b>Rebuild</b> = structural changes to prevent future breaks."
      );

      $("#oneLinerHelp").innerHTML = business
        ? t(
            "Beispiel 1: <b>„Unsere Entscheidungen dauern zu lange und hängen an 1 Person.“</b><br>Beispiel 2: <b>„Team A und B blockieren sich, Qualität fällt.“</b>",
            "Örnek 1: <b>“Kararlar çok uzun sürüyor ve 1 kişiye bağlı.”</b><br>Örnek 2: <b>“Takım A ve B birbirini kilitliyor, kalite düşüyor.”</b>",
            "Example 1: <b>“Decisions take too long and depend on one person.”</b><br>Example 2: <b>“Team A and B block each other, quality drops.”</b>"
          )
        : t(
            "Beispiel 1: <b>„Ich prokrastiniere und verliere Kontrolle über meinen Alltag.“</b><br>Beispiel 2: <b>„Wir haben wiederkehrende Konflikte und nichts ändert sich.“</b>",
            "Örnek 1: <b>“Erteleme yapıyorum ve günlük hayat kontrolüm kayıyor.”</b><br>Örnek 2: <b>“Tekrarlayan çatışmalar var ve hiçbir şey değişmiyor.”</b>",
            "Example 1: <b>“I procrastinate and lose control over my daily life.”</b><br>Example 2: <b>“We have recurring conflicts and nothing changes.”</b>"
          );

      // Slider example blocks (2 examples each)
      $("#exLoad").innerHTML = business
        ? t(
            "0 = verteilt, kein Engpass. 6 = 1–2 Rollen sind Dauer-Engpass.<div class='dx-example'><div class='ex'>Beispiel: „Sales hängt an mir, ohne mich kein Abschluss.“</div><div class='ex'>Beispiel: „Ops ist 120% ausgelastet, alle warten.“</div></div>",
            "0 = dağıtık, darboğaz yok. 6 = 1–2 rol sürekli darboğaz.<div class='dx-example'><div class='ex'>Örnek: “Satış bende; ben olmadan kapanış yok.”</div><div class='ex'>Örnek: “Operasyon %120 dolu; herkes bekliyor.”</div></div>",
            "0 = distributed, no bottleneck. 6 = 1–2 roles are permanent bottlenecks.<div class='dx-example'><div class='ex'>Example: “Sales depends on me; without me no close.”</div><div class='ex'>Example: “Ops at 120%; everyone is waiting.”</div></div>"
          )
        : t(
            "0 = gleichmäßig tragbar. 6 = alles hängt an dir/1 Person.<div class='dx-example'><div class='ex'>Beispiel: „Wenn ich 2 Tage ausfalle, bricht alles.“</div><div class='ex'>Beispiel: „Ich mache 90% allein, niemand übernimmt.“</div></div>",
            "0 = dengeli. 6 = her şey sana/1 kişiye bağlı.<div class='dx-example'><div class='ex'>Örnek: “2 gün yok olsam her şey çöker.”</div><div class='ex'>Örnek: “%90’ını ben yapıyorum, kimse devralmıyor.”</div></div>",
            "0 = evenly manageable. 6 = everything depends on you/one person.<div class='dx-example'><div class='ex'>Example: “If I’m out for 2 days, everything breaks.”</div><div class='ex'>Example: “I do 90% alone; nobody takes over.”</div></div>"
          );

      $("#exDecisions").innerHTML = business
        ? t(
            "0 = klare Entscheidungen, kurze Wege. 6 = unklar, langsam, politisch.<div class='dx-example'><div class='ex'>Beispiel: „Keiner weiß wer entscheiden darf.“</div><div class='ex'>Beispiel: „Wir diskutieren 3 Wochen, dann passiert nichts.“</div></div>",
            "0 = net ve hızlı. 6 = belirsiz, yavaş, politik.<div class='dx-example'><div class='ex'>Örnek: “Kim karar verir belli değil.”</div><div class='ex'>Örnek: “3 hafta tartışıp hiçbir şey yapmıyoruz.”</div></div>",
            "0 = clear decisions, short cycle. 6 = unclear, slow, political.<div class='dx-example'><div class='ex'>Example: “No one knows who can decide.”</div><div class='ex'>Example: “We debate for 3 weeks, then nothing happens.”</div></div>"
          )
        : t(
            "0 = du entscheidest klar und setzt um. 6 = Chaos/Endlosschleife.<div class='dx-example'><div class='ex'>Beispiel: „Ich ändere ständig die Richtung.“</div><div class='ex'>Beispiel: „Wir drehen uns im Kreis und eskalieren.“</div></div>",
            "0 = net karar + uygulama. 6 = kaos / kısır döngü.<div class='dx-example'><div class='ex'>Örnek: “Sürekli yön değiştiriyorum.”</div><div class='ex'>Örnek: “Kısır döngüdeyiz ve büyüyor.”</div></div>",
            "0 = clear decisions + execution. 6 = chaos / infinite loop.<div class='dx-example'><div class='ex'>Example: “I constantly change direction.”</div><div class='ex'>Example: “We go in circles and escalate.”</div></div>"
          );

      $("#exEnergy").innerHTML = business
        ? t(
            "0 = stabiler Rhythmus, Fehler werden genutzt. 6 = Überlastung, Fehler eskalieren.<div class='dx-example'><div class='ex'>Beispiel: „Fehler werden versteckt, niemand lernt.“</div><div class='ex'>Beispiel: „Dauerfeuer, keine Regeneration.“</div></div>",
            "0 = ritim iyi, hatalardan öğreniliyor. 6 = aşırı yük, hatalar büyüyor.<div class='dx-example'><div class='ex'>Örnek: “Hatalar saklanıyor, kimse öğrenmiyor.”</div><div class='ex'>Örnek: “Sürekli yoğun, toparlanma yok.”</div></div>",
            "0 = stable rhythm, errors become learning. 6 = overload, errors escalate.<div class='dx-example'><div class='ex'>Example: “Errors are hidden; nobody learns.”</div><div class='ex'>Example: “Constant fire; no recovery.”</div></div>"
          )
        : t(
            "0 = du hast Energie & Feedback. 6 = du bist am Limit, Fehler häufen sich.<div class='dx-example'><div class='ex'>Beispiel: „Ich schlafe schlecht und bin gereizt.“</div><div class='ex'>Beispiel: „Ich mache ständig dieselben Fehler.“</div></div>",
            "0 = enerji var. 6 = limit, hata artıyor.<div class='dx-example'><div class='ex'>Örnek: “Kötü uyuyorum ve çabuk sinirleniyorum.”</div><div class='ex'>Örnek: “Aynı hataları tekrar ediyorum.”</div></div>",
            "0 = energy + feedback. 6 = at the limit, errors pile up.<div class='dx-example'><div class='ex'>Example: “I sleep badly and get irritated.”</div><div class='ex'>Example: “I keep repeating the same mistakes.”</div></div>"
          );

      $("#exGrowth").innerHTML = business
        ? t(
            "0 = Wachstum kontrolliert. 6 = Komplexität explodiert schneller als Struktur.<div class='dx-example'><div class='ex'>Beispiel: „Neue Projekte rein, aber Prozesse fehlen.“</div><div class='ex'>Beispiel: „Koordination frisst Output.“</div></div>",
            "0 = kontrollü büyüme. 6 = karmaşıklık yapıdan hızlı büyüyor.<div class='dx-example'><div class='ex'>Örnek: “Yeni projeler var ama süreç yok.”</div><div class='ex'>Örnek: “Koordinasyon çıktıyı yiyor.”</div></div>",
            "0 = controlled growth. 6 = complexity grows faster than structure.<div class='dx-example'><div class='ex'>Example: “New projects, but no processes.”</div><div class='ex'>Example: “Coordination eats output.”</div></div>"
          )
        : t(
            "0 = wenig Komplexität. 6 = zu viele Themen, du verlierst Überblick.<div class='dx-example'><div class='ex'>Beispiel: „Ich fange 10 Dinge an, nichts wird fertig.“</div><div class='ex'>Beispiel: „Alles wird gleichzeitig wichtiger.“</div></div>",
            "0 = az karmaşıklık. 6 = çok fazla konu, kontrol kayıyor.<div class='dx-example'><div class='ex'>Örnek: “10 işe başlıyorum, hiçbiri bitmiyor.”</div><div class='ex'>Örnek: “Her şey aynı anda acil oluyor.”</div></div>",
            "0 = low complexity. 6 = too many topics, you lose overview.<div class='dx-example'><div class='ex'>Example: “I start 10 things, finish none.”</div><div class='ex'>Example: “Everything becomes urgent at once.”</div></div>"
          );

      $("#exPower").innerHTML = business
        ? t(
            "0 = Verantwortung + Befugnis passen. 6 = Macht ohne Verantwortung ODER Verantwortung ohne Macht.<div class='dx-example'><div class='ex'>Beispiel: „Owner trägt KPI, aber darf nicht entscheiden.“</div><div class='ex'>Beispiel: „Entscheider trägt keine Konsequenz.“</div></div>",
            "0 = yetki+sorumluluk uyumlu. 6 = yetki-sorumluluk kopuk.<div class='dx-example'><div class='ex'>Örnek: “KPI bende ama karar yetkisi yok.”</div><div class='ex'>Örnek: “Karar veren sonuç taşımıyor.”</div></div>",
            "0 = authority matches responsibility. 6 = misalignment either way.<div class='dx-example'><div class='ex'>Example: “Owner has KPI but can’t decide.”</div><div class='ex'>Example: “Decider bears no consequence.”</div></div>"
          )
        : t(
            "0 = du kannst entscheiden und trägst es. 6 = du trägst Konsequenzen ohne Einfluss (oder umgekehrt).<div class='dx-example'><div class='ex'>Beispiel: „Ich muss liefern, aber andere blockieren.“</div><div class='ex'>Beispiel: „Ich entscheide, aber ich spüre keine Folgen.“</div></div>",
            "0 = karar+sonuç uyumlu. 6 = etki olmadan sonuç taşıma (ya da tersi).<div class='dx-example'><div class='ex'>Örnek: “Teslim bende ama başkaları engelliyor.”</div><div class='ex'>Örnek: “Karar veriyorum ama sonuç yaşamıyorum.”</div></div>",
            "0 = influence matches consequence. 6 = you bear consequences without influence (or vice versa).<div class='dx-example'><div class='ex'>Example: “I must deliver but others block.”</div><div class='ex'>Example: “I decide but feel no consequences.”</div></div>"
          );

      $("#execHint").textContent = business
        ? t(
            "Business-Report: präzise Diagnose, Architektur-Entscheidungen, Operating Model, Rollen, Rhythmus, KPIs, 30-60-90 Plan.",
            "Business raporu: kesin teşhis, mimari kararlar, işletim modeli, roller, ritim, KPI’lar, 30-60-90 planı.",
            "Business report: precise diagnosis, architecture decisions, operating model, roles, cadence, KPIs, 30-60-90 plan."
          )
        : t(
            "Privat-Report: Ursachenlogik, Spannungsdynamik, klare Prioritäten, konkrete Moves, Stabilisierung vs Umbau.",
            "Özel rapor: neden mantığı, gerilim dinamiği, net öncelikler, somut adımlar, stabilize vs yeniden kur.",
            "Private report: causal logic, tension dynamics, clear priorities, concrete moves, stabilize vs rebuild."
          );
    }

    // ---- Adaptive questions (2 examples each, business-specific) ----
    function renderAdaptiveQuestions(lang){
      const L = lang;
      const business = (mode === "business");
      const t = (de,tr,en) => (L==="de"?de:(L==="tr"?tr:en));

      const qs = business ? [
        {
          id:"b_q1",
          title: t("Wo entsteht aktuell die größte Verzögerung?", "En büyük gecikme nerede oluşuyor?", "Where is the biggest delay right now?"),
          help: t("Wähle, was am besten passt.", "En uygun olanı seç.", "Pick the best match."),
          options: [
            {v:"decisions", label:t("Entscheidungen (Freigaben, Eskalation)", "Kararlar (onaylar, eskalasyon)", "Decisions (approvals, escalation)")},
            {v:"handoff", label:t("Übergaben (zwischen Teams/Funktionen)", "Devirler (takımlar arası)", "Handoffs (between teams/functions)")},
            {v:"quality", label:t("Qualität (Rework, Bugs, Nacharbeit)", "Kalite (yeniden iş, bug)", "Quality (rework, bugs)")},
            {v:"capacity", label:t("Kapazität (zu wenig Leute/Skills)", "Kapasite (yetersiz kişi/skill)", "Capacity (too few people/skills)")},
          ],
          ex: [
            t("Beispiel: „Freigaben brauchen immer den CEO.“","Örnek: “Onaylar hep CEO’ya gidiyor.”","Example: “Approvals always need the CEO.”"),
            t("Beispiel: „Team A wartet ständig auf Team B.“","Örnek: “Takım A sürekli Takım B’yi bekliyor.”","Example: “Team A constantly waits for Team B.”")
          ]
        },
        {
          id:"b_q2",
          title: t("Was passiert, wenn die Schlüsselrolle 2 Wochen ausfällt?", "Kritik rol 2 hafta yoksa ne olur?", "What happens if the key role is out for 2 weeks?"),
          help: t("Wähle die realistischste Antwort.", "Gerçekçi olanı seç.", "Choose the most realistic."),
          options: [
            {v:"fine", label:t("Läuft weiter (kleine Reibung)", "Devam eder (küçük sürtünme)", "Continues (minor friction)")},
            {v:"slow", label:t("Wird deutlich langsamer", "Belirgin yavaşlar", "Gets clearly slower")},
            {v:"break", label:t("Bricht (Lieferung/Entscheidung stoppt)", "Kırılır (teslim/karar durur)", "Breaks (delivery/decisions stop)")},
          ],
          ex: [
            t("Beispiel: „Pipeline steht, weil nur 1 Person abschließen darf.“","Örnek: “Pipeline durur çünkü kapatmayı 1 kişi biliyor.”","Example: “Pipeline stops because only one person can close.”"),
            t("Beispiel: „Niemand kennt die Schritte – alles hängt an Chat/Slack.“","Örnek: “Kimse adımları bilmiyor – her şey Slack’te.”","Example: “No one knows the steps—everything is in Slack.”")
          ]
        },
        {
          id:"b_q3",
          title: t("Wie klar sind Rollen & Zuständigkeiten?", "Roller ve sorumluluklar ne kadar net?", "How clear are roles & ownership?"),
          help: t("Wähle, was am ehesten stimmt.", "En doğru olanı seç.", "Pick what’s most true."),
          options: [
            {v:"clear", label:t("Sehr klar (Owner, KPI, Entscheidung)", "Çok net (owner, KPI, karar)", "Very clear (owner, KPI, decision)")},
            {v:"mixed", label:t("Teilweise klar (Grauzonen)", "Kısmen net (gri alan)", "Partially clear (grey zones)")},
            {v:"unclear", label:t("Unklar (Konflikte/Eskalation)", "Belirsiz (çatışma/eskalasyon)", "Unclear (conflict/escalation)")},
          ],
          ex: [
            t("Beispiel: „Owner trägt KPI, aber Entscheidung liegt woanders.“","Örnek: “KPI owner’da ama karar başka yerde.”","Example: “Owner has KPI but decision is elsewhere.”"),
            t("Beispiel: „Zwei Teams glauben beide, verantwortlich zu sein.“","Örnek: “İki takım da sorumlu olduğunu sanıyor.”","Example: “Two teams both think they own it.”")
          ]
        }
      ] : [
        {
          id:"p_q1",
          title: t("Was ist der Haupt-Auslöser der Spannung?", "Gerilimin ana tetikleyicisi nedir?", "What’s the main trigger of the tension?"),
          help: t("Wähle die beste Option.", "En uygun olanı seç.", "Pick the best option."),
          options: [
            {v:"time", label:t("Zeitdruck / zu viele Dinge", "Zaman baskısı / çok şey", "Time pressure / too many things")},
            {v:"conflict", label:t("Konflikte / wiederkehrende Streitpunkte", "Çatışma / tekrar eden konu", "Conflict / recurring issue")},
            {v:"uncertainty", label:t("Unklarheit / Entscheidungen schieben", "Belirsizlik / erteleme", "Uncertainty / delayed decisions")},
            {v:"energy", label:t("Erschöpfung / wenig Regeneration", "Yorgunluk / az toparlanma", "Exhaustion / low recovery")},
          ],
          ex: [
            t("Beispiel: „Ich schiebe Entscheidungen, dann staut sich alles.“","Örnek: “Kararı erteliyorum, sonra her şey birikiyor.”","Example: “I delay decisions, then everything piles up.”"),
            t("Beispiel: „Wir kippen bei kleinen Themen sofort in Streit.“","Örnek: “Küçük şeylerde hemen tartışmaya dönüyor.”","Example: “Small topics quickly escalate into conflict.”")
          ]
        },
        {
          id:"p_q2",
          title: t("Wie stark hängt das System an 1 Person?", "Sistem 1 kişiye ne kadar bağlı?", "How much does the system depend on one person?"),
          help: t("Wähle realistisch.", "Gerçekçi seç.", "Choose realistically."),
          options: [
            {v:"low", label:t("Kaum (ersetzbar)", "Az (değiştirilebilir)", "Low (replaceable)")},
            {v:"medium", label:t("Teilweise (mit Aufwand)", "Orta (eforla)", "Medium (with effort)")},
            {v:"high", label:t("Sehr stark (fällt aus = bricht)", "Çok (yoksa kırılır)", "High (out = break)")},
          ],
          ex: [
            t("Beispiel: „Wenn ich weg bin, bleibt alles liegen.“","Örnek: “Ben yokken her şey durur.”","Example: “When I’m away, everything stalls.”"),
            t("Beispiel: „Andere können übernehmen, wenn es dokumentiert ist.“","Örnek: “Dokümanteyse başkası devralır.”","Example: “Others can take over if documented.”")
          ]
        },
        {
          id:"p_q3",
          title: t("Wie gut werden Fehler genutzt (statt versteckt)?", "Hatalar saklanmak yerine ne kadar öğrenmeye dönüyor?", "How well are errors used (instead of hidden)?"),
          help: t("Wähle die beste Option.", "En uygun olanı seç.", "Pick the best option."),
          options: [
            {v:"good", label:t("Gut (lernen, anpassen)", "İyi (öğrenme, uyum)", "Good (learn, adapt)")},
            {v:"mixed", label:t("Gemischt", "Karışık", "Mixed")},
            {v:"bad", label:t("Schlecht (Schuld, Wiederholung)", "Kötü (suçlama, tekrar)", "Bad (blame, repeats)")},
          ],
          ex: [
            t("Beispiel: „Wir sprechen offen und ändern die Ursache.“","Örnek: “Açık konuşup kökü değiştiriyoruz.”","Example: “We talk openly and change the root cause.”"),
            t("Beispiel: „Fehler werden vertuscht, dann passiert es wieder.“","Örnek: “Hata saklanır, tekrar olur.”","Example: “Errors get hidden, then repeat.”")
          ]
        }
      ];

      const root = $("#questions");
      root.innerHTML = "";
      qs.forEach(q => {
        const wrap = document.createElement("div");
        wrap.className = "dx-q";
        wrap.innerHTML = `
          <div class="dx-qtitle">${escapeHtml(q.title)}</div>
          <div class="dx-help">${q.help ? escapeHtml(q.help) : ""}</div>
          <div class="dx-actions" style="margin-top:.55rem;">
            ${q.options.map(o => `
              <label class="pill pill--muted" style="cursor:pointer;">
                <input type="radio" name="${q.id}" value="${o.v}" style="margin-right:.4rem; accent-color: rgba(110,231,183,.9);" />
                ${escapeHtml(o.label)}
              </label>
            `).join("")}
          </div>
          <div class="dx-example">
            <div class="ex">${q.ex[0]}</div>
            <div class="ex">${q.ex[1]}</div>
          </div>
        `;
        root.appendChild(wrap);
      });
    }

    function renderHints(lang){
      const L = lang;
      const t = (de,tr,en) => (L==="de"?de:(L==="tr"?tr:en));
      $("#statusLine").textContent = t("Status: bereit", "Durum: hazır", "Status: ready");
      $("#execText").textContent = "—";
      $("#resultText").textContent = "—";
      $("#copyExecBtn").disabled = true;
      $("#reportContainer").style.display = "none";
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ---- Sliders ----
    function syncSliders(){
      const pairs = [
        ["sLoad","vLoad"],
        ["sDecisions","vDecisions"],
        ["sEnergy","vEnergy"],
        ["sGrowth","vGrowth"],
        ["sPower","vPower"],
      ];
      pairs.forEach(([sid, vid]) => {
        const s = document.getElementById(sid);
        const v = document.getElementById(vid);
        if (s && v) v.textContent = s.value;
      });
    }
    $$('input[type="range"]').forEach(r => r.addEventListener("input", syncSliders));

    // ---- Build payload ----
    function getLang(){
      const pressed = $$("[data-lang]").find(b => b.getAttribute("aria-pressed") === "true");
      return pressed?.dataset.lang || "en";
    }

    function readRadios(){
      const out = {};
      $$('input[type="radio"]:checked').forEach(r => { out[r.name] = r.value; });
      return out;
    }

    // NOTE: Worker expects keys like: problem, intent, answers
    // We send BOTH:
    // - new keys for worker (problem/intent/answers)
    // - old keys for compatibility/debugging (one_liner/goal/quick_scan)
    function buildPayload(){
      const oneLiner = ($("#oneLiner").value || "").trim();
      const goal = $("#goalSelect").value;

      const quick_scan = {
        load: Number($("#sLoad").value),
        decisions: Number($("#sDecisions").value),
        energy: Number($("#sEnergy").value),
        growth: Number($("#sGrowth").value),
        power: Number($("#sPower").value),
      };

      const radioAnswers = readRadios();

      const answers = {
        quick_scan,
        radios: radioAnswers
      };

      return {
        version: "v4",
        mode,
        token: (mode === "business") ? businessToken : undefined,

        // worker-facing keys
        problem: oneLiner,
        intent: goal,
        answers,

        // legacy/debug keys (keep)
        lang: getLang(),
        goal,
        one_liner: oneLiner,
        quick_scan,
        meta: {
          ts: new Date().toISOString(),
          ua: navigator.userAgent
        }
      };
    }

    // ---- Calls ----
    async function postJson(path, body){
      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || `Request failed (${res.status})`);
      return data;
    }

    let LAST_ASSESSMENT = null;

    async function runAssessment(){
      const lang = getLang();
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));

      const payload = buildPayload();

      if (!payload.problem) {
        alert(t("Bitte beschreibe die Situation in einem Satz.", "Lütfen durumu tek cümleyle yaz.", "Please describe the situation in one sentence."));
        return;
      }

      if (mode === "business" && !payload.token) {
        alert(t("Business-Token fehlt. Bitte über die Landingpage erneut einsteigen.", "Business token eksik. Lütfen ana sayfadan tekrar gir.", "Business token missing. Please re-enter via landing page."));
        return;
      }

      $("#statusLine").textContent = t("Status: läuft …", "Durum: çalışıyor …", "Status: running …");
      $("#resultText").textContent = "—";
      $("#copyExecBtn").disabled = true;
      $("#reportContainer").style.display = "none";
      $("#execText").textContent = "—";

      try{
        const data = await postJson("/api/assess", payload);
        LAST_ASSESSMENT = data;

        const text = data.assessment_text || data.assessment || data.text || JSON.stringify(data, null, 2);
        $("#resultText").textContent = text;

        // KPIs (best-effort)
        $("#kpiPrimary").textContent = "Primary: " + (data.primary || data.primary_label || data.dominant || "—");
        $("#kpiPath").textContent = "Path: " + (data.path || "—");
        $("#kpiRisk").textContent = "Risk: " + (data.risk || data.risk_level || "—");

        $("#statusLine").textContent = t("Status: fertig", "Durum: bitti", "Status: done");
      } catch(e){
        $("#statusLine").textContent = t("Status: Fehler – ", "Durum: Hata – ", "Status: Error – ") + (e?.message || String(e));
      }
    }

    async function runExecutiveReport(){
      const lang = getLang();
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));

      if (!LAST_ASSESSMENT) {
        alert(t("Bitte zuerst die Diagnose starten.", "Önce değerlendirmeyi çalıştır.", "Run the assessment first."));
        return;
      }

      $("#statusLine").textContent = t("Status: Report wird erstellt …", "Durum: Rapor oluşturuluyor …", "Status: generating report …");
      $("#execText").textContent = "—";
      $("#copyExecBtn").disabled = true;
      $("#reportContainer").style.display = "none";

      try{
        const payload = buildPayload();
        payload.assessment = LAST_ASSESSMENT;

        const data = await postJson("/api/report", payload);

        // Worker returns: report_markdown
        const text =
          data.report_markdown ||
          data.report_text ||
          data.executive_report ||
          JSON.stringify(data, null, 2);

        $("#execText").textContent = text;
        $("#reportContainer").style.display = "";
        $("#copyExecBtn").disabled = false;

        $("#statusLine").textContent = t("Status: Report fertig", "Durum: Rapor hazır", "Status: report ready");
      } catch(e){
        $("#statusLine").textContent = t("Status: Fehler – ", "Durum: Hata – ", "Status: Error – ") + (e?.message || String(e));
      }
    }

    // ---- Reset ----
    function resetAll(){
      $("#oneLiner").value = "";
      $("#goalSelect").value = "stabilize";
      ["sLoad","sDecisions","sEnergy","sGrowth","sPower"].forEach(id => {
        const el = $("#" + id);
        if (el) el.value = "2";
      });
      $$('input[type="radio"]').forEach(r => r.checked = false);
      LAST_ASSESSMENT = null;
      $("#resultText").textContent = "—";
      $("#execText").textContent = "—";
      $("#reportContainer").style.display = "none";
      $("#copyExecBtn").disabled = true;
      $("#kpiPrimary").textContent = "Primary: —";
      $("#kpiPath").textContent = "Path: —";
      $("#kpiRisk").textContent = "Risk: —";
      const lang = getLang();
      $("#statusLine").textContent = (lang==="de"?"Status: bereit":(lang==="tr"?"Durum: hazır":"Status: ready"));
      syncSliders();
    }

    // ---- Copy ----
    $("#copyExecBtn").addEventListener("click", async () => {
      const txt = $("#execText").textContent || "";
      if (!txt || txt === "—") return;
      try {
        await navigator.clipboard.writeText(txt);
        const lang = getLang();
        $("#statusLine").textContent = (lang==="de"?"Status: kopiert":(lang==="tr"?"Durum: kopyalandı":"Status: copied"));
      } catch {
        // ignore
      }
    });

    // ---- Wire buttons ----
    $("#runBtn").addEventListener("click", runAssessment);
    $("#execBtn").addEventListener("click", runExecutiveReport);
    $("#resetBtn").addEventListener("click", () => {
      const lang = getLang();
      const ok = confirm(lang==="de" ? "Wirklich zurücksetzen?" : (lang==="tr" ? "Sıfırlansın mı?" : "Reset?"));
      if (ok) resetAll();
    });

    // ---- Init ----
    syncSliders();
    const defaultLang = "de";
    applyLang(defaultLang);
  })();
  </script>
</body>
</html>
