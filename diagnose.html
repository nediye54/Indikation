<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagnose – MDG</title>
  <meta name="description" content="In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen." />
  <link rel="stylesheet" href="./style.css" />
  <style>
    /* Drop 4 UI polish (page-only) */
    .dx-wrap{ max-width: 1120px; margin: 0 auto; padding: 1.25rem 1rem 3rem; }

    /* keep 2-column layout stable (output must NOT shrink) */
    .dx-top{
      display:grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(380px, .9fr);
      gap:1rem;
      align-items:start;
    }
    @media (max-width: 980px){
      .dx-top{ grid-template-columns: 1fr; }
    }

    .dx-actions{ display:flex; gap:.65rem; flex-wrap:wrap; align-items:center; }
    .dx-kpi{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.8rem; }
    .dx-kpi .pill{ white-space:nowrap; }
    .dx-grid{ display:grid; grid-template-columns: 1fr; gap:.75rem; margin-top:.6rem; }
    .dx-field{ display:grid; gap:.35rem; }
    .dx-label{ font-weight: 800; color: var(--muted, #aab); }
    .dx-help{ font-size:.9rem; color: var(--muted, #aab); line-height:1.35; }
    .dx-help b{ color: var(--text, #fff); }
    .dx-rangeRow{ display:grid; grid-template-columns: 1fr auto; gap:.7rem; align-items:center; }
    .dx-rangeVal{ font-weight: 900; min-width: 2.2rem; text-align:right; }
    .dx-divider{ height:1px; background: rgba(255,255,255,.08); margin: .9rem 0; }
    .dx-questions{ display:grid; gap: 1rem; margin-top: 1rem; }
    .dx-q{ padding-top:.9rem; border-top: 1px solid rgba(255,255,255,.08); }
    .dx-q:first-child{ border-top: 0; padding-top: 0; }
    .dx-qtitle{ font-weight: 950; margin-bottom:.35rem; }

    /* output: readable, stable width */
    .dx-output{ min-width: 0; }
    .dx-output pre{
      white-space: pre-wrap;
      word-break: break-word;
      overflow: auto;
      max-height: 46vh;
    }

    .dx-report{ margin-top: 1rem; }
    .dx-reportGrid{ display:grid; grid-template-columns: 1fr; gap:1rem; }
    .dx-reportBox{
      padding: 1rem;
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2, 18px);
      background: rgba(255,255,255,.02);
    }
    .dx-reportBox h3{ margin:0 0 .6rem; }
    .dx-note{ font-size:.9rem; color: var(--muted, #aab); }

    /* Header cleanup: remove visual clutter + stop duplicate drawer showing */
    .brand__text{ display:none !important; } /* removes "v4" next to MDG */
    .drawer[hidden]{ display:none !important; }

    /* small UI cleanup */
    .dx-modeLine{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .dx-modeTag{ font-weight:900; }

    /* Feedback UI */
    .dx-feedbackGrid{ display:grid; gap:.65rem; margin-top:.8rem; }
    .dx-fRow{ display:grid; gap:.35rem; }
    .dx-fLabel{ font-weight:800; color: var(--muted, #aab); font-size:.95rem; }
    .dx-fSmall{ font-size:.85rem; color: var(--muted, #aab); }
    .dx-fSplit{ display:grid; grid-template-columns: 1fr; gap:.6rem; }
    .dx-fInline{ display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
    .dx-fStatus{ opacity:.85; }
  </style>
</head>

  <header class="header" id="top">
    <div class="container header__inner">
      <a class="brand" href="./index.html" aria-label="Home">
        <span class="brand__mark" aria-hidden="true">MDG</span>
        <span class="brand__text">v4</span>
      </a>

      <nav class="nav" aria-label="Main">
        <a class="nav__link" href="./how.html" data-i18n="nav.how">How it works</a>
        <a class="nav__link" href="./why.html" data-i18n="nav.why">Why MDG</a>
        <a class="nav__link" href="./faq.html" data-i18n="nav.faq">FAQ</a>
      </nav>

      <div class="header__actions">
        <div class="lang" role="group" aria-label="Language">
          <button class="chip chip--ghost" type="button" data-lang="de" aria-pressed="true">DE</button>
          <button class="chip chip--ghost" type="button" data-lang="tr" aria-pressed="false">TR</button>
          <button class="chip chip--ghost" type="button" data-lang="en" aria-pressed="false">EN</button>
        </div>
        <a class="btn btn--ghost" href="./index.html" data-i18n="cta.backHome">Zur Homepage</a>
      </div>

      <button class="burger" type="button" aria-label="Menu" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
    </div>

    <div class="drawer" hidden>
      <div class="drawer__content">
        <a class="drawer__link" href="./how.html" data-i18n="nav.how">How it works</a>
        <a class="drawer__link" href="./why.html" data-i18n="nav.why">Why MDG</a>
        <a class="drawer__link" href="./faq.html" data-i18n="nav.faq">FAQ</a>
        <div class="drawer__sep"></div>
        <a class="btn btn--ghost btn--full" href="./index.html" data-i18n="cta.backHome">Zur Homepage</a>
      </div>
    </div>
  </header>

  <main id="main">
    <div class="dx-wrap">
      <div class="section__head">
        <h1 class="h2" data-i18n="dx.title">Diagnose</h1>
        <p class="sub" data-i18n="dx.sub">
          In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen.
        </p>
      </div>

      <div class="dx-top">
        <!-- LEFT: input -->
        <div class="card">
          <h2 class="h3" data-i18n="dx.contextTitle">1) Kontext</h2>

          <div class="dx-grid">
            <div class="dx-field">
              <div class="dx-label" data-i18n="dx.mode">Modus</div>

              <div class="dx-modeLine">
                <span class="dx-modeTag" id="modeText">—</span>
                <span class="pill pill--muted" id="tokenBadge" style="display:none;">Token: ✓</span>
              </div>

              <div class="dx-help" id="modeHint"></div>
            </div>

            <div class="dx-field">
              <label class="dx-label" for="goalSelect" data-i18n="dx.goal">Ziel</label>
              <select class="dx-input" id="goalSelect">
                <!-- options become short; explanation stays once in goalHelp (redundancy removed) -->
                <option value="stabilize" data-i18n="dx.goal.stabilize">Stabilisieren (Spannung schnell senken)</option>
                <option value="rebuild" data-i18n="dx.goal.rebuild">Umbauen (Architektur verändern)</option>
              </select>
              <div class="dx-help" id="goalHelp"></div>
            </div>

            <div class="dx-field">
              <label class="dx-label" for="oneLiner" data-i18n="dx.oneliner">Beschreibe die Situation in einem Satz</label>
              <input class="dx-input" id="oneLiner" type="text" maxlength="160" placeholder="…" />
              <div class="dx-help" id="oneLinerHelp"></div>
            </div>

            <div class="dx-divider"></div>

            <h2 class="h3" style="margin:0;" data-i18n="dx.scanTitle">2) Quick Scan (Slider)</h2>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.load.title">Last & Engpässe</div>
              <div class="dx-help" id="exLoad"></div>
              <div class="dx-rangeRow">
                <input id="sLoad" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vLoad">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.decisions.title">Entscheidungsarchitektur</div>
              <div class="dx-help" id="exDecisions"></div>
              <div class="dx-rangeRow">
                <input id="sDecisions" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vDecisions">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.energy.title">Energie & Fehlerkultur</div>
              <div class="dx-help" id="exEnergy"></div>
              <div class="dx-rangeRow">
                <input id="sEnergy" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vEnergy">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.growth.title">Wachstumsdruck / Komplexität</div>
              <div class="dx-help" id="exGrowth"></div>
              <div class="dx-rangeRow">
                <input id="sGrowth" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vGrowth">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.power.title">Macht–Verantwortung (Alignment)</div>
              <div class="dx-help" id="exPower"></div>
              <div class="dx-rangeRow">
                <input id="sPower" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vPower">2</div>
              </div>
            </div>

            <div class="dx-divider"></div>

            <h2 class="h3" style="margin:0;" data-i18n="dx.moreTitle">3) Präzisionsfragen (adaptiv)</h2>
            <div class="dx-questions" id="questions"></div>

            <div class="dx-actions" style="margin-top: .9rem;">
              <button class="btn btn--primary" type="button" id="runBtn" data-i18n="dx.run">Diagnose starten</button>
              <button class="btn btn--ghost" type="button" id="resetBtn" data-i18n="dx.reset">Zurücksetzen</button>
              <span class="micro" id="statusLine">—</span>
            </div>

            <div class="dx-kpi">
              <span class="pill pill--muted" id="kpiPrimary">Primär: —</span>
              <span class="pill pill--muted" id="kpiPath">Pfad: —</span>
              <span class="pill pill--muted" id="kpiRisk">Risiko: —</span>
            </div>
          </div>
        </div>

        <!-- RIGHT: output -->
        <div class="card dx-output">
          <h2 class="h3" data-i18n="dx.outputTitle">Output</h2>
          <p class="micro" data-i18n="dx.outputHint">
          </p>

          <div class="dx-reportGrid">
            <div class="dx-reportBox">
              <h3 class="h3" style="margin-top:0;" data-i18n="dx.assessmentTitle">Strategisches Assessment</h3>
              <pre id="resultText" class="micro" style="margin:0;">—</pre>
            </div>

            <div class="dx-reportBox">
              <h3 class="h3" style="margin-top:0;" data-i18n="dx.execTitle">Executive Report</h3>
              <p class="dx-note" id="execHint"></p>

              <div class="dx-actions" style="margin-top:.6rem;">
                <button class="btn btn--primary" type="button" id="execBtn" data-i18n="dx.execBtn">Executive Report erzeugen</button>
                <button class="btn btn--ghost" type="button" id="copyExecBtn" disabled data-i18n="dx.copy">Kopieren</button>
                <!-- SVG removed (function + UI) -->
                <button class="btn btn--ghost" type="button" id="pdfBtn" data-i18n="dx.pdfBtn">PDF</button>
              </div>

              <div class="dx-report" id="reportContainer" style="display:none;">
                <pre id="execText" class="micro" style="margin: .8rem 0 0;">—</pre>

                <!-- Feedback (shown after Executive Summary / when report exists) -->
                <div class="dx-divider" style="margin: .9rem 0;"></div>
                <div id="feedbackBox" style="display:none;">
                  <div class="dx-qtitle" data-i18n="fb.title">Feedback (kurz)</div>

                  <div class="dx-feedbackGrid">
                    <div class="dx-fRow">
                      <div class="dx-fLabel" data-i18n="fb.q1">1) Was war am hilfreichsten?</div>
                      <input class="dx-input" id="fbHelpful" type="text" maxlength="180" placeholder="…" />
                    </div>

                    <div class="dx-fRow">
                      <div class="dx-fLabel" data-i18n="fb.q2">2) Was fehlt / ist unklar?</div>
                      <input class="dx-input" id="fbMissing" type="text" maxlength="180" placeholder="…" />
                    </div>

                    <div class="dx-fRow">
                      <div class="dx-fLabel" data-i18n="fb.q3">3) Bewertung (0–10)</div>
                      <div class="dx-fInline">
                        <input class="dx-input" id="fbScore" type="number" min="0" max="10" step="1" value="8" style="max-width:120px;" />
                        <span class="dx-fSmall" data-i18n="fb.q3hint">0 = nicht hilfreich • 10 = extrem hilfreich</span>
                      </div>
                    </div>

                    <div class="dx-fInline" style="margin-top:.2rem;">
                      <button class="btn btn--primary" type="button" id="fbSendBtn" data-i18n="fb.send">Senden</button>
                      <span class="micro dx-fStatus" id="fbStatus">—</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Tree container removed (SVG feature removed) -->
            </div>
          </div>

          <p class="micro" style="margin-top:1rem; opacity:.85;" data-i18n="dx.privacy">
            Datenschutz: Inputs werden via API nur zur Generierung von Assessment/Report verarbeitet.
          </p>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer__grid">
      <div>
        <div class="brand brand--footer">
          <span class="brand__mark" aria-hidden="true">MDG</span>
          <span class="brand__text">v4</span>
        </div>
        <p class="micro" data-i18n="footer.tag">Strukturdiagnose für Stabilisierung und Umbau.</p>
      </div>
      <div class="footer__legal">
        <a href="./impressum.html" rel="nofollow">Impressum</a>
        <a href="./datenschutz.html" rel="nofollow">Datenschutz</a>
        <a href="./kontakt.html" rel="nofollow">Kontakt</a>
      </div>
    </div>
  </footer>

  <script>
  (() => {
    const API_BASE = "https://api.mdg-indikation.de";

    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    const burger = $(".burger");
    const drawer = $(".drawer");
    if (burger && drawer) {
      burger.addEventListener("click", () => {
        const open = drawer.hasAttribute("hidden") ? false : true;
        if (open) {
          drawer.setAttribute("hidden", "");
          burger.setAttribute("aria-expanded", "false");
        } else {
          drawer.removeAttribute("hidden");
          burger.setAttribute("aria-expanded", "true");
        }
      });
    }

    const params = new URLSearchParams(location.search);
    const modeParam = (params.get("mode") || "").toLowerCase();

    const ss = window.sessionStorage;
    const ls = window.localStorage;

    const storedMode = ((ss.getItem("mdg_mode") || ls.getItem("mdg_mode") || "")).toLowerCase();
    const businessOk = (ss.getItem("mdg_business_ok") === "1") || (ls.getItem("mdg_business_ok") === "1");
    const tokenStored =
      (ss.getItem("mdg_business_token") || ls.getItem("mdg_business_token") || ls.getItem("mdg_token") || "").trim();

    const wantsBusiness = (modeParam === "business") || (storedMode === "business");
    const mode = (wantsBusiness && businessOk) ? "business" : "private";

    $("#modeText").textContent = (mode === "business") ? "Business" : "Privat";
    if (mode === "business") $("#tokenBadge").style.display = "";

    const dict = {
      de: {
        "nav.how":"Wie es funktioniert",
        "nav.why":"Warum MDG",
        "nav.faq":"FAQ",
        "cta.backHome":"Zur Homepage",

        "dx.title":"Diagnose",
        "dx.sub":"In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen.",
        "dx.contextTitle":"1) Kontext",
        "dx.mode":"Modus",
        "dx.goal":"Ziel",
        "dx.goal.stabilize":"Stabilisieren",
        "dx.goal.rebuild":"Umbauen",
        "dx.oneliner":"Beschreibe die Situation in einem Satz",
        "dx.scanTitle":"2) Quick Scan (Slider)",
        "dx.moreTitle":"3) Präzisionsfragen (adaptiv)",
        "dx.run":"Diagnose starten",
        "dx.reset":"Zurücksetzen",

        "dx.outputTitle":"Output",
        "dx.outputHint":"Du erhältst: Primärinstabilität, warum sie entsteht, Sofortmaßnahmen und Umbaupfad.",
        "dx.assessmentTitle":"Strategisches Assessment",
        "dx.execTitle":"Executive Report",
        "dx.execBtn":"Executive Report erzeugen",
        "dx.copy":"Kopieren",
        "dx.pdfBtn":"PDF",
        "dx.privacy":"Datenschutz: Inputs werden via API nur zur Generierung von Assessment/Report verarbeitet.",
        "footer.tag":"Strukturdiagnose für Stabilisierung und Umbau.",

        "q.load.title":"Last & Engpässe",
        "q.decisions.title":"Entscheidungsarchitektur",
        "q.energy.title":"Energie & Fehlerkultur",
        "q.growth.title":"Wachstumsdruck / Komplexität",
        "q.power.title":"Macht–Verantwortung (Alignment)",

        "kpi.primary":"Primär",
        "kpi.path":"Pfad",
        "kpi.risk":"Risiko",

        "fb.title":"Feedback (kurz)",
        "fb.q1":"1) Was war am hilfreichsten?",
        "fb.q2":"2) Was fehlt / ist unklar?",
        "fb.q3":"3) Bewertung (0–10)",
        "fb.q3hint":"0 = nicht hilfreich • 10 = extrem hilfreich",
        "fb.send":"Senden"
      },
      tr: {
        "nav.how":"Nasıl çalışır",
        "nav.why":"Neden MDG",
        "nav.faq":"SSS",
        "cta.backHome":"Anasayfa",

        "dx.title":"Analiz",
        "dx.sub":"Birkaç dakika içinde karar güveni: istikrarsızlığı erken gör, nedeni doğru teşhis et, mimari kur.",
        "dx.contextTitle":"1) Bağlam",
        "dx.mode":"Mod",
        "dx.goal":"Hedef",
        "dx.goal.stabilize":"Stabilize et",
        "dx.goal.rebuild":"Yeniden kur",
        "dx.oneliner":"Durumu tek cümleyle anlat",
        "dx.scanTitle":"2) Hızlı tarama (Slider)",
        "dx.moreTitle":"3) Kesinleştirme soruları",
        "dx.run":"Başlat",
        "dx.reset":"Sıfırla",

        "dx.outputTitle":"Çıktı",
        "dx.outputHint":"Alacağın: ana instabilite, nedenleri, hemen yapılacaklar ve dönüşüm yolu.",
        "dx.assessmentTitle":"Stratejik değerlendirme",
        "dx.execTitle":"Yönetici raporu",
        "dx.execBtn":"Rapor üret",
        "dx.copy":"Kopyala",
        "dx.pdfBtn":"PDF",
        "dx.privacy":"Gizlilik: Veriler yalnızca rapor üretimi için API üzerinden işlenir.",
        "footer.tag":"Stabilizasyon ve yeniden kurulum için yapı teşhisi.",

        "q.load.title":"Yük & darboğazlar",
        "q.decisions.title":"Karar mimarisi",
        "q.energy.title":"Enerji & hata kültürü",
        "q.growth.title":"Büyüme baskısı / karmaşıklık",
        "q.power.title":"Güç–sorumluluk uyumu",

        "kpi.primary":"Ana",
        "kpi.path":"Yol",
        "kpi.risk":"Risk",

        "fb.title":"Geri bildirim (kısa)",
        "fb.q1":"1) En faydalı kısım neydi?",
        "fb.q2":"2) Ne eksik / belirsiz?",
        "fb.q3":"3) Puan (0–10)",
        "fb.q3hint":"0 = faydasız • 10 = çok faydalı",
        "fb.send":"Gönder"
      },
      en: {
        "nav.how":"How it works",
        "nav.why":"Why MDG",
        "nav.faq":"FAQ",
        "cta.backHome":"Home",

        "dx.title":"Diagnosis",
        "dx.sub":"In a few minutes to decision-confidence: detect instability early, diagnose precisely, build architecture.",
        "dx.contextTitle":"1) Context",
        "dx.mode":"Mode",
        "dx.goal":"Goal",
        "dx.goal.stabilize":"Stabilize",
        "dx.goal.rebuild":"Rebuild",
        "dx.oneliner":"Describe the situation in one sentence",
        "dx.scanTitle":"2) Quick Scan (sliders)",
        "dx.moreTitle":"3) Precision Questions (adaptive)",
        "dx.run":"Run assessment",
        "dx.reset":"Reset",

        "dx.outputTitle":"Output",
        "dx.outputHint":"You will get: primary instability, why it happens, what to do now, and what to rebuild.",
        "dx.assessmentTitle":"Strategic Assessment",
        "dx.execTitle":"Executive Report",
        "dx.execBtn":"Generate Executive Report",
        "dx.copy":"Copy",
        "dx.pdfBtn":"PDF",
        "dx.privacy":"Privacy: inputs are processed via API only to generate the assessment/report.",
        "footer.tag":"Structure diagnosis for stabilization and rebuild.",

        "q.load.title":"Load & bottlenecks",
        "q.decisions.title":"Decision architecture",
        "q.energy.title":"Energy & error handling",
        "q.growth.title":"Growth pressure / complexity",
        "q.power.title":"Power–responsibility alignment",

        "kpi.primary":"Primary",
        "kpi.path":"Path",
        "kpi.risk":"Risk",

        "fb.title":"Feedback (quick)",
        "fb.q1":"1) What helped most?",
        "fb.q2":"2) What’s missing / unclear?",
        "fb.q3":"3) Score (0–10)",
        "fb.q3hint":"0 = not helpful • 10 = extremely helpful",
        "fb.send":"Send"
      }
    };

    function getLang(){
      const pressed = $$("[data-lang]").find(b => b.getAttribute("aria-pressed") === "true");
      return pressed?.dataset.lang || "de";
    }

    function applyLang(lang){
      if(!dict[lang]) lang = "en";
      document.documentElement.lang = lang;

      $$("[data-lang]").forEach(b => b.setAttribute("aria-pressed", String(b.dataset.lang === lang)));
      $$("[data-i18n]").forEach(el => {
        const k = el.dataset.i18n;
        const v = dict[lang][k];
        if (v) el.textContent = v;
      });

      renderHelpTexts(lang);
      renderAdaptiveQuestions(lang);
      renderHints(lang);

      const k = dict[lang] || dict.en;
      $("#kpiPrimary").textContent = (k["kpi.primary"] || "Primary") + ": —";
      $("#kpiPath").textContent    = (k["kpi.path"] || "Path") + ": —";
      $("#kpiRisk").textContent    = (k["kpi.risk"] || "Risk") + ": —";
    }

    $$("[data-lang]").forEach(btn => btn.addEventListener("click", () => applyLang(btn.dataset.lang)));

    function renderHelpTexts(lang){
      const business = (mode === "business");
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));

      if (wantsBusiness && !businessOk) {
        $("#modeHint").innerHTML = t(
          "Business-Zugang nicht aktiv. Bitte Token über die Landingpage bestätigen.",
          "Business erişimi aktif değil. Lütfen token’ı ana sayfada doğrula.",
          "Business access not active. Please verify token on the landing page."
        );
      } else {
        $("#modeHint").innerHTML = business
          ? t(
              "Business-Modus: Fokus auf Unternehmen, Führung, Teams und Verantwortung.",
              "Business modu: şirket, liderlik, ekip ve sorumluluk odağı.",
              "Business mode: focus on companies, leadership, teams, accountability."
            )
          : t(
              "Privat-Modus: Fokus auf persönliche Systeme, Beziehungen, Alltag, Rollen & Belastung.",
              "Özel mod: kişisel sistemler, ilişkiler, günlük hayat, roller ve yük odağı.",
              "Private mode: focus on personal systems, relationships, daily life, roles and load."
            );
      }

      /* Redundanz bei Ziel: nur 1 Erklärung, Optionen kurz */
      $("#goalHelp").innerHTML = t(
        "<b>Stabilisieren</b> = Spannung senken. <b>Umbauen</b> = Architektur ändern.",
        "<b>Stabilize</b> = gerilimi düşür. <b>Yeniden kur</b> = mimariyi değiştir.",
        "<b>Stabilize</b> = reduce tension. <b>Rebuild</b> = change architecture."
      );

      /* 2 Beispiele bleiben NUR hier (wie gewünscht) */
      $("#oneLinerHelp").innerHTML = business
        ? t(
            "Beispiel 1: <b>„Unsere Entscheidungen dauern zu lange und hängen an einer Person.“</b><br>Beispiel 2: <b>„Team A und B blockieren sich, Qualität fällt.“</b>",
            "Örnek 1: <b>“Kararlar çok uzun sürüyor ve bir kişiye bağlı.”</b><br>Örnek 2: <b>“Takım A ve B birbirini kilitliyor, kalite düşüyor.”</b>",
            "Example 1: <b>“Decisions take too long and depend on one person.”</b><br>Example 2: <b>“Team A and B block each other, quality drops.”</b>"
          )
        : t(
            "Beispiel 1: <b>„Ich prokrastiniere und verliere Kontrolle über meinen Alltag.“</b><br>Beispiel 2: <b>„Wir haben wiederkehrende Konflikte und nichts ändert sich.“</b>",
            "Örnek 1: <b>“Erteleme yapıyorum ve günlük hayat kontrolüm kayıyor.”</b><br>Örnek 2: <b>“Tekrarlayan çatışmalar var ve hiçbir şey değişmiyor.”</b>",
            "Example 1: <b>“I procrastinate and lose control over my daily life.”</b><br>Example 2: <b>“We have recurring conflicts and nothing changes.”</b>"
          );

      /* Quickscan: KEINE Beispiele mehr */
      $("#exLoad").innerHTML = t(
        "0 = verteilt • 6 = Dauer-Engpass",
        "0 = dağıtılmış • 6 = sürekli darboğaz",
        "0 = distributed • 6 = permanent bottleneck"
      );
      $("#exDecisions").innerHTML = t(
        "0 = klar & schnell • 6 = unklar & langsam",
        "0 = net & hızlı • 6 = belirsiz & yavaş",
        "0 = clear & fast • 6 = unclear & slow"
      );
      $("#exEnergy").innerHTML = t(
        "0 = stabil • 6 = am Limit",
        "0 = stabil • 6 = limitte",
        "0 = stable • 6 = at the limit"
      );
      $("#exGrowth").innerHTML = t(
        "0 = kontrolliert • 6 = Komplexität > Struktur",
        "0 = kontrollü • 6 = karmaşıklık > yapı",
        "0 = controlled • 6 = complexity > structure"
      );
      $("#exPower").innerHTML = t(
        "0 = verteilt • 6 = konzentriert",
        "0 = uyumlu • 6 = kopuk",
        "0 = aligned • 6 = misalignment"
      );

      $("#execHint").textContent = business
        ? t(
            "Business: Diagnose + Operating Model + Rollen + Rhythmus + KPIs + 30-60-90.",
            "Business: teşhis + işletim modeli + roller + ritim + KPI + 30-60-90.",
            "Business: diagnosis + operating model + roles + cadence + KPIs + 30-60-90."
          )
        : t(
            "Privat: Ursachenlogik, Spannungsdynamik, klare Prioritäten, konkrete Moves.",
            "Özel: neden mantığı, gerilim dinamiği, net öncelikler, somut adımlar.",
            "Private: causal logic, tension dynamics, clear priorities, concrete moves."
          );
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderAdaptiveQuestions(lang){
      const business = (mode === "business");
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));

      const qs = business ? [
        {
          id:"b_q1",
          title: t("Wo entsteht aktuell die größte Verzögerung?","En büyük gecikme nerede?","Where is the biggest delay?"),
          options: [
            {v:"decisions", label:t("Entscheidungen","Kararlar","Decisions")},
            {v:"handoff", label:t("Übergaben","Devir","Handoffs")},
            {v:"quality", label:t("Qualität / Rework","Kalite / rework","Quality / rework")},
            {v:"capacity", label:t("Kapazität / Skills","Kapasite / skill","Capacity / skills")}
          ]
        },
        {
          id:"b_q2",
          title: t("Was passiert, wenn die Schlüsselrolle zwei Wochen ausfällt?","Kritik rol iki hafta yoksa?","If the key role is out for two weeks?"),
          options: [
            {v:"fine", label:t("Läuft weiter","Devam eder","Continues")},
            {v:"slow", label:t("Wird langsamer","Yavaşlar","Slower")},
            {v:"break", label:t("Bricht","Kırılır","Breaks")}
          ]
        },
        {
          id:"b_q3",
          title: t("Wie klar sind Rollen & Zuständigkeiten?","Roller/sorumluluk ne kadar net?","How clear are roles & ownership?"),
          options: [
            {v:"clear", label:t("Sehr klar","Çok net","Very clear")},
            {v:"mixed", label:t("Teilweise klar","Kısmen net","Partially clear")},
            {v:"unclear", label:t("Unklar","Belirsiz","Unclear")}
          ]
        }
      ] : [
        {
          id:"p_q1",
          title: t("Was ist der Haupt-Auslöser der Spannung?","Gerilimin ana tetikleyicisi?","Main trigger of the tension?"),
          options: [
            {v:"time", label:t("Zeitdruck","Zaman baskısı","Time pressure")},
            {v:"conflict", label:t("Konflikt","Çatışma","Conflict")},
            {v:"uncertainty", label:t("Unklarheit","Belirsizlik","Uncertainty")},
            {v:"energy", label:t("Energie / Erschöpfung","Enerji / yorgunluk","Energy / exhaustion")}
          ]
        },
        {
          id:"p_q2",
          title: t("Wie stark hängt das System an einer Person?","Sistem bir kişiye ne kadar bağlı?","How much does the system depend on one person?"),
          options: [
            {v:"low", label:t("Gering","Az","Low")},
            {v:"medium", label:t("Mittel","Orta","Medium")},
            {v:"high", label:t("Hoch","Yüksek","High")}
          ]
        },
        {
          id:"p_q3",
          title: t("Wie gut werden Fehler genutzt (statt versteckt)?","Hatalar öğrenmeye dönüyor mu?","How well are errors used (instead of hidden)?"),
          options: [
            {v:"good", label:t("Gut","İyi","Good")},
            {v:"mixed", label:t("Gemischt","Karışık","Mixed")},
            {v:"bad", label:t("Schlecht","Kötü","Bad")}
          ]
        }
      ];

      const root = $("#questions");
      root.innerHTML = "";
      qs.forEach(q => {
        const wrap = document.createElement("div");
        wrap.className = "dx-q";
        wrap.innerHTML = `
          <div class="dx-qtitle">${escapeHtml(q.title)}</div>
          <div class="dx-actions" style="margin-top:.55rem;">
            ${q.options.map(o => `
              <label class="pill pill--muted" style="cursor:pointer;">
                <input type="radio" name="${q.id}" value="${o.v}" style="margin-right:.4rem; accent-color: rgba(110,231,183,.9);" />
                ${escapeHtml(o.label)}
              </label>
            `).join("")}
          </div>
        `;
        root.appendChild(wrap);
      });
    }

    function renderHints(lang){
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));
      $("#statusLine").textContent = t("Status: bereit", "Durum: hazır", "Status: ready");
      $("#execText").textContent = "—";
      $("#resultText").textContent = "—";
      $("#copyExecBtn").disabled = true;
      $("#reportContainer").style.display = "none";
      $("#feedbackBox").style.display = "none";
      $("#fbStatus").textContent = "—";
    }

    function syncSliders(){
      const pairs = [["sLoad","vLoad"],["sDecisions","vDecisions"],["sEnergy","vEnergy"],["sGrowth","vGrowth"],["sPower","vPower"]];
      pairs.forEach(([sid, vid]) => {
        const s = document.getElementById(sid);
        const v = document.getElementById(vid);
        if (s && v) v.textContent = s.value;
      });
    }
    $$('input[type="range"]').forEach(r => r.addEventListener("input", syncSliders));

    function readRadios(){
      const out = {};
      $$('input[type="radio"]:checked').forEach(r => { out[r.name] = r.value; });
      return out;
    }

    function buildPayload(){
      const oneLiner = ($("#oneLiner").value || "").trim();
      const intent = $("#goalSelect").value;

      const quick_scan = {
        load: Number($("#sLoad").value),
        decisions: Number($("#sDecisions").value),
        energy: Number($("#sEnergy").value),
        growth: Number($("#sGrowth").value),
        power: Number($("#sPower").value),
      };

      return {
        version: "v4",
        mode,
        token: (mode === "business") ? tokenStored : undefined,
        lang: getLang(),
        problem: oneLiner,
        intent,
        answers: { quick_scan, radios: readRadios() },
        meta: { ts: new Date().toISOString(), ua: navigator.userAgent }
      };
    }

    async function postJson(path, body){
      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || `Request failed (${res.status})`);
      return data;
    }

    function downloadBlob(blob, filename){
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 800);
    }

    let LAST_ASSESSMENT = null;
    let LAST_REPORT = "";

    async function runAssessment(){
      const lang = getLang();
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));
      const k = dict[lang] || dict.en;

      const payload = buildPayload();

      if (!payload.problem) {
        alert(t("Bitte beschreibe die Situation in einem Satz.", "Lütfen durumu tek cümleyle yaz.", "Please describe the situation in one sentence."));
        return;
      }
      if (mode === "business" && !payload.token) {
        alert(t("Business-Token fehlt. Bitte über die Landingpage erneut einsteigen.", "Business token eksik. Lütfen ana sayfadan tekrar gir.", "Business token missing. Please re-enter via landing page."));
        return;
      }

      $("#statusLine").textContent = t("Status: läuft …", "Durum: çalışıyor …", "Status: running …");
      $("#resultText").textContent = "—";
      $("#execText").textContent = "—";
      $("#copyExecBtn").disabled = true;
      $("#reportContainer").style.display = "none";
      $("#feedbackBox").style.display = "none";
      $("#fbStatus").textContent = "—";
      LAST_ASSESSMENT = null;
      LAST_REPORT = "";

      try{
        const data = await postJson("/api/assess", payload);
        LAST_ASSESSMENT = data;

        const text = data.assessment_text || JSON.stringify(data, null, 2);
        $("#resultText").textContent = text;

        $("#kpiPrimary").textContent = (k["kpi.primary"] || "Primary") + ": " + (data.primary || "—");
        $("#kpiPath").textContent    = (k["kpi.path"] || "Path") + ": " + (data.path || "—");
        $("#kpiRisk").textContent    = (k["kpi.risk"] || "Risk") + ": " + (data.risk || "—");

        $("#statusLine").textContent = t("Status: fertig", "Durum: bitti", "Status: done");
      } catch(e){
        $("#statusLine").textContent = t("Status: Fehler – ", "Durum: Hata – ", "Status: Error – ") + (e?.message || String(e));
      }
    }

    async function runExecutiveReport(){
      const lang = getLang();
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));

      if (!LAST_ASSESSMENT) {
        alert(t("Bitte zuerst die Diagnose starten.", "Önce değerlendirmeyi çalıştır.", "Run the assessment first."));
        return;
      }

      $("#statusLine").textContent = t("Status: Report wird erstellt …", "Durum: Rapor oluşturuluyor …", "Status: generating report …");
      $("#execText").textContent = "—";
      $("#copyExecBtn").disabled = true;
      $("#reportContainer").style.display = "none";
      $("#feedbackBox").style.display = "none";
      $("#fbStatus").textContent = "—";
      LAST_REPORT = "";

      try{
        const payload = buildPayload();
        payload.assessment = LAST_ASSESSMENT;

        const data = await postJson("/api/report", payload);
        const text = data.report_markdown || JSON.stringify(data, null, 2);

        LAST_REPORT = text;
        $("#execText").textContent = text;

        $("#reportContainer").style.display = "";
        $("#copyExecBtn").disabled = false;

        initFeedbackUI();          /* reset state */
        $("#feedbackBox").style.display = "block";

        $("#statusLine").textContent = t("Status: Report fertig", "Durum: Rapor hazır", "Status: report ready");
      } catch(e){
        $("#statusLine").textContent = t("Status: Fehler – ", "Durum: Hata – ", "Status: Error – ") + (e?.message || String(e));
      }
    }

    async function runPdf(){
      const lang = getLang();
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));

      if (!LAST_ASSESSMENT) {
        alert(t("Bitte zuerst die Diagnose starten.", "Önce değerlendirmeyi çalıştır.", "Run the assessment first."));
        return;
      }
      if (mode === "business" && !tokenStored) {
        alert(t("Business-Token fehlt.", "Business token eksik.", "Business token missing."));
        return;
      }

      $("#statusLine").textContent = t("Status: PDF wird erstellt …", "Durum: PDF oluşturuluyor …", "Status: generating PDF …");

      try{
        const payload = buildPayload();
        payload.assessment = LAST_ASSESSMENT;
        if (LAST_REPORT) payload.report_markdown = LAST_REPORT;

        const res = await fetch(`${API_BASE}/api/pdf`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error((txt && txt.slice(0,140)) || `PDF endpoint failed (${res.status})`);
        }

        const ct = (res.headers.get("content-type") || "").toLowerCase();

        if (ct.includes("application/json")) {
          const data = await res.json().catch(() => ({}));
          const b64 = data?.pdf_base64 || data?.base64 || "";
          if (!b64) throw new Error("PDF JSON received but no pdf_base64.");
          const bin = atob(b64);
          const bytes = new Uint8Array(bin.length);
          for (let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
          downloadBlob(new Blob([bytes], { type: "application/pdf" }), "mdg-executive-report.pdf");
        } else {
          const buf = await res.arrayBuffer();
          downloadBlob(new Blob([buf], { type: "application/pdf" }), "mdg-executive-report.pdf");
        }

        $("#statusLine").textContent = t("Status: PDF fertig", "Durum: PDF hazır", "Status: PDF ready");
      } catch(e){
        $("#statusLine").textContent = t("Status: Fehler – ", "Durum: Hata – ", "Status: Error – ") + (e?.message || String(e));
      }
    }

    function initFeedbackUI(){
      const k = dict[getLang()] || dict.en;
      $("#fbHint").textContent = k["fb.q3hint"] || "";
      $("#fbQ1").value = "";
      $("#fbQ2").value = "";
      $("#fbNps").value = "";
      $("#fbSendBtn").disabled = true;
      $("#fbStatus").textContent = "—";
    }

    function feedbackReady(){
      const q1 = ($("#fbQ1").value || "").trim();
      const q2 = ($("#fbQ2").value || "").trim();
      const nps = ($("#fbNps").value || "").trim();
      return (q1.length >= 2) && (q2.length >= 2) && (/^\d{1,2}$/.test(nps)) && (Number(nps) >= 0) && (Number(nps) <= 10);
    }

    function hookFeedbackInputs(){
      ["fbQ1","fbQ2","fbNps"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("input", () => {
          $("#fbSendBtn").disabled = !feedbackReady();
        });
      });
    }

    async function sendFeedback(){
      const lang = getLang();
      const t = (de,tr,en) => (lang==="de"?de:(lang==="tr"?tr:en));

      if (!feedbackReady()) return;

      const payload = {
        page: "diagnose",
        mode,
        lang,
        problem: ($("#oneLiner").value || "").trim(),
        q1: ($("#fbQ1").value || "").trim(),
        q2: ($("#fbQ2").value || "").trim(),
        nps: Number(($("#fbNps").value || "").trim()),
        meta: { ts: new Date().toISOString(), ua: navigator.userAgent }
      };

      $("#fbStatus").textContent = "…";
      $("#fbSendBtn").disabled = true;

      try{
        await postJson("/api/feedback", payload);
        $("#fbStatus").textContent = "✓";
      } catch(e){
        $("#fbStatus").textContent = t("Fehler", "Hata", "Error");
        $("#fbSendBtn").disabled = false;
      }
    }

    function resetAll(){
      $("#oneLiner").value = "";
      $("#goalSelect").value = "stabilize";

      ["sLoad","sDecisions","sEnergy","sGrowth","sPower"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "2";
      });
      $$('input[type="radio"]').forEach(r => r.checked = false);

      LAST_ASSESSMENT = null;
      LAST_REPORT = "";

      $("#resultText").textContent = "—";
      $("#execText").textContent = "—";
      $("#reportContainer").style.display = "none";
      $("#copyExecBtn").disabled = true;

      $("#feedbackBox").style.display = "none";
      $("#fbStatus").textContent = "—";

      renderHints(getLang());
      syncSliders();
      renderAdaptiveQuestions(getLang());
    }

    $("#copyExecBtn").addEventListener("click", async () => {
      const txt = $("#execText").textContent || "";
      if (!txt || txt === "—") return;
      try { await navigator.clipboard.writeText(txt); } catch {}
    });

    $("#runBtn").addEventListener("click", runAssessment);
    $("#execBtn").addEventListener("click", runExecutiveReport);
    $("#pdfBtn").addEventListener("click", runPdf);

    $("#resetBtn").addEventListener("click", () => {
      const lang = getLang();
      const ok = confirm(lang==="de" ? "Wirklich zurücksetzen?" : (lang==="tr" ? "Sıfırlansın mı?" : "Reset?"));
      if (ok) resetAll();
    });

    hookFeedbackInputs();
    $("#fbSendBtn").addEventListener("click", sendFeedback);

    syncSliders();
    applyLang("de");

    /* ===== Feedback UI Integration ===== */

    function injectFeedbackBox(){
      const container = document.getElementById("reportContainer");
      if (!container) return;

      if (document.getElementById("feedbackBox")) return;

      const box = document.createElement("div");
      box.id = "feedbackBox";
      box.className = "dx-feedback";
      box.style.display = "none";

      box.innerHTML = `
        <h4 data-i18n="fb.title">Feedback (kurz)</h4>

        <div class="row">
          <label data-i18n="fb.q1">1) Was war am hilfreichsten?</label>
          <textarea id="fbQ1" rows="2"></textarea>
        </div>

        <div class="row">
          <label data-i18n="fb.q2">2) Was fehlt / ist unklar?</label>
          <textarea id="fbQ2" rows="2"></textarea>
        </div>

        <div class="row">
          <label data-i18n="fb.q3">3) Bewertung (0–10)</label>
          <input id="fbNps" type="number" min="0" max="10" />
          <div id="fbHint" class="hint"></div>
        </div>

        <div class="actions">
          <button id="fbSendBtn" disabled data-i18n="fb.send">Senden</button>
          <span id="fbStatus" class="status">—</span>
        </div>
      `;

      container.appendChild(box);
    }

    injectFeedbackBox();

    const feedbackStyle = document.createElement("style");
    feedbackStyle.innerHTML = `
      .dx-feedback{
        margin-top:1.6rem;
        padding:1.2rem 1.2rem 1.3rem;
        border-radius:18px;
        background:rgba(255,255,255,.03);
        border:1px solid rgba(255,255,255,.08);
      }

      .dx-feedback h4{
        margin:0 0 .8rem;
        font-size:.95rem;
        letter-spacing:.08em;
        text-transform:uppercase;
        opacity:.85;
      }

      .dx-feedback .row{
        margin-bottom:.85rem;
      }

      .dx-feedback textarea,
      .dx-feedback input[type="number"]{
        width:100%;
        padding:.65rem .75rem;
        border-radius:12px;
        border:1px solid rgba(255,255,255,.12);
        background:rgba(255,255,255,.04);
        color:#fff;
        font-size:.85rem;
        resize:vertical;
      }

      .dx-feedback input[type="number"]{
        max-width:120px;
      }

      .dx-feedback .hint{
        font-size:.7rem;
        opacity:.55;
        margin-top:.35rem;
      }

      .dx-feedback .actions{
        display:flex;
        align-items:center;
        gap:.8rem;
        margin-top:.5rem;
      }

      .dx-feedback button{
        padding:.55rem 1rem;
        border-radius:999px;
        border:1px solid rgba(110,231,183,.35);
        background:rgba(110,231,183,.12);
        color:#d1fae5;
        font-size:.8rem;
        cursor:pointer;
      }

      .dx-feedback button:disabled{
        opacity:.4;
        cursor:not-allowed;
      }

      .dx-feedback .status{
        font-size:.8rem;
        opacity:.7;
      }
    `;
    document.head.appendChild(feedbackStyle);

    /* ===== Final Init ===== */

    document.addEventListener("DOMContentLoaded", () => {
      try {
        syncSliders();
        applyLang("de");
        renderAdaptiveQuestions("de");
        renderHints("de");
      } catch(e){
        console.error("Init error:", e);
      }
    });

  })();
  </script>
</body>
</html>
