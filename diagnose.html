<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagnose – MDG</title>
  <meta name="description" content="In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen." />
  <link rel="stylesheet" href="./style.css" />
  <style>
    .dx-wrap{ max-width:1120px; margin:0 auto; padding:1.25rem 1rem 3rem; }
    .dx-top{ display:grid; grid-template-columns:1.1fr .9fr; gap:1rem; align-items:start; }
    .dx-actions{ display:flex; gap:.65rem; flex-wrap:wrap; align-items:center; }
    .dx-kpi{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.8rem; }
    .dx-kpi .pill{ white-space:nowrap; }
    .dx-grid{ display:grid; grid-template-columns:1fr; gap:.75rem; margin-top:.6rem; }
    .dx-field{ display:grid; gap:.35rem; }
    .dx-label{ font-weight:800; color:var(--muted,#aab); }
    .dx-help{ font-size:.9rem; color:var(--muted,#aab); line-height:1.35; }
    .dx-help b{ color:var(--text,#fff); }
    .dx-rangeRow{ display:grid; grid-template-columns:1fr auto; gap:.7rem; align-items:center; }
    .dx-rangeVal{ font-weight:900; min-width:2.2rem; text-align:right; }
    .dx-divider{ height:1px; background:rgba(255,255,255,.08); margin:.9rem 0; }
    .dx-questions{ display:grid; gap:1rem; margin-top:1rem; }
    .dx-q{ padding-top:.9rem; border-top:1px solid rgba(255,255,255,.08); }
    .dx-q:first-child{ border-top:0; padding-top:0; }
    .dx-qtitle{ font-weight:950; margin-bottom:.35rem; }
    .dx-output pre{ white-space:pre-wrap; word-break:break-word; }
    .dx-report{ margin-top:1rem; }
    .dx-reportGrid{ display:grid; grid-template-columns:1fr; gap:1rem; }
    .dx-reportBox{ padding:1rem; border:1px solid rgba(255,255,255,.10); border-radius:var(--radius2,18px); background:rgba(255,255,255,.02); }
    .dx-reportBox h3{ margin:0 0 .6rem; }
    .dx-badges{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .dx-note{ font-size:.9rem; color:var(--muted,#aab); }
    .dx-feedback{ display:none; margin-top:.9rem; }
    .dx-feedback .row{ display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
    .dx-stars{ display:flex; gap:.25rem; }
    .dx-star{ width:34px; height:34px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.03); display:grid; place-items:center; cursor:pointer; user-select:none; }
    .dx-star[aria-pressed="true"]{ border-color:rgba(110,231,183,.65); box-shadow:0 0 0 2px rgba(110,231,183,.15) inset; }
    .dx-ta{ width:100%; min-height:90px; resize:vertical; padding:.75rem .85rem; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.18); color:var(--text,#fff); }
    @media (max-width:980px){ .dx-top{ grid-template-columns:1fr; } }
  </style>
</head>

<body>
  <a class="skip-link" href="#main">Skip</a>

  <header class="header" id="top">
    <div class="container header__inner">
      <a class="brand" href="./index.html" aria-label="Home">
        <span class="brand__mark" aria-hidden="true">MDG</span>
      </a>

      <nav class="nav" aria-label="Main">
        <a class="nav__link" href="./how.html" data-i18n="nav.how">Wie es funktioniert</a>
        <a class="nav__link" href="./why.html" data-i18n="nav.why">Warum MDG</a>
        <a class="nav__link" href="./faq.html" data-i18n="nav.faq">FAQ</a>
      </nav>

      <div class="header__actions">
        <div class="lang" role="group" aria-label="Language">
          <button class="chip chip--ghost" type="button" data-lang="de" aria-pressed="true">DE</button>
          <button class="chip chip--ghost" type="button" data-lang="tr" aria-pressed="false">TR</button>
          <button class="chip chip--ghost" type="button" data-lang="en" aria-pressed="false">EN</button>
        </div>
        <a class="btn btn--ghost" href="./index.html" data-i18n="cta.backHome">Zur Homepage</a>
      </div>

      <button class="burger" type="button" aria-label="Menu" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
    </div>

    <div class="drawer" hidden>
      <div class="drawer__content">
        <a class="drawer__link" href="./how.html" data-i18n="nav.how">Wie es funktioniert</a>
        <a class="drawer__link" href="./why.html" data-i18n="nav.why">Warum MDG</a>
        <a class="drawer__link" href="./faq.html" data-i18n="nav.faq">FAQ</a>
        <div class="drawer__sep"></div>
        <a class="btn btn--ghost btn--full" href="./index.html" data-i18n="cta.backHome">Zur Homepage</a>
      </div>
    </div>
  </header>

  <main id="main">
    <div class="dx-wrap">
      <div class="section__head">
        <h1 class="h2" data-i18n="dx.title">Diagnose</h1>
        <p class="sub" data-i18n="dx.sub">In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen.</p>
      </div>

      <div class="dx-top">
        <div class="card">
          <h2 class="h3" data-i18n="dx.contextTitle">1) Kontext</h2>

          <div class="dx-grid">
            <div class="dx-field">
              <div class="dx-label" data-i18n="dx.mode">Modus</div>
              <div class="dx-badges">
                <span class="pill pill--muted" id="modeBadge">—</span>
                <span class="pill pill--muted" id="tokenBadge" style="display:none;">Token: ✓</span>
              </div>
              <div class="dx-help" id="modeHint"></div>
            </div>

            <div class="dx-field">
              <label class="dx-label" for="goalSelect" data-i18n="dx.goal">Ziel</label>
              <select class="dx-input" id="goalSelect">
                <option value="stabilize" data-i18n="dx.goal.stabilize">Stabilisieren</option>
                <option value="rebuild" data-i18n="dx.goal.rebuild">Umbauen</option>
              </select>
              <div class="dx-help" id="goalHelp"></div>
            </div>

            <div class="dx-field">
              <label class="dx-label" for="oneLiner" data-i18n="dx.oneliner">Beschreibe die Situation in einem Satz</label>
              <input class="dx-input" id="oneLiner" type="text" maxlength="160" placeholder="…" />
              <div class="dx-help" id="oneLinerHelp"></div>
            </div>

            <div class="dx-divider"></div>

            <h2 class="h3" style="margin:0;" data-i18n="dx.scanTitle">2) Quick Scan (Slider)</h2>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.load.title">Last & Engpässe</div>
              <div class="dx-help" id="exLoad"></div>
              <div class="dx-rangeRow">
                <input id="sLoad" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vLoad">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.decisions.title">Entscheidungsarchitektur</div>
              <div class="dx-help" id="exDecisions"></div>
              <div class="dx-rangeRow">
                <input id="sDecisions" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vDecisions">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.energy.title">Energie & Fehlerkultur</div>
              <div class="dx-help" id="exEnergy"></div>
              <div class="dx-rangeRow">
                <input id="sEnergy" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vEnergy">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.growth.title">Wachstumsdruck / Komplexität</div>
              <div class="dx-help" id="exGrowth"></div>
              <div class="dx-rangeRow">
                <input id="sGrowth" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vGrowth">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.power.title">Macht–Verantwortung (Alignment)</div>
              <div class="dx-help" id="exPower"></div>
              <div class="dx-rangeRow">
                <input id="sPower" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vPower">2</div>
              </div>
            </div>

            <div class="dx-divider"></div>

            <h2 class="h3" style="margin:0;" data-i18n="dx.moreTitle">3) Präzisionsfragen (adaptiv)</h2>
            <div class="dx-questions" id="questions"></div>

            <div class="dx-actions" style="margin-top:.9rem;">
              <button class="btn btn--primary" type="button" id="runBtn" data-i18n="dx.run">Diagnose starten</button>
              <button class="btn btn--ghost" type="button" id="resetBtn" data-i18n="dx.reset">Zurücksetzen</button>
              <span class="micro" id="statusLine"><span data-i18n="dx.status">Status</span>: —</span>
            </div>

            <div class="dx-kpi">
              <span class="pill pill--muted" id="kpiPrimary">—</span>
              <span class="pill pill--muted" id="kpiPath">—</span>
              <span class="pill pill--muted" id="kpiRisk">—</span>
            </div>
          </div>
        </div>

        <div class="card dx-output">
          <h2 class="h3" data-i18n="dx.outputTitle">Output</h2>
          <p class="micro" data-i18n="dx.outputHint">Du erhältst: Primärinstabilität, warum sie entsteht, Sofortmaßnahmen und Umbaupfad.</p>

          <div class="dx-reportGrid">
            <div class="dx-reportBox">
              <h3 class="h3" style="margin-top:0;" data-i18n="dx.assessmentTitle">Strategisches Assessment</h3>
              <pre id="resultText" class="micro" style="margin:0;">—</pre>
            </div>

            <div class="dx-reportBox">
              <h3 class="h3" style="margin-top:0;" data-i18n="dx.execTitle">Executive Report</h3>
              <p class="dx-note" id="execHint"></p>

              <div class="dx-actions" style="margin-top:.6rem;">
                <button class="btn btn--primary" type="button" id="execBtn" data-i18n="dx.execBtn">Executive Report erzeugen</button>
                <button class="btn btn--ghost" type="button" id="copyExecBtn" disabled data-i18n="dx.copy">Kopieren</button>
              </div>

              <div class="dx-report" id="reportContainer" style="display:none;">
                <pre id="execText" class="micro" style="margin:.8rem 0 0;">—</pre>
              </div>

              <div class="dx-feedback dx-reportBox" id="feedbackBox">
                <h3 class="h3" style="margin-top:0;" data-i18n="fb.title">Feedback</h3>
                <p class="dx-note" id="fbHint"></p>

                <div class="row" style="margin-top:.6rem;">
                  <div class="dx-stars" id="fbStars" aria-label="Rating">
                    <button class="dx-star" type="button" data-v="1" aria-pressed="false">1</button>
                    <button class="dx-star" type="button" data-v="2" aria-pressed="false">2</button>
                    <button class="dx-star" type="button" data-v="3" aria-pressed="false">3</button>
                    <button class="dx-star" type="button" data-v="4" aria-pressed="false">4</button>
                    <button class="dx-star" type="button" data-v="5" aria-pressed="false">5</button>
                  </div>
                  <span class="micro" id="fbVal">—</span>
                </div>

                <div style="margin-top:.6rem;">
                  <textarea class="dx-ta" id="fbText" maxlength="800" placeholder="…"></textarea>
                </div>

                <div class="dx-actions" style="margin-top:.6rem;">
                  <button class="btn btn--primary" type="button" id="fbSendBtn" disabled data-i18n="fb.send">Senden</button>
                  <span class="micro" id="fbStatus">—</span>
                </div>
              </div>

            </div>
          </div>

          <p class="micro" style="margin-top:1rem; opacity:.85;" data-i18n="dx.privacy">Datenschutz: Inputs werden via API nur zur Generierung von Assessment/Report verarbeitet.</p>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer__grid">
      <div>
        <div class="brand brand--footer">
          <span class="brand__mark" aria-hidden="true">MDG</span>
        </div>
        <p class="micro" data-i18n="footer.tag">Strukturdiagnose für Stabilisierung und Umbau.</p>
      </div>
      <div class="footer__legal">
        <a href="./impressum.html" rel="nofollow">Impressum</a>
        <a href="./datenschutz.html" rel="nofollow">Datenschutz</a>
        <a href="./kontakt.html" rel="nofollow">Kontakt</a>
      </div>
    </div>
  </footer>

  <script>
  (() => {
    const API_BASE = "https://api.mdg-indikation.de";
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    const burger = $(".burger");
    const drawer = $(".drawer");
    if (burger && drawer) {
      burger.addEventListener("click", () => {
        const open = !drawer.hasAttribute("hidden");
        if (open) { drawer.setAttribute("hidden",""); burger.setAttribute("aria-expanded","false"); }
        else { drawer.removeAttribute("hidden"); burger.setAttribute("aria-expanded","true"); }
      });
    }

    const ls = window.localStorage;
    const ss = window.sessionStorage;

    const params = new URLSearchParams(location.search);
    const modeParam = (params.get("mode") || "").toLowerCase();
    const storedMode = ((ss.getItem("mdg_mode") || ls.getItem("mdg_mode") || "")).toLowerCase();
    const businessOk = (ss.getItem("mdg_business_ok") === "1") || (ls.getItem("mdg_business_ok") === "1");
    const tokenStored = (ss.getItem("mdg_business_token") || ls.getItem("mdg_business_token") || ls.getItem("mdg_token") || "").trim();

    const wantsBusiness = (modeParam === "business") || (storedMode === "business");
    const mode = (wantsBusiness && businessOk) ? "business" : "private";

    $("#modeBadge").textContent = (mode === "business") ? "Business" : "Private";
    if (mode === "business") $("#tokenBadge").style.display = "";

    const dict = {
      de: {
        "nav.how":"Wie es funktioniert","nav.why":"Warum MDG","nav.faq":"FAQ","cta.backHome":"Zur Homepage",
        "dx.title":"Diagnose","dx.sub":"In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen.",
        "dx.contextTitle":"1) Kontext","dx.mode":"Modus","dx.goal":"Ziel","dx.goal.stabilize":"Stabilisieren","dx.goal.rebuild":"Umbauen",
        "dx.oneliner":"Beschreibe die Situation in einem Satz","dx.scanTitle":"2) Quick Scan (Slider)","dx.moreTitle":"3) Präzisionsfragen (adaptiv)",
        "dx.run":"Diagnose starten","dx.reset":"Zurücksetzen","dx.status":"Status",
        "dx.outputTitle":"Output","dx.outputHint":"Du erhältst: Primärinstabilität, warum sie entsteht, Sofortmaßnahmen und Umbaupfad.",
        "dx.assessmentTitle":"Strategisches Assessment","dx.execTitle":"Executive Report","dx.execBtn":"Executive Report erzeugen","dx.copy":"Kopieren",
        "dx.privacy":"Datenschutz: Inputs werden via API nur zur Generierung von Assessment/Report verarbeitet.",
        "footer.tag":"Strukturdiagnose für Stabilisierung und Umbau.",
        "q.load.title":"Last & Engpässe","q.decisions.title":"Entscheidungsarchitektur","q.energy.title":"Energie & Fehlerkultur","q.growth.title":"Wachstumsdruck / Komplexität","q.power.title":"Macht–Verantwortung (Alignment)",
        "fb.title":"Feedback","fb.send":"Senden"
      },
      tr: {
        "nav.how":"Nasıl çalışır","nav.why":"Neden MDG","nav.faq":"SSS","cta.backHome":"Anasayfa",
        "dx.title":"Analiz","dx.sub":"Birkaç dakika içinde karar güveni: istikrarsızlığı erken gör, nedeni doğru teşhis et, mimari kur.",
        "dx.contextTitle":"1) Bağlam","dx.mode":"Mod","dx.goal":"Hedef","dx.goal.stabilize":"Stabilize et","dx.goal.rebuild":"Yeniden kur",
        "dx.oneliner":"Durumu tek cümleyle anlat","dx.scanTitle":"2) Hızlı tarama (Slider)","dx.moreTitle":"3) Kesinleştirme soruları",
        "dx.run":"Başlat","dx.reset":"Sıfırla","dx.status":"Durum",
        "dx.outputTitle":"Çıktı","dx.outputHint":"Alacağın: ana instabilite, nedenleri, hemen yapılacaklar ve dönüşüm yolu.",
        "dx.assessmentTitle":"Stratejik değerlendirme","dx.execTitle":"Yönetici Raporu","dx.execBtn":"Rapor üret","dx.copy":"Kopyala",
        "dx.privacy":"Gizlilik: Veriler yalnızca rapor üretimi için API üzerinden işlenir.",
        "footer.tag":"Stabilizasyon ve yeniden kurulum için yapı teşhisi.",
        "q.load.title":"Yük & darboğazlar","q.decisions.title":"Karar mimarisi","q.energy.title":"Enerji & hata kültürü","q.growth.title":"Büyüme baskısı / karmaşıklık","q.power.title":"Güç–sorumluluk uyumu",
        "fb.title":"Geri bildirim","fb.send":"Gönder"
      },
      en: {
        "nav.how":"How it works","nav.why":"Why MDG","nav.faq":"FAQ","cta.backHome":"Home",
        "dx.title":"Diagnosis","dx.sub":"In a few minutes to decision-confidence: detect instability early, diagnose precisely, build architecture.",
        "dx.contextTitle":"1) Context","dx.mode":"Mode","dx.goal":"Goal","dx.goal.stabilize":"Stabilize","dx.goal.rebuild":"Rebuild",
        "dx.oneliner":"Describe the situation in one sentence","dx.scanTitle":"2) Quick Scan (sliders)","dx.moreTitle":"3) Precision Questions (adaptive)",
        "dx.run":"Run assessment","dx.reset":"Reset","dx.status":"Status",
        "dx.outputTitle":"Output","dx.outputHint":"You will get: primary instability, why it happens, what to do now, and what to rebuild.",
        "dx.assessmentTitle":"Strategic Assessment","dx.execTitle":"Executive Report","dx.execBtn":"Generate Executive Report","dx.copy":"Copy",
        "dx.privacy":"Privacy: inputs are processed via API only to generate the assessment/report.",
        "footer.tag":"Structure diagnosis for stabilization and rebuild.",
        "q.load.title":"Load & bottlenecks","q.decisions.title":"Decision architecture","q.energy.title":"Energy & error handling","q.growth.title":"Growth pressure / complexity","q.power.title":"Power–responsibility alignment",
        "fb.title":"Feedback","fb.send":"Send"
      }
    };

    function t(lang, de, tr, en){ return (lang==="de"?de:(lang==="tr"?tr:en)); }

    function getLang(){
      const pressed = $$("[data-lang]").find(b => b.getAttribute("aria-pressed") === "true");
      return pressed?.dataset.lang || "de";
    }

    function applyLang(lang){
      if(!dict[lang]) lang = "de";
      document.documentElement.lang = lang;
      $$("[data-lang]").forEach(b => b.setAttribute("aria-pressed", String(b.dataset.lang === lang)));
      $$("[data-i18n]").forEach(el => {
        const k = el.dataset.i18n;
        const v = dict[lang][k];
        if (v) el.textContent = v;
      });
      renderCopy(lang);
      renderQuestions(lang);
      syncKpiLanguage(lang);
    }

    $$("[data-lang]").forEach(btn => btn.addEventListener("click", () => applyLang(btn.dataset.lang)));

    function renderCopy(lang){
      if (wantsBusiness && !businessOk) {
        $("#modeHint").innerHTML = t(lang,
          "Business-Zugang nicht aktiv. Bitte Token über die Landingpage bestätigen.",
          "Business erişimi aktif değil. Lütfen token’ı ana sayfada doğrula.",
          "Business access not active. Please verify token on the landing page."
        );
      } else {
        $("#modeHint").innerHTML = (mode === "business")
          ? t(lang,"Business-Modus: Fokus auf Unternehmen, Führung, Teams und Verantwortung.","Business modu: şirket, liderlik, ekip ve sorumluluk odağı.","Business mode: focus on companies, leadership, teams, accountability.")
          : t(lang,"Privat-Modus: Fokus auf persönliche Systeme, Beziehungen, Alltag, Rollen & Belastung.","Özel mod: kişisel sistemler, ilişkiler, günlük hayat, roller ve yük odağı.","Private mode: focus on personal systems, relationships, daily life, roles and load.");
      }

      $("#goalHelp").innerHTML = t(lang,
        "<b>Stabilisieren</b> = Spannung senken. <b>Umbauen</b> = Architektur ändern.",
        "<b>Stabilize</b> = gerilimi düşür. <b>Yeniden kur</b> = mimariyi değiştir.",
        "<b>Stabilize</b> = reduce tension. <b>Rebuild</b> = change architecture."
      );

      $("#oneLinerHelp").innerHTML = (mode === "business")
        ? t(lang,
            "Beispiel 1: <b>„Entscheidungen dauern zu lange und hängen an 1 Person.“</b><br>Beispiel 2: <b>„Team A und B blockieren sich, Qualität fällt.“</b>",
            "Örnek 1: <b>“Kararlar çok uzun sürüyor ve 1 kişiye bağlı.”</b><br>Örnek 2: <b>“Takım A ve B birbirini blokluyor, kalite düşüyor.”</b>",
            "Example 1: <b>“Decisions take too long and depend on one person.”</b><br>Example 2: <b>“Teams block each other, quality drops.”</b>"
          )
        : t(lang,
            "Beispiel 1: <b>„Ich prokrastiniere und verliere Kontrolle über meinen Alltag.“</b><br>Beispiel 2: <b>„Wir haben wiederkehrende Konflikte und nichts ändert sich.“</b>",
            "Örnek 1: <b>“Erteleme yapıyorum ve günlük hayat kontrolüm kayıyor.”</b><br>Örnek 2: <b>“Tekrarlayan çatışmalar var ve hiçbir şey değişmiyor.”</b>",
            "Example 1: <b>“I procrastinate and lose control over my daily life.”</b><br>Example 2: <b>“Recurring conflicts and nothing changes.”</b>"
          );

      $("#exLoad").textContent = t(lang,"0 = verteilt/tragbar. 6 = Dauer-Engpass.","0 = dengeli. 6 = sürekli darboğaz.","0 = distributed/manageable. 6 = permanent bottleneck.");
      $("#exDecisions").textContent = t(lang,"0 = klar & schnell. 6 = unklar, langsam.","0 = net & hızlı. 6 = belirsiz, yavaş.","0 = clear & fast. 6 = unclear, slow.");
      $("#exEnergy").textContent = t(lang,"0 = Rhythmus ok. 6 = Überlastung.","0 = ritim iyi. 6 = aşırı yük.","0 = rhythm ok. 6 = overload.");
      $("#exGrowth").textContent = t(lang,"0 = kontrolliert. 6 = Komplexität > Struktur.","0 = kontrollü. 6 = karmaşıklık > yapı.","0 = controlled. 6 = complexity > structure.");
      $("#exPower").textContent = t(lang,"0 = aligned. 6 = stark verdreht.","0 = uyumlu. 6 = kopuk.","0 = aligned. 6 = misaligned.");

      $("#execHint").textContent = (mode === "business")
        ? t(lang,"Business: Diagnose + Operating Model + Rollen + Rhythmus + KPIs + 30-60-90.","Business: teşhis + işletim modeli + roller + ritim + KPI + 30-60-90.","Business: diagnosis + operating model + roles + cadence + KPIs + 30-60-90.")
        : t(lang,"Privat: Ursachenlogik, klare Prioritäten, konkrete Moves.","Özel: neden mantığı, net öncelikler, somut adımlar.","Private: causal logic, clear priorities, concrete moves.");

      $("#fbHint").textContent = t(lang,
        "Kurz: Wie hilfreich war der Output – und was fehlt?",
        "Kısa: Çıktı ne kadar faydalı – ne eksik?",
        "Short: How helpful was the output – and what’s missing?"
      );
    }

    function renderQuestions(lang){
      const el = $("#questions");
      el.innerHTML = "";

      const q = (mode === "business")
        ? [
            { id:"q1", title: t(lang,"Wo entsteht aktuell die größte Verzögerung?","En büyük gecikme nerede?","Where is the biggest delay right now?"),
              opts: [
                t(lang,"Entscheidungen (Freigaben/Eskalation)","Kararlar (onay/escalation)","Decisions (approvals/escalation)"),
                t(lang,"Übergaben (Team→Team)","Devir (takım→takım)","Handoffs (team→team)"),
                t(lang,"Qualität (Rework/Bugs)","Kalite (yeniden iş)","Quality (rework/bugs)"),
                t(lang,"Kapazität (Leute/Skills)","Kapasite (insan/skill)","Capacity (people/skills)")
              ]},
            { id:"q2", title: t(lang,"Was passiert, wenn eine Schlüsselrolle 2 Wochen ausfällt?","Kilit rol 2 hafta yoksa ne olur?","What happens if a key role is out for 2 weeks?"),
              opts: [
                t(lang,"Läuft weiter (kleine Reibung)","Devam eder (küçük sürtünme)","Continues (minor friction)"),
                t(lang,"Wird deutlich langsamer","Belirgin yavaşlar","Gets much slower"),
                t(lang,"Bricht (Stop in Lieferung/Entscheid)","Kırılır (teslim/karar durur)","Breaks (delivery/decisions stop)")
              ]},
            { id:"q3", title: t(lang,"Wer hat Einfluss – und wer trägt die Last?","Kim etkiliyor – kim yükü taşıyor?","Who has influence – and who carries the load?"),
              opts: [
                t(lang,"Passt zusammen","Uyumlu","Aligned"),
                t(lang,"Teilweise verdreht","Kısmen ters","Partly misaligned"),
                t(lang,"Stark verdreht","Ciddi ters","Strongly misaligned")
              ]}
          ]
        : [
            { id:"q1", title: t(lang,"Was zieht dich aktuell am stärksten runter?","Şu an seni en çok ne aşağı çekiyor?","What pulls you down most right now?"),
              opts: [
                t(lang,"Überlastung / zu viel gleichzeitig","Aşırı yük / çok şey aynı anda","Overload / too many things"),
                t(lang,"Konflikte / Spannungen mit Personen","Kişilerle çatışma / gerilim","Conflicts / tensions with people"),
                t(lang,"Vermeidung / Prokrastination","Kaçınma / erteleme","Avoidance / procrastination"),
                t(lang,"Chaos / keine Struktur im Alltag","Kaos / günlükte yapı yok","Chaos / no structure")
              ]},
            { id:"q2", title: t(lang,"Wo verlierst du am häufigsten Zeit/Energie?","En çok nerede zaman/enerji kaybediyorsun?","Where do you lose time/energy most?"),
              opts: [
                t(lang,"Zu viele offene Themen","Çok açık konu","Too many open threads"),
                t(lang,"Unklare Prioritäten","Belirsiz öncelikler","Unclear priorities"),
                t(lang,"Schlechte Routinen / Rhythmus","Zayıf rutin / ritim","Weak routines / rhythm"),
                t(lang,"Reibung mit Menschen","İnsanlarla sürtünme","Friction with people")
              ]},
            { id:"q3", title: t(lang,"Wer hat Einfluss – und wer trägt die Last?","Kim etkiliyor – kim yükü taşıyor?","Who has influence – and who carries the load?"),
              opts: [
                t(lang,"Passt zusammen","Uyumlu","Aligned"),
                t(lang,"Teilweise verdreht","Kısmen ters","Partly misaligned"),
                t(lang,"Stark verdreht","Ciddi ters","Strongly misaligned")
              ]}
          ];

      q.forEach(item => {
        const wrap = document.createElement("div");
        wrap.className = "dx-q";
        wrap.innerHTML = `
          <div class="dx-qtitle">${item.title}</div>
          <div class="dx-actions">
            ${item.opts.map((label, i) => `
              <label class="pill pill--muted" style="display:inline-flex; gap:.5rem; align-items:center; cursor:pointer;">
                <input type="radio" name="${item.id}" value="${i}" style="accent-color: var(--accent,#6ee7b7);" />
                <span class="micro" style="opacity:.95;">${label}</span>
              </label>
            `).join("")}
          </div>
        `;
        el.appendChild(wrap);
      });
    }

    const sliders = ["Load","Decisions","Energy","Growth","Power"];
    sliders.forEach(key => {
      const s = $("#s" + key);
      const v = $("#v" + key);
      if (!s || !v) return;
      v.textContent = s.value;
      s.addEventListener("input", () => v.textContent = s.value);
    });

    function getPrecisionAnswers(){
      const out = {};
      const lang = document.documentElement.lang || "de";
      ["q1","q2","q3"].forEach(id => {
        const sel = document.querySelector(`input[name="${id}"]:checked`);
        out[id] = sel ? Number(sel.value) : null;
      });
      out._lang = lang;
      out._mode = mode;
      return out;
    }

    function mapPrimary(lang, val){
      const v = String(val || "");
      const deMap = {
        "Decision architecture":"Entscheidungsarchitektur",
        "Load asymmetry":"Last-Asymmetrie",
        "Growth sensitivity":"Wachstumssensitivität",
        "Power-responsibility mismatch":"Macht–Verantwortung (Mismatch)",
        "Energy & error integration":"Energie & Fehlerintegration"
      };
      const trMap = {
        "Decision architecture":"Karar mimarisi",
        "Load asymmetry":"Yük asimetrisi",
        "Growth sensitivity":"Büyüme hassasiyeti",
        "Power-responsibility mismatch":"Güç–sorumluluk uyumsuzluğu",
        "Energy & error integration":"Enerji & hata entegrasyonu"
      };
      if (lang === "de") return deMap[v] || v || "—";
      if (lang === "tr") return trMap[v] || v || "—";
      return v || "—";
    }

    function mapRisk(lang, val){
      const v = String(val || "").toLowerCase();
      const de = { low:"niedrig", medium:"mittel", high:"hoch" };
      const tr = { low:"düşük", medium:"orta", high:"yüksek" };
      if (lang === "de") return de[v] || (v || "—");
      if (lang === "tr") return tr[v] || (v || "—");
      return v ? v : "—";
    }

    function mapPath(lang, val){
      const v = String(val || "");
      const de = { "IDG":"IDG", "ADG":"ADG", "IDG → ADG":"IDG → ADG" };
      const tr = { "IDG":"IDG", "ADG":"ADG", "IDG → ADG":"IDG → ADG" };
      if (lang === "de") return de[v] || v || "—";
      if (lang === "tr") return tr[v] || v || "—";
      return v || "—";
    }

    function syncKpiLanguage(lang){
      const raw = window.__lastAssessment || null;
      if (!raw) return;
      $("#kpiPrimary").textContent = mapPrimary(lang, raw.primary);
      $("#kpiPath").textContent = mapPath(lang, raw.path);
      $("#kpiRisk").textContent = mapRisk(lang, raw.risk);
    }

    $("#runBtn").addEventListener("click", async () => {
      const lang = document.documentElement.lang || "de";

      $("#statusLine").innerHTML = `<span data-i18n="dx.status">${dict[lang]["dx.status"] || "Status"}</span>: …`;
      $("#resultText").textContent = "…";
      $("#kpiPrimary").textContent = "—";
      $("#kpiPath").textContent = "—";
      $("#kpiRisk").textContent = "—";
      $("#reportContainer").style.display = "none";
      $("#feedbackBox").style.display = "none";
      $("#copyExecBtn").disabled = true;

      const payload = {
        mode,
        token: tokenStored || undefined,
        problem: $("#oneLiner").value.trim(),
        intent: $("#goalSelect").value,
        lang,
        quick_scan: {
          load: Number($("#sLoad").value),
          decisions: Number($("#sDecisions").value),
          energy: Number($("#sEnergy").value),
          growth: Number($("#sGrowth").value),
          power: Number($("#sPower").value)
        },
        answers: {
          precision: getPrecisionAnswers()
        }
      };

      try {
        const res = await fetch(API_BASE + "/api/assess", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("Assessment failed");

        const data = await res.json();
        window.__lastAssessment = data;

        $("#resultText").textContent = data.assessment_text || "—";
        $("#kpiPrimary").textContent = mapPrimary(lang, data.primary);
        $("#kpiPath").textContent = mapPath(lang, data.path);
        $("#kpiRisk").textContent = mapRisk(lang, data.risk);

        $("#statusLine").innerHTML = `<span data-i18n="dx.status">${dict[lang]["dx.status"] || "Status"}</span>: ✓`;
      } catch (err) {
        $("#statusLine").innerHTML = `<span data-i18n="dx.status">${dict[lang]["dx.status"] || "Status"}</span>: Error`;
        $("#resultText").textContent = (lang==="de") ? "Serverfehler." : (lang==="tr" ? "Sunucu hatası." : "Server error.");
      }
    });

    $("#execBtn").addEventListener("click", async () => {
      const lang = document.documentElement.lang || "de";
      if (!window.__lastAssessment) return;

      $("#execText").textContent = "…";
      $("#reportContainer").style.display = "block";
      $("#feedbackBox").style.display = "none";
      $("#copyExecBtn").disabled = true;

      const body = {
        mode,
        token: tokenStored || undefined,
        lang,
        problem: $("#oneLiner").value.trim(),
        intent: $("#goalSelect").value,
        quick_scan: {
          load: Number($("#sLoad").value),
          decisions: Number($("#sDecisions").value),
          energy: Number($("#sEnergy").value),
          growth: Number($("#sGrowth").value),
          power: Number($("#sPower").value)
        },
        answers: {
          precision: getPrecisionAnswers()
        },
        assessment: window.__lastAssessment?.assessment_text || ""
      };

      try {
        const res = await fetch(API_BASE + "/api/report", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error("Report failed");
        const data = await res.json();

        window.__lastReport = data.report_markdown || "";
        $("#execText").textContent = window.__lastReport || "—";
        $("#copyExecBtn").disabled = !window.__lastReport;
        $("#feedbackBox").style.display = "block";
      } catch (err) {
        $("#execText").textContent = (lang==="de") ? "Serverfehler." : (lang==="tr" ? "Sunucu hatası." : "Server error.");
      }
    });

    $("#copyExecBtn").addEventListener("click", async () => {
      if (!window.__lastReport) return;
      try { await navigator.clipboard.writeText(window.__lastReport); } catch {}
    });

    $("#resetBtn").addEventListener("click", () => {
      $("#oneLiner").value = "";
      $("#goalSelect").value = "stabilize";
      ["Load","Decisions","Energy","Growth","Power"].forEach(k => {
        const s = $("#s"+k), v = $("#v"+k);
        if (s && v) { s.value = "2"; v.textContent = "2"; }
      });
      $$("#questions input[type='radio']").forEach(r => r.checked = false);

      $("#resultText").textContent = "—";
      $("#execText").textContent = "—";
      $("#reportContainer").style.display = "none";
      $("#feedbackBox").style.display = "none";
      $("#copyExecBtn").disabled = true;

      $("#kpiPrimary").textContent = "—";
      $("#kpiPath").textContent = "—";
      $("#kpiRisk").textContent = "—";
      const lang = document.documentElement.lang || "de";
      $("#statusLine").innerHTML = `<span data-i18n="dx.status">${dict[lang]["dx.status"] || "Status"}</span>: —`;

      window.__lastAssessment = null;
      window.__lastReport = "";
    });

    let rating = 0;

    function renderFeedbackCopy(lang){
      $("#fbStatus").textContent = "—";
      $("#fbVal").textContent = "—";
      $("#fbText").placeholder = (lang==="de") ? "Optional: 1–2 Sätze…" : (lang==="tr" ? "İsteğe bağlı: 1–2 cümle…" : "Optional: 1–2 sentences…");
      $("#fbSendBtn").disabled = true;
      $$("#fbStars .dx-star").forEach(b => b.setAttribute("aria-pressed","false"));
      rating = 0;
    }

    $$("#fbStars .dx-star").forEach(btn => {
      btn.addEventListener("click", () => {
        rating = Number(btn.dataset.v);
        $$("#fbStars .dx-star").forEach(b => b.setAttribute("aria-pressed", String(Number(b.dataset.v) === rating)));
        $("#fbVal").textContent = `${rating}/5`;
        $("#fbSendBtn").disabled = (rating <= 0);
      });
    });

    $("#fbSendBtn").addEventListener("click", async () => {
      const lang = document.documentElement.lang || "de";
      const text = $("#fbText").value.trim();

      $("#fbStatus").textContent = "…";

      try {
        const res = await fetch(API_BASE + "/api/feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            rating,
            text,
            page: "diagnose",
            mode,
            lang,
            client_id: (ls.getItem("mdg_client_id") || null),
            ts: new Date().toISOString()
          })
        });

        if (res.ok) {
          $("#fbStatus").textContent = "✓";
          $("#fbSendBtn").disabled = true;
        } else {
          $("#fbStatus").textContent = "Error";
        }
      } catch {
        $("#fbStatus").textContent = "Error";
      }
    });

    function ensureClientId(){
      let id = ls.getItem("mdg_client_id");
      if (!id || id.length < 16) {
        const a = crypto.getRandomValues(new Uint8Array(16));
        a[6] = (a[6] & 0x0f) | 0x40;
        a[8] = (a[8] & 0x3f) | 0x80;
        const h = [...a].map(b => b.toString(16).padStart(2,"0")).join("");
        id = `${h.slice(0,8)}-${h.slice(8,12)}-${h.slice(12,16)}-${h.slice(16,20)}-${h.slice(20)}`;
        ls.setItem("mdg_client_id", id);
      }
    }

    ensureClientId();
    applyLang((ls.getItem("mdg_lang") || ss.getItem("mdg_lang") || "de").toLowerCase());

    const startLang = getLang();
    renderCopy(startLang);
    renderQuestions(startLang);
    renderFeedbackCopy(startLang);

    const originalApply = applyLang;
    applyLang = (lang) => {
      ls.setItem("mdg_lang", lang);
      ss.setItem("mdg_lang", lang);
      originalApply(lang);
      renderFeedbackCopy(lang);
      const statusKey = dict[lang]["dx.status"] || "Status";
      const raw = $("#statusLine").textContent.includes("✓") ? "✓" : ($("#statusLine").textContent.includes("Error") ? "Error" : "—");
      $("#statusLine").innerHTML = `<span data-i18n="dx.status">${statusKey}</span>: ${raw}`;
    };

  })();
  </script>
</body>
</html>
