<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagnose – MDG</title>
  <meta name="description" content="In wenigen Minuten zur Entscheidungssicherheit: Instabilität früh erkennen, Ursache präzise diagnostizieren, Architektur bauen." />
  <link rel="stylesheet" href="./style.css" />
  <style>
    /* minimal page-only tweaks (keeps v2 look via style.css) */
    .dx-wrap{ max-width: 1120px; margin: 0 auto; padding: 1.25rem 1rem 3rem; }
    .dx-top{ display:grid; grid-template-columns: 1.1fr .9fr; gap:1rem; align-items:start; }
    .dx-actions{ display:flex; gap:.65rem; flex-wrap:wrap; align-items:center; }
    .dx-kpi{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.8rem; }
    .dx-kpi .pill{ white-space:nowrap; }
    .dx-grid{ display:grid; grid-template-columns: 1fr; gap:.75rem; margin-top:.6rem; }
    .dx-field{ display:grid; gap:.35rem; }
    .dx-label{ font-weight: 800; color: var(--muted, #aab); }
    .dx-help{ font-size:.9rem; color: var(--muted, #aab); line-height:1.35; }
    .dx-help b{ color: var(--text, #fff); }
    .dx-rangeRow{ display:grid; grid-template-columns: 1fr auto; gap:.7rem; align-items:center; }
    .dx-rangeVal{ font-weight: 900; min-width: 2.2rem; text-align:right; }
    .dx-divider{ height:1px; background: rgba(255,255,255,.08); margin: .9rem 0; }
    .dx-questions{ display:grid; gap: 1rem; margin-top: 1rem; }
    .dx-q{ padding-top:.9rem; border-top: 1px solid rgba(255,255,255,.08); }
    .dx-q:first-child{ border-top: 0; padding-top: 0; }
    .dx-qtitle{ font-weight: 950; margin-bottom:.35rem; }
    .dx-example{ margin-top:.25rem; display:grid; gap:.25rem; }
    .dx-example .ex{ font-size:.9rem; color: var(--muted, #aab); }
    .dx-example .ex::before{ content:"• "; opacity:.9; }
    .dx-output pre{ white-space: pre-wrap; word-break: break-word; }
    .dx-report{ margin-top: 1rem; }
    .dx-reportGrid{ display:grid; grid-template-columns: 1fr; gap:1rem; }
    .dx-reportBox{ padding: 1rem; border:1px solid rgba(255,255,255,.10); border-radius: var(--radius2, 18px); background: rgba(255,255,255,.02); }
    .dx-reportBox h3{ margin:0 0 .6rem; }
    .dx-badges{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .dx-note{ font-size:.9rem; color: var(--muted, #aab); }
    @media (max-width: 980px){
      .dx-top{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <a class="skip-link" href="#main">Skip</a>

  <header class="header" id="top">
    <div class="container header__inner">
      <a class="brand" href="./index.html" aria-label="Home">
        <span class="brand__mark" aria-hidden="true">MDG</span>
        <span class="brand__text">v4</span>
      </a>

      <nav class="nav" aria-label="Main">
        <a class="nav__link" href="./how.html" data-i18n="nav.how">How it works</a>
        <a class="nav__link" href="./why.html" data-i18n="nav.why">Why MDG</a>
        <a class="nav__link" href="./faq.html" data-i18n="nav.faq">FAQ</a>
      </nav>

      <div class="header__actions">
        <div class="lang" role="group" aria-label="Language">
          <button class="chip chip--ghost" type="button" data-lang="de" aria-pressed="true">DE</button>
          <button class="chip chip--ghost" type="button" data-lang="tr" aria-pressed="false">TR</button>
          <button class="chip chip--ghost" type="button" data-lang="en" aria-pressed="false">EN</button>
        </div>
        <a class="btn btn--ghost" href="./index.html" data-i18n="cta.backHome">Home</a>
      </div>

      <button class="burger" type="button" aria-label="Menu" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>
    </div>

    <div class="drawer" hidden>
      <div class="drawer__content">
        <a class="drawer__link" href="./how.html" data-i18n="nav.how">How it works</a>
        <a class="drawer__link" href="./why.html" data-i18n="nav.why">Why MDG</a>
        <a class="drawer__link" href="./faq.html" data-i18n="nav.faq">FAQ</a>
        <div class="drawer__sep"></div>
        <a class="btn btn--ghost btn--full" href="./index.html" data-i18n="cta.backHome">Home</a>
      </div>
    </div>
  </header>

  <main id="main">
    <div class="dx-wrap">
      <div class="section__head">
        <h1 class="h2" data-i18n="dx.title">Diagnosis</h1>
        <p class="sub" data-i18n="dx.sub">
          In a few minutes to decision-confidence: detect instability early, diagnose precisely, build architecture.
        </p>
      </div>

      <div class="dx-top">
        <!-- LEFT: input -->
        <div class="card">
          <h2 class="h3" data-i18n="dx.contextTitle">1) Context</h2>

          <div class="dx-grid">
            <div class="dx-field">
              <div class="dx-label" data-i18n="dx.mode">Mode</div>
              <div class="dx-badges">
                <span class="pill pill--muted" id="modeBadge">—</span>
                <span class="pill pill--muted" id="tokenBadge" style="display:none;">Token: ✓</span>
              </div>
              <div class="dx-help" id="modeHint"></div>
            </div>

            <div class="dx-field">
              <label class="dx-label" for="goalSelect" data-i18n="dx.goal">Goal</label>
              <select class="dx-input" id="goalSelect">
                <option value="stabilize" data-i18n="dx.goal.stabilize">Stabilize (reduce tension fast)</option>
                <option value="rebuild" data-i18n="dx.goal.rebuild">Rebuild (change architecture)</option>
              </select>
              <div class="dx-help" id="goalHelp"></div>
            </div>

            <div class="dx-field">
              <label class="dx-label" for="oneLiner" data-i18n="dx.oneliner">Describe the situation in one sentence</label>
              <input class="dx-input" id="oneLiner" type="text" maxlength="160" placeholder="…" />
              <div class="dx-help" id="oneLinerHelp"></div>
            </div>

            <div class="dx-divider"></div>

            <h2 class="h3" style="margin:0;" data-i18n="dx.scanTitle">2) Quick Scan (sliders)</h2>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.load.title">Load & bottlenecks</div>
              <div class="dx-help" id="exLoad"></div>
              <div class="dx-rangeRow">
                <input id="sLoad" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vLoad">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.decisions.title">Decision architecture</div>
              <div class="dx-help" id="exDecisions"></div>
              <div class="dx-rangeRow">
                <input id="sDecisions" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vDecisions">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.energy.title">Energy & error handling</div>
              <div class="dx-help" id="exEnergy"></div>
              <div class="dx-rangeRow">
                <input id="sEnergy" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vEnergy">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.growth.title">Growth pressure / complexity</div>
              <div class="dx-help" id="exGrowth"></div>
              <div class="dx-rangeRow">
                <input id="sGrowth" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vGrowth">2</div>
              </div>
            </div>

            <div class="dx-field">
              <div class="dx-qtitle" data-i18n="q.power.title">Power–responsibility alignment</div>
              <div class="dx-help" id="exPower"></div>
              <div class="dx-rangeRow">
                <input id="sPower" class="dx-range" type="range" min="0" max="6" step="1" value="2" />
                <div class="dx-rangeVal" id="vPower">2</div>
              </div>
            </div>

            <div class="dx-divider"></div>

            <h2 class="h3" style="margin:0;" data-i18n="dx.moreTitle">3) Precision Questions (adaptive)</h2>
            <div class="dx-help" data-i18n="dx.moreHint">
              Answer the follow-up questions. They increase precision. Each question includes 2 simple examples.
            </div>

            <div class="dx-questions" id="questions"></div>

            <div class="dx-actions" style="margin-top: .9rem;">
              <button class="btn btn--primary" type="button" id="runBtn" data-i18n="dx.run">Run assessment</button>
              <button class="btn btn--ghost" type="button" id="resetBtn" data-i18n="dx.reset">Reset</button>
              <span class="micro" id="statusLine">—</span>
            </div>

            <div class="dx-kpi">
              <span class="pill pill--muted" id="kpiPrimary">Primary: —</span>
              <span class="pill pill--muted" id="kpiPath">Path: —</span>
              <span class="pill pill--muted" id="kpiRisk">Risk: —</span>
            </div>
          </div>
        </div>

        <!-- RIGHT: output -->
        <div class="card dx-output">
          <h2 class="h3" data-i18n="dx.outputTitle">Strategic Output</h2>
          <p class="micro" data-i18n="dx.outputHint">
            You will get: primary instability, why it happens, what to do now, and what to rebuild.
          </p>

          <div class="dx-reportGrid">
            <div class="dx-reportBox">
              <h3 class="h3" style="margin-top:0;" data-i18n="dx.assessmentTitle">Assessment</h3>
              <pre id="resultText" class="micro" style="margin:0;">—</pre>
            </div>

            <div class="dx-reportBox">
              <h3 class="h3" style="margin-top:0;" data-i18n="dx.execTitle">Executive Report (Premium)</h3>
              <p class="dx-note" id="execHint"></p>
              <div class="dx-actions" style="margin-top:.6rem;">
                <button class="btn btn--primary" type="button" id="execBtn" data-i18n="dx.execBtn">Generate Executive Report</button>
                <button class="btn btn--ghost" type="button" id="copyExecBtn" disabled data-i18n="dx.copy">Copy</button>
                <button class="btn btn--ghost" type="button" id="pdfBtn">Premium PDF</button>
              </div>
              <div class="dx-report" id="reportContainer" style="display:none;">
                <pre id="execText" class="micro" style="margin: .8rem 0 0;">—</pre>
              </div>
            </div>
          </div>

          <p class="micro" style="margin-top:1rem; opacity:.85;" data-i18n="dx.privacy">
            Privacy: inputs are processed via API only to generate the assessment/report.
          </p>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container footer__grid">
      <div>
        <div class="brand brand--footer">
          <span class="brand__mark" aria-hidden="true">MDG</span>
          <span class="brand__text">v4</span>
        </div>
        <p class="micro" data-i18n="footer.tag">Structure diagnosis for stabilization and rebuild.</p>
      </div>
      <div class="footer__legal">
        <a href="./impressum.html" rel="nofollow">Impressum</a>
        <a href="./datenschutz.html" rel="nofollow">Datenschutz</a>
        <a href="./kontakt.html" rel="nofollow">Kontakt</a>
      </div>
    </div>
  </footer>

<script>
(() => {

  const API_BASE = "https://api.mdg-indikation.de";

  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  // ------------------------------
  // Drawer (Burger)
  // ------------------------------
  const burger = $(".burger");
  const drawer = $(".drawer");

  if (burger && drawer) {
    burger.addEventListener("click", () => {
      const open = !drawer.hasAttribute("hidden");
      if (open) {
        drawer.setAttribute("hidden", "");
        burger.setAttribute("aria-expanded", "false");
      } else {
        drawer.removeAttribute("hidden");
        burger.setAttribute("aria-expanded", "true");
      }
    });
  }

  // ------------------------------
  // MODE + TOKEN (ROBUST)
  // ------------------------------

  const params = new URLSearchParams(location.search);
  const modeParam = (params.get("mode") || "").toLowerCase();

  const ss = window.sessionStorage;
  const ls = window.localStorage;

  const storedMode = (ss.getItem("mdg_mode") || ls.getItem("mdg_mode") || "").toLowerCase();

  const businessOk =
    ss.getItem("mdg_business_ok") === "1" ||
    ls.getItem("mdg_business_ok") === "1";

  const tokenStored =
    (ss.getItem("mdg_business_token") ||
     ls.getItem("mdg_business_token") ||
     ls.getItem("mdg_token") ||
     "").trim();

  const wantsBusiness = (modeParam === "business") || (storedMode === "business");
  const mode = (wantsBusiness && businessOk) ? "business" : "private";

  const modeBadge = $("#modeBadge");
  const tokenBadge = $("#tokenBadge");

  if (modeBadge) modeBadge.textContent = (mode === "business") ? "Business" : "Private";
  if (mode === "business" && tokenBadge) tokenBadge.style.display = "";

  // ------------------------------
  // SLIDER SYNC
  // ------------------------------

  function syncSliders(){
    const pairs = [
      ["sLoad","vLoad"],
      ["sDecisions","vDecisions"],
      ["sEnergy","vEnergy"],
      ["sGrowth","vGrowth"],
      ["sPower","vPower"]
    ];
    pairs.forEach(([sid, vid]) => {
      const s = document.getElementById(sid);
      const v = document.getElementById(vid);
      if (s && v) v.textContent = s.value;
    });
  }

  $$('input[type="range"]').forEach(r => r.addEventListener("input", syncSliders));
  syncSliders();

  // ------------------------------
  // HELPERS
  // ------------------------------

  function readRadios(){
    const out = {};
    $$('input[type="radio"]:checked').forEach(r => {
      out[r.name] = r.value;
    });
    return out;
  }

  function buildPayload(){

    const quick_scan = {
      load: Number($("#sLoad")?.value || 0),
      decisions: Number($("#sDecisions")?.value || 0),
      energy: Number($("#sEnergy")?.value || 0),
      growth: Number($("#sGrowth")?.value || 0),
      power: Number($("#sPower")?.value || 0)
    };

    return {
      version: "v4",
      mode,
      token: (mode === "business") ? tokenStored : undefined,
      lang: document.documentElement.lang || "de",
      problem: ($("#oneLiner")?.value || "").trim(),
      intent: $("#goalSelect")?.value || "stabilize",
      answers: {
        quick_scan,
        radios: readRadios()
      },
      meta: {
        ts: new Date().toISOString(),
        ua: navigator.userAgent
      }
    };
  }

  async function postJson(path, body){
    const res = await fetch(API_BASE + path, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json().catch(()=>({}));

    if (!res.ok) {
      throw new Error(data?.error || `Request failed (${res.status})`);
    }

    return data;
  }

  let LAST_ASSESSMENT = null;

  // ------------------------------
  // RUN ASSESSMENT
  // ------------------------------

  async function runAssessment(){

    const payload = buildPayload();

    if (!payload.problem){
      alert("Bitte Situation in einem Satz beschreiben.");
      return;
    }

    if (mode === "business" && !payload.token){
      alert("Business-Token fehlt. Bitte über die Landingpage einsteigen.");
      return;
    }

    $("#statusLine").textContent = "Status: läuft …";
    $("#resultText").textContent = "—";
    $("#execText").textContent = "—";
    $("#reportContainer").style.display = "none";
    $("#copyExecBtn").disabled = true;

    try {

      const data = await postJson("/api/assess", payload);
      LAST_ASSESSMENT = data;

      $("#resultText").textContent =
        data.assessment_text || JSON.stringify(data, null, 2);

      $("#kpiPrimary").textContent = "Primary: " + (data.primary || "—");
      $("#kpiPath").textContent = "Path: " + (data.path || "—");
      $("#kpiRisk").textContent = "Risk: " + (data.risk || "—");

      $("#statusLine").textContent = "Status: fertig";

    } catch(e){
      $("#statusLine").textContent = "Status: Fehler – " + e.message;
    }
  }

  // ------------------------------
  // EXECUTIVE REPORT
  // ------------------------------

  async function runExecutiveReport(){

    if (!LAST_ASSESSMENT){
      alert("Bitte zuerst Diagnose starten.");
      return;
    }

    $("#statusLine").textContent = "Status: Report wird erstellt …";
    $("#execText").textContent = "—";
    $("#reportContainer").style.display = "none";
    $("#copyExecBtn").disabled = true;

    try {

      const payload = buildPayload();
      payload.assessment = LAST_ASSESSMENT;

      const data = await postJson("/api/report", payload);

      $("#execText").textContent =
        data.report_markdown || JSON.stringify(data, null, 2);

      $("#reportContainer").style.display = "";
      $("#copyExecBtn").disabled = false;

      $("#statusLine").textContent = "Status: Report fertig";

    } catch(e){
      $("#statusLine").textContent = "Status: Fehler – " + e.message;
    }
  }

  // ------------------------------
  // COPY
  // ------------------------------

  $("#copyExecBtn")?.addEventListener("click", async ()=>{
    const txt = $("#execText").textContent;
    if (!txt || txt === "—") return;
    try { await navigator.clipboard.writeText(txt); } catch {}
  });

  // ------------------------------
  // RESET
  // ------------------------------

  function resetAll(){
    $("#oneLiner").value = "";
    $("#goalSelect").value = "stabilize";
    ["sLoad","sDecisions","sEnergy","sGrowth","sPower"].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.value = "2";
    });
    $$('input[type="radio"]').forEach(r=>r.checked=false);

    LAST_ASSESSMENT = null;

    $("#resultText").textContent = "—";
    $("#execText").textContent = "—";
    $("#reportContainer").style.display = "none";
    $("#copyExecBtn").disabled = true;

    $("#kpiPrimary").textContent = "Primary: —";
    $("#kpiPath").textContent = "Path: —";
    $("#kpiRisk").textContent = "Risk: —";

    $("#statusLine").textContent = "Status: bereit";

    syncSliders();
  }

  // ------------------------------
  // PDF EXPORT (Fallback)
  // ------------------------------

  $("#pdfBtn")?.addEventListener("click", ()=>{
    window.print();
  });

  // ------------------------------
  // EVENT BINDINGS
  // ------------------------------

  $("#runBtn")?.addEventListener("click", runAssessment);
  $("#execBtn")?.addEventListener("click", runExecutiveReport);
  $("#resetBtn")?.addEventListener("click", ()=>{
    if (confirm("Wirklich zurücksetzen?")) resetAll();
  });

})();
</script>

</body>
</html>
