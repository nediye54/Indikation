export default {
  async fetch(request, env) {

    const url = new URL(request.url);
    const cors = makeCorsHeaders();

    if (request.method === "OPTIONS") {
      return new Response(null, { status: 204, headers: cors });
    }

    try {

      // -----------------------------
      // HEALTH
      // -----------------------------
      if (url.pathname === "/api/health") {
        return json({ ok: true }, 200, cors);
      }

      // -----------------------------
      // AI INITIAL ANALYSIS
      // -----------------------------
      if (url.pathname === "/api/ai/analyze" && request.method === "POST") {

        const body = await request.json();

        const prompt = buildInitialPrompt(body);

        const result = await callOpenAI(env.OPENAI_API_KEY, prompt);

        return json(result, 200, cors);
      }

      // -----------------------------
      // AI FOLLOWUP
      // -----------------------------
      if (url.pathname === "/api/ai/followup" && request.method === "POST") {

        const body = await request.json();

        const prompt = buildFollowupPrompt(body);

        const result = await callOpenAI(env.OPENAI_API_KEY, prompt);

        return json(result, 200, cors);
      }

      // -----------------------------
      // AI EXECUTIVE REPORT  <-- HIER gehÃ¶rt es hin
      // -----------------------------
      if (url.pathname === "/api/ai/report" && request.method === "POST") {

        const body = await request.json();

        const prompt = buildReportPrompt(body);

        const result = await callOpenAI(env.OPENAI_API_KEY, prompt);

        return json(result, 200, cors);
      }

      // -----------------------------
      // SAVE DIAGNOSIS
      // -----------------------------
      if (url.pathname === "/api/diagnoses" && request.method === "POST") {

        const body = await request.json();

        const id = crypto.randomUUID();
        const createdAt = new Date().toISOString();

        await env.DB.prepare(`
          INSERT INTO diagnoses
          (id, created_at, client_id, payload_json)
          VALUES (?1, ?2, ?3, ?4)
        `)
        .bind(id, createdAt, body.client_id || null, JSON.stringify(body))
        .run();

        return json({ id }, 201, cors);
      }

      // -----------------------------
      // LOAD DIAGNOSIS
      // -----------------------------
      if (url.pathname.startsWith("/api/diagnoses/") && request.method === "GET") {

        const id = url.pathname.split("/").pop();

        const row = await env.DB.prepare(`
          SELECT payload_json FROM diagnoses WHERE id = ?1
        `)
        .bind(id)
        .first();

        if (!row) {
          return json({ error: "Not found" }, 404, cors);
        }

        return json(JSON.parse(row.payload_json), 200, cors);
      }

      return json({ error: "Not found" }, 404, cors);

    } catch (e) {
      return json({ error: e.message }, 500, cors);
    }
  }
};

// ===================================================
// OPENAI CALL
// ===================================================

async function callOpenAI(apiKey, prompt) {

  const response = await fetch("https://api.openai.com/v1/responses", {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${apiKey}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      model: "gpt-4o",
      temperature: 0.2,
      response_format: { type: "json_object" },
      input: [
        {
          role: "system",
          content: prompt
        }
      ]
    })
  });

  const data = await response.json();

  if (!response.ok) {
    throw new Error(data.error?.message || "OpenAI error");
  }

  return JSON.parse(data.output_text);
}

// ===================================================
// PROMPTS
// ===================================================

function buildInitialPrompt(data) {
  return `
You are a senior strategy partner.

Analyze the structural business scores below:

${JSON.stringify(data.scores, null, 2)}

Return strict JSON:

{
  "primary_instability": "...",
  "risk_level": "...",
  "preliminary_assessment": "...",
  "followup_questions": ["...", "...", "..."]
}

Be analytical. No fluff.
`;
}

function buildFollowupPrompt(data) {
  return `
You are a senior strategy partner.

Initial assessment:
${data.initial_assessment}

Followup answers:
${JSON.stringify(data.answers, null, 2)}

Return strict JSON:

{
  "final_primary_instability": "...",
  "root_cause": "...",
  "risk_amplification": "...",
  "strategic_path": "...",
  "30_60_90_outline": "..."
}
`;
}

function buildReportPrompt(data) {
  return `
You are a senior strategy partner writing for a board-level audience.

Assessment:
${JSON.stringify(data.assessment, null, 2)}

Return strict JSON:

{
  "executive_summary": "...",
  "structural_root_cause": "...",
  "risk_amplification_dynamic": "...",
  "strategic_positioning": "...",
  "thirty_sixty_ninety_plan": {
    "30_days": "...",
    "60_days": "...",
    "90_days": "..."
  },
  "ceo_memo": "..."
}

Tone:
Precise.
Strategic.
Board-ready.
No fluff.
`;
}

// ===================================================
// HELPERS
// ===================================================

function makeCorsHeaders() {
  const headers = new Headers();
  headers.set("Access-Control-Allow-Origin", "*");
  headers.set("Access-Control-Allow-Methods", "GET,POST,OPTIONS");
  headers.set("Access-Control-Allow-Headers", "Content-Type");
  return headers;
}

function json(obj, status, headers) {
  const h = new Headers(headers);
  h.set("Content-Type", "application/json");
  return new Response(JSON.stringify(obj), { status, headers: h });
}
